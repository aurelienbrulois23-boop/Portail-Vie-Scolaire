<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>La Biblioth√®que de Valdurne</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cinzel+Decorative:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{--or:#c9a84c;--or2:#e8c97a;--enc:#e8dfc8;--enc2:#c8bfa8;--p0:#0d0b08;--p1:#1a1510;--p2:#231d14;--r:8px;--rouge:#8a2a2a;--bleu:#1a3a6a}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--p0);color:var(--enc);font-family:'Crimson Text',Georgia,serif;font-size:1.05em;line-height:1.75;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(201,168,76,0.06) 0%,transparent 60%),
             radial-gradient(ellipse at 10% 80%,rgba(138,42,42,0.04) 0%,transparent 50%),
             radial-gradient(ellipse at 90% 50%,rgba(26,58,106,0.04) 0%,transparent 50%)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--p0)}::-webkit-scrollbar-thumb{background:rgba(201,168,76,.25);border-radius:3px}

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero{position:relative;text-align:center;padding:60px 24px 40px;overflow:hidden;z-index:1}
.hero::after{content:'';position:absolute;bottom:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,rgba(201,168,76,.3),transparent)}
.hero-rune{font-size:3.5em;margin-bottom:16px;filter:drop-shadow(0 0 20px rgba(201,168,76,.4));display:block;animation:rune-glow 3s ease-in-out infinite}
@keyframes rune-glow{0%,100%{filter:drop-shadow(0 0 12px rgba(201,168,76,.3))}50%{filter:drop-shadow(0 0 28px rgba(201,168,76,.6))}}
.hero-tag{font-family:'Cinzel',serif;font-size:.62em;letter-spacing:5px;color:var(--or);opacity:.7;text-transform:uppercase;margin-bottom:12px}
.hero-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.8em,6vw,3em);font-weight:700;color:var(--or2);line-height:1.15;margin-bottom:10px;text-shadow:0 0 40px rgba(201,168,76,.2)}
.hero-sub{font-style:italic;color:var(--enc2);opacity:.75;max-width:560px;margin:0 auto 20px;font-size:1.05em}
.xp-pill{display:inline-flex;align-items:center;gap:8px;background:rgba(201,168,76,.06);border:1px solid rgba(201,168,76,.2);border-radius:999px;padding:6px 18px;font-family:'Cinzel',serif;font-size:.7em;color:var(--or2);letter-spacing:1px}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav-bar{max-width:1100px;margin:0 auto;padding:14px 24px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;position:relative;z-index:2}
.bk{padding:6px 14px;background:transparent;border:1px solid rgba(201,168,76,.25);border-radius:4px;color:var(--enc2);font-size:.78em;text-decoration:none;display:inline-block;transition:all .2s}
.bk:hover{border-color:var(--or);color:var(--or)}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.lib{max-width:1100px;margin:0 auto;padding:0 24px 80px;position:relative;z-index:1}
.section-label{font-family:'Cinzel',serif;font-size:.68em;letter-spacing:4px;color:var(--or);text-transform:uppercase;margin:40px 0 16px;padding-bottom:8px;border-bottom:1px solid rgba(201,168,76,.15);display:flex;align-items:center;gap:10px}
.section-label::before{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,rgba(201,168,76,.15))}

/* ‚îÄ‚îÄ ROMAN PRINCIPAL ‚îÄ‚îÄ */
.roman-header{background:linear-gradient(135deg,rgba(26,21,16,.9),rgba(35,29,20,.8));border:1px solid rgba(201,168,76,.2);border-radius:12px;padding:28px;margin-bottom:24px;position:relative;overflow:hidden}
.roman-header::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--or),transparent)}
.roman-series{font-family:'Cinzel',serif;font-size:.6em;letter-spacing:4px;color:var(--or);opacity:.65;text-transform:uppercase;margin-bottom:8px}
.roman-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.1em,3vw,1.6em);color:var(--or2);margin-bottom:8px}
.roman-desc{font-style:italic;color:var(--enc2);line-height:1.8;font-size:.97em}

/* ‚îÄ‚îÄ CHAPTERS GRID ‚îÄ‚îÄ */
.chapters-list{display:grid;gap:14px}
.chapter{background:var(--p1);border:1px solid rgba(201,168,76,.15);border-radius:10px;padding:20px 24px;position:relative;overflow:hidden;transition:all .2s;display:grid;grid-template-columns:60px 1fr auto;align-items:center;gap:18px}
.chapter::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--ca,var(--or));opacity:.5}
.chapter.unlocked{cursor:pointer}
.chapter.unlocked:hover{border-color:rgba(201,168,76,.4);transform:translateX(4px);box-shadow:0 4px 20px rgba(0,0,0,.4)}
.chapter.locked{opacity:.5;filter:grayscale(.5)}
.chapter.done::after{content:'‚úì';position:absolute;top:12px;right:14px;color:var(--or);opacity:.6;font-size:.7em;font-family:'Cinzel',serif}
.chnum{font-family:'Cinzel',serif;font-size:.6em;letter-spacing:2px;color:var(--or);opacity:.6;text-align:center}
.chicon{font-size:1.8em;text-align:center;filter:drop-shadow(0 0 8px rgba(201,168,76,.3))}
.chtitle{font-family:'Cinzel',serif;font-size:.95em;color:var(--or2);margin-bottom:4px}
.chmeta{font-size:.78em;color:var(--enc2);opacity:.6;font-style:italic}
.chxp{font-family:'Cinzel',serif;font-size:.6em;letter-spacing:2px;color:var(--or);opacity:.7;white-space:nowrap;text-align:right}
.lock-icon{font-size:1.1em;opacity:.4;text-align:right}
.cta-read{padding:5px 14px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.35);border-radius:4px;color:var(--or2);font-size:.72em;font-family:'Cinzel',serif;letter-spacing:1px;white-space:nowrap}

/* ‚îÄ‚îÄ LDVELH ‚îÄ‚îÄ */
.ldv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.ldv-card{background:var(--p1);border:1px solid rgba(201,168,76,.15);border-radius:10px;padding:20px;position:relative;overflow:hidden;transition:all .2s}
.ldv-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--ca,var(--or)),transparent)}
.ldv-card.unlocked{cursor:pointer}
.ldv-card.unlocked:hover{transform:translateY(-3px);border-color:rgba(201,168,76,.4);box-shadow:0 8px 28px rgba(0,0,0,.4)}
.ldv-card.locked{opacity:.45;filter:grayscale(.6)}
.ldv-icon{font-size:1.8em;margin-bottom:10px;display:block;filter:drop-shadow(0 0 8px rgba(201,168,76,.3))}
.ldv-label{font-family:'Cinzel',serif;font-size:.6em;letter-spacing:3px;color:var(--or);opacity:.65;text-transform:uppercase;margin-bottom:6px}
.ldv-title{font-family:'Cinzel',serif;font-size:.9em;color:var(--or2);margin-bottom:6px;line-height:1.3}
.ldv-desc{font-style:italic;font-size:.82em;color:var(--enc2);line-height:1.7;margin-bottom:12px;border-left:2px solid rgba(201,168,76,.2);padding-left:10px}
.ldv-unlock{font-size:.68em;color:var(--enc2);opacity:.5;font-style:italic}
.ldv-badge{display:inline-block;font-family:'Cinzel',serif;font-size:.58em;letter-spacing:2px;color:var(--or);background:rgba(201,168,76,.08);border:1px solid rgba(201,168,76,.2);padding:3px 10px;border-radius:3px;margin-bottom:8px}

/* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
.prog-block{background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.12);border-radius:8px;padding:18px 22px;margin-bottom:24px}
.prog-title{font-family:'Cinzel',serif;font-size:.68em;letter-spacing:3px;color:var(--or);text-transform:uppercase;margin-bottom:12px}
.prog-bar{height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;margin-bottom:8px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--rouge),var(--or));border-radius:3px;transition:width .6s ease}
.prog-info{display:flex;justify-content:space-between;font-size:.74em;color:var(--enc2);opacity:.7}

/* ‚îÄ‚îÄ XP NOTIF ‚îÄ‚îÄ */
.xp-notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;padding:10px 24px;border-radius:8px;font-weight:600;font-size:.88em;text-align:center;pointer-events:none;display:none}

@media(max-width:700px){
  .chapter{grid-template-columns:50px 1fr}
  .chxp,.lock-icon,.cta-read{display:none}
  .ldv-grid{grid-template-columns:1fr}
  .nav-bar,.lib{padding-left:14px;padding-right:14px}
}
</style>
</head>
<body>

<div class="nav-bar">
  <a class="bk" href="index.html">‚Üê Portail</a>
  <a class="bk" href="hub_fontainebleau.html">Ch√¢teau de Fontainebleau</a>
</div>

<section class="hero">
  <span class="hero-rune">üìö</span>
  <div class="hero-tag">Exp√©dition de Valdurne</div>
  <h1 class="hero-title">La Biblioth√®que de Valdurne</h1>
  <p class="hero-sub">Chaque chapitre se m√©rite. Chaque page se gagne. L'histoire de Lyam attend les courageux.</p>
  <div class="xp-pill">‚öîÔ∏è √âcuyer : <span id="nomJ">‚Äî</span> &nbsp;¬∑&nbsp; ‚ú® <span id="xpJ">0</span> XP</div>
</section>

<div class="lib">

  <!-- ROMAN PRINCIPAL -->
  <div class="roman-header">
    <div class="roman-series">Roman Principal ¬∑ Exp√©dition de Valdurne</div>
    <div class="roman-title">Les Veilleurs de Valdurne</div>
    <p class="roman-desc">Lyam n'√©tait pas cens√© entrer √† Valdurne. Il n'avait pas les bonnes origines, pas le bon sang, pas le bon nom. Et pourtant, le soir o√π les portes de pierre se sont ouvertes devant lui, quelque chose d'ancien dans les murs du ch√¢teau a reconnu quelque chose d'ancien en lui. Ce roman suit sa premi√®re ann√©e ‚Äî les √©preuves, les amiti√©s, les trahisons, et une question qui grandit de chapitre en chapitre : qu'est-ce qu'on doit, exactement, √† ceux qui nous ont tout appris ?</p>
  </div>

  <div class="prog-block">
    <div class="prog-title">Ta progression dans le roman</div>
    <div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
    <div class="prog-info"><span id="progLabel">Chapitre 1 disponible</span><span id="progXp">0 / 4500 XP</span></div>
  </div>

  <div class="section-label">Les Chapitres</div>
  <div class="chapters-list" id="listChapitres"></div>

  <!-- HISTOIRES LDVELH -->
  <div class="section-label">Histoires Compl√©mentaires ¬∑ Livres dont vous √™tes le h√©ros</div>
  <div class="ldv-grid" id="gridLDV"></div>

</div>

<div class="xp-notif" id="xpNotif"></div>

<script>
var KEY='pvs_hof_v2';var AKEY='pvs_current_player';var DKEY='pvs_narration_done';
var W={pixhare:60,psc1:60,sanctuaire:60,loge:60,autres:60};
var CIT={representant_ca:{xp:500}};
var cur='';

function getS(){try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch(e){return{}}}
function getP(c){var S=getS();return(S.players&&S.players[c])?S.players[c]:null}
function getDone(){try{return JSON.parse(localStorage.getItem(DKEY)||'{}')}catch(e){return{}}}

function missionXp(c){try{var S=getS();var l=S.citizen_lists||{};var n=0;Object.keys(CIT).forEach(function(k){if((l[k]||[]).indexOf(c)>=0)n+=CIT[k].xp});return n}catch(e){return 0}}
function socialRaw(p){return Number(p&&p.socialG||0)+Number(p&&p.wBonusG||0)}
function socialValid(p){return Number(p&&p.witnessGiven||0)>0?socialRaw(p):0}
function citizenXp(p){try{return missionXp(p&&p.code)+socialValid(p)}catch(e){return 0}}
function academyXp(p){try{var cp=(p&&p.cp)||{};return Object.keys(W).reduce(function(a,k){return a+Number(cp[k]||0)*W[k]},0)}catch(e){return 0}}
function videoXp(p){return Number(p&&p.videoG||0)}
function acadDoneCount(p){try{return Object.keys(p.acadDone||{}).length}catch(e){return 0}}
function acadCoeff(p){try{var n=Math.min(acadDoneCount(p),50);return Math.round((1+n*0.02)*100)/100}catch(e){return 1}}
function xg(p){if(!p)return 0;try{var base=citizenXp(p)+academyXp(p)+videoXp(p)+Number(p.malusG||0);return Math.round(base*acadCoeff(p))}catch(e){return 0}}

// ‚îÄ‚îÄ CATALOGUE DES CHAPITRES ‚îÄ‚îÄ
var CHAPITRES = [
  {
    id:'ch01', file:'roman_ch01.html', num:'Chapitre I', icon:'üóº',
    title:'Les Portes de Pierre',
    meta:'Arriv√©e √† Valdurne ¬∑ La d√©sorientation du premier jour',
    xpRequired:0,
    desc:'Lyam d√©couvre pour la premi√®re fois les tours de Valdurne ‚Äî et r√©alise que rien, absolument rien, ne ressemble √† ce qu\'on lui avait promis.'
  },
  {
    id:'ch02', file:'roman_ch02.html', num:'Chapitre II', icon:'üìñ',
    title:'La Fille qui Savait Trop',
    meta:'Rencontre avec R√©na ¬∑ Les r√®gles non-√©crites',
    xpRequired:500,
    desc:'Il y a une fille qui conna√Æt tous les couloirs. Elle s\'appelle R√©na. Elle a un an d\'avance, et personne ne veut lui reconna√Ætre.'
  },
  {
    id:'ch03', file:'roman_ch03.html', num:'Chapitre III', icon:'üî•',
    title:'L\'√âpreuve du Scriptorium',
    meta:'Premier test ¬∑ Intelligence collective',
    xpRequired:1000,
    desc:'L\'√©preuve du Scriptorium n\'est pas cens√©e pouvoir se r√©ussir √† deux. Mais personne ne l\'interdit non plus.'
  },
  {
    id:'ch04', file:'roman_ch04.html', num:'Chapitre IV', icon:'üë§',
    title:'Le Gar√ßon qui N\'existait Pas',
    meta:'Exclusion ¬∑ Identit√© ¬∑ Ce qu\'on doit √† ceux qui nous ignorent',
    xpRequired:1500,
    desc:'Ils effacent le nom de Lyam du tableau des √©cuyers. Comme √ßa. Sans explication. R√©na dit qu\'elle sait qui a fait √ßa ‚Äî et pourquoi.'
  },
  {
    id:'ch05', file:'roman_ch05.html', num:'Chapitre V', icon:'‚öíÔ∏è',
    title:'Sang de Forge, Sang Royal',
    meta:'Classes sociales ¬∑ Discrimination d\'origine',
    xpRequired:2000,
    desc:'√ätre fils de forgeron √† Valdurne, c\'est porter une marque invisible que tout le monde voit. Ce chapitre, Lyam d√©cide d\'en faire une force.'
  },
  {
    id:'ch06', file:'roman_ch06.html', num:'Chapitre VI', icon:'üåë',
    title:'Ce que la Nuit Cache',
    meta:'Complot ¬∑ Courage civil ¬∑ T√©moigner quand c\'est dangereux',
    xpRequired:2500,
    desc:'Lyam voit quelque chose qu\'il n\'aurait pas d√ª voir. Maintenant il doit choisir : parler, et tout risquer ‚Äî ou se taire, et laisser faire.'
  },
  {
    id:'ch07', file:'roman_ch07.html', num:'Chapitre VII', icon:'‚öñÔ∏è',
    title:'Le Proc√®s du Couloir Nord',
    meta:'Justice ¬∑ Harc√®lement institutionnel ¬∑ Ce qu\'un t√©moin peut changer',
    xpRequired:3000,
    desc:'Un √©l√®ve est accus√© √† tort. Les preuves ont disparu. Et le seul t√©moin fiable, c\'est R√©na ‚Äî qu\'on a d√©cid√©, ce matin-l√†, de ne pas √©couter.'
  },
  {
    id:'ch08', file:'roman_ch08.html', num:'Chapitre VIII', icon:'üèÜ',
    title:'La Joute des Savoirs',
    meta:'Coop√©ration ¬∑ Leadership partag√© ¬∑ Qui m√©rite la victoire',
    xpRequired:3500,
    desc:'Le grand tournoi annuel. Deux √©quipes, une seule victoire possible. Lyam et R√©na doivent choisir : jouer s√©par√©ment, ou tout miser sur l\'autre.'
  },
  {
    id:'ch09', file:'roman_ch09.html', num:'Chapitre IX', icon:'üíî',
    title:'Les Serments que l\'on Tient',
    meta:'Trahison ¬∑ R√©silience ¬∑ Est-ce qu\'on peut pardonner √† quelqu\'un qu\'on admirait ?',
    xpRequired:4000,
    desc:'Le mentor de Lyam a menti. Pas un petit mensonge. Un grand, qui a eu des cons√©quences sur des gens r√©els. Que fait-on avec √ßa ?'
  },
  {
    id:'ch10', file:'roman_ch10.html', num:'Chapitre X', icon:'‚≠ê',
    title:'L\'Ordre des Veilleurs',
    meta:'√âpilogue ouvert ¬∑ Ce que l\'on choisit de devenir',
    xpRequired:4500,
    desc:'Fin de premi√®re ann√©e. Lyam re√ßoit un message, scell√© d\'un signe qu\'il ne reconna√Æt pas. Et R√©na dit : ¬´ Je sais ce que c\'est. Et tu vas dire non. ¬ª'
  },
];

// ‚îÄ‚îÄ CATALOGUE DES LDVELH ‚îÄ‚îÄ
var LDVELH = [
  {
    id:'ldv_phare', file:'font_ldv_passages.html', icon:'üóùÔ∏è',
    label:'LDVELH ¬∑ Fontainebleau',
    title:'Les Couloirs de l\'Ombre',
    desc:'Lyam d√©couvre une porte cach√©e derri√®re une tapisserie. Passages secrets, histoires oubli√©es ‚Äî et une question : laquelle des deux histoires du ch√¢teau est vraie ?',
    unlockCondition:'Visite le Ch√¢teau de Fontainebleau',
    unlockKey:'font_ldv',
    unlockPillar:null,
    badge:'Historien des Ombres',
    color:'#5a3a6a'
  },
  {
    id:'ldv_fraternite', file:'ldv_fraternite_01.html', icon:'ü§ù',
    label:'LDVELH ¬∑ Fraternit√©',
    title:'Le Serment de la Forge',
    desc:'R√©na est accus√©e par un groupe d\'√©l√®ves nobles de tricher. Lyam sait qu\'elle n\'a pas trich√©. Mais parler, c\'est choisir son camp ‚Äî pour toujours.',
    unlockCondition:'Compl√®te un module Fraternit√©',
    unlockKey:'ldv_fraternite',
    unlockPillar:'fraternite',
    badge:'T√©moin Courageux',
    color:'#6a2a2a'
  },
  {
    id:'ldv_egalite', file:'ldv_egalite_01.html', icon:'‚öñÔ∏è',
    label:'LDVELH ¬∑ √âgalit√©',
    title:'Les Deux Visages du Tournoi',
    desc:'La r√®gle dit que les filles ne peuvent pas participer au Tournoi des Lames. R√©na veut y aller quand m√™me. Lyam doit d√©cider s\'il l\'aide ‚Äî et comment.',
    unlockCondition:'Compl√®te un module √âgalit√©',
    unlockKey:'ldv_egalite',
    unlockPillar:'egalite',
    badge:'Alli√© de l\'√âgale',
    color:'#2a4a6a'
  },
  {
    id:'ldv_pHARe', file:'ldv_phare_01.html', icon:'üõ°Ô∏è',
    label:'LDVELH ¬∑ pHARe',
    title:'Le Silence du Dortoir',
    desc:'Depuis trois semaines, un √©l√®ve mange seul. Personne ne lui parle. Personne ne lui fait rien. Mais Lyam sait que le silence, √ßa fait aussi mal que les coups.',
    unlockCondition:'Compl√®te un module pHARe',
    unlockKey:'ldv_pHARe',
    unlockPillar:'phare',
    badge:'Sentinelle Silencieuse',
    color:'#2a5a3a'
  },
];

function getDoneChapters(){var d=getDone();var count=0;CHAPITRES.forEach(function(c){if(d[c.id])count++});return count}

function renderChapitres(p){
  var xp=xg(p||{});
  var done=getDone();
  var list=document.getElementById('listChapitres');
  list.innerHTML='';

  CHAPITRES.forEach(function(ch){
    var unlocked=xp>=ch.xpRequired;
    var isDone=!!done[ch.id];
    var div=document.createElement('div');
    div.className='chapter'+(unlocked?' unlocked':'  locked')+(isDone?' done':'');
    div.style.setProperty('--ca', ch.color||'var(--or)');
    var rightContent='';
    if(unlocked){
      rightContent='<span class="cta-read">'+(isDone?'Relire':'Lire')+'</span>';
    } else {
      rightContent='<span class="lock-icon">üîí</span>';
    }
    var xpLabel=ch.xpRequired===0?'Gratuit':(ch.xpRequired+' XP requis');
    div.innerHTML=
      '<div class="chnum">'+ch.num+'<br/><span style="font-size:1.4em">'+ch.icon+'</span></div>'+
      '<div><div class="chtitle">'+ch.title+'</div><div class="chmeta">'+ch.meta+'</div></div>'+
      '<div style="text-align:right"><div class="chxp">'+xpLabel+'</div>'+rightContent+'</div>';
    if(unlocked&&ch.file){
      div.onclick=function(f){return function(){window.location.href=f}}(ch.file);
    }
    list.appendChild(div);
  });
}

function renderLDV(p){
  var done=getDone();
  var S=getS();
  var cp=(p&&p.cp)||{};
  var grid=document.getElementById('gridLDV');
  grid.innerHTML='';

  LDVELH.forEach(function(l){
    // V√©rifier si d√©bloqu√© selon le pilier
    var unlocked=false;
    if(!l.unlockPillar){
      // D√©bloqu√© selon les salles Fontainebleau visit√©es
      unlocked=true; // on rend disponible par d√©faut pour l'instant
    } else if(l.unlockPillar==='fraternite'){
      unlocked=Number(cp.autres||0)>0;
    } else if(l.unlockPillar==='egalite'){
      unlocked=Number(cp.autres||0)>0;
    } else if(l.unlockPillar==='phare'){
      unlocked=Number(cp.pixhare||0)>0;
    }
    var isDone=!!done[l.id];
    var card=document.createElement('div');
    card.className='ldv-card'+(unlocked?' unlocked':'  locked');
    card.style.setProperty('--ca', l.color||'var(--or)');
    card.innerHTML=
      '<span class="ldv-icon">'+l.icon+'</span>'+
      '<div class="ldv-label">'+l.label+'</div>'+
      (isDone?'<div class="ldv-badge">‚úì Termin√©</div>':'')+
      '<div class="ldv-title">'+l.title+'</div>'+
      '<div class="ldv-desc">'+l.desc+'</div>'+
      (unlocked?'<span style="font-size:.7em;color:var(--or);opacity:.8;font-family:Cinzel,serif;letter-spacing:1px">'+(isDone?'Rejouer':'Commencer l\'aventure')+'</span>':
        '<div class="ldv-unlock">üîí '+l.unlockCondition+'</div>');
    if(unlocked&&l.file){
      card.onclick=function(f){return function(){window.location.href=f}}(l.file);
    }
    grid.appendChild(card);
  });
}

function renderProgress(p){
  var xp=xg(p||{});
  var done=getDone();
  var chapDone=CHAPITRES.filter(function(c){return done[c.id]}).length;
  var pct=Math.min(100,Math.round((chapDone/CHAPITRES.length)*100));
  var fill=document.getElementById('progFill');
  var label=document.getElementById('progLabel');
  var xpLabel=document.getElementById('progXp');
  if(fill)fill.style.width=pct+'%';
  var nextLocked=CHAPITRES.find(function(c){return xp<c.xpRequired&&!done[c.id]});
  if(label){
    if(chapDone===CHAPITRES.length)label.textContent='Roman termin√© ! ‚≠ê';
    else if(nextLocked)label.textContent='Prochain chapitre √† '+nextLocked.xpRequired+' XP : '+nextLocked.title;
    else label.textContent=chapDone+' chapitre'+(chapDone>1?'s':'')+' lu'+(chapDone>1?'s':'');
  }
  if(xpLabel)xpLabel.textContent=xp+' / 4500 XP';
}

(function(){
  var raw=localStorage.getItem(AKEY)||'';
  if(!raw){window.location.href='index.html';return}
  cur=raw.trim().toUpperCase();
  var p=getP(cur);
  if(!p){window.location.href='index.html';return}
  var xp=xg(p);
  var nomEl=document.getElementById('nomJ');
  var xpEl=document.getElementById('xpJ');
  if(nomEl)nomEl.textContent=cur;
  if(xpEl)xpEl.textContent=xp;
  renderChapitres(p);
  renderLDV(p);
  renderProgress(p);
})();
</script>
</body>
</html>
