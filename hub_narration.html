<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BibliothÃ¨que de Valdurne â€” L'Ordre des Ã‰cuyers</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{--or:#c9a84c;--or-clair:#e8c97a;--encre:#e8dfc8;--encre-2:#c8bfa8;--parch:#120e0a;--parch-2:#1e1710;--radius:8px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--parch);color:var(--encre);font-family:'Crimson Text',Georgia,serif;font-size:1.05em;line-height:1.75;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 60% 40% at 20% 20%,rgba(139,42,42,.06) 0%,transparent 60%),radial-gradient(ellipse 50% 60% at 80% 80%,rgba(42,42,139,.06) 0%,transparent 60%)}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--parch)}::-webkit-scrollbar-thumb{background:rgba(201,168,76,.3);border-radius:3px}
@keyframes ni-in{from{opacity:0;top:0}to{opacity:1;top:20px}}
@keyframes ni-out{from{opacity:1}to{opacity:0}}

/* HEADER */
.hub-header{position:relative;z-index:1;padding:36px 24px 0;max-width:1100px;margin:0 auto}
.hub-tag{font-family:'Cinzel',serif;font-size:.63em;letter-spacing:5px;color:var(--or);opacity:.7;text-transform:uppercase;margin-bottom:10px}
.hub-title{font-family:'Cinzel',serif;font-size:clamp(1.8em,5vw,2.8em);font-weight:700;color:var(--or-clair);text-shadow:0 0 40px rgba(201,168,76,.3);line-height:1.2;margin-bottom:6px}
.hub-sub{font-style:italic;color:var(--encre-2);opacity:.7;margin-bottom:20px}
.player-bar{display:flex;align-items:center;gap:14px;flex-wrap:wrap;padding:10px 14px;background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.15);border-radius:6px;margin-bottom:28px;font-size:.82em}
.pb-item{color:var(--encre-2)}.pb-val{color:var(--or-clair);font-weight:600;margin-left:4px}
.pb-sep{color:rgba(201,168,76,.3)}
.btn-home{margin-left:auto;padding:5px 14px;background:transparent;border:1px solid rgba(201,168,76,.25);border-radius:4px;color:var(--encre-2);font-size:.82em;cursor:pointer;text-decoration:none;display:inline-block;transition:all .2s}
.btn-home:hover{border-color:var(--or);color:var(--or)}

/* LIBRARY */
.library{max-width:1100px;margin:0 auto;padding:0 24px 60px;position:relative;z-index:1}
.pillar-section{margin-bottom:36px}
.pillar-label{font-family:'Cinzel',serif;font-size:.7em;letter-spacing:4px;color:var(--or);text-transform:uppercase;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid rgba(201,168,76,.2);display:flex;align-items:center;gap:10px}
.pillar-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(201,168,76,.2),transparent)}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}

/* CARTE */
.story-card{background:var(--parch-2);border:1px solid rgba(201,168,76,.2);border-radius:var(--radius);padding:20px;transition:transform .2s,border-color .2s,box-shadow .2s;position:relative;overflow:hidden;cursor:default}
.story-card.unlocked{cursor:pointer}
.story-card.unlocked:hover{transform:translateY(-3px);border-color:rgba(201,168,76,.5);box-shadow:0 8px 30px rgba(0,0,0,.4),0 0 12px rgba(201,168,76,.15)}
.story-card.locked{opacity:.5;filter:grayscale(.4)}
.story-card.completed::after{content:'âœ“';position:absolute;top:12px;right:12px;color:var(--or);opacity:.7;font-size:.75em}
.story-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--card-accent,var(--or)),transparent)}
.sc-icon{font-size:1.8em;margin-bottom:10px;display:block}
.sc-title{font-family:'Cinzel',serif;font-size:.9em;font-weight:600;color:var(--or-clair);line-height:1.3;margin-bottom:4px}
.sc-meta{font-size:.72em;color:var(--encre-2);opacity:.65;margin-bottom:10px}
.sc-excerpt{font-style:italic;font-size:.82em;color:var(--encre-2);line-height:1.65;border-left:2px solid rgba(201,168,76,.2);padding-left:10px;margin-bottom:14px}
.sc-locked-hint{font-size:.75em;color:#888;font-style:italic;margin-bottom:12px}
.sc-footer{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.sc-badge{font-size:.7em;color:var(--or);opacity:.8}
.sc-cta{display:inline-block;padding:5px 14px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.4);border-radius:4px;color:var(--or-clair);font-size:.75em;letter-spacing:1px;transition:background .2s}
.sc-cta:hover{background:rgba(201,168,76,.25)}
.event-ribbon{position:absolute;top:12px;right:12px;background:linear-gradient(135deg,#7a2020,#3a0a5a);border:1px solid var(--or);border-radius:3px;padding:2px 8px;font-size:.65em;color:var(--or-clair);letter-spacing:1px;font-family:'Cinzel',serif}

/* MODALE LDVELH / LECTURE */
#ldvelhModal{position:fixed;inset:0;z-index:9500;background:rgba(10,8,5,.97);display:none;flex-direction:column;overflow-y:auto}
#ldvelhModal.open{display:flex}
.ldvelh-header{padding:20px 24px 0;max-width:740px;margin:0 auto;width:100%;display:flex;align-items:center;gap:16px}
.ldvelh-close{margin-left:auto;padding:7px 16px;background:transparent;border:1px solid rgba(201,168,76,.3);border-radius:4px;color:var(--encre-2);cursor:pointer;font-size:.8em;transition:all .2s;flex-shrink:0}
.ldvelh-close:hover{border-color:var(--or);color:var(--or)}
.ldvelh-chapter-name{font-family:'Cinzel',serif;font-size:.8em;color:var(--or);letter-spacing:2px;opacity:.8}
.ldvelh-body{max-width:740px;margin:0 auto;padding:32px 24px 60px;width:100%;flex:1}
.ldv-progress{display:flex;gap:4px;margin-bottom:28px;align-items:center}
.ldv-step{height:3px;flex:1;border-radius:2px;background:rgba(201,168,76,.15);transition:background .3s}
.ldv-step.done{background:rgba(201,168,76,.7)}.ldv-step.current{background:var(--or)}
.passage{display:none;animation:p-in .4s ease}.passage.active{display:block}
@keyframes p-in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.passage-num{font-family:'Cinzel',serif;font-size:.65em;letter-spacing:3px;color:var(--or);opacity:.5;margin-bottom:20px}
.passage-text{font-size:1.1em;line-height:1.9;margin-bottom:28px}
.passage-text p{margin-bottom:1.2em;text-align:justify}
.passage-text em{font-style:italic;color:var(--encre-2)}
.passage-mood{text-align:center;font-size:3em;margin:20px 0;filter:drop-shadow(0 0 16px rgba(201,168,76,.4))}
.passage-divider{border:none;border-top:1px solid rgba(201,168,76,.15);margin:20px 0}
.choices{display:flex;flex-direction:column;gap:10px;margin-top:24px}
.choice-btn{width:100%;padding:14px 18px;text-align:left;background:rgba(201,168,76,.05);border:1px solid rgba(201,168,76,.25);border-radius:6px;color:var(--encre);font-family:'Crimson Text',serif;font-size:1em;line-height:1.5;cursor:pointer;transition:all .2s}
.choice-btn::before{content:'â–¸ ';color:var(--or);opacity:.6}
.choice-btn:hover{background:rgba(201,168,76,.12);border-color:rgba(201,168,76,.5);color:var(--or-clair);transform:translateX(4px)}
.result-block{margin-top:24px;padding:24px;border-radius:8px;text-align:center}
.result-block.success{background:linear-gradient(135deg,rgba(26,58,26,.6),rgba(42,74,26,.4));border:1px solid rgba(100,180,100,.4)}
.result-block.failure{background:linear-gradient(135deg,rgba(58,26,26,.6),rgba(74,42,26,.4));border:1px solid rgba(180,80,80,.4)}
.result-icon{font-size:2.5em;margin-bottom:12px;display:block}
.result-title{font-family:'Cinzel',serif;font-size:1em;margin-bottom:8px;letter-spacing:1px}
.result-block.success .result-title{color:#8fe888}.result-block.failure .result-title{color:#e88888}
.result-xp{font-size:1.2em;font-weight:600;margin:10px 0}
.result-block.success .result-xp{color:#b8e8b8}.result-block.failure .result-xp{color:#e8b8b8}
.result-text{font-size:.88em;color:var(--encre-2);line-height:1.6;margin-bottom:16px}
.btn-retry,.btn-close-result{padding:10px 24px;border-radius:4px;cursor:pointer;font-size:.8em;transition:all .2s;margin-right:6px}
.btn-retry{background:rgba(201,168,76,.1);border:1px solid var(--or);color:var(--or-clair);font-family:'Cinzel',serif;letter-spacing:1px}
.btn-retry:hover{background:rgba(201,168,76,.25)}
.btn-close-result{background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--encre-2)}
.btn-close-result:hover{border-color:rgba(255,255,255,.4)}

@media(max-width:600px){.hub-header,.library{padding-left:14px;padding-right:14px}.ldvelh-body{padding:20px 14px 40px}}
</style>
</head>
<body>

<div id="hubMain" style="display:none">
  <div class="hub-header">
    <div class="hub-tag">ChÃ¢teau-Ã‰cole de Valdurne Â· Saison I</div>
    <h1 class="hub-title">BibliothÃ¨que de Valdurne</h1>
    <p class="hub-sub">L'Ordre des Ã‰cuyers â€” Une bibliothÃ¨que qui grandit avec toi.</p>
    <div class="player-bar">
      <span class="pb-item">Ã‰cuyer : <span class="pb-val" id="playerName">â€”</span></span>
      <span class="pb-sep">Â·</span>
      <span class="pb-item">XP : <span class="pb-val" id="playerXP">0</span></span>
      <span class="pb-sep">Â·</span>
      <span class="pb-item">Chapitres lus : <span class="pb-val" id="chaptersRead">0</span></span>
      <a class="btn-home" href="index.html">â† Portail Vie Scolaire</a>
    </div>
  </div>

  <div class="library">
    <div class="pillar-section">
      <div class="pillar-label">ğŸ“š Histoire Principale â€” La PremiÃ¨re AnnÃ©e</div>
      <div class="cards-grid" id="mainStoryGrid"></div>
    </div>
    <div class="pillar-section">
      <div class="pillar-label">âš”ï¸ SÃ©quences de Valdurne â€” Tu es le hÃ©ros</div>
      <div class="cards-grid" id="satelliteGrid"></div>
    </div>
    <div class="pillar-section">
      <div class="pillar-label">ğŸŒ€ ExpÃ©ditions au-delÃ  du Portail</div>
      <div class="cards-grid" id="expeditionGrid"></div>
    </div>
  </div>
</div>

<!-- MODALE LDVELH -->
<div id="ldvelhModal" role="dialog" aria-modal="true">
  <div class="ldvelh-header">
    <span class="ldvelh-chapter-name" id="ldvelhTitle">SÃ©quence de Valdurne</span>
    <button class="ldvelh-close" onclick="closeLdvelh()">âœ• Fermer</button>
  </div>
  <div class="ldvelh-body">
    <div class="ldv-progress" id="ldvelhProgress"></div>
    <div id="ldvelhContent"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & UTILS â€” rÃ©plique exacte du superhub, PAS DE RE-AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KEY               = 'pvs_hof_v2';
const ACTIVE_PLAYER_KEY = 'pvs_current_player';
const XP_PENDING_KEY    = 'pvs_narration_xp';
const NARRATION_DONE    = 'pvs_narration_done';
const VISITOR_CODE      = 'VISITEUR-VIESCOLAIRE-CHATEAURANCE';
const XP_BON_CHOIX      = 50;
const XP_MAUVAIS_CHOIX  = -25;

const W   = {pixhare:60,psc1:60,sanctuaire:60,loge:60,autres:60};
const CIT = {representant_ca:{xp:500}};

function nCode(v){return String(v||'').trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'')}
function getS(){try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch{return{}}}
function saveS(S){try{localStorage.setItem(KEY,JSON.stringify(S))}catch(e){}}
function getPlayer(c){const S=getS();return S.players&&S.players[c]?S.players[c]:null}

// RÃ©plique EXACTE de xg() superhub
function missionXp(code){const S=getS();const lists=S.citizen_lists||{};let n=0;Object.keys(CIT).forEach(k=>{if((lists[k]||[]).includes(code))n+=CIT[k].xp});return n}
function socialRawG(p){return Number(p.socialG||0)+Number(p.wBonusG||0)}
function socialValidG(p){return Number(p.witnessGiven||0)>0?socialRawG(p):0}
function citizenXp(p){return missionXp(p.code)+socialValidG(p)}
function academyXp(p){const cp=p.cp||{};return Object.keys(W).reduce((a,k)=>a+Number(cp[k]||0)*W[k],0)}
function videoXp(p){return Number(p.videoG||0)}
function acadCoeff(p){const n=Math.min(Number(p.acadDone||0),50);return Math.round((1+n*0.02)*100)/100}
function xg(p){if(!p)return 0;const base=citizenXp(p)+academyXp(p)+videoXp(p)+Number(p.malusG||0);return Math.round(base*acadCoeff(p))}

function getDone(){try{return JSON.parse(localStorage.getItem(NARRATION_DONE)||'{}')}catch{return{}}}
function markDone(id){const d=getDone();d[id]=1;localStorage.setItem(NARRATION_DONE,JSON.stringify(d))}
function isDone(id){return !!getDone()[id]}

function creditXP(code,amount,reason){
  if(!code)return;
  const S=getS();if(!S.players||!S.players[code])return;
  const p=S.players[code];const now=new Date().toISOString();
  if(!Array.isArray(S.logs))S.logs=[];
  S.logs.unshift({d:now,p:code,t:reason,target:'NARRATION',xp:Number(amount)});
  if(S.logs.length>700)S.logs.length=700;
  if(amount>0){p.wBonusG=(Number(p.wBonusG||0)+(amount/10));p.wBonusW=(Number(p.wBonusW||0)+(amount/10))}
  else{p.malusG=(Number(p.malusG||0)+amount);p.malusW=(Number(p.malusW||0)+amount)}
  p.up=now;saveS(S);
  const pending=JSON.parse(localStorage.getItem(XP_PENDING_KEY)||'[]');
  pending.push({code,amount,reason,d:now});
  localStorage.setItem(XP_PENDING_KEY,JSON.stringify(pending));
}

function showXpNotif(amount){
  const d=document.createElement('div');
  d.className='xp-notif';
  d.style.cssText='position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;padding:11px 26px;border-radius:8px;font-weight:600;font-size:.92em;text-align:center;pointer-events:none';
  if(amount>0){d.style.background='linear-gradient(135deg,#1a3a1a,#2a4a1a)';d.style.border='1px solid rgba(100,200,100,.5)';d.style.color='#b8e8b8';d.textContent='+'+amount+' XP â€” Bien jouÃ© !'}
  else{d.style.background='linear-gradient(135deg,#3a1a1a,#4a1a1a)';d.style.border='1px solid rgba(200,80,80,.5)';d.style.color='#e8b8b8';d.textContent=amount+' XP â€” Retente !'}
  document.body.appendChild(d);setTimeout(()=>d.remove(),5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” Lit le joueur depuis superhub, PAS DE RE-AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var cur='';

(function(){
  const raw=localStorage.getItem(ACTIVE_PLAYER_KEY)||'';
  if(!raw){ window.location.href='index.html'; return; }
  cur=nCode(raw);
  const p=getPlayer(cur)||(nCode(raw)===nCode(VISITOR_CODE)?{code:cur,cp:{},socialG:0,wBonusG:0,videoG:0,malusG:0,acadDone:0,witnessGiven:1}:null);
  if(!p){ window.location.href='index.html'; return; }
  document.getElementById('hubMain').style.display='block';
  renderHub(p);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONNÃ‰ES â€” CHAPITRES & SATELLITES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var MAIN_CHAPTERS=[
  {id:'main_prologue',icon:'ğŸ°',title:'Prologue â€” L\'ArrivÃ©e',meta:'DÃ©bloquÃ© dÃ¨s le dÃ©but',excerpt:'Lyam arrive au ChÃ¢teau-Ã‰cole de Valdurne. Il ne connaÃ®t personne. Dans la grande salle bruissante, un autre Ã©cuyer lui sourit depuis un coin.',badge:null,minXP:0,text:["La grande salle de Valdurne sentait la cire et la pierre ancienne.","Lyam posa son sac contre le mur du fond â€” le plus loin possible de tous les autres â€” et regarda. Des dizaines d'Ã©cuyers de premiÃ¨re annÃ©e, certains avec des familles qui les embrassaient, d'autres qui riaient dÃ©jÃ  en petits groupes constituÃ©s avant mÃªme d'Ãªtre arrivÃ©s. Il ne reconnaissait personne.","Il ne savait pas encore que c'Ã©tait Ã§a, le vrai enseignement de Valdurne. Pas les cours de stratÃ©gie ou les exercices au champ. L'apprentissage de <em>comment Ãªtre avec les autres</em> quand personne ne te connaÃ®t encore.","Un Ã©cuyer dans le coin opposÃ© leva les yeux de son livre et lui fit un signe de tÃªte. Juste Ã§a â€” un signe de tÃªte. Mais dans ce moment prÃ©cis, dans cette salle trop grande et trop bruyante, Ã§a avait suffi.","Son nom Ã©tait RÃ©na. Ce serait son premier alliÃ©. Peut-Ãªtre le plus important de tous."],endNote:'La premiÃ¨re annÃ©e commence. D\'autres chapitres s\'ouvriront Ã  mesure que tu progresseras dans le Portail.'},
  {id:'main_ch1',icon:'âš”ï¸',title:'Chapitre I â€” Le TÃ©moin',meta:'DÃ©bloquÃ© Ã  100 XP',excerpt:'Lyam voit RÃ©na cernÃ© par trois Ã©cuyers. Tout le monde dÃ©tourne les yeux. Il a deux chemins devant lui.',badge:null,minXP:100,text:["Ã‡a s'est passÃ© un mercredi, aprÃ¨s l'entraÃ®nement aux cartes.","Lyam avait pris le couloir du bas â€” plus court, moins frÃ©quentÃ©. C'est lÃ  qu'il les avait vus : trois Ã©cuyers de deuxiÃ¨me annÃ©e encerclant RÃ©na contre le mur de pierre. Ils ne le frappaient pas. Ils faisaient pire : ils lui parlaient Ã  voix basse, avec ce ton particulier qui n'est pas de la violence mais qui lui ressemble trait pour trait.","RÃ©na regardait le sol. Il y avait une honte dans ses Ã©paules que Lyam reconnut immÃ©diatement â€” il l'avait portÃ©e lui-mÃªme, Ã  l'Ã©cole d'avant.","Il s'arrÃªta. Personne d'autre dans le couloir. Les trois Ã©cuyers ne l'avaient pas encore vu. Il pouvait passer par le couloir du haut, prendre dix minutes de plus, et ne jamais avoir Ã  dÃ©cider quoi que ce soit.","Il ne prit pas le couloir du haut.","Il s'avanÃ§a, pas sÃ»r de lui du tout, et dit simplement Ã  haute voix : <em>Â« HÃ©, RÃ©na. MaÃ®tre Aldric te cherchait. Â»</em> C'Ã©tait faux. Mais dans la seconde qui suivit, les trois Ã©cuyers s'Ã©cartÃ¨rent, et RÃ©na put s'en aller.","Plus tard, Lyam se demanda si c'Ã©tait du courage. Il conclut que non â€” il n'avait pas eu le temps d'avoir peur. C'Ã©tait juste une dÃ©cision. Rapide. Ordinaire. Comme en prendre des centaines d'autres chaque jour, sauf que celle-lÃ  comptait vraiment."],endNote:'ÃŠtre tÃ©moin, c\'est dÃ©jÃ  agir. La suite au Chapitre II â€” dÃ©bloquÃ© Ã  300 XP.'},
  {id:'main_ch2',icon:'ğŸ“œ',title:'Chapitre II â€” La RÃ¨gle du ChÃ¢teau',meta:'DÃ©bloquÃ© Ã  300 XP',excerpt:'Un conflit Ã©clate entre deux maisons. Les rÃ¨gles de Valdurne sont floues, et certains le savent trÃ¨s bien.',badge:null,minXP:300,text:["La dispute entre la Maison Argent et la Maison Bois avait commencÃ© pour une raison idiote â€” un banc dans le rÃ©fectoire â€” et avait escaladÃ© jusqu'Ã  devenir un incident officiel.","Le Doyen Ferraud convoqua les deux maisons dans la grande salle. Lyam observait depuis le fond. Ce qui le frappa, ce n'Ã©tait pas la dispute. C'Ã©tait comment certains Ã©cuyers â€” les plus anciens, ceux qui connaissaient le Codex â€” manipulaient les rÃ¨gles avec une prÃ©cision chirurgicale. Ils ne mentaient pas. Ils choisissaient quelles rÃ¨gles citer, et lesquelles oublier.","<em>Â« Comprendre les rÃ¨gles, c'est du pouvoir Â»</em>, lui dit RÃ©na Ã  voix basse. <em>Â« Mais les utiliser pour Ã©craser les autres, c'est de la lÃ¢chetÃ©. Â»</em>","Ce soir-lÃ , Lyam emprunta le Codex Ã  la bibliothÃ¨que pour la premiÃ¨re fois. Pas pour gagner. Pour comprendre.","Il y passa la nuit. Le lendemain matin, il savait exactement quels articles la Maison Argent avait omis de mentionner. Il ne le dit pas Ã  voix haute â€” ce n'Ã©tait pas Ã  lui de trancher. Mais il le nota, soigneusement, et le remit au Doyen sans son nom dessus.","Ferraud le regarda par-dessus ses lunettes. Il savait trÃ¨s bien d'oÃ¹ venait le parchemin. Il ne dit rien. Mais le lendemain, le jugement fut juste."],endNote:'La connaissance des rÃ¨gles protÃ¨ge. La suite â€” Chapitre III â€” Ã  500 XP.'},
  {id:'main_ch3_base',icon:'âš–ï¸',title:'Chapitre III â€” L\'Ã‰gale',meta:'DÃ©bloquÃ© Ã  500 XP',excerpt:'Kira n\'a pas le droit d\'accÃ©der Ã  la Forge Haute. Lyam se retrouve face Ã  un choix entre tradition et justice.',badge:"âš–ï¸ L'Ã‰cu d'Ã‰gale",minXP:500,isEvent:true,text:["La forge haute se trouvait au sommet de la tour sud, lÃ  oÃ¹ la fumÃ©e rejoignait les nuages bas de fÃ©vrier.","Lyam y montait chaque jeudi. Ce jeudi-lÃ , dans l'escalier Ã©troit, il croisa Kira. Elle descendait. Lui montait. Elle portait des parchemins de formules d'enchantement avancÃ©es â€” le genre que les Ã©cuyers de troisiÃ¨me annÃ©e effleuraient Ã  peine.","<em>Â« Tu n'es pas supposÃ©e monter. La Forge Haute est rÃ©servÃ©e aux Ã©cuyers du parcours forge. Â»</em>","Elle le regarda avec quelque chose de plus calme et de plus lourd que la colÃ¨re. La patience prÃ©cise de quelqu'un qui a dÃ©jÃ  cartographiÃ© tous les murs avant de chercher la porte.","<em>Â« Je sais. On me l'a dÃ©jÃ  dit. Â»</em>","Elle continua de descendre. Lui continua de monter. Il ne put pas travailler.","Il pensa Ã  son <em>\"je sais\"</em>. Pas rÃ©signation â€” prÃ©cision tranquille. Il redescendit, trouva MaÃ®tre Aldric, et posa la question directement. <em>Â« Cette rÃ¨gle. Elle est Ã©crite oÃ¹ ? Â»</em>","<em>Â« Nulle part. Â»</em>","<em>Â« Alors elle peut changer ? Â»</em>","<em>Â« Tout peut changer, Lyam. La question, c'est qui dÃ©cide de le faire. Â»</em>","La semaine suivante, Kira monta Ã  la Forge Haute pour la premiÃ¨re fois. Elle ne dit rien Ã  Lyam. Ce n'Ã©tait pas Ã  lui qu'elle devait quelque chose.","Mais dans la cour, elle lui lanÃ§a ses parchemins de formules. <em>Â« Tu en auras besoin. Â»</em> â€” <em>Â« J'en suis pas sÃ»r. Â»</em> â€” <em>Â« Moi si. Â»</em>"],endNote:"L'Ã©galitÃ© ne se dÃ©clare pas. Elle se construit, un acte ordinaire Ã  la fois."},
  {id:'main_ch4',icon:'ğŸ¥',title:'Chapitre IV â€” Le Secours en Danger',meta:'DÃ©bloquÃ© Ã  800 XP',excerpt:'Un accident au terrain d\'entraÃ®nement. Lyam seul sait ce qu\'il faut faire.',badge:null,minXP:800,comingSoon:true},
  {id:'main_ch5',icon:'ğŸŒŸ',title:'Chapitre V â€” La FraternitÃ© des Ã‰cus',meta:'DÃ©bloquÃ© Ã  1200 XP',excerpt:'Fin de premiÃ¨re annÃ©e. Le chÃ¢teau n\'a pas changÃ©. C\'est Lyam qui a changÃ©.',badge:'ğŸŒŸ Chevalier Complet',minXP:1200,comingSoon:true},
];

var SATELLITES=[
  {id:'sat_egalite',icon:'âš–ï¸',title:"L'Ã‰preuve de la Forge",pilier:'Module Ã‰galitÃ©',unlock:'EGALITE',accent:'#7a3a9a',isEvent:true,excerpt:'Tu es Lyam. Kira vient d\'Ãªtre refoulÃ©e de la Forge Haute. Tu as assistÃ© Ã  la scÃ¨ne. Que fais-tu maintenant ?',badge:"âš–ï¸ L'Ã‰cu d'Ã‰gale",ldvelhId:'egalite'},
  {id:'sat_pixhare',icon:'ğŸ›¡ï¸',title:'La Cour des Ombres',pilier:'Pilier Groupe â€” PIXHARe',unlock:'PIXHARE',accent:'#3a6a9a',excerpt:'RÃ©na est de nouveau la cible. Cette fois, c\'est plus subtil. Et cette fois, tu as des outils.',badge:'ğŸ›¡ï¸ Gardien du Groupe',ldvelhId:'pixhare',comingSoon:true},
  {id:'sat_psc1',icon:'ğŸ¥',title:'Le BlessÃ© du Tournoi',pilier:'Module PSC1',unlock:'PSC1',accent:'#9a3a3a',excerpt:'Le tournoi de printemps. Un Ã©cuyer tombe. Tu es le seul Ã  savoir quoi faire.',badge:'ğŸ¥ Gardien des Corps',ldvelhId:'psc1',comingSoon:true},
  {id:'sat_fraternite',icon:'ğŸ¤',title:'Le Banquet des Maisons',pilier:'Pilier FraternitÃ©',unlock:'FRATERNITE',accent:'#3a9a5a',excerpt:'Les Maisons Argent et Bois ont Ã©tÃ© convoquÃ©es pour un banquet de rÃ©conciliation.',badge:'ğŸ¤ Tisserand de Liens',ldvelhId:'fraternite',comingSoon:true},
  {id:'sat_liberte',icon:'ğŸ—½',title:'La PÃ©tition',pilier:'Hub LibertÃ©',unlock:'LIBERTE',accent:'#9a8a2a',excerpt:'Les Ã©cuyers de premiÃ¨re annÃ©e veulent changer une rÃ¨gle du chÃ¢teau.',badge:"ğŸ—½ Voix du Peuple",ldvelhId:'liberte',comingSoon:true},
  {id:'sat_delegues',icon:'ğŸ“£',title:'Le Conseil des Ã‰cuyers',pilier:'Hub DÃ©lÃ©guÃ©s',unlock:'DELEGUES',accent:'#5a7a3a',excerpt:'Lyam est Ã©lu reprÃ©sentant de sa maison. Son premier vrai conseil.',badge:'ğŸ“£ DÃ©lÃ©guÃ© de Valdurne',ldvelhId:'delegues',comingSoon:true},
];

var EXPEDITIONS=[
  {id:'exp_fontainebleau',icon:'ğŸ°',title:'ChÃ¢teau de Fontainebleau',subtitle:'Au-delÃ  du portail de la bibliothÃ¨que',accent:'#8a6a1f',excerpt:'Lyam et RÃ©na franchissent un portail dans un grimoire ancien. De l\'autre cÃ´tÃ© : un chÃ¢teau de huit siÃ¨cles, trente-quatre rois, et des visiteurs qui lÃ¨vent de petits rectangles brillants pour capturer les Ã¢mes des fresques.',file:'hub_fontainebleau.html',badge:'ğŸ—ï¸ Explorateur de Mondes'},
  {id:'exp_prochaine',icon:'ğŸŒ€',title:'Prochaine ExpÃ©dition',subtitle:'Destination inconnue',accent:'#3a3a5a',excerpt:'Le portail s\'allume parfois seul, la nuit. Personne ne sait encore oÃ¹ il mÃ¨ne. La bibliothÃ¨que garde ses secrets.',file:null,badge:null},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isUnlocked_sat(sat,p){
  if(!p)return false;
  const cp=p.cp||{};
  const S=getS();const logs=(S.logs||[]).filter(l=>l.p===cur);
  if(sat.unlock==='EGALITE')return (cp.autres||0)>=1||logs.some(l=>(l.t||'').includes('EGALITE'));
  if(sat.unlock==='PIXHARE')return (cp.pixhare||0)>=1;
  if(sat.unlock==='PSC1')return (cp.psc1||0)>=1;
  if(sat.unlock==='FRATERNITE')return logs.some(l=>(l.t||'').includes('FRATERNITE'));
  if(sat.unlock==='LIBERTE')return logs.some(l=>(l.t||'').includes('LIBERTE'));
  if(sat.unlock==='DELEGUES')return logs.some(l=>(l.t||'').includes('DELEGUES'));
  return false;
}

function renderHub(p){
  const xp=xg(p);
  document.getElementById('playerName').textContent=cur;
  document.getElementById('playerXP').textContent=xp;
  const done=getDone();
  document.getElementById('chaptersRead').textContent=Object.values(done).filter(v=>v).length;
  renderMainStory(p,xp);
  renderSatellites(p);
  renderExpeditions(p,xp);
}

function renderMainStory(p,xp){
  const grid=document.getElementById('mainStoryGrid');grid.innerHTML='';
  MAIN_CHAPTERS.forEach(ch=>{
    const unlocked=xp>=ch.minXP;const done=isDone(ch.id);
    const card=document.createElement('div');
    card.className='story-card'+(unlocked?' unlocked':'  locked')+(done?' completed':'');
    card.style.setProperty('--card-accent','#c9a84c');
    if(unlocked&&!ch.comingSoon){
      card.onclick=()=>openMainChapter(ch);
      card.innerHTML=`${ch.isEvent?'<div class="event-ribbon">âœ¨ Ã‰VÃ‰NEMENT</div>':''}<span class="sc-icon">${ch.icon}</span><div class="sc-title">${ch.title}</div><div class="sc-meta">${ch.meta}</div><div class="sc-excerpt">${ch.excerpt}</div><div class="sc-footer">${ch.badge?`<span class="sc-badge">${ch.badge}</span>`:'<span></span>'}<span class="sc-cta">${done?'Relire':'Lire â–¸'}</span></div>`;
    } else if(ch.comingSoon){
      card.innerHTML=`<span class="sc-icon">${ch.icon}</span><div class="sc-title">${ch.title}</div><div class="sc-meta">${ch.meta}</div><div class="sc-excerpt">${ch.excerpt}</div><div class="sc-footer"><span class="sc-locked-hint">ğŸ“… Ã€ venirâ€¦</span></div>`;
    } else {
      card.innerHTML=`<span class="sc-icon">ğŸ”’</span><div class="sc-title">${ch.title}</div><div class="sc-meta">${ch.meta}</div><div class="sc-locked-hint">Il te faut ${ch.minXP-xp} XP de plus.</div>`;
    }
    grid.appendChild(card);
  });
}

function renderSatellites(p){
  const grid=document.getElementById('satelliteGrid');grid.innerHTML='';
  SATELLITES.forEach(sat=>{
    const unlocked=isUnlocked_sat(sat,p);const done=isDone(sat.id);
    const card=document.createElement('div');
    card.className='story-card'+(unlocked?' unlocked':'  locked')+(done?' completed':'');
    card.style.setProperty('--card-accent',sat.accent||'#c9a84c');
    if(unlocked&&!sat.comingSoon){
      card.onclick=()=>openLdvelh(sat.ldvelhId,sat);
      card.innerHTML=`${sat.isEvent?'<div class="event-ribbon">ğŸ—“ï¸ Ã‰VÃ‰NEMENT</div>':''}<span class="sc-icon">${sat.icon}</span><div class="sc-title">${sat.title}</div><div class="sc-meta">${sat.pilier}</div><div class="sc-excerpt">${sat.excerpt}</div><div class="sc-footer">${sat.badge?`<span class="sc-badge">${sat.badge}</span>`:'<span></span>'}<span class="sc-cta">${done?'Rejouer':'â–¸ Incarner le hÃ©ros'}</span></div>`;
    } else if(sat.comingSoon&&unlocked){
      card.innerHTML=`<span class="sc-icon">${sat.icon}</span><div class="sc-title">${sat.title}</div><div class="sc-meta">${sat.pilier}</div><div class="sc-excerpt">${sat.excerpt}</div><div class="sc-footer"><span class="sc-locked-hint">ğŸ“… En cours de rÃ©dactionâ€¦</span></div>`;
    } else {
      card.innerHTML=`<span class="sc-icon">ğŸ”’</span><div class="sc-title">${sat.title}</div><div class="sc-meta">${sat.pilier}</div><div class="sc-locked-hint">ComplÃ¨te <strong>${sat.pilier}</strong> dans le Portail pour dÃ©bloquer.</div>`;
    }
    grid.appendChild(card);
  });
}

function renderExpeditions(p,xp){
  const grid=document.getElementById('expeditionGrid');grid.innerHTML='';
  EXPEDITIONS.forEach(exp=>{
    const unlocked=!!exp.file;const done=isDone(exp.id);
    const card=document.createElement('div');
    card.className='story-card'+(unlocked?' unlocked':'  locked')+(done?' completed':'');
    card.style.setProperty('--card-accent',exp.accent||'#c9a84c');
    if(unlocked){
      card.onclick=()=>{window.location.href=exp.file};
      card.innerHTML=`<span class="sc-icon">${exp.icon}</span><div class="sc-title">${exp.title}</div><div class="sc-meta">${exp.subtitle}</div><div class="sc-excerpt">${exp.excerpt}</div><div class="sc-footer">${exp.badge?`<span class="sc-badge">${exp.badge}</span>`:'<span></span>'}<span class="sc-cta">Franchir le portail â–¸</span></div>`;
    } else {
      card.innerHTML=`<span class="sc-icon">${exp.icon}</span><div class="sc-title">${exp.title}</div><div class="sc-meta">${exp.subtitle}</div><div class="sc-excerpt">${exp.excerpt}</div><div class="sc-footer"><span class="sc-locked-hint">ğŸ“… Ã€ venirâ€¦</span></div>`;
    }
    grid.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LECTURE CHAPITRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMainChapter(ch){
  const title=document.getElementById('ldvelhTitle');
  const content=document.getElementById('ldvelhContent');
  document.getElementById('ldvelhProgress').innerHTML='';
  title.textContent=ch.title;
  content.innerHTML=`<div class="passage active"><div class="passage-num">ğŸ“š Histoire Principale Â· Saison I</div><div class="passage-mood">${ch.icon}</div><div class="passage-text">${(ch.text||[]).map(t=>`<p>${t}</p>`).join('')}</div><hr class="passage-divider"><div style="font-style:italic;color:var(--encre-2);font-size:.85em;opacity:.75;text-align:center;margin-bottom:20px">${ch.endNote||''}</div>${ch.badge?`<div style="text-align:center;margin-bottom:16px"><span class="sc-badge" style="font-size:.9em">${ch.badge}</span></div>`:''}<div style="text-align:center"><button class="btn-close-result" onclick="closeLdvelh()">Fermer</button></div></div>`;
  document.getElementById('ldvelhModal').classList.add('open');
  markDone(ch.id);
  document.getElementById('chaptersRead').textContent=Object.values(getDone()).filter(v=>v).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOTEUR LDVELH Ã‰GALITÃ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeLdvelh(){document.getElementById('ldvelhModal').classList.remove('open')}

var SEQUENCES={
  egalite:{title:"L'Ã‰preuve de la Forge â€” SÃ©quence Ã‰galitÃ©",steps:6,start:'p1',passages:{
    p1:{num:'Â§ 1 Â· La rencontre',mood:'âš–ï¸',text:["Tu es Lyam. Apprenti Ã©cuyer de premiÃ¨re annÃ©e.","Ce matin, en traversant le couloir de la tour sud pour rejoindre ton cours de stratÃ©gie, tu assistes Ã  quelque chose.","La ChancelliÃ¨re Maren barre le chemin Ã  Kira â€” l'Ã©cuyÃ¨re que tout le monde sait Ãªtre la meilleure en formules d'enchantement â€” et lui dit froidement : <em>Â« La Forge Haute est rÃ©servÃ©e aux parcours forge. Ce n'est pas ton chemin. Â»</em>","Kira ne discute pas. Elle hoche la tÃªte et repart. Mais tu as vu son visage une fraction de seconde avant â€” la faÃ§on dont elle a rangÃ© quelque chose trÃ¨s loin Ã  l'intÃ©rieur d'elle-mÃªme.","La ChancelliÃ¨re s'en va. Tu es seul dans le couloir avec Kira."],choices:[{text:'Aller voir Kira et lui demander si elle va bien.',next:'p2a'},{text:'Continuer vers ton cours. Ce n\'est pas ton problÃ¨me.',next:'p2b'},{text:'Regarder discrÃ¨tement, sans intervenir.',next:'p2c'}]},
    p2a:{num:'Â§ 2 Â· Le contact',mood:'ğŸ¤',text:["Tu t'approches de Kira. Elle te regarde avec un calme que tu trouves difficile Ã  dÃ©chiffrer.","<em>Â« Je t'ai vu, Â»</em> dit-elle simplement. <em>Â« Tu n'avais pas Ã  t'arrÃªter. Â»</em>","<em>Â« Je sais. Â»</em>","Un silence. Puis elle te montre ses parchemins â€” des formules de niveau trois. Tu ne comprends pas la moitiÃ© des symboles.","<em>Â« C'est injuste, Â»</em> dis-tu. Ce n'est pas malin comme rÃ©ponse, mais c'est vrai.","<em>Â« Oui. Â»</em> Elle range ses parchemins. <em>Â« La question c'est ce qu'on fait avec une injustice qu'on a identifiÃ©e. Â»</em>"],choices:[{text:'Proposer Ã  Kira d\'aller voir Aldric avec elle.',next:'p3a'},{text:'Lui dire que tu poseras la question Ã  Aldric toi-mÃªme.',next:'p3b'},{text:'Lui suggÃ©rer de demander audience au Doyen directement.',next:'p3c'}]},
    p2b:{num:'Â§ 2 Â· L\'absence',mood:'ğŸ˜¶',text:["Tu continues vers ton cours. Ã€ la pause, RÃ©na lÃ¨ve les yeux de son parchemin : <em>Â« Kira ? La ChancelliÃ¨re lui interdit la Forge Haute depuis le dÃ©but de l'annÃ©e. Â»</em>","<em>Â« Et personne n'a rien dit ? Â»</em>","RÃ©na te regarde. <em>Â« Toi non plus tu n'as rien dit, apparemment. Â»</em>","Ce n'est pas une accusation. C'est juste la rÃ©alitÃ©. Tu as encore le temps d'agir."],choices:[{text:'Aller trouver Kira maintenant.',next:'p3b'},{text:'Parler Ã  MaÃ®tre Aldric directement.',next:'p3b'},{text:'Rester en dehors. Ce n\'est vraiment pas ton rÃ´le.',next:'p_mauvais_chemin'}]},
    p2c:{num:'Â§ 2 Â· L\'observateur',mood:'ğŸ‘ï¸',text:["Tu restes en retrait. Kira repart sans se retourner.","Dans l'aprÃ¨s-midi, tu apprends par RÃ©na que cette situation dure depuis le dÃ©but de l'annÃ©e. Tu as plusieurs options."],choices:[{text:'Aller parler Ã  Kira maintenant.',next:'p2a'},{text:'Aller voir MaÃ®tre Aldric directement.',next:'p3b'},{text:'Laisser faire.',next:'p_mauvais_chemin'}]},
    p3a:{num:'Â§ 3 Â· Le MaÃ®tre',mood:'ğŸ”¥',text:["Vous trouvez Aldric Ã  la Forge du bas. Kira explique. Aldric Ã©coute sans l'interrompre.","<em>Â« C'est une vieille rÃ¨gle, Â»</em> dit-il. <em>Â« Jamais Ã©crite nulle part. Â»</em>","<em>Â« Donc elle peut changer ? Â»</em> demandes-tu.","<em>Â« Tout peut changer. La question c'est qui dÃ©cide de le faire, et comment. Â»</em>","Kira prend un parchemin. Elle commence Ã  Ã©crire."],choices:[{text:'L\'aider Ã  rÃ©diger la demande, en cosignant.',next:'p4'},{text:'La laisser Ã©crire seule â€” c\'est son combat.',next:'p4_seul'}]},
    p3b:{num:'Â§ 3 Â· La dÃ©marche',mood:'ğŸ•¯ï¸',text:["Tu trouves MaÃ®tre Aldric et tu lui dis ce que tu as vu.","<em>Â« C'est une vieille rÃ¨gle. Elle n'a jamais Ã©tÃ© Ã©crite nulle part. Â»</em>","<em>Â« Alors elle peut changer ? Â»</em>","<em>Â« Tout peut changer, Lyam. Mais la demande doit venir de Kira â€” ou avec son accord. Â»</em>","Tu vas trouver Kira. Elle te regarde longtemps, puis : <em>Â« Bien. Je cosigne. Â»</em>"],choices:[{text:'RÃ©diger la demande ensemble.',next:'p4'}]},
    p3c:{num:'Â§ 3 Â· Le Doyen',mood:'ğŸ›ï¸',text:["Ferraud vous reÃ§oit. Il Ã©coute Kira, puis te regarde. <em>Â« Et toi, tu es lÃ  pourquoi ? Â»</em>","<em>Â« Parce que j'ai vu quelque chose d'injuste et que je ne pouvais pas juste passer mon chemin. Â»</em>","Trois jours plus tard : la rÃ¨gle est abolie."],choices:[{text:'Continuer.',next:'p4_rapide'}]},
    p_mauvais_chemin:{num:'Â§ Une voie sans issue',mood:'ğŸŒ«ï¸',text:["Tu passes ton chemin. Pendant des jours, tu continues de croiser Kira. Elle ne te regarde pas diffÃ©remment. Mais toi, tu sais.","RÃ©na te demande : <em>Â« Et tu n'as rien fait ? Â»</em>","Il n'y a pas de jugement dans sa voix. Juste la question."],choices:[{text:'Retourner au dÃ©but et faire autrement.',next:'p1'},{text:'Fermer cette sÃ©quence.',action:'close'}]},
    p4:{num:'Â§ 4 Â· La rÃ©ponse de Valdurne',mood:'âœ¨',text:["Trois jours aprÃ¨s la demande, la rÃ¨gle d'accÃ¨s Ã  la Forge Haute est rÃ©visÃ©e.","La semaine suivante, Kira monte Ã  la Forge pour la premiÃ¨re fois.","Dans la cour, elle te lance ses parchemins de formules. <em>Â« Tu en auras besoin. Â»</em> â€” <em>Â« J'en suis pas sÃ»r. Â»</em> â€” <em>Â« Moi si. Â»</em>","Et maintenant â€” le vrai moment de cette histoire. Ton ami Tolven t'accoste le soir mÃªme. Il est agitÃ©."],choices:[{text:'Ã‰couter ce que Tolven a Ã  dire.',next:'p5_dilemme'}]},
    p4_seul:{num:'Â§ 4 Â· La dÃ©cision de Kira',mood:'âœï¸',text:["Kira rÃ©dige seule. Trois jours plus tard la rÃ¨gle change. Tolven s'approche."],choices:[{text:'Voir ce que Tolven veut dire.',next:'p5_dilemme'}]},
    p4_rapide:{num:'Â§ 4 Â· Ce soir-lÃ ',mood:'ğŸŒ™',text:["Tolven t'accoste."],choices:[{text:'Ã‰couter.',next:'p5_dilemme'}]},
    p5_dilemme:{num:'Â§ 5 Â· Le vrai choix',mood:'âš–ï¸',text:["<em>Â« C'est injuste. Â»</em>","Tolven est furieux. <em>Â« Moi, j'ai attendu deux ans pour accÃ©der Ã  la Forge Haute. Deux ans Ã  faire mes preuves. Elle, Ã§a lui prend une pÃ©tition et une semaine. T'aurais dÃ» te taire, Lyam. Â»</em>","Il ne t'accuse pas vraiment. Il exprime quelque chose qu'il ressent comme une injustice.","Comment lui expliques-tu que corriger une injustice, ce n'est pas en crÃ©er une nouvelle ?"],choices:[{text:'"T\'as raison, j\'aurais peut-Ãªtre pas dÃ» m\'impliquer."',next:'p_echec',result:'fail'},{text:'"Kira attendait aussi. D\'une rÃ¨gle injuste qu\'on lÃ¨ve enfin. Ta patience valait quelque chose â€” sa compÃ©tence aussi."',next:'p_succes',result:'success'},{text:'"Ce qu\'on a corrigÃ©, c\'est une rÃ¨gle qui l\'empÃªchait d\'accÃ©der Ã  quelque chose qu\'elle mÃ©ritait. Ã‡a ne t\'enlÃ¨ve rien."',next:'p_succes',result:'success'}]},
    p_succes:{num:'Â§ Fin â€” La vÃ©ritÃ© de Tolven',mood:'ğŸŒŸ',isResult:true,resultType:'success',text:["Tolven reste silencieux. Puis : <em>Â« Elle mÃ©ritait vraiment ? Â»</em>","<em>Â« Tu l'as vue travailler. Â»</em>","<em>Â« ...Oui. Â»</em>","Il repart sans rien ajouter. Ce n'est pas une victoire. Juste une graine plantÃ©e."],endNote:"L'Ã©galitÃ© n'est pas un jeu Ã  somme nulle. Corriger une injustice n'en crÃ©e pas une nouvelle â€” elle rend le terrain plus juste pour tout le monde."},
    p_echec:{num:'Â§ Un doute',mood:'ğŸŒ«ï¸',isResult:true,resultType:'fail',text:["Tolven hoche la tÃªte. <em>Â« VoilÃ . C'est ce que je pensais. Â»</em>","Mais toi, quelque chose te reste dans l'estomac. Tu viens de valider l'idÃ©e que corriger une injustice ancienne crÃ©e une injustice nouvelle. Mais ce n'est pas vrai. Kira attendait aussi â€” pas de l'entraÃ®nement, mais d'une rÃ¨gle injuste qu'on lÃ¨ve enfin."],endNote:"L'Ã©galitÃ© n'enlÃ¨ve rien Ã  ceux qui ont attendu honnÃªtement. Elle donne accÃ¨s Ã  ceux qui en ont Ã©tÃ© privÃ©s injustement. Retente le choix final."},
  }}
};

var currentSeq=null,currentSat=null,stepHistory=[];
function openLdvelh(seqId,sat){
  const seq=SEQUENCES[seqId];if(!seq)return;
  currentSeq=seq;currentSat=sat;stepHistory=[];
  document.getElementById('ldvelhTitle').textContent=seq.title;
  document.getElementById('ldvelhModal').classList.add('open');
  renderPassage(seq.start);
}
function renderPassage(passageId){
  const seq=currentSeq;const pass=seq.passages[passageId];if(!pass)return;
  stepHistory.push(passageId);
  const prog=document.getElementById('ldvelhProgress');prog.innerHTML='';
  for(let i=0;i<seq.steps;i++){const s=document.createElement('div');s.className='ldv-step'+(i<stepHistory.length-1?' done':i===stepHistory.length-1?' current':'');prog.appendChild(s)}
  const content=document.getElementById('ldvelhContent');
  let html=`<div class="passage active"><div class="passage-num">${pass.num}</div>${pass.mood?`<div class="passage-mood">${pass.mood}</div>`:''}<div class="passage-text">${(pass.text||[]).map(t=>`<p>${t}</p>`).join('')}</div><hr class="passage-divider">`;
  if(pass.isResult){
    const ok=pass.resultType==='success';
    const xp=ok?XP_BON_CHOIX:XP_MAUVAIS_CHOIX;
    if(ok){markDone(currentSat?.id||'ldvelh')}
    html+=`<div class="result-block ${ok?'success':'failure'}"><span class="result-icon">${ok?'â­':'ğŸ’­'}</span><div class="result-title">${ok?'RÃ©ponse juste !':'Ã€ retravaillerâ€¦'}</div><div class="result-xp">${ok?'+'+xp+' XP':''+xp+' XP'}</div><div class="result-text">${pass.endNote||''}</div><div style="margin-top:12px">${!ok?`<button class="btn-retry" onclick="openLdvelh('egalite',currentSat)">Recommencer</button>`:''}<button class="btn-close-result" onclick="closeLdvelh()">Fermer</button></div></div>`;
    creditXP(cur,xp,ok?'NARRATION_EGALITE_SUCCESS':'NARRATION_EGALITE_ECHEC');
    showXpNotif(xp);
    document.getElementById('chaptersRead').textContent=Object.values(getDone()).filter(v=>v).length;
  } else if(pass.choices){
    html+=`<div class="choices">`;
    pass.choices.forEach(c=>{
      if(c.action==='close') html+=`<button class="choice-btn" onclick="closeLdvelh()">${c.text}</button>`;
      else html+=`<button class="choice-btn" onclick="renderPassage('${c.next}')">${c.text}</button>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  content.innerHTML=html;
  document.getElementById('ldvelhModal').scrollTop=0;
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeLdvelh()});
</script>
</body>
</html>
