<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Les Chevaliers de la Justice</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a0f}
body{display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Press Start 2P',monospace}

#gameWrapper{position:relative;display:flex;flex-direction:column;align-items:center}
#hud{width:100%;display:flex;justify-content:space-between;align-items:center;padding:8px 4px;gap:8px}
.hud-hearts{display:flex;gap:4px;align-items:center}
.heart{width:16px;height:16px;display:inline-block}
#hudRoom{color:#aaa;font-size:7px}
#hudTier{color:#ffd700;font-size:7px;text-align:right}
#gameCanvas{display:block;image-rendering:pixelated;border:2px solid #333;cursor:none}
#mobileControls{display:none;flex-direction:column;align-items:center;gap:6px;margin-top:8px}
.dpad{display:grid;grid-template-columns:repeat(3,44px);grid-template-rows:repeat(3,44px);gap:2px}
.dpad-btn{background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;active:background:rgba(255,255,255,0.3)}
.dpad-btn:active{background:rgba(255,255,255,0.3)}
.dpad-center{background:transparent;border:none}
.action-btns{display:flex;gap:12px}
.action-btn{width:52px;height:52px;border-radius:50%;border:2px solid;color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;text-align:center;line-height:1.2}
.btn-sword{background:rgba(255,80,80,0.25);border-color:#ff5050}
.btn-shield{background:rgba(80,150,255,0.25);border-color:#5096ff}
.btn-special{background:rgba(255,215,0,0.25);border-color:#ffd700;display:none}

/* Screens */
#screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:10;padding:20px;text-align:center}
#screen.hidden{display:none}
.scr-title{color:#ffd700;font-size:14px;margin-bottom:16px;text-shadow:0 0 20px #ffd70088;line-height:1.6}
.scr-sub{color:#ccc;font-size:8px;line-height:1.8;margin-bottom:20px}
.scr-btn{background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;border:none;padding:12px 24px;border-radius:4px;font-family:'Press Start 2P',monospace;font-size:9px;cursor:pointer;margin:4px;transition:transform 0.1s}
.scr-btn:hover{transform:scale(1.05)}
.scr-btn.secondary{background:rgba(255,255,255,0.15);color:#fff;border:1px solid #555}
.tier-badge{display:inline-block;background:#ffd700;color:#000;padding:4px 10px;border-radius:3px;font-size:8px;margin-bottom:12px}
.tier-unlock{color:#ffd700;font-size:7px;line-height:2;margin-top:8px}
</style>
</head>
<body>
<div id="gameWrapper">
  <div id="hud">
    <div class="hud-hearts" id="hudHearts"></div>
    <div id="hudRoom">SALLE 1/5</div>
    <div id="hudTier">APPRENTI</div>
  </div>
  <canvas id="gameCanvas"></canvas>
  <div id="mobileControls">
    <div class="dpad">
      <div class="dpad-center"></div>
      <button class="dpad-btn" id="btnUp">â–²</button>
      <div class="dpad-center"></div>
      <button class="dpad-btn" id="btnLeft">â—€</button>
      <div class="dpad-center"></div>
      <button class="dpad-btn" id="btnRight">â–¶</button>
      <div class="dpad-center"></div>
      <button class="dpad-btn" id="btnDown">â–¼</button>
      <div class="dpad-center"></div>
    </div>
    <div class="action-btns">
      <button class="action-btn btn-shield" id="btnShield">ğŸ›¡ï¸<br>Garde</button>
      <button class="action-btn btn-sword" id="btnSword">âš”ï¸<br>Attaque</button>
      <button class="action-btn btn-special" id="btnSpecial">âœ¨<br>SpÃ©cial</button>
    </div>
  </div>
  <div id="screen">
    <div id="scrContent"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LECTURE XP SUPERHUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getHubXP(){
  try{
    const key=Object.keys(localStorage).find(k=>k.includes('pvs_')||k.includes('portail'));
    // Chercher dans les donnÃ©es du superhub
    for(const k of Object.keys(localStorage)){
      try{
        const d=JSON.parse(localStorage.getItem(k)||'{}');
        if(d.players){
          const cur=localStorage.getItem('pvs_current_player')||'';
          const p=d.players[cur]||d.players[cur.toUpperCase()];
          if(p){
            // xg() Ã©quivalent : somme des CPÃ—50 + social + bonus
            let xp=0;
            if(p.cp)Object.values(p.cp).forEach(v=>xp+=Number(v||0)*50);
            xp+=Number(p.socialG||0)*10+Number(p.wBonusG||0)*20+Number(p.videoG||0)*15;
            if(xp>0)return xp;
          }
        }
      }catch(e){}
    }
    // Fallback: lire pvs_rewards_seen pour tier approximatif
    const seen=JSON.parse(localStorage.getItem('pvs_rewards_seen')||'{}');
    if(seen['2000'])return 2000;
    if(seen['1500'])return 1500;
    if(seen['1000'])return 1000;
    if(seen['500'])return 500;
  }catch(e){}
  return 0; // dÃ©mo : toujours accessible
}

function getTierFromXP(xp){
  if(xp>=2000)return 4;
  if(xp>=1500)return 3;
  if(xp>=1000)return 2;
  if(xp>=500)return 1;
  return 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG TIERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TIERS=[
  { // Tier 0 â€” Apprenti
    name:"APPRENTI",color:"#a0a0a0",
    hp:3,speed:2.2,
    sword:{range:28,arc:55,damage:1,cooldown:420,color:"#c8c8c8"},
    shield:{arc:50,reduce:0.5},
    special:null,
    enemies:{count:12,speed:1.4,hp:2,damage:1,aggro:180,color:"#cc3333"},
    palette:{floor:"#1a1a2e",wall:"#0d0d1a",door:"#2a1a0a",accent:"#333355"}
  },
  { // Tier 1 â€” Ã‰cuyer
    name:"Ã‰CUYER",color:"#4fc3f7",
    hp:4,speed:2.5,
    sword:{range:36,arc:65,damage:1,cooldown:340,color:"#4fc3f7"},
    shield:{arc:80,reduce:0.3},
    special:null,
    enemies:{count:12,speed:1.5,hp:2,damage:1,aggro:200,color:"#cc6600"},
    palette:{floor:"#1a2e1a",wall:"#0d1a0d",door:"#1a2a0a",accent:"#1a4a1a"}
  },
  { // Tier 2 â€” Chevalier
    name:"CHEVALIER",color:"#ffb74d",
    hp:5,speed:2.8,
    sword:{range:44,arc:75,damage:2,cooldown:280,color:"#ffb74d"},
    shield:{arc:110,reduce:0.2,bash:true},
    special:{name:"CHARGÃ‰",key:"charge",damage:3,range:60,cooldown:3000,color:"#ff8c00"},
    enemies:{count:12,speed:1.6,hp:3,damage:1,aggro:220,color:"#8800cc"},
    palette:{floor:"#2e1a0a",wall:"#1a0a00",door:"#3a2a0a",accent:"#4a2a00"}
  },
  { // Tier 3 â€” Paladin
    name:"PALADIN",color:"#e040fb",
    hp:6,speed:3.0,
    sword:{range:52,arc:85,damage:2,cooldown:240,color:"#e040fb"},
    shield:{arc:140,reduce:0.1,bash:true},
    special:{name:"TOURBILLON",key:"whirl",damage:2,range:72,cooldown:2500,color:"#e040fb"},
    enemies:{count:12,speed:1.7,hp:4,damage:1,aggro:240,color:"#cc0044"},
    palette:{floor:"#2e002e",wall:"#1a001a",door:"#3a003a",accent:"#4a004a"}
  },
  { // Tier 4 â€” Paladin Divin
    name:"PALADIN DIVIN",color:"#ffd700",
    hp:7,speed:3.2,
    sword:{range:60,arc:90,damage:3,cooldown:200,color:"#ffd700"},
    shield:{arc:160,reduce:0.05,bash:true},
    special:{name:"FRAPPE SACRÃ‰E",key:"holy",damage:4,range:200,cooldown:2000,color:"#fff176"},
    enemies:{count:12,speed:1.8,hp:5,damage:1,aggro:260,color:"#ff2200"},
    palette:{floor:"#1a1a00",wall:"#0a0a00",door:"#2a2a00",accent:"#3a3a00"}
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS & DIMENSIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const TILE=32,COLS=18,ROWS=13;
const W=COLS*TILE,H=ROWS*TILE; // 576Ã—416
canvas.width=W;canvas.height=H;

// Responsive
function resizeGame(){
  const maxW=Math.min(window.innerWidth-16,600);
  const maxH=window.innerHeight-180;
  const scale=Math.min(maxW/W,maxH/H);
  canvas.style.width=Math.floor(W*scale)+'px';
  canvas.style.height=Math.floor(H*scale)+'px';
  const mob=window.innerWidth<=640;
  document.getElementById('mobileControls').style.display=mob?'flex':'none';
}
window.addEventListener('resize',resizeGame);resizeGame();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LAYOUT SALLE â€” mÃªme pour tous les tiers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 0=sol, 1=mur, 2=porte-sortie, 3=porte-entrÃ©e
function makeRoom(roomIdx,totalRooms){
  const grid=[];
  for(let r=0;r<ROWS;r++){
    grid.push([]);
    for(let c=0;c<COLS;c++){
      if(r===0||r===ROWS-1||c===0||c===COLS-1)grid[r].push(1);
      else grid[r].push(0);
    }
  }
  // Colonnes obstacles internes â€” mÃªme layout
  const obstacles=[[3,3],[3,14],[6,6],[6,11],[9,4],[9,13]];
  obstacles.forEach(([or,oc])=>{
    for(let dr=0;dr<2;dr++)for(let dc=0;dc<2;dc++)
      if(grid[or+dr]&&grid[or+dr][oc+dc]!==undefined)grid[or+dr][oc+dc]=1;
  });
  // Porte entrÃ©e (gauche) sauf salle 0
  if(roomIdx>0){grid[6][0]=3;grid[7][0]=3;}
  // Porte sortie (droite) sauf derniÃ¨re salle
  if(roomIdx<totalRooms-1){grid[6][COLS-1]=2;grid[7][COLS-1]=2;}
  return grid;
}

function spawnPositions(grid){
  const pos=[];
  for(let r=2;r<ROWS-2;r++)for(let c=8;c<COLS-3;c++)
    if(grid[r][c]===0)pos.push({x:c*TILE+TILE/2,y:r*TILE+TILE/2});
  // Shuffle
  for(let i=pos.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pos[i],pos[j]]=[pos[j],pos[i]];}
  return pos;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TAT DU JEU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tier,tierCfg,currentRoom,totalRooms=5,rooms,roomEnemies;
let hero,keys={},lastTime=0,gameState='screen'; // screen|playing|dead|win
let swordTimer=0,specialTimer=0,iFrames=0;
let attackAnim={active:false,timer:0,angle:0};
let shieldActive=false;
let specialActive=false,specialAnim={active:false,timer:0,angle:0,type:''};
let particles=[];

function initGame(t){
  tier=t;tierCfg=TIERS[tier];
  totalRooms=5;currentRoom=0;
  rooms=Array.from({length:totalRooms},(_,i)=>makeRoom(i,totalRooms));
  roomEnemies=null;
  const sx=TILE*2+TILE/2,sy=TILE*6+TILE/2;
  hero={
    x:sx,y:sy,
    hp:tierCfg.hp,maxHp:tierCfg.hp,
    facing:0, // angle en radians, 0=droite
    facingDir:'right'
  };
  swordTimer=0;specialTimer=0;iFrames=0;
  attackAnim={active:false,timer:0,angle:0};
  specialAnim={active:false,timer:0,angle:0,type:''};
  shieldActive=false;specialActive=false;
  particles=[];
  spawnEnemies();
  gameState='playing';
}

function spawnEnemies(){
  const grid=rooms[currentRoom];
  const pos=spawnPositions(grid);
  const n=Math.min(tierCfg.enemies.count,pos.length);
  roomEnemies=[];
  for(let i=0;i<n;i++){
    roomEnemies.push({
      x:pos[i].x,y:pos[i].y,
      hp:tierCfg.enemies.hp,maxHp:tierCfg.enemies.hp,
      vx:0,vy:0,
      iFrames:0,
      alertTimer:0,
      state:'idle', // idle|chase|attack
      attackCd:0,
      type:tier>=2?(i%3===0?'guard':i%3===1?'bat':'grunt'):'grunt'
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KEYS={ArrowUp:false,ArrowDown:false,ArrowLeft:false,ArrowRight:false,
  KeyZ:false,KeyX:false,KeyC:false,Space:false,
  'w':false,'a':false,'s':false,'d':false};
document.addEventListener('keydown',e=>{if(e.code in KEYS||(e.key in KEYS)){KEYS[e.code||e.key]=true;e.preventDefault();}});
document.addEventListener('keyup',e=>{if(e.code in KEYS||(e.key in KEYS)){KEYS[e.code||e.key]=false;}});

// Mobile
function setupMobile(){
  const map={btnUp:'ArrowUp',btnDown:'ArrowDown',btnLeft:'ArrowLeft',btnRight:'ArrowRight'};
  Object.entries(map).forEach(([id,key])=>{
    const btn=document.getElementById(id);
    btn.addEventListener('touchstart',e=>{KEYS[key]=true;e.preventDefault();},{passive:false});
    btn.addEventListener('touchend',e=>{KEYS[key]=false;e.preventDefault();},{passive:false});
    btn.addEventListener('mousedown',()=>KEYS[key]=true);
    btn.addEventListener('mouseup',()=>KEYS[key]=false);
  });
  document.getElementById('btnSword').addEventListener('touchstart',e=>{doSword();e.preventDefault();},{passive:false});
  document.getElementById('btnSword').addEventListener('mousedown',doSword);
  document.getElementById('btnShield').addEventListener('touchstart',e=>{shieldActive=true;e.preventDefault();},{passive:false});
  document.getElementById('btnShield').addEventListener('touchend',e=>{shieldActive=false;e.preventDefault();},{passive:false});
  document.getElementById('btnShield').addEventListener('mousedown',()=>shieldActive=true);
  document.getElementById('btnShield').addEventListener('mouseup',()=>shieldActive=false);
  document.getElementById('btnSpecial').addEventListener('touchstart',e=>{doSpecial();e.preventDefault();},{passive:false});
  document.getElementById('btnSpecial').addEventListener('mousedown',doSpecial);
}

function isUp(){return KEYS['ArrowUp']||KEYS['KeyW']||KEYS['w']}
function isDown(){return KEYS['ArrowDown']||KEYS['KeyS']||KEYS['s']}
function isLeft(){return KEYS['ArrowLeft']||KEYS['KeyA']||KEYS['a']}
function isRight(){return KEYS['ArrowRight']||KEYS['KeyD']||KEYS['d']}
function isSword(){return KEYS['KeyZ']||KEYS['Space']}
function isShield(){return KEYS['KeyX']}
function isSpecial(){return KEYS['KeyC']}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HR=10; // hero radius
function tileAt(x,y){
  const c=Math.floor(x/TILE),r=Math.floor(y/TILE);
  const grid=rooms[currentRoom];
  if(r<0||r>=ROWS||c<0||c>=COLS)return 1;
  return grid[r][c];
}
function isSolid(t){return t===1}
function isDoor(t){return t===2||t===3}

function moveEntity(e,dx,dy,radius){
  radius=radius||HR;
  // Tenter dÃ©placement complet
  const nx=e.x+dx,ny=e.y+dy;
  const corners=[
    {x:nx-radius,y:ny-radius},{x:nx+radius,y:ny-radius},
    {x:nx-radius,y:ny+radius},{x:nx+radius,y:ny+radius}
  ];
  let blockX=false,blockY=false;
  // Test X
  const cx=[{x:e.x+dx-radius,y:e.y-radius+2},{x:e.x+dx+radius,y:e.y-radius+2},
             {x:e.x+dx-radius,y:e.y+radius-2},{x:e.x+dx+radius,y:e.y+radius-2}];
  cx.forEach(p=>{if(isSolid(tileAt(p.x,p.y)))blockX=true;});
  if(!blockX)e.x+=dx;
  const cy=[{x:e.x-radius+2,y:e.y+dy-radius},{x:e.x+radius-2,y:e.y+dy-radius},
             {x:e.x-radius+2,y:e.y+dy+radius},{x:e.x+radius-2,y:e.y+dy+radius}];
  cy.forEach(p=>{if(isSolid(tileAt(p.x,p.y)))blockY=true;});
  if(!blockY)e.y+=dy;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFacingAngle(){
  if(hero.facingDir==='right')return 0;
  if(hero.facingDir==='left')return Math.PI;
  if(hero.facingDir==='up')return -Math.PI/2;
  return Math.PI/2;
}

function doSword(){
  if(swordTimer>0)return;
  const sc=tierCfg.sword;
  swordTimer=sc.cooldown;
  const angle=getFacingAngle();
  attackAnim={active:true,timer:220,angle};
  // Hit tous les ennemis dans le cÃ´ne
  const arcRad=(sc.arc/2)*(Math.PI/180);
  roomEnemies.forEach(en=>{
    if(en.hp<=0||en.iFrames>0)return;
    const dx=en.x-hero.x,dy=en.y-hero.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist>sc.range+8)return;
    const a=Math.atan2(dy,dx);
    let diff=a-angle;
    while(diff>Math.PI)diff-=Math.PI*2;
    while(diff<-Math.PI)diff+=Math.PI*2;
    if(Math.abs(diff)<=arcRad){
      hitEnemy(en,sc.damage,dx/dist,dy/dist);
    }
  });
  spawnParticles(hero.x+Math.cos(angle)*30,hero.y+Math.sin(angle)*30,sc.color,6);
}

function doSpecial(){
  if(!tierCfg.special||specialTimer>0)return;
  const sp=tierCfg.special;
  specialTimer=sp.cooldown;
  const angle=getFacingAngle();
  specialAnim={active:true,timer:400,angle,type:sp.key};
  if(sp.key==='charge'){
    // Coup chargÃ© frontal puissant
    const arcRad=35*(Math.PI/180);
    roomEnemies.forEach(en=>{
      if(en.hp<=0)return;
      const dx=en.x-hero.x,dy=en.y-hero.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist>sp.range)return;
      const a=Math.atan2(dy,dx);
      let diff=a-angle;
      while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;
      if(Math.abs(diff)<=arcRad)hitEnemy(en,sp.damage,dx/dist,dy/dist);
    });
  } else if(sp.key==='whirl'){
    // Tourbillon 360Â°
    roomEnemies.forEach(en=>{
      if(en.hp<=0)return;
      const dx=en.x-hero.x,dy=en.y-hero.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<=sp.range)hitEnemy(en,sp.damage,dx/dist,dy/dist);
    });
  } else if(sp.key==='holy'){
    // Projectile sacrÃ© â€” on l'ajoute Ã  particles avec type projectile
    particles.push({type:'projectile',x:hero.x,y:hero.y,
      vx:Math.cos(angle)*6,vy:Math.sin(angle)*6,
      life:60,damage:sp.damage,color:sp.color,r:10});
  }
  spawnParticles(hero.x,hero.y,sp.color,12);
}

function hitEnemy(en,dmg,nx,ny){
  en.hp-=dmg;
  en.iFrames=320;
  en.vx=(nx||0)*4;en.vy=(ny||0)*4;
  spawnParticles(en.x,en.y,'#ff4444',5);
  if(en.hp<=0){
    en.hp=0;
    spawnParticles(en.x,en.y,'#ffaa00',10);
  }
}

function tryShieldBlock(dmg,nx,ny){
  if(!shieldActive&&!isShield())return false;
  const sc=tierCfg.shield;
  const arcRad=(sc.arc/2)*(Math.PI/180);
  const angle=getFacingAngle();
  // Direction de l'attaque
  const attackAngle=Math.atan2(ny,nx);
  let diff=attackAngle-angle;
  while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;
  if(Math.abs(diff)<=arcRad+0.4){
    // BloquÃ© (rÃ©duit)
    spawnParticles(hero.x+Math.cos(angle)*20,hero.y+Math.sin(angle)*20,'#5096ff',4);
    return sc.reduce; // retourne le ratio de dÃ©gÃ¢ts passant
  }
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(x,y,color,n){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=Math.random()*3+1;
    particles.push({type:'spark',x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,
      life:Math.random()*25+15,color,r:Math.random()*3+1});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function update(dt){
  if(gameState!=='playing')return;
  const spd=tierCfg.speed;

  // Mouvement hÃ©ros
  let dx=0,dy=0;
  if(isLeft()){dx-=spd;hero.facingDir='left';}
  if(isRight()){dx+=spd;hero.facingDir='right';}
  if(isUp()){dy-=spd;if(!isLeft()&&!isRight())hero.facingDir='up';}
  if(isDown()){dy+=spd;if(!isLeft()&&!isRight())hero.facingDir='down';}
  if(dx&&dy){dx*=0.707;dy*=0.707;}
  moveEntity(hero,dx,dy);

  // Bouclier
  shieldActive=isShield();

  // Attaque Ã©pÃ©e (tenu = rÃ©pÃ©tÃ©)
  if(isSword()&&swordTimer<=0)doSword();
  if(swordTimer>0)swordTimer-=dt;
  if(attackAnim.active){attackAnim.timer-=dt;if(attackAnim.timer<=0)attackAnim.active=false;}

  // SpÃ©cial
  if(isSpecial()&&specialTimer<=0&&tierCfg.special)doSpecial();
  if(specialTimer>0)specialTimer-=dt;
  if(specialAnim.active){specialAnim.timer-=dt;if(specialAnim.timer<=0)specialAnim.active=false;}

  // iFrames hÃ©ros
  if(iFrames>0)iFrames-=dt;

  // Ennemis
  updateEnemies(dt);

  // Projectiles & particules
  updateParticles(dt);

  // Check porte sortie
  const grid=rooms[currentRoom];
  const hc=Math.floor(hero.x/TILE),hr=Math.floor(hero.y/TILE);
  if(grid[hr]&&grid[hr][hc]===2&&roomEnemies.every(e=>e.hp<=0)){
    nextRoom();
  }

  // Check mort
  if(hero.hp<=0){gameState='dead';showDead();}

  // HUD
  updateHUD();
}

function updateEnemies(dt){
  const grid=rooms[currentRoom];
  roomEnemies.forEach(en=>{
    if(en.hp<=0)return;
    if(en.iFrames>0){en.iFrames-=dt;en.x+=en.vx;en.y+=en.vy;en.vx*=0.85;en.vy*=0.85;return;}
    if(en.attackCd>0)en.attackCd-=dt;

    const dx=hero.x-en.x,dy=hero.y-en.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const cfg=tierCfg.enemies;

    // IA selon type
    let spd=cfg.speed;
    if(en.type==='guard')spd*=0.7;
    if(en.type==='bat')spd*=1.5;

    if(dist<cfg.aggro){
      en.state='chase';
      // Fonce sur le hÃ©ros
      if(dist>18){
        const nx=dx/dist,ny=dy/dist;
        // SÃ©paration des ennemis
        let sx=0,sy=0;
        roomEnemies.forEach(o=>{
          if(o===en||o.hp<=0)return;
          const ox=en.x-o.x,oy=en.y-o.y;
          const od=Math.sqrt(ox*ox+oy*oy);
          if(od<24&&od>0){sx+=ox/od*(24-od)/24;sy+=oy/od*(24-od)/24;}
        });
        const fdx=(nx+sx*0.3),fdy=(ny+sy*0.3);
        const fm=Math.sqrt(fdx*fdx+fdy*fdy)||1;
        moveEntity(en,(fdx/fm)*spd,(fdy/fm)*spd,8);
      } else if(en.attackCd<=0){
        // Attaque
        en.attackCd=900+(tier===0?-200:0);
        if(iFrames<=0){
          const blockRatio=tryShieldBlock(cfg.damage,dx/dist,dy/dist);
          const dmg=blockRatio===false?cfg.damage:Math.ceil(cfg.damage*blockRatio);
          if(dmg>0){
            hero.hp-=dmg;
            iFrames=600;
            spawnParticles(hero.x,hero.y,'#ff0000',8);
          }
          // Shield bash
          if(blockRatio!==false&&tierCfg.shield.bash){
            en.iFrames=400;en.vx=-dx/dist*5;en.vy=-dy/dist*5;
            spawnParticles(en.x,en.y,'#5096ff',6);
          }
        }
      }
    } else {
      en.state='idle';
      // Errance lÃ©gÃ¨re
      en.x+=Math.sin(Date.now()*0.001+en.x)*0.3;
      en.y+=Math.cos(Date.now()*0.001+en.y)*0.3;
    }
  });
}

function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.life-=1;
    if(p.type==='projectile'){
      p.x+=p.vx;p.y+=p.vy;
      if(isSolid(tileAt(p.x,p.y))){particles.splice(i,1);continue;}
      // Hit ennemis
      roomEnemies.forEach(en=>{
        if(en.hp<=0)return;
        const dx=en.x-p.x,dy=en.y-p.y;
        if(Math.sqrt(dx*dx+dy*dy)<p.r+10){
          hitEnemy(en,p.damage,dx/(Math.sqrt(dx*dx+dy*dy)||1),dy/(Math.sqrt(dx*dx+dy*dy)||1));
          p.life=0;
        }
      });
    } else {
      p.x+=p.vx;p.y+=p.vy;p.vx*=0.9;p.vy*=0.9;
    }
    if(p.life<=0)particles.splice(i,1);
  }
}

function nextRoom(){
  currentRoom++;
  if(currentRoom>=totalRooms){gameState='win';showWin();return;}
  // Repositionner hÃ©ros Ã  l'entrÃ©e
  hero.x=TILE+TILE/2;hero.y=TILE*6+TILE/2;
  spawnEnemies();
  particles=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DESSIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function draw(){
  const pal=tierCfg.palette;
  ctx.clearRect(0,0,W,H);

  // Sol et murs
  const grid=rooms[currentRoom];
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const t=grid[r][c];
      const tx=c*TILE,ty=r*TILE;
      if(t===0){
        ctx.fillStyle=pal.floor;
        ctx.fillRect(tx,ty,TILE,TILE);
        // Motif carrelage
        ctx.fillStyle='rgba(255,255,255,0.025)';
        if((r+c)%2===0)ctx.fillRect(tx,ty,TILE,TILE);
        ctx.strokeStyle='rgba(255,255,255,0.04)';
        ctx.strokeRect(tx+0.5,ty+0.5,TILE-1,TILE-1);
      } else if(t===1){
        // Mur avec relief
        ctx.fillStyle=pal.wall;
        ctx.fillRect(tx,ty,TILE,TILE);
        ctx.fillStyle='rgba(255,255,255,0.08)';
        ctx.fillRect(tx,ty,TILE,4);
        ctx.fillRect(tx,ty,4,TILE);
        ctx.fillStyle='rgba(0,0,0,0.3)';
        ctx.fillRect(tx,ty+TILE-4,TILE,4);
        ctx.fillRect(tx+TILE-4,ty,4,TILE);
        // Pierre
        ctx.strokeStyle='rgba(255,255,255,0.06)';
        ctx.strokeRect(tx+2,ty+2,TILE-4,TILE-4);
      } else if(t===2){
        // Porte sortie
        const locked=roomEnemies&&roomEnemies.some(e=>e.hp>0);
        ctx.fillStyle=locked?'#220000':'#3a2a0a';
        ctx.fillRect(tx,ty,TILE,TILE);
        ctx.fillStyle=locked?'#ff000033':'#ffd70044';
        ctx.fillRect(tx+4,ty+4,TILE-8,TILE-8);
        // IcÃ´ne
        ctx.fillStyle=locked?'#ff4444':'#ffd700';
        ctx.font='14px sans-serif';
        ctx.textAlign='center';
        ctx.fillText(locked?'ğŸ”’':'â†’',tx+TILE/2,ty+TILE/2+5);
      } else if(t===3){
        ctx.fillStyle='#1a2a3a';ctx.fillRect(tx,ty,TILE,TILE);
        ctx.fillStyle='#5096ff44';ctx.fillRect(tx+4,ty+4,TILE-8,TILE-8);
        ctx.fillStyle='#5096ff';ctx.font='14px sans-serif';ctx.textAlign='center';
        ctx.fillText('â†',tx+TILE/2,ty+TILE/2+5);
      }
    }
  }

  // Ennemis
  roomEnemies&&roomEnemies.forEach(en=>{if(en.hp>0)drawEnemy(en);});

  // Particules
  particles.forEach(p=>{
    ctx.save();
    ctx.globalAlpha=Math.max(0,p.life/(p.type==='projectile'?60:40));
    if(p.type==='projectile'){
      ctx.fillStyle=p.color;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=15;ctx.shadowColor=p.color;ctx.fill();
    } else {
      ctx.fillStyle=p.color;
      ctx.fillRect(p.x-p.r/2,p.y-p.r/2,p.r,p.r);
    }
    ctx.restore();
  });

  // HÃ©ros
  drawHero();

  // Overlay iFrames
  if(iFrames>0&&Math.floor(Date.now()/80)%2===0){
    ctx.globalAlpha=0.3;
    ctx.fillStyle='#ff0000';
    ctx.fillRect(hero.x-HR,hero.y-HR,HR*2,HR*2);
    ctx.globalAlpha=1;
  }

  // Compte ennemis restants
  const alive=roomEnemies?roomEnemies.filter(e=>e.hp>0).length:0;
  if(alive>0){
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.fillRect(W/2-45,H-22,90,18);
    ctx.fillStyle='#ff4444';
    ctx.font='7px "Press Start 2P"';
    ctx.textAlign='center';
    ctx.fillText(`${alive} ennemi${alive>1?'s':''} restant${alive>1?'s':''}`,W/2,H-9);
  }
}

function drawHero(){
  ctx.save();
  ctx.translate(hero.x,hero.y);
  const facing=hero.facingDir;
  if(facing==='left')ctx.scale(-1,1);

  const tc=tierCfg;

  // Cape / corps (selon tier)
  const capeColor=['#6a4a2a','#2a5a8a','#7a4a00','#5a005a','#8a6a00'][tier];
  const armorColor=['#888','#4fc3f7','#ffb74d','#ce93d8','#ffd700'][tier];

  // Corps
  ctx.fillStyle=capeColor;
  ctx.fillRect(-5,-8,10,12); // torse

  // Jambes
  ctx.fillStyle='#333';
  ctx.fillRect(-5,4,4,7); // jambe gauche
  ctx.fillRect(1,4,4,7);  // jambe droite

  // Armure poitrine (selon tier)
  ctx.fillStyle=armorColor;
  ctx.fillRect(-4,-7,8,9);

  // TÃªte
  ctx.fillStyle='#f5c095';
  ctx.fillRect(-4,-15,8,8);

  // Casque (selon tier)
  ctx.fillStyle=armorColor;
  if(tier===0){
    // Casque cuir basique
    ctx.fillRect(-4,-17,8,4);
    ctx.fillStyle='#5a3a1a';ctx.fillRect(-5,-13,10,2);
  } else if(tier===1){
    // Heaume
    ctx.fillRect(-5,-18,10,6);
    ctx.fillStyle='#555';ctx.fillRect(-5,-18,10,2);
  } else if(tier>=2){
    // Heaume complet avec nasal
    ctx.fillRect(-5,-19,10,8);
    ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(-2,-17,4,5); // visiÃ¨re
    ctx.fillStyle=armorColor;ctx.fillRect(-1,-18,2,6); // nasal
  }

  // Yeux (visible si tier 0-1)
  if(tier<=1){
    ctx.fillStyle='#222';
    ctx.fillRect(-2,-13,2,2);ctx.fillRect(1,-13,2,2);
  }

  // Ã‰pÃ©e (droite)
  const swordLen=[16,22,28,34,40][tier];
  ctx.fillStyle=tierCfg.sword.color;
  ctx.fillRect(5,-swordLen*0.6,3,swordLen);
  ctx.fillStyle='#5a3a1a';ctx.fillRect(3,-1,8,4); // garde
  // Glow Ã©pÃ©e si attaque
  if(attackAnim.active){
    ctx.globalAlpha=(attackAnim.timer/220)*0.8;
    ctx.shadowBlur=15;ctx.shadowColor=tierCfg.sword.color;
    ctx.fillStyle=tierCfg.sword.color;
    ctx.fillRect(5,-swordLen*0.6,3,swordLen);
    ctx.shadowBlur=0;ctx.globalAlpha=1;
  }

  // Bouclier (gauche)
  const shieldSize=[10,14,18,22,26][tier];
  ctx.fillStyle=shieldActive?'#7ab4ff':'#3a5a8a';
  ctx.fillRect(-5-shieldSize,-shieldSize/2,shieldSize,shieldSize);
  ctx.fillStyle=armorColor;
  ctx.fillRect(-4-shieldSize,-shieldSize/2+1,shieldSize-2,shieldSize-2);
  // EmblÃ¨me bouclier
  ctx.fillStyle='rgba(255,255,255,0.3)';
  ctx.fillRect(-5-shieldSize/2,-2,3,3);

  // Aura spÃ©ciale
  if(specialAnim.active){
    const prog=specialAnim.timer/400;
    ctx.globalAlpha=prog*0.6;
    ctx.shadowBlur=20;ctx.shadowColor=tierCfg.special?tierCfg.special.color:'#fff';
    ctx.fillStyle=tierCfg.special?tierCfg.special.color:'#fff';
    ctx.beginPath();ctx.arc(0,0,20+prog*15,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.globalAlpha=1;
  }

  ctx.restore();

  // Arc d'attaque (debug visuel)
  if(attackAnim.active){
    const angle=getFacingAngle();
    const arc=(tierCfg.sword.arc/2)*(Math.PI/180);
    ctx.beginPath();
    ctx.moveTo(hero.x,hero.y);
    ctx.arc(hero.x,hero.y,tierCfg.sword.range,angle-arc,angle+arc);
    ctx.closePath();
    ctx.fillStyle=tierCfg.sword.color+'33';
    ctx.fill();
  }

  // Arc bouclier
  if((shieldActive||isShield())&&tier>=0){
    const angle=getFacingAngle();
    const arc=(tierCfg.shield.arc/2)*(Math.PI/180);
    ctx.beginPath();
    ctx.moveTo(hero.x,hero.y);
    ctx.arc(hero.x,hero.y,22,angle-arc,angle+arc);
    ctx.closePath();
    ctx.fillStyle='#5096ff22';
    ctx.strokeStyle='#5096ff66';
    ctx.fill();ctx.stroke();
  }
}

function drawEnemy(en){
  ctx.save();
  ctx.translate(en.x,en.y);
  const flash=en.iFrames>0&&Math.floor(Date.now()/60)%2===0;

  const ec=tierCfg.enemies.color;

  if(en.type==='bat'){
    // Chauve-souris
    ctx.fillStyle=flash?'#fff':ec;
    ctx.fillRect(-6,-4,12,6);
    ctx.fillRect(-10,-2,6,4); // aile gauche
    ctx.fillRect(4,-2,6,4);   // aile droite
    ctx.fillStyle='#ff0000';
    ctx.fillRect(-3,-5,2,2);ctx.fillRect(1,-5,2,2);
  } else if(en.type==='guard'){
    // Garde lourd
    ctx.fillStyle=flash?'#fff':'#555';
    ctx.fillRect(-7,-12,14,16);
    ctx.fillStyle=flash?'#fff':ec;
    ctx.fillRect(-6,-11,12,13);
    ctx.fillStyle='#333';ctx.fillRect(-7,-14,14,5); // heaume
    ctx.fillStyle='#888';ctx.fillRect(-8,-8,4,12); // bouclier lourd
    // Barre de vie garde
    ctx.fillStyle='#333';ctx.fillRect(-7,6,14,3);
    ctx.fillStyle='#ff4444';ctx.fillRect(-7,6,14*(en.hp/en.maxHp),3);
  } else {
    // Grunt
    ctx.fillStyle=flash?'#fff':'#cc2222';
    ctx.fillRect(-5,-10,10,12);
    ctx.fillStyle=flash?'#fff':ec;
    ctx.fillRect(-4,-9,8,10);
    ctx.fillStyle='#111';ctx.fillRect(-5,-12,10,5); // crÃ¢ne/capuche
    ctx.fillStyle='#ff0000';
    ctx.fillRect(-3,-11,2,2);ctx.fillRect(1,-11,2,2); // yeux
    // Arme
    ctx.fillStyle='#888';ctx.fillRect(5,-14,2,18);
    // Barre de vie
    ctx.fillStyle='#333';ctx.fillRect(-6,4,12,2);
    ctx.fillStyle='#ff4444';ctx.fillRect(-6,4,12*(en.hp/en.maxHp),2);
  }

  // Alerte
  if(en.state==='chase'){
    ctx.fillStyle='#ff4444';
    ctx.font='8px sans-serif';ctx.textAlign='center';
    ctx.fillText('!',0,-18);
  }

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  // CÅ“urs
  const hh=document.getElementById('hudHearts');
  hh.innerHTML='';
  for(let i=0;i<hero.maxHp;i++){
    const span=document.createElement('span');
    span.className='heart';
    span.textContent=i<hero.hp?'â¤ï¸':'ğŸ–¤';
    hh.appendChild(span);
  }
  document.getElementById('hudRoom').textContent=`SALLE ${currentRoom+1}/${totalRooms}`;
  const tc=tierCfg;
  let tierTxt=tc.name;
  if(tc.special){
    const pct=Math.round((1-specialTimer/tc.special.cooldown)*100);
    const ready=specialTimer<=0;
    tierTxt+=ready?` âœ¨PRÃŠT`:`  âœ¨${pct}%`;
  }
  document.getElementById('hudTier').textContent=tierTxt;

  // Bouton spÃ©cial mobile
  const sb=document.getElementById('btnSpecial');
  if(tierCfg.special){
    sb.style.display='flex';
    sb.style.opacity=specialTimer<=0?'1':'0.5';
    sb.children[0].textContent=tierCfg.special.name;
  } else sb.style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰CRANS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(html){
  document.getElementById('screen').classList.remove('hidden');
  document.getElementById('scrContent').innerHTML=html;
  gameState='screen';
}
function hideScreen(){
  document.getElementById('screen').classList.add('hidden');
  gameState='playing';
}

function showTitleScreen(){
  const xp=getHubXP();
  const maxTier=getTierFromXP(xp);
  let tiersHTML='';
  TIERS.forEach((t,i)=>{
    const unlocked=i<=maxTier;
    const xpReq=[0,500,1000,1500,2000][i];
    tiersHTML+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #222;opacity:${unlocked?1:0.4}">
      <span style="color:${t.color};font-size:7px">${t.name}</span>
      <span style="font-size:6px;color:#888">${unlocked?'âœ“ DÃ‰BLOQUÃ‰':xpReq+' XP requis'}</span>
      ${unlocked?`<button class="scr-btn" style="font-size:6px;padding:6px 10px;margin:0" onclick="startTier(${i})">JOUER</button>`:'<span style="font-size:8px">ğŸ”’</span>'}
    </div>`;
  });
  showScreen(`
    <div class="scr-title">âš”ï¸ LES CHEVALIERS<br>DE LA JUSTICE</div>
    <div class="scr-sub">DÃ©fends le CollÃ¨ge ChÃ¢teau Rance<br>contre les forces du chaos !</div>
    <div style="text-align:left;width:100%;max-width:320px;margin:0 auto 16px">
      ${tiersHTML}
    </div>
    <div style="font-size:6px;color:#555;margin-top:8px">Z/Espace: Attaque â€” X: Bouclier â€” C: SpÃ©cial<br>FlÃ¨ches/WASD: DÃ©placement</div>
  `);
}

function startTier(t){
  initGame(t);
  hideScreen();
}

function showDead(){
  showScreen(`
    <div class="scr-title" style="color:#ff4444">ğŸ’€ DÃ‰FAITE !</div>
    <div class="scr-sub">Tu t'es battu vaillamment...<br>mais le chÃ¢teau est tombÃ©.</div>
    <button class="scr-btn" onclick="startTier(${tier})">â†© RÃ‰ESSAYER</button>
    <button class="scr-btn secondary" onclick="showTitleScreen()">Menu</button>
  `);
}

function showWin(){
  const nextTier=tier+1;
  const hasNext=nextTier<TIERS.length;
  const xpReq=[0,500,1000,1500,2000][nextTier]||9999;
  showScreen(`
    <div class="scr-title" style="color:#ffd700">âš”ï¸ VICTOIRE !</div>
    <div class="tier-badge">${TIERS[tier].name} â€” ${totalRooms} salles conquises !</div>
    <div class="scr-sub">Le chÃ¢teau est protÃ©gÃ© !<br>Le mal a Ã©tÃ© repoussÃ©.</div>
    ${hasNext?`<div class="tier-unlock">Prochain palier : ${TIERS[nextTier].name}<br>Requis : ${xpReq} XP dans le Portail</div>`:'<div class="tier-unlock" style="color:#ffd700">ğŸ† NIVEAU MAXIMUM ATTEINT !</div>'}
    <button class="scr-btn" onclick="startTier(${tier})">â†© REJOUER</button>
    <button class="scr-btn secondary" onclick="showTitleScreen()">Menu</button>
  `);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOUCLE PRINCIPALE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min(ts-lastTime,50);
  lastTime=ts;
  if(gameState==='playing'){
    update(dt);
    draw();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setupMobile();
showTitleScreen();
requestAnimationFrame(ts=>{lastTime=ts;requestAnimationFrame(loop);});
</script>
</body>
</html>