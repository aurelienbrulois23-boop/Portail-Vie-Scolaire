﻿<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Portail Vie Scolaire</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}body{margin:0;font-family:Rajdhani,sans-serif;color:#fff;background:radial-gradient(circle at 10% 10%,#00d4ff22,transparent 30%),radial-gradient(circle at 90% 90%,#ffd70022,transparent 35%),linear-gradient(135deg,#070b17,#172444);min-height:100vh;padding:14px}.wrap{max-width:1250px;margin:auto}.card{background:#ffffff0d;border:1px solid #ffffff26;border-radius:12px;padding:12px}.grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:10px}.grid3{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px}h1{font-family:Orbitron,monospace;background:linear-gradient(135deg,#00d4ff,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:6px 0}h2,h3{font-family:Orbitron,monospace;font-size:1rem;color:#00d4ff;margin:0 0 8px}.tag{display:inline-block;background:linear-gradient(135deg,#00d4ff,#ffd700);color:#000;padding:5px 10px;border-radius:999px;font-weight:700}.sub{color:#a9bbd6}.alert{background:linear-gradient(90deg,#ff7d00,#3f6de1);padding:8px;border-radius:9px;font-weight:700;margin:8px 0 12px}.row{display:grid;gap:6px;margin:7px 0}input,select,textarea{width:100%;padding:9px;border-radius:8px;border:1px solid #ffffff3a;background:#0000005e;color:#fff;font-family:inherit}textarea{min-height:80px}button{border:0;border-radius:8px;padding:9px 12px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#00d4ff,#ffd700);color:#000}.btn2{background:#ffffff17;color:#fff;border:1px solid #ffffff37}.btnBad{background:linear-gradient(135deg,#ff6b6b,#ff2250);color:#fff}.btnNuclear{background:linear-gradient(135deg,#ff2a2a,#8a0016);border:1px solid #ff9a9a66;color:#fff;text-transform:uppercase;letter-spacing:.4px;box-shadow:0 0 0 0 #ff2a2a55;animation:pulseDanger 1.2s infinite}.rw{display:flex;flex-wrap:wrap;gap:8px}.msg{display:none;margin-top:8px;padding:7px 9px;border-radius:8px;font-weight:700}.ok{display:block;background:#16d28422;border:1px solid #16d28466}.bad{display:block;background:#ff557722;border:1px solid #ff557766}.hint{color:#a9bbd6}.profile{display:none;border:1px solid #ffffff32;border-radius:8px;background:#00000035;padding:8px;margin-top:8px}.profile.on{display:block}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;margin-top:8px}.stat{border:1px solid #ffffff2a;border-radius:8px;padding:6px;background:#ffffff08}.k{font-size:.8rem;color:#a9bbd6}.v{font-family:Orbitron,monospace}table{width:100%;border-collapse:collapse;border:1px solid #ffffff32;border-radius:10px;overflow:hidden}th,td{padding:7px;border-bottom:1px solid #ffffff20;text-align:left}th{font-family:Orbitron,monospace;color:#00d4ff;background:#00000048;font-size:.82rem}tr:nth-child(odd){background:#ffffff08}.tabs{display:flex;gap:8px}.tab{padding:5px 9px;border-radius:999px;border:1px solid #ffffff36;background:#00000047;color:#fff;cursor:pointer;font-weight:700}.tab.on{background:linear-gradient(135deg,#00d4ff,#ffd700);color:#000;border:0}.mini{max-height:170px;overflow:auto;border:1px solid #ffffff26;border-radius:8px}.mini td,.mini th{font-size:.86rem;padding:6px}.tutoFocus{outline:2px solid #ffd700;outline-offset:2px;box-shadow:0 0 0 6px #ffd70033;border-radius:10px}.audioDock{position:fixed;left:12px;bottom:12px;z-index:1400;max-width:360px;padding:10px;background:#ffffff12;border:1px solid #ffffff33;border-radius:12px;backdrop-filter:blur(4px)}@keyframes pulseDanger{0%{box-shadow:0 0 0 0 #ff2a2a66}70%{box-shadow:0 0 0 12px #ff2a2a00}100%{box-shadow:0 0 0 0 #ff2a2a00}}

/* ── Hub Académique ─────────────────────────────── */
.acad-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:10px}
.acad-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #2a2a4a;border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:6px;transition:transform .15s,border-color .15s}
.acad-card:hover{transform:translateY(-2px);border-color:#5050aa}
.acad-done{border-color:#00aa44 !important;background:linear-gradient(135deg,#0a1f0a,#0f2f0f) !important}
.acad-icon{font-size:1.6em;text-align:center}
.acad-meta{font-size:0.65em;color:#7788aa;text-align:center}
.acad-level{background:#2a2a5a;padding:1px 5px;border-radius:3px;color:#aab0ff}
.acad-subj{background:#1a3a2a;padding:1px 5px;border-radius:3px;color:#88ffaa}
.acad-title{font-size:0.72em;font-weight:600;color:#e8e8ff;line-height:1.4;text-align:center;min-height:32px}
.acad-status{font-size:0.65em;text-align:center;color:#aaa}
.acad-done .acad-status{color:#00cc55}
.acad-btn{background:linear-gradient(135deg,#3a3a7a,#5050aa);border:none;color:#fff;padding:5px 0;border-radius:5px;font-size:0.7em;cursor:pointer;transition:background .15s}
.acad-btn:hover{background:linear-gradient(135deg,#5050aa,#7070cc)}
.acad-redo{background:linear-gradient(135deg,#1a3a1a,#2a5a2a) !important}
.acad-coeff-bar{background:linear-gradient(90deg,#1a1a3a,#2a2a5a);border:1px solid #4040aa;border-radius:8px;padding:10px 14px;margin-bottom:10px;font-size:0.78em;color:#aab0ff;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.acad-coeff-val{font-size:1.1em;font-weight:700;color:#ffd700}
.acad-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.acad-filters select{background:#1a1a2e;border:1px solid #333;color:#ccc;padding:4px 8px;border-radius:4px;font-size:0.78em}
@media(max-width:500px){.acad-grid{grid-template-columns:repeat(2,1fr)}}


/* ── Intro vidéo ── */
#introOverlay{position:fixed;inset:0;z-index:9999;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;}
#introOverlay.fade-out{opacity:0;pointer-events:none;transition:opacity 0.85s ease}
#introVideo{width:100%;height:100%;object-fit:cover;pointer-events:none}
#introSkip{position:absolute;bottom:28px;right:28px;background:rgba(0,0,0,0.75);border:2px solid rgba(255,255,255,0.6);color:#fff;padding:10px 22px;border-radius:20px;cursor:pointer;font-size:0.85em;z-index:10001;pointer-events:all;}
/* ── Récompenses vidéo ── */
#rewardOverlay{position:fixed;inset:0;z-index:9998;background:#000;display:none;flex-direction:column;align-items:center;justify-content:center;}
#rewardOverlay.active{display:flex}
#rewardOverlay.fade-out{opacity:0;pointer-events:none;transition:opacity 0.7s ease}
#rewardVideo{width:100%;height:100%;object-fit:cover}
#rewardSkip{position:absolute;bottom:28px;right:28px;background:rgba(0,0,0,0.7);border:2px solid rgba(255,255,255,0.5);color:#fff;padding:10px 22px;border-radius:20px;cursor:pointer;font-size:0.85em;z-index:10000;}
#rewardTitle{position:absolute;top:28px;left:50%;transform:translateX(-50%);color:#ffd700;font-size:1.3em;font-weight:700;text-shadow:0 0 20px rgba(255,215,0,0.8);text-align:center;white-space:nowrap}
/* ── Section récompenses ── */
#rewardsSection{margin-top:10px}
#rewardsToggle{background:none;border:1px solid #ffd70055;color:#ffd700;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:0.85em;margin-bottom:8px}
.reward-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.04)}
.reward-item.ri-locked{opacity:0.45}
.ri-icon{font-size:1.4em}
.ri-info{flex:1}
.ri-title{font-weight:600;font-size:0.9em}
.ri-sub{font-size:0.75em;color:#aaa}
.btn2{background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;color:#000;padding:6px 14px;border-radius:8px;cursor:pointer;font-size:0.8em;font-weight:700}

</style>
<style>
#authGate{position:fixed;inset:0;z-index:2000;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 15% 15%,#00d4ff22,transparent 35%),radial-gradient(circle at 85% 85%,#ffd70022,transparent 40%),linear-gradient(135deg,#02060f,#101f3f)}
#authCard{max-width:560px;width:min(92vw,560px)}
#authTitle{font-family:Orbitron,monospace;background:linear-gradient(135deg,#00d4ff,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0 0 8px}
#hubScreen{display:none}
</style>
<style>
.fronton{margin-top:10px}
.frontonHead{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
.frontonTitle{font-family:Orbitron,monospace;color:#ffd700;font-size:1.02rem}
.frontonSub{color:#d4e3f7;font-size:.95rem}
.frontonGrid{display:grid;grid-template-columns:repeat(3,minmax(220px,1fr));gap:10px}
.frontonCol{border-radius:12px;padding:12px;border:1px solid #ffffff40;box-shadow:0 8px 20px #00000030}
.frontonCol h3{margin:0 0 6px;font-size:1.1rem;color:inherit}
.frontonCol p{margin:0 0 10px;font-size:.93rem}
.frontonBlue{background:linear-gradient(140deg,#0b4fd6,#3ab6ff);color:#fff}
.frontonWhite{background:linear-gradient(145deg,#f3f4f8,#ffffff);color:#0b1d3f;border:2px solid #d8dbe5}
.frontonRed{background:linear-gradient(140deg,#ab1228,#ff4c4c);color:#fff}
.frontonCol .rw{gap:6px}
.frontonCol .btn2{border-color:rgba(255,255,255,.45)}
.frontonWhite .btn2{color:#0b1d3f;border-color:#32496f66;background:#0b1d3f10}
.frontonPrimary{font-family:Orbitron,monospace;letter-spacing:.4px}
.frontonMain{transform:translateY(-2px);box-shadow:0 12px 24px #00000025}
@media (max-width:980px){.frontonGrid{grid-template-columns:1fr}.frontonMain{transform:none}}
</style></head>
<body>
<div id="introOverlay">
  <video id="introVideo" autoplay playsinline muted>
    <source src="Les Chevaliers du Collège Château Rance.mp4" type="video/mp4">
  </video>
  <button id="introSkip" onclick="skipIntro()">Passer ▶</button>
</div>

<div id="rewardOverlay">
  <video id="rewardVideo" playsinline>
    <source id="rewardVideoSrc" src="" type="video/mp4">
  </video>
  <div id="rewardTitle"></div>
  <button id="rewardSkip" onclick="closeReward()">Passer ▶</button>
</div>

<div id="authGate">
  <article id="authCard" class="card">
    <div class="tag">AUTHENTIFICATION</div>
    <h2 id="authTitle">Portail Vie Scolaire</h2>
    <p class="hint">Identifie-toi pour acceder au hub et relier toutes les actions a ton compte.</p>
    <div class="row"><label for="authCode">Identifiant joueur</label><input id="authCode" placeholder="Code joueur"></div>
    <div class="row"><label for="authAdmin">Acces admin (CPE)</label><input id="authAdmin" type="password" placeholder="Identifiant admin"></div>
    <div class="hint">Code visiteur demonstration: Visiteur-Viescolaire-ChateauRance</div>
    <div class="rw" style="margin-top:8px">
      <button onclick="loginPlayer()">Entrer dans le Hub</button>
      <button class="btn2" onclick="loginAdmin()">Entrer en mode admin</button>
      <button class="btn2" onclick="fillVisitorCode()">Acces visiteur</button>
    </div>
    <div class="msg" id="authMsg"></div>
  </article>
</div>

<div id="hubScreen">
<div class="wrap">
<header>
<div class="tag">GAME DESIGN SOCIAL</div>
<h1>Portail Vie Scolaire</h1>
<div class="sub">SuperHub central: PIXHARe + PSC1 + Videos + missions citoyennes + fronton Liberte / Egalite / Fraternite.</div>
<div class="alert">Liaison stricte par ligne: Code Joueur (col.3) <-> Code Temoin (col.4).</div>
</header>

<section class="grid2">
<article class="card">
<h2>Session Joueur</h2>
<div class="hint" id="loginHint">Session verrouillee. Authentification requise.</div>
<div class="rw">
  <button class="btn2" onclick="openAuthGate()">Changer d'identifiant</button>
  <button class="btn2" onclick="logoutPlayer()">Verrouiller session</button>
</div>
<div class="msg" id="loginMsg"></div>
<div class="row"><label for="playerBackupFile">Importer ma sauvegarde (.csv)</label><input id="playerBackupFile" type="file" accept=".csv,text/csv"></div>
<div class="rw"><button class="btn2" onclick="downloadPlayerBackup()">Telecharger ma sauvegarde</button><button class="btn2" onclick="importPlayerBackup()">Importer ma sauvegarde</button></div>
<div class="hint">Portable: conserve ton profil joueur pour changer de poste.</div>
<div class="msg" id="pbMsg"></div>
<div class="profile" id="profile">
<div>Profil actif: <b id="pCode"></b></div>
<div class="hint">Statut: <span id="pRole"></span></div>
<div class="stats">
<div class="stat"><div class="k">XP Global</div><div class="v" id="pXg">0</div></div>
<div class="stat"><div class="k">XP Hebdo</div><div class="v" id="pXw">0</div></div>
<div class="stat"><div class="k">Citoyen</div><div class="v" id="pCit">0</div></div>
<div class="stat"><div class="k">Academie</div><div class="v" id="pAca">0</div></div>
<div class="stat"><div class="k">Videos</div><div class="v" id="pVid">0</div></div>
<div class="stat"><div class="k">Social attente</div><div class="v" id="pPend">0</div></div>
<div class="stat"><div class="k">CP Total</div><div class="v" id="pCp">0</div></div><div class="stat"><div class="k">Coeff Académie</div><div class="v" id="pAcadCoeff" style="color:#ffd700;font-size:0.85em">×1,00</div></div><div class="stat"><div class="k">XP Final ×coeff</div><div class="v" id="pXgFinal" style="color:#4fc3f7">0</div></div>
</div>
</div>
</article>

<article class="card">
<h2>Action Temoin</h2>
<div style="background:rgba(255,152,0,0.08);border:1px solid rgba(255,152,0,0.3);border-radius:8px;padding:10px;margin-bottom:12px;font-size:0.78em;line-height:1.7">
  <b>📜 Engagement moral du temoin :</b> En soumettant ce temoignage, tu certifies que l'action a <b>reellement eu lieu</b>.<br>
  <span style="color:#ff9800">⚠ Faux temoignage = convocation + minimum -500 XP (double pour actions majeures).</span><br>
  <span style="color:#aaa">🎫 Limite : <b id="jetonCount">3 jetons</b>/semaine &mdash; au-dela, tu es convoque(e) pour argumenter.</span>
</div>
<div class="row"><label for="wCode">Code temoin (col.4)</label><input id="wCode" placeholder="Ton code temoin officiel" oninput="updateJetonDisplay()"></div>
<div class="row"><label for="tCode">Code public cible (col.5 ou code public)</label><input id="tCode" placeholder="Code public du camarade"></div>
<div class="row"><label for="aType">Action</label><select id="aType"></select></div>
<div class="row">
  <label for="wDesc">Description de l'action <span style="color:#aaa;font-weight:normal">(obligatoire)</span></label>
  <textarea id="wDesc" rows="2" placeholder="Decris precisement ce que tu as vu : quand, ou, comment..." style="width:100%;padding:8px;background:#1a1a2e;border:1px solid #444;color:#e8e8e8;border-radius:6px;resize:vertical;font-size:0.85em"></textarea>
</div>
<button id="btnWitnessSend" onclick="witnessAction()">Envoyer XP</button>
<div class="msg" id="wMsg"></div>
<div class="rw" style="margin-top:10px"><button id="btnNegHub" class="btnNuclear" onclick="openNegativeHub()">Lancement alerte rouge: temoignages de faits negatifs</button></div>
</article>
</section>

<section class="card fronton" id="frontonRepublicain">
<div class="frontonHead">
<div class="frontonTitle">Fronton Republicain</div>
<div class="frontonSub">Trois axes structurants du portail: Liberte, Egalite, Fraternite.</div>
</div>
<div class="frontonGrid">
<article class="frontonCol frontonBlue">
<h3>Liberte</h3>
<p>Modules autour des droits, de l'expression et de l'esprit critique.</p>
<div class="rw">
<button class="btn2 frontonPrimary" onclick="openTracked('theme','LIBERTE_HUB','hub_en_construction.html')">Ouvrir le Hub Liberte</button>
</div>
</article>
<article class="frontonCol frontonWhite frontonMain">
<h3>Egalite</h3>
<p>Egalite filles-garcons et lutte contre les stereotypes: axe prioritaire actuel.</p>
<div class="rw">
<button id="btnPixEgalite" class="frontonPrimary" onclick="openTracked('theme','PIX_EGALITE_HUB','index_PIX_Egalite.html')">Entrer dans EGALITE !</button>
<button class="btn2" onclick="openTracked('theme','PIX_EGALITE_HUB','index_PIX_Egalite.html')">Module principal</button>
</div>
</article>
<article class="frontonCol frontonRed">
<h3>Fraternite</h3>
<p>Cooperation, solidarite, entraide et projets collectifs.</p>
<div class="rw">
<button class="btn2 frontonPrimary" onclick="openTracked('theme','FRATERNITE_HUB','hub_en_construction.html')">Ouvrir le Hub Fraternite</button>
</div>
</article>
</div>
</section>

<section class="card" style="margin-top:10px">
<div class="rw" style="justify-content:space-between;align-items:center">
<h2>Hall des Heros - Top 10</h2>
<div class="tabs"><button class="tab on" id="tg" onclick="switchHall('global')">Global</button><button class="tab" id="tw" onclick="switchHall('week')">Hebdo</button></div>
</div>
<table>
<thead><tr><th>#</th><th>Code</th><th>Statut</th><th>CP</th><th id="scoreHead">XP Global</th></tr></thead>
<tbody id="hall"></tbody>
</table>
<div class="hint" id="hallMeta"></div>
</section>

<section class="card" style="margin-top:10px">
<h2 style="margin-bottom:10px">Academie</h2>
<div class="grid3">
<article class="card">
<h3 style="color:#ffd700">pHARe</h3>
<p class="hint" style="margin:0 0 8px">Anti-harcelement & securite scolaire.</p>
<div class="rw"><button id="btnPixhare" onclick="openTracked('academy','PIXHARE_HUB','index_PIXHARe.html')">PIXHARe pHARe</button></div>
<div class="rw" style="margin-top:8px"><button id="btnVideos" onclick="openTracked('academy','VIDEO_HUB','hub_videos.html')">Hub Videos</button><button id="btnNeocities" onclick="openTracked('external','NEOCITIES_HUB','https://cpebru.neocities.org/cpebru_hub_index%20%283%29')">Neocities</button></div>
<div class="rw" style="margin-top:8px"><button class="btn2" onclick="syncPixhare()">Importer CP PIXHARe</button></div>
</article>
<article class="card">
<h3 style="color:#ffd700">Delegues</h3>
<p class="hint" style="margin:0 0 8px">Formation, missions et ressources des delegues de classe.</p>
<div class="rw"><button onclick="openTracked('academy','DELEGUES_HUB','index_PIX_DELEGUES.html')">Hub Delegues (AGORA)</button></div>
<div style="margin-top:10px"><p class="hint" style="margin:0 0 6px;font-weight:700">Playlist de formation :</p>
<div style="display:flex;flex-direction:column;gap:6px">
<button class="btn2" onclick="openTracked('external','DEL_VIDEO_1','https://www.youtube.com/watch?v=ynpYOmwtLUk&list=PLd8i04wGCdrlHiCKsTCaC_Ci4Dk9LXCBF')">▶ Vid.1 — Role du delegue</button>
<button class="btn2" onclick="openTracked('external','DEL_VIDEO_2','https://www.youtube.com/watch?v=a0KH9HIe5ws&list=PLd8i04wGCdrlHiCKsTCaC_Ci4Dk9LXCBF&index=2')">▶ Vid.2 — Instances scolaires</button>
<button class="btn2" onclick="openTracked('external','DEL_VIDEO_3','https://www.youtube.com/watch?v=E0PcTuCYFr4&list=PLd8i04wGCdrlHiCKsTCaC_Ci4Dk9LXCBF&index=3')">▶ Vid.3 — Prise de parole</button>
</div></div>
</article>
<article class="card">
<h3 style="color:#ffd700">Cadets de la Securite</h3>
<p class="hint" style="margin:0 0 8px">Formation securite civile et citoyennete active.</p>
<div class="rw"><button class="btn2" onclick="openTracked('academy','CADETS_HUB','hub_en_construction.html')">Hub Cadets (bientot)</button><button id="btnPsc1" onclick="openTracked('academy','PSC1_HUB','index_PSC1.html')">PIX_Like PSC1</button></div>
<div class="rw" style="margin-top:8px"><button class="btn2" onclick="syncPsc1()">Importer CP PSC1</button></div>
<div style="margin-top:10px"><p class="hint" style="margin:0 0 6px;font-weight:700">Video de formation :</p>
<div style="display:flex;flex-direction:column;gap:6px">
<button class="btn2" onclick="openTracked('external','CAD_VIDEO_1','https://www.youtube.com/watch?v=SOOkiQeGskU&t=1s')">&#9654; Vid.1 &#8212; Formation Cadets securite</button>
</div></div>
</article>
</div>
<div class="msg" id="sMsg"></div><div class="msg" id="vMsg"></div>
</section>

<section class="grid2" style="margin-top:10px">
<article class="card"><h3>Regles</h3><p class="hint">1) Couple joueur/temoin fixe par referentiel.</p><p class="hint">2) Bonus temoin conditionnel.</p><p class="hint">3) Grades citoyens = admin only.</p></article>
<article class="card"><h3>Referentiel</h3><p class="hint" id="codesInfo">Referentiel codes: non charge.</p><p class="hint" id="syncInfo">Sync serveur: verification...</p></article>
</section>

<section class="grid2" style="margin-top:10px">
<article class="card"><h3>Journal</h3><div class="mini"><table><thead><tr><th>Date</th><th>Joueur</th><th>Type</th><th>Cible</th><th>XP</th></tr></thead><tbody id="logBody"></tbody></table></div></article>
<article class="card"><h3>Popularite</h3><table><thead><tr><th>Cible</th><th>Ouvertures</th><th>Validations</th></tr></thead><tbody id="popBody"></tbody></table></article>
</section>

<section class="card" id="adminConsole" style="margin-top:10px;display:none">
<h2>Console Admin</h2>
<div class="hint" id="adminHint">Mode admin actif.</div>
<div id="adminBlock" style="display:block">
<div class="row"><label for="codesFile">Importer referentiel TSV/CSV</label><input id="codesFile" type="file" accept=".tsv,.csv,text/tab-separated-values,text/csv"></div>
<div class="rw"><button class="btn2" onclick="importCodesFile()">Importer fichier codes</button><button class="btn2" onclick="loadDefaultCodes(true)">Charger students.csv</button></div>
<div class="row"><label for="adultFile">Importer temoins adultes (TSV/CSV)</label><input id="adultFile" type="file" accept=".tsv,.csv,text/tab-separated-values,text/csv"></div>
<div class="rw"><button class="btn2" onclick="importAdultFile()">Importer temoins adultes</button><button class="btn2" onclick="loadDefaultAdults(true)">Charger adults.csv</button></div>
<div class="row"><label for="parentFile">Importer comptes parents (TSV/CSV)</label><input id="parentFile" type="file" accept=".tsv,.csv,text/tab-separated-values,text/csv"></div>
<div class="rw"><button class="btn2" onclick="importParentFile()">Importer comptes parents</button><button class="btn2" onclick="loadDefaultParents(true)">Charger parents.csv</button></div>
<div class="grid3" style="margin-top:8px">
<div class="card"><h3>CP / Academie</h3><div class="row"><label for="adCode">Code eleve</label><input id="adCode"></div><div class="row"><label for="adHub">Hub CP</label><select id="adHub"><option value="pixhare">PIXHARe</option><option value="psc1">PSC1</option><option value="sanctuaire">Sanctuaire</option><option value="loge">Loge</option><option value="autres">Autres</option></select></div><div class="row"><label for="adCp">Valeur</label><input id="adCp" type="number" min="0" step="1" value="1"></div><div class="rw"><button onclick="setCp()">Definir CP</button><button class="btn2" onclick="addCp()">Ajouter CP</button></div></div>
<div class="card"><h3>Malus</h3><div class="row"><label for="malType">Regulation</label><select id="malType"></select></div><button class="btnBad" onclick="applyMalus()">Appliquer malus</button></div>
<div class="card"><h3>Sauvegardes</h3><div class="row"><label for="jsonBox">JSON</label><textarea id="jsonBox"></textarea></div><div class="rw"><button class="btn2" onclick="exportData()">Exporter JSON</button><button class="btn2" onclick="importData()">Importer JSON</button><button class="btn2" onclick="downloadCsv()">Telecharger CSV</button><button class="btn2" onclick="downloadLogsCsv()">Telecharger logs CSV</button><button class="btn2" onclick="syncPull(true)">Sync pull</button><button class="btn2" onclick="syncPush(true)">Sync push</button><button onclick="sbPullAllPlayers(true)">&#9729; Pull tous les joueurs</button><button onclick="sbPushGlobal(true)">&#9729; Push config</button></div><div class="row"><label for="stateFile">Snapshot global (.json)</label><input id="stateFile" type="file" accept=".json,application/json"></div><div class="rw"><button class="btn2" onclick="downloadStateFile()">Telecharger snapshot global</button><button class="btn2" onclick="importStateFile()">Importer snapshot global</button></div></div>
</div>
<h3 style="margin-top:10px">Missions Citoyennes (admin)</h3>
<div id="missionAdmin" class="grid3"></div>
<h3 style="margin-top:10px">Pre-temoignages Positifs</h3>
<div class="mini"><table><thead><tr><th>Date</th><th>1er Temoin</th><th>2e Temoin</th><th>Cible</th><th>Action</th><th>Statut</th><th>Action admin</th></tr></thead><tbody id="posBody"></tbody></table></div>
<h3 style="margin-top:10px">Pre-signalements Negatifs</h3>
<div class="mini"><table><thead><tr><th>Date</th><th>Temoin</th><th>Cible</th><th>Fait</th><th>Statut</th><th>Action</th></tr></thead><tbody id="negBody"></tbody></table></div>
<div class="msg" id="aMsg"></div>
</div>
</section>

<!-- ══════════════════════════════════════════════ -->
<!-- HUB ACADÉMIQUE — Français & Mathématiques     -->
<!-- Pour ajouter des modules : éditer ACAD_REGISTRY dans le JS ci-dessus -->
<!-- ══════════════════════════════════════════════ -->
<section class="card" id="acadHub" style="margin-top:18px">
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:4px">
  <h2 style="margin:0">📚 Hub Académique</h2>
  <span style="font-size:0.7em;color:#aaa">Français · Mathématiques · 6e → 3e</span>
</div>
<p class="hint" style="margin:0 0 10px">Ces modules renforcent les axes prioritaires du projet d'établissement.<br>
Ils ne donnent <b>pas de points directs</b>, mais chaque module accompli augmente ton <b>coefficient multiplicatif</b> XP de +2 % (plafonné à ×2,00).</p>

<div class="acad-coeff-bar">
  <span>🔬 Coefficient académique :</span>
  <span class="acad-coeff-val" id="acadCoeffDisp">×1,00</span>
  <span style="color:#888;font-size:0.85em">— tous tes XP citoyens sont multipliés par ce coefficient.</span>
</div>

<div class="acad-filters">
  <select id="acadFilterLevel" onchange="renderAcademie()">
    <option value="">Tous niveaux</option>
    <option value="6e">6e</option>
    <option value="5e">5e</option>
    <option value="4e">4e</option>
    <option value="3e">3e</option>
  </select>
  <select id="acadFilterSubj" onchange="renderAcademie()">
    <option value="">Toutes matières</option>
    <option value="Francais">📝 Français</option>
    <option value="Maths">🔢 Maths</option>
  </select>
</div>

<div class="acad-grid" id="acadGrid"></div>
<div class="msg" id="acadMsg"></div>
<p class="hint" style="margin-top:10px;border-top:1px solid #222;padding-top:8px">
  💡 <b>Pour ajouter des modules :</b> éditer le tableau <code>ACAD_REGISTRY</code> dans le code source du hub, puis créer le fichier HTML correspondant.
</p>
</section>



<!-- ══════════════════════════════════════════════ -->
<!-- SECTION ACADÉMIQUE                             -->
<!-- ══════════════════════════════════════════════ -->
<section class="card" id="acadSection" style="margin-top:10px">
<h2 style="margin-bottom:8px">📚 Académie du Collège — Français &amp; Mathématiques</h2>
<p class="hint" style="margin-bottom:10px">
  Ces modules entraînent ta maîtrise du français et des maths.<br>
  Chaque module réussi (≥60%) ajoute ×1,02 à tous tes XP citoyens — sans les remplacer.<br>
  <b id="acadCoeffDisplay" style="color:#ffd700"></b>
</p>

<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px" id="acadLevelTabs">
  <button class="tab on" onclick="acadFilter('6e',this)">6e</button>
  <button class="tab"    onclick="acadFilter('5e',this)">5e</button>
  <button class="tab"    onclick="acadFilter('4e',this)">4e</button>
  <button class="tab"    onclick="acadFilter('3e',this)">3e</button>
  <button class="tab"    onclick="acadFilter('all',this)">Tous</button>
  <span style="flex:1"></span>
  <button class="tab" onclick="acadFilter('fr',this)">📖 Français</button>
  <button class="tab" onclick="acadFilter('ma',this)">🔢 Maths</button>
</div>

<div id="acadGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px"></div>

<!-- Modale quiz -->
<div id="acadModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:2000;overflow-y:auto;padding:20px">
  <div style="max-width:600px;margin:0 auto;background:#1a1a2e;border:1px solid #444;border-radius:12px;padding:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <h3 id="quizTitle" style="color:#ffd700;font-size:1em"></h3>
      <button onclick="closeAcadQuiz()" style="background:rgba(255,255,255,0.1);border:1px solid #555;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer">✕</button>
    </div>
    <div id="quizProgress" style="font-size:0.75em;color:#aaa;margin-bottom:10px"></div>
    <div id="quizBar" style="height:4px;background:#333;border-radius:2px;margin-bottom:16px">
      <div id="quizBarFill" style="height:100%;background:#ffd700;border-radius:2px;transition:width 0.3s"></div>
    </div>
    <div id="quizQuestion" style="font-size:0.95em;color:#e8e8e8;margin-bottom:16px;line-height:1.6"></div>
    <div id="quizChoices" style="display:flex;flex-direction:column;gap:8px"></div>
    <div id="quizExpl" style="display:none;margin-top:12px;padding:10px;background:rgba(255,215,0,0.08);border-left:3px solid #ffd700;border-radius:4px;font-size:0.82em;color:#ccc;line-height:1.6"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
      <div id="quizScore" style="font-size:0.78em;color:#aaa"></div>
      <button id="quizNext" onclick="acadNextQ()" style="display:none;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;border:none;padding:8px 18px;border-radius:4px;cursor:pointer;font-weight:600">Suivant →</button>
    </div>
  </div>
</div>

</section>

<script>
// ── État quiz ──
let _qMod=null,_qIdx=0,_qScore=0,_qAnswered=false,_qLevelFilter='6e',_qMatiereFilter='all';

function acadFilter(val,btn){
  if(['6e','5e','4e','3e','all'].includes(val)){
    _qLevelFilter=val;
    document.querySelectorAll('#acadLevelTabs .tab').forEach(b=>{
      if(['6e','5e','4e','3e','all'].includes(b.textContent.trim()))b.classList.remove('on');
    });
  } else {
    _qMatiereFilter=val==='all'?'all':val;
    document.querySelectorAll('#acadLevelTabs .tab').forEach(b=>{
      if(['📖 Français','🔢 Maths'].includes(b.textContent.trim()))b.classList.remove('on');
    });
  }
  btn.classList.add('on');
  renderAcadGrid();
}

function renderAcadGrid(){
  const b=document.getElementById('acadGrid');if(!b)return;
  const p=cur?S.players[cur]:null;
  const done=p?(p.acadDone||{}):{};
  const coeff=p?acadCoeff(p):1;
  const nb=acadDoneCount(p||{});

  const dispEl=document.getElementById('acadCoeffDisplay');
  if(dispEl){
    if(nb>0)dispEl.textContent=`🎓 Modules réussis : ${nb} — Coefficient actuel : ×${coeff.toFixed(2)} — XP final : ${p?xgFinal(p):'—'}`;
    else dispEl.textContent='Commence un module pour débloquer ton coefficient multiplicatif !';
  }

  const mods=ACAD_MODULES.filter(m=>{
    const lvl=_qLevelFilter==='all'||m.niveau===_qLevelFilter;
    const mat=_qMatiereFilter==='all'||m.matiere===_qMatiereFilter;
    return lvl&&mat;
  });

  b.innerHTML='';
  if(!mods.length){b.innerHTML='<div style="color:#aaa;font-size:0.8em">Aucun module pour ces filtres.</div>';return;}

  mods.forEach(m=>{
    const d=done[m.id];
    const passed=!!d;
    const card=document.createElement('div');
    card.style.cssText='background:rgba(255,255,255,0.05);border:1px solid '+(passed?'rgba(80,220,80,0.4)':'rgba(255,255,255,0.15)')+';border-radius:8px;padding:10px;cursor:'+(passed&&cur?'default':'pointer')+';transition:border-color 0.2s;position:relative';
    const niv=`<span style="font-size:0.65em;background:rgba(255,215,0,0.15);color:#ffd700;padding:2px 6px;border-radius:3px;margin-right:4px">${m.niveau}</span>`;
    const mat=`<span style="font-size:0.65em;background:rgba(255,255,255,0.08);color:#aaa;padding:2px 6px;border-radius:3px">${m.matiere==='fr'?'Français':'Maths'}</span>`;
    const badge=passed?'<span style="position:absolute;top:6px;right:8px;font-size:0.7em;color:#4CAF50">✓ Réussi</span>':'';
    card.innerHTML=`${badge}<div style="font-size:1.3em;margin-bottom:4px">${m.icone}</div><div style="margin-bottom:5px">${niv}${mat}</div><div style="font-size:0.82em;font-weight:600;color:${passed?'#4CAF50':'#e8e8e8'};line-height:1.4">${m.titre}</div><div style="font-size:0.7em;color:#888;margin-top:4px">${m.questions.length} questions · ×1,02 si ≥60%</div>`;
    if(!passed||!cur){
      card.onclick=()=>startAcadQuiz(m.id);
      card.onmouseenter=()=>{if(!passed)card.style.borderColor='rgba(255,215,0,0.4)';};
      card.onmouseleave=()=>{if(!passed)card.style.borderColor='rgba(255,255,255,0.15)';};
    }
    b.appendChild(card);
  });
}

function startAcadQuiz(id){
  if(!cur&&!isVisitor){
    alert('Connecte-toi pour enregistrer ta progression.');return;
  }
  _qMod=ACAD_MODULES.find(m=>m.id===id);
  if(!_qMod)return;
  _qIdx=0;_qScore=0;_qAnswered=false;
  document.getElementById('quizTitle').textContent=_qMod.icone+' '+_qMod.titre+' ('+_qMod.niveau+')';
  document.getElementById('acadModal').style.display='block';
  document.body.style.overflow='hidden';
  showAcadQ();
}

function showAcadQ(){
  if(!_qMod)return;
  const q=_qMod.questions[_qIdx];
  const total=_qMod.questions.length;
  _qAnswered=false;
  document.getElementById('quizProgress').textContent=`Question ${_qIdx+1} / ${total}`;
  document.getElementById('quizBarFill').style.width=((_qIdx/total)*100)+'%';
  document.getElementById('quizQuestion').textContent=q.q;
  document.getElementById('quizExpl').style.display='none';
  document.getElementById('quizNext').style.display='none';
  document.getElementById('quizScore').textContent=`Score : ${_qScore}/${_qIdx}`;
  const cc=document.getElementById('quizChoices');cc.innerHTML='';
  q.choices.forEach((c,i)=>{
    const btn=document.createElement('button');
    btn.textContent=c;
    btn.style.cssText='background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.2);color:#e8e8e8;padding:10px 14px;border-radius:6px;cursor:pointer;text-align:left;font-size:0.88em;transition:background 0.15s';
    btn.onclick=()=>answerAcad(i,btn,q);
    btn.onmouseenter=()=>{if(!_qAnswered)btn.style.background='rgba(255,215,0,0.12)';};
    btn.onmouseleave=()=>{if(!_qAnswered)btn.style.background='rgba(255,255,255,0.07)';};
    cc.appendChild(btn);
  });
}

function answerAcad(i,btn,q){
  if(_qAnswered)return;
  _qAnswered=true;
  const correct=i===q.ans;
  if(correct)_qScore++;
  document.querySelectorAll('#quizChoices button').forEach((b,idx)=>{
    b.style.cursor='default';
    if(idx===q.ans)b.style.background='rgba(76,175,80,0.3)',b.style.borderColor='#4CAF50';
    else if(idx===i&&!correct)b.style.background='rgba(244,67,54,0.3)',b.style.borderColor='#f44336';
    b.onmouseenter=null;b.onmouseleave=null;
  });
  const explEl=document.getElementById('quizExpl');
  explEl.textContent='💡 '+q.expl;explEl.style.display='block';
  document.getElementById('quizScore').textContent=`Score : ${_qScore}/${_qIdx+1}`;
  document.getElementById('quizNext').style.display='block';
  document.getElementById('quizNext').textContent=_qIdx<_qMod.questions.length-1?'Suivant →':'Terminer ✓';
}

function acadNextQ(){
  _qIdx++;
  if(_qIdx<_qMod.questions.length){showAcadQ();return;}
  // Fin du quiz
  const total=_qMod.questions.length;
  const pct=_qScore/total;
  const passed=pct>=ACAD_PASS_RATE;
  const cc=document.getElementById('quizChoices');cc.innerHTML='';
  document.getElementById('quizExpl').style.display='none';
  document.getElementById('quizNext').style.display='none';
  document.getElementById('quizBarFill').style.width='100%';
  document.getElementById('quizProgress').textContent='Module terminé';
  document.getElementById('quizQuestion').innerHTML=
    `<div style="text-align:center;padding:20px 0">
      <div style="font-size:2.5em;margin-bottom:10px">${passed?'🏆':'😕'}</div>
      <div style="font-size:1.2em;color:${passed?'#4CAF50':'#ff9800'};font-weight:600;margin-bottom:8px">${passed?'Module réussi !':'Pas tout à fait…'}</div>
      <div style="font-size:0.85em;color:#aaa">Score : <b style="color:#fff">${_qScore} / ${total}</b> (${Math.round(pct*100)}%)</div>
      <div style="font-size:0.75em;color:#888;margin-top:6px">${passed?`Coefficient mis à jour !`:`Il faut ≥${Math.round(ACAD_PASS_RATE*100)}% pour valider. Tu peux réessayer.`}</div>
    </div>`;
  document.getElementById('quizScore').textContent='';

  if(passed&&cur&&!isVisitor){
    const p=S.players[cur];if(!p)return;
    if(!p.acadDone)p.acadDone={};
    if(!p.acadDone[_qMod.id]){
      p.acadDone[_qMod.id]=new Date().toISOString();
      logEv(cur,'ACAD_DONE',_qMod.id,0);
      save();refresh();
    }
  }

  // Bouton fermer/rejouer
  const actions=document.createElement('div');actions.style.cssText='display:flex;gap:8px;justify-content:center;margin-top:16px';
  const btnClose=document.createElement('button');btnClose.textContent='Retour aux modules';btnClose.style.cssText='background:rgba(255,255,255,0.1);border:1px solid #555;color:#fff;padding:8px 14px;border-radius:4px;cursor:pointer';btnClose.onclick=closeAcadQuiz;
  if(!passed){
    const btnRetry=document.createElement('button');btnRetry.textContent='↩ Réessayer';btnRetry.style.cssText='background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;font-weight:600';btnRetry.onclick=()=>startAcadQuiz(_qMod.id);
    actions.appendChild(btnRetry);
  }
  actions.appendChild(btnClose);
  cc.appendChild(actions);
}

function closeAcadQuiz(){
  document.getElementById('acadModal').style.display='none';
  document.body.style.overflow='';
  renderAcadGrid();
}

// Initialisation
document.addEventListener('DOMContentLoaded',()=>{renderAcadGrid();});
</script>

<div id="quickTabs" style="position:fixed;right:12px;bottom:12px;z-index:1400;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;max-width:680px">
  <button id="tutorialTab" class="btn2" onclick="openTutorial()">Guide didacticiel</button>
  <button id="visitorArticleTab" class="btn2" style="display:none" onclick="openVisitorArticle()">Article visiteur</button>
  <button id="rulesTab" class="btn2" onclick="openRules()">Regles et bareme</button>
</div>
<div id="audioDock" class="audioDock">
  <div class="rw" style="justify-content:space-between;align-items:center">
    <b style="font-family:Orbitron,monospace;color:#ffd700">Ambiance</b>
    <button id="audioToggle" class="btn2" onclick="toggleAudio()">Lancer</button>
  </div>
  <div class="row" style="margin-top:6px">
    <label for="audioVol">Volume</label>
    <input id="audioVol" type="range" min="0" max="100" step="1" value="35">
  </div>
  <div class="hint" id="audioInfo">Piste: Tous Ensemble Aujourd'hui.mp3</div>
  <audio id="bgAudio" preload="none" loop></audio>
</div>
<div id="rulesModal" style="display:none;position:fixed;inset:0;z-index:1500;background:#000000bb;padding:16px;overflow:auto">
  <div class="card" style="max-width:860px;margin:auto">
    <h2>Regles du Jeu - Portail Vie Scolaire</h2>
    <p class="hint">1) Chaque eleve est identifie par sa ligne officielle: Code Joueur (secret), Code Temoin (secret) et Code Public.</p>
    <p class="hint">2) Les temoignages eleves donnent les points complets.</p>
    <p class="hint">3) Les temoignages adultes donnent 2x moins de points.</p>
    <p class="hint">4) Le bonus temoin eleve = 10% de l'action, seulement s'il a deja ete reconnu au moins 1 fois.</p>
    <p class="hint">5) Les XP sociaux d'un eleve ne sont valides que s'il a temoigne au moins 1 fois.</p>
    <p class="hint">6) Faux temoignage: sanction possible de -500 XP et convocation CPE.</p>
    <h3 style="margin-top:8px">Bareme principal</h3>
    <p class="hint">Tutorat +100 | Mediation +150 | Ramassage +40 | Soutien +120 | Creation +200</p>
    <p class="hint">Grades citoyens admin: CA +500 | Cadet +450 | Ambassadeur +400 | Delegue +350 | Eco-delegue +300</p>
    <p class="hint">Malus: Incivilite -50 | Agressivite -150 | Degradation -300 | Reset total</p>
    <div class="rw" style="margin-top:10px"><button onclick="closeRules()">Fermer</button></div>
  </div>
</div>
<div id="visitorModal" style="display:none;position:fixed;inset:0;z-index:1510;background:#000000d1;padding:16px;overflow:auto">
  <div class="card" style="max-width:980px;margin:auto">
    <div class="rw" style="justify-content:space-between;align-items:center">
      <h2>Demonstrateur Visiteur - Ingenierie de la Bienveillance</h2>
      <button class="btn2" onclick="closeVisitorArticle()">X</button>
    </div>
    <div class="hint">Cette fenetre est reservee au mode visiteur.</div>
    <div style="margin-top:10px;max-height:72vh;overflow:auto;padding-right:4px">
      <p class="hint"><b>L'Ingenierie de la Bienveillance en Milieu Scolaire : Ecosysteme, Autorite Reparatrice et Motivation Prosociale</b></p>
      <p class="hint"><b>Resume :</b> Face a la montee de l'agressivite reactive, la simple injonction morale montre ses limites. Cet article presente la modelisation d'un "ecosysteme prosocial auto-entretenu" (le Super-Hub). En croisant la neurobiologie fonctionnelle (Favre), l'ethique de la sanction (Prairat), l'approche systemique du climat scolaire (Condette) et le game design, ce dispositif transforme le college en un espace ou la bienveillance devient une norme structurellement gratifiante.</p>
      <p class="hint"><b>1. L'etablissement comme ecosysteme vivant et l'ingenierie du climat scolaire</b><br>Historiquement, la gestion du climat scolaire repose sur une approche bureaucratique. Or, les travaux de Sylvie Condette montrent qu'un etablissement doit etre pense comme un systeme vivant d'interactions multiples ou chaque acteur contribue a une dynamique d'ensemble. Dans cette perspective, le role du CPE n'est plus celui d'un simple regulateur disciplinaire, mais celui d'un architecte des interdependances. Le Super-Hub rend visibles et interconnectes les engagements de chacun.</p>
      <p class="hint"><b>2. Neurobiologie de la motivation : du renforcement extrinseque a la joie intrinseque</b><br>L'usage de la gamification (XP, niveaux) peut faire craindre une derive purement behavioriste. Les travaux de Daniel Favre rappellent la limite des recompenses externes lorsqu'elles ecrasent la motivation intrinseque. Ici, l'XP sert d'etayage transitionnel : elle attire d'abord, puis l'experience sociale positive (entraide, reconnaissance) devient la vraie source de motivation durable.</p>
      <p class="hint"><b>3. Autorite educative et quetes de redemption</b><br>Pour Eirick Prairat, une autorite juste est une autorite qui autorise a grandir. Dans le Super-Hub, les comportements negatifs ne sont pas exposes publiquement; ils sont arbitres par le CPE. La sanction peut s'accompagner d'une quete de redemption afin de reintegrer l'eleve dans la communaute.</p>
      <p class="hint"><b>4. Preuve sociale et mediation par les pairs</b><br>La valorisation passe par un tiers: l'eleve ne s'auto-attribue pas des points. Un temoin (eleve ou adulte) reconnait l'action. Ce mecanisme favorise la vigilance prosociale, la mediation horizontale et la diffusion d'une norme collective positive.</p>
      <p class="hint"><b>5. Briser le cycle frustration-agression</b><br>L'agressivite reactive nait souvent du sentiment d'impuissance. Le projet integre aussi des leviers environnementaux (musique, creations eleves, rituels de progression) pour diminuer le stress et faciliter les comportements cooperatifs.</p>
      <p class="hint"><b>6. Conclusion</b><br>Le Super-Hub structure un cadre ou cooperation, mediation et bienveillance deviennent les strategies les plus logiques, les plus gratifiantes et les plus valorisantes.</p>
    </div>
  </div>
</div>
<div id="tutorialBubble" style="display:none;position:fixed;z-index:1520;max-width:360px;background:#101a35f2;border:1px solid #5ac8ff66;border-radius:12px;padding:10px;box-shadow:0 10px 30px #00000080">
  <div style="position:absolute;width:14px;height:14px;background:#101a35f2;border-left:1px solid #5ac8ff66;border-top:1px solid #5ac8ff66;transform:rotate(45deg);left:-8px;top:22px" id="tutorialArrow"></div>
  <div class="rw" style="justify-content:space-between;align-items:center">
    <h3 id="tutorialTitle" style="margin:0;color:#ffd700">Guide</h3>
    <button class="btn2" style="padding:4px 8px" onclick="closeTutorial()">X</button>
  </div>
  <div class="hint" id="tutorialText" style="margin-top:6px"></div>
  <div class="hint" id="tutorialTarget" style="margin-top:4px;font-size:.88rem"></div>
  <div class="rw" style="margin-top:10px;justify-content:space-between;align-items:center">
    <button class="btn2" onclick="prevTutorial()">Precedent</button>
    <span class="hint" id="tutorialPage">1/10</span>
    <button onclick="nextTutorial()">Suivant</button>
  </div>
</div>
</div>
</div>
<script src="videos_catalog.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const KEY='pvs_hof_v2',ACTIVE_PLAYER_KEY='pvs_current_player',BRIDGE_KEY='pvs_bridge_events',DEFAULT_CODES_FILE='students.csv',ADULT_DEFAULT_FILE='adults.csv',PARENT_DEFAULT_FILE='parents.csv',ADMIN_PASS='CPE59!-Chateau-70+',RULES_SEEN_KEY='pvs_rules_seen_v1',TUTORIAL_SEEN_KEY='pvs_tutorial_seen_v1',VISITOR_ARTICLE_SEEN_KEY='pvs_visitor_article_seen_v1',VISITOR_CODE='VISITEUR-VIESCOLAIRE-CHATEAURANCE',SESSION_AUTH_KEY='pvs_session_auth_v1',ADMIN_SESSION_KEY='pvs_admin_session_v1',SYNC_URL_KEY='pvs_sync_url',SYNC_REV_KEY='pvs_sync_rev',DEFAULT_SYNC_URL='http://127.0.0.1:8765',AUDIO_PREF_KEY='pvs_audio_pref_v1',AUDIO_VOL_KEY='pvs_audio_vol_v1',AUDIO_SOURCE_KEY='pvs_audio_source_v1';
const W={pixhare:60,psc1:60,sanctuaire:60,loge:60,autres:60};
const CIT={representant_ca:{title:'Representant CA',label:'Grand Stratege',xp:500},cadet:{title:'Cadet securite',label:'Gardien de la Cite',xp:450},ambassadeur:{title:'Ambassadeur pHARe',label:'Sentinelle de la Paix',xp:400},delegue:{title:'Delegue classe',label:'Porte-Voix',xp:350},eco_delegue:{title:'Eco-delegue',label:'Protecteur Nature',xp:300}};
const ACAD_REGISTRY=[{"id": "FR_6E_01", "level": "6e", "subject": "Francais", "icon": "📝", "title": "Grammaire et classes de mots", "file": "ACAD_FR_6e_01.html"}, {"id": "FR_6E_02", "level": "6e", "subject": "Francais", "icon": "📝", "title": "Conjugaison - Present et Passe compose", "file": "ACAD_FR_6e_02.html"}, {"id": "FR_5E_01", "level": "5e", "subject": "Francais", "icon": "📝", "title": "Propositions et subordonnees", "file": "ACAD_FR_5e_01.html"}, {"id": "FR_5E_02", "level": "5e", "subject": "Francais", "icon": "📝", "title": "Imparfait, Plus-que-parfait et figures de style", "file": "ACAD_FR_5e_02.html"}, {"id": "FR_4E_01", "level": "4e", "subject": "Francais", "icon": "📝", "title": "Argumentation et discours rapporte", "file": "ACAD_FR_4e_01.html"}, {"id": "FR_4E_02", "level": "4e", "subject": "Francais", "icon": "📝", "title": "Stylistique et analyse de texte", "file": "ACAD_FR_4e_02.html"}, {"id": "FR_3E_01", "level": "3e", "subject": "Francais", "icon": "📝", "title": "Brevet - Grammaire et syntaxe", "file": "ACAD_FR_3e_01.html"}, {"id": "FR_3E_02", "level": "3e", "subject": "Francais", "icon": "📝", "title": "Brevet - Analyse de texte", "file": "ACAD_FR_3e_02.html"}, {"id": "MATH_6E_01", "level": "6e", "subject": "Maths", "icon": "🔢", "title": "Fractions et proportionnalite", "file": "ACAD_MATH_6e_01.html"}, {"id": "MATH_6E_02", "level": "6e", "subject": "Maths", "icon": "🔢", "title": "Geometrie et priorites operatoires", "file": "ACAD_MATH_6e_02.html"}, {"id": "MATH_5E_01", "level": "5e", "subject": "Maths", "icon": "🔢", "title": "Pythagore et equations", "file": "ACAD_MATH_5e_01.html"}, {"id": "MATH_5E_02", "level": "5e", "subject": "Maths", "icon": "🔢", "title": "Statistiques et probabilites", "file": "ACAD_MATH_5e_02.html"}, {"id": "MATH_4E_01", "level": "4e", "subject": "Maths", "icon": "🔢", "title": "Fonctions lineaires et trigonometrie", "file": "ACAD_MATH_4e_01.html"}, {"id": "MATH_4E_02", "level": "4e", "subject": "Maths", "icon": "🔢", "title": "Racines carrees et puissances", "file": "ACAD_MATH_4e_02.html"}, {"id": "MATH_3E_01", "level": "3e", "subject": "Maths", "icon": "🔢", "title": "Thales et geometrie", "file": "ACAD_MATH_3e_01.html"}, {"id": "MATH_3E_02", "level": "3e", "subject": "Maths", "icon": "🔢", "title": "Brevet - Algebre et fonctions", "file": "ACAD_MATH_3e_02.html"}];
const ACT={tutorat:{l:'Tutorat / aide aux devoirs',x:100},mediation:{l:'Mediation de conflit',x:150},ramassage:{l:'Ramassage d ordures spontane',x:40},soutien:{l:'Soutien a un eleve isole',x:120},creation:{l:'Creation chanson / video NAH',x:200}};

// ══════════════════════════════════════════════════════════════════
// REGISTRE ACADÉMIQUE — ÉDITEZ ICI POUR AJOUTER DES MODULES
// ══════════════════════════════════════════════════════════════════
// Chaque module : { id (unique), titre, matiere ('fr'|'ma'), niveau ('6e'|'5e'|'4e'|'3e'),
//                  icone, questions:[{q, choices:[4], ans(0-3), expl}] }
// Seuil de réussite : 60% → coefficient +0.02 par module validé
// Coefficient global : 1 + n_validés × 0.02 (plafonné à +0.40 = ×1.40)
// ══════════════════════════════════════════════════════════════════
const ACAD_COEFF_STEP = 0.02;
const ACAD_COEFF_MAX  = 0.40;
const ACAD_PASS_RATE  = 0.60;

const ACAD_MODULES=[
{id:'fr6_gram1',titre:'Nature des mots',matiere:'fr',niveau:'6e',icone:'📖',questions:[
{q:"Quelle est la nature du mot « rapidement » ?",choices:["Adjectif","Adverbe","Verbe","Nom"],ans:1,expl:"Les mots en -ment formés sur un adjectif sont des adverbes."},
{q:"Dans « le chat noir dort », quelle est la nature de « noir » ?",choices:["Nom commun","Verbe","Adjectif qualificatif","Déterminant"],ans:2,expl:"Noir qualifie le nom chat → adjectif qualificatif."},
{q:"Quel est le déterminant dans « une belle fleur » ?",choices:["belle","une","fleur","une belle"],ans:1,expl:"L'article indéfini 'une' introduit le nom."},
{q:"Le mot « chanter » est un…",choices:["Nom","Adjectif","Verbe à l'infinitif","Pronom"],ans:2,expl:"Chanter est un verbe à l'infinitif."},
{q:"Quelle est la nature de « il » dans « il mange » ?",choices:["Déterminant","Pronom personnel","Nom","Adverbe"],ans:1,expl:"'Il' remplace un nom → pronom personnel sujet."},
{q:"Dans « cette maison », quel est le déterminant ?",choices:["maison","cette","la","de"],ans:1,expl:"'Cette' est un déterminant démonstratif."},
{q:"Quel mot est un nom commun ?",choices:["courir","grand","Paris","table"],ans:3,expl:"Table désigne un objet → nom commun."},
{q:"La conjonction de coordination qui relie deux propositions de cause est…",choices:["mais","ou","car","donc"],ans:2,expl:"Car indique la cause."},
]},
{id:'fr6_conj1',titre:'Présent de l\'indicatif',matiere:'fr',niveau:'6e',icone:'✏️',questions:[
{q:"Conjuguez 'aller' à la 1re personne du singulier au présent.",choices:["je vais","je vait","je vâ","j'alle"],ans:0,expl:"Aller est irrégulier : je vais."},
{q:"Conjuguez 'finir' à la 3e personne du pluriel au présent.",choices:["ils finissent","ils finissont","ils finisent","ils finis"],ans:0,expl:"Verbes en -ir (2e groupe) : ils finissent."},
{q:"Quelle terminaison pour 'vous' au présent (1er groupe) ?",choices:["-is","-ez","-ons","-ent"],ans:1,expl:"Vous chantez → terminaison -ez."},
{q:"Conjuguez 'être' à la 2e personne du singulier au présent.",choices:["tu était","tu est","tu es","tu ait"],ans:2,expl:"Être irrégulier : tu es."},
{q:"Conjuguez 'avoir' à la 1re personne du pluriel au présent.",choices:["nous avons","nous avez","nous ont","nous avont"],ans:0,expl:"Nous avons → terminaison -ons."},
{q:"Conjuguez 'prendre' à la 3e personne du singulier au présent.",choices:["il prens","il prent","il prend","il prende"],ans:2,expl:"Prendre irrégulier : il prend (sans s)."},
{q:"Bonne conjugaison de 'manger' à 'nous' au présent ?",choices:["nous mangons","nous mangeons","nous manges","nous mangez"],ans:1,expl:"Devant -ons, verbes en -ger gardent le e : mangeons."},
{q:"Quel pronom est toujours suivi de 'suis' au présent ?",choices:["tu","je","nous","il"],ans:1,expl:"Je suis → seule forme possible."},
]},
{id:'fr6_orth1',titre:'Orthographe — Accords',matiere:'fr',niveau:'6e',icone:'🔤',questions:[
{q:"Accordez : « des filles [intelligent_] »",choices:["intelligents","intelligentes","intelligent","intelligente"],ans:1,expl:"Filles = féminin pluriel → intelligentes."},
{q:"Choisissez : « les chats [noir/noirs] »",choices:["noir","noirs","noirt","noirrs"],ans:1,expl:"Chats = masculin pluriel → noirs."},
{q:"« Le garçon [est/et] parti. » Lequel convient ?",choices:["et","est","ai","ait"],ans:1,expl:"Est = verbe être. Et = conjonction."},
{q:"Participe passé de 'aimer' accordé avec 'elles' ?",choices:["aimé","aimés","aimée","aimées"],ans:3,expl:"Elles (féminin pluriel) → aimées."},
{q:"Quelle phrase est correctement orthographiée ?",choices:["Elle est partis","Elle est partie","Elle sont partie","Elles est parties"],ans:1,expl:"Elle (singulier féminin) → partie."},
{q:"Comment accorde-t-on 'tout' dans « [tout/toutes] les filles » ?",choices:["tout","toute","tous","toutes"],ans:3,expl:"Filles = féminin pluriel → toutes."},
{q:"Quelle est la bonne graphie : « il [a/à] mangé » ?",choices:["à","a","â","as"],ans:1,expl:"'A' = verbe avoir. 'À' = préposition."},
{q:"Accordez : « des arbres [vert_] »",choices:["vert","verte","verts","vertes"],ans:2,expl:"Arbres = masculin pluriel → verts."},
]},
{id:'fr5_synt1',titre:'Fonctions grammaticales',matiere:'fr',niveau:'5e',icone:'📖',questions:[
{q:"Dans « Le chien mord le facteur », quel est le COD ?",choices:["le chien","mord","le facteur","aucun"],ans:2,expl:"Le facteur répond à 'qui ?' après le verbe → COD."},
{q:"Dans « Elle parle à son ami », 'à son ami' est…",choices:["COD","COI","sujet","attribut du sujet"],ans:1,expl:"Parler à quelqu'un → COI."},
{q:"Dans « Marie est heureuse », 'heureuse' est…",choices:["COD","sujet","attribut du sujet","CC"],ans:2,expl:"Reliée au sujet par être → attribut du sujet."},
{q:"Le complément répondant à 'où ? quand ? comment ?' est un…",choices:["COD","COI","CC","attribut"],ans:2,expl:"Complément Circonstanciel."},
{q:"Dans « La fille sourit », quel est le sujet ?",choices:["sourit","fille","la fille","La"],ans:2,expl:"'La fille' = groupe nominal sujet."},
{q:"Quelle phrase contient un CC de temps ?",choices:["Il court vite","Il court à l'école","Il court chaque matin","Il court avec son chien"],ans:2,expl:"'Chaque matin' répond à 'quand ?' → CC de temps."},
{q:"Dans « Les enfants semblent fatigués », 'fatigués' est…",choices:["COD","sujet","attribut du sujet","adverbe"],ans:2,expl:"Sembler = verbe d'état → attribut."},
{q:"Dans « Il donne un cadeau à sa mère », 'à sa mère' est…",choices:["COD","COI","sujet","CC de lieu"],ans:1,expl:"Donner à quelqu'un → COI."},
]},
{id:'fr5_fig1',titre:'Figures de style',matiere:'fr',niveau:'5e',icone:'✨',questions:[
{q:"« Sa voix est douce comme du miel. » Quelle figure ?",choices:["Métaphore","Comparaison","Hyperbole","Personnification"],ans:1,expl:"Comparaison : deux termes + outil 'comme'."},
{q:"« Le vent murmure entre les arbres. » Quelle figure ?",choices:["Comparaison","Métaphore","Personnification","Antithèse"],ans:2,expl:"Personnification : action humaine prêtée au vent."},
{q:"« Cette valise pèse une tonne ! » Quelle figure ?",choices:["Litote","Hyperbole","Comparaison","Anaphore"],ans:1,expl:"Hyperbole : exagération volontaire."},
{q:"« C'est un lion sur le terrain. » Quelle figure ?",choices:["Comparaison","Métaphore","Hyperbole","Oxymore"],ans:1,expl:"Métaphore : comparaison sans outil de comparaison."},
{q:"« Je vis, je meurs ; je brûle et me noie. » Quelle figure ?",choices:["Anaphore","Antithèse","Hyperbole","Comparaison"],ans:1,expl:"Antithèse : opposition de termes contraires."},
{q:"L'anaphore consiste à…",choices:["Comparer deux choses","Répéter un mot en début de phrase","Exagérer","Personnifier"],ans:1,expl:"Anaphore = répétition en tête de vers/phrase."},
{q:"« C'est une obscure clarté. » Quelle figure ?",choices:["Métaphore","Comparaison","Oxymore","Litote"],ans:2,expl:"Oxymore : alliance de mots contradictoires."},
{q:"« Ce n'est pas sans talent. » Quelle figure ?",choices:["Hyperbole","Litote","Antithèse","Métaphore"],ans:1,expl:"Litote : dire moins pour suggérer plus."},
]},
{id:'fr5_conj2',titre:'Imparfait & Passé simple',matiere:'fr',niveau:'5e',icone:'✏️',questions:[
{q:"Conjuguez 'chanter' à l'imparfait, 3e pers. sing.",choices:["il chantait","il chanta","il chanterait","il chantais"],ans:0,expl:"Imparfait : il chantait."},
{q:"Conjuguez 'finir' au passé simple, 3e pers. plur.",choices:["ils finirent","ils finissaient","ils finiront","ils finissèrent"],ans:0,expl:"Passé simple finir : ils finirent."},
{q:"Conjuguez 'être' à l'imparfait, 1re pers. plur.",choices:["nous étions","nous étais","nous étaient","nous sommes"],ans:0,expl:"Être imparfait : nous étions."},
{q:"Conjuguez 'avoir' au passé simple, 3e pers. sing.",choices:["il avait","il a eu","il eut","il ait"],ans:2,expl:"Avoir passé simple : il eut."},
{q:"Terminaison de l'imparfait pour 'il/elle' ?",choices:["-ais","-ait","-ions","-iez"],ans:1,expl:"Il/Elle → -ait à l'imparfait."},
{q:"Conjuguez 'venir' au passé simple, 1re pers. sing.",choices:["je vins","je venais","je viendrai","je venins"],ans:0,expl:"Venir passé simple : je vins."},
{q:"L'imparfait exprime en général…",choices:["Une action ponctuelle","Une durée ou habitude passée","Une action future","Une action accomplie"],ans:1,expl:"L'imparfait = durée, habitude, état passé."},
{q:"Conjuguez 'aller' à l'imparfait, 2e pers. sing.",choices:["tu allais","tu allas","tu irais","tu alles"],ans:0,expl:"Aller imparfait : tu allais."},
]},
{id:'fr4_subj1',titre:'Le subjonctif',matiere:'fr',niveau:'4e',icone:'✏️',questions:[
{q:"Conjuguez 'être' au subjonctif présent, 3e pers. sing.",choices:["qu'il soit","qu'il est","qu'il sera","qu'il ait"],ans:0,expl:"Être subjonctif : qu'il soit."},
{q:"Quel indicateur impose le subjonctif ?",choices:["parce que","bien que","puisque","quand"],ans:1,expl:"'Bien que' + subjonctif."},
{q:"Conjuguez 'avoir' au subjonctif présent, 1re pers. sing.",choices:["que j'ai","que j'aie","que j'aies","que j'avais"],ans:1,expl:"Avoir subjonctif : que j'aie."},
{q:"Conjuguez 'aller' au subjonctif présent, 3e pers. plur.",choices:["qu'ils aillent","qu'ils allent","qu'ils vont","qu'ils iraient"],ans:0,expl:"Aller subjonctif : qu'ils aillent."},
{q:"Quelle locution n'exige PAS le subjonctif ?",choices:["pour que","afin que","parce que","à condition que"],ans:2,expl:"'Parce que' → indicatif (cause)."},
{q:"Conjuguez 'faire' au subjonctif présent, 2e pers. sing.",choices:["que tu fasses","que tu fais","que tu ferais","que tu fassiez"],ans:0,expl:"Faire subjonctif : que tu fasses."},
{q:"Conjuguez 'vouloir' au subjonctif présent, 1re pers. plur.",choices:["que nous voulons","que nous voulions","que nous veuillons","que nous voulez"],ans:1,expl:"Vouloir subjonctif : que nous voulions."},
{q:"Après 'il faut que', quel mode ?",choices:["Indicatif","Conditionnel","Subjonctif","Infinitif"],ans:2,expl:"Il faut que + subjonctif."},
]},
{id:'fr4_arg1',titre:'Le texte argumentatif',matiere:'fr',niveau:'4e',icone:'📖',questions:[
{q:"Qu'est-ce qu'une thèse ?",choices:["Un exemple","L'opinion défendue","Un résumé","Une question"],ans:1,expl:"La thèse = position que l'auteur défend."},
{q:"Quel connecteur indique une concession ?",choices:["donc","car","certes","ainsi"],ans:2,expl:"'Certes' = concession (on admet un argument adverse)."},
{q:"Différence argument / exemple ?",choices:["L'argument est plus court","L'argument justifie, l'exemple illustre","L'exemple est plus convaincant","Ils sont identiques"],ans:1,expl:"Argument = raison. Exemple = illustration concrète."},
{q:"Quel connecteur introduit une conséquence ?",choices:["or","car","donc","mais"],ans:2,expl:"'Donc' = conséquence."},
{q:"Dans un plan dialectique, la 3e partie est…",choices:["La thèse","L'antithèse","La synthèse","L'introduction"],ans:2,expl:"Thèse / Antithèse / Synthèse."},
{q:"Un texte argumentatif cherche à…",choices:["Raconter","Décrire","Convaincre","Expliquer"],ans:2,expl:"L'argumentation vise à faire adhérer à une opinion."},
{q:"Exemple d'argument d'autorité ?",choices:["D'après Einstein, l'imagination est plus importante que le savoir.","J'aime le chocolat.","Il fait chaud.","Les fleurs sont belles."],ans:0,expl:"Argument d'autorité = citation d'une référence reconnue."},
{q:"Quel connecteur introduit une cause ?",choices:["donc","puis","car","enfin"],ans:2,expl:"'Car' = parce que → cause."},
]},
{id:'fr3_cond1',titre:'Conditionnel & modes',matiere:'fr',niveau:'3e',icone:'✏️',questions:[
{q:"Conjuguez 'pouvoir' au conditionnel présent, 1re pers. sing.",choices:["je pouvais","je pourrai","je pourrais","je pus"],ans:2,expl:"Conditionnel = radical futur + terminaisons imparfait : je pourrais."},
{q:"Conjuguez 'savoir' au conditionnel présent, 3e pers. plur.",choices:["ils sauraient","ils savent","ils savaient","ils sauront"],ans:0,expl:"Savoir conditionnel : ils sauraient."},
{q:"Le conditionnel passé se forme avec…",choices:["Aux. présent + pp","Aux. conditionnel + pp","Aux. imparfait + pp","Infinitif"],ans:1,expl:"J'aurais mangé / je serais parti."},
{q:"Conjuguez 'venir' au conditionnel présent, 2e pers. sing.",choices:["tu venais","tu viendras","tu viendrais","tu vins"],ans:2,expl:"Venir conditionnel : tu viendrais."},
{q:"Quel mode exprime le doute ou le souhait ?",choices:["Indicatif","Impératif","Subjonctif","Infinitif"],ans:2,expl:"Subjonctif = incertitude, souhait, doute."},
{q:"Dans « Si j'avais le temps, je lirais davantage. », le temps dans la subordonnée est…",choices:["Conditionnel présent","Imparfait","Passé composé","Futur"],ans:1,expl:"Si + imparfait → conditionnel présent."},
{q:"Conjuguez 'devoir' au conditionnel passé, 1re pers. sing.",choices:["j'aurais dû","j'avais dû","j'aurai dû","je devrais"],ans:0,expl:"Conditionnel passé : j'aurais dû."},
{q:"L'impératif s'utilise pour…",choices:["Exprimer un souhait","Donner un ordre ou conseil","Décrire une action","Exprimer un doute"],ans:1,expl:"L'impératif = ordre, conseil, prière."},
]},
{id:'fr3_brevet1',titre:'Brevet — Langue française',matiere:'fr',niveau:'3e',icone:'🎓',questions:[
{q:"Nature de 'que' dans « Je crois que tu as raison » ?",choices:["Pronom relatif","Conjonction de subordination","Adverbe","Déterminant"],ans:1,expl:"'Que' introduit une subordonnée complétive → conjonction de subordination."},
{q:"La proposition subordonnée relative a pour rôle de…",choices:["Exprimer une cause","Qualifier un nom","Exprimer une conséquence","Remplacer un COD"],ans:1,expl:"La relative complète un nom (antécédent)."},
{q:"Quelle phrase est à la voix passive ?",choices:["Le chien mord le facteur","Le facteur est mordu par le chien","Le facteur court vite","Le chien aboie"],ans:1,expl:"Voix passive = être + participe passé (+ par + agent)."},
{q:"'Bien qu'il soit fatigué, il travaille.' La subordonnée est…",choices:["Relative","Cause","Concession","Complétive"],ans:2,expl:"'Bien que' introduit une concession."},
{q:"Mode de 'aille' dans « Il faut qu'il aille » ?",choices:["Indicatif","Conditionnel","Impératif","Subjonctif"],ans:3,expl:"Il faut que + subjonctif."},
{q:"La phrase complexe contient…",choices:["Un seul verbe","Deux verbes ou plus","Aucun verbe","Un infinitif"],ans:1,expl:"Phrase complexe = plusieurs propositions."},
{q:"Antécédent de 'que' dans « L'homme que j'ai vu » ?",choices:["j'","vu","l'homme","demain"],ans:2,expl:"'Que' est pronom relatif dont l'antécédent est 'l'homme'."},
{q:"« L'aurore aux doigts de rose » : quelle figure ?",choices:["Hyperbole","Périphrase","Antithèse","Oxymore"],ans:1,expl:"Périphrase : désigner par plusieurs mots."},
]},
{id:'ma6_frac1',titre:'Fractions — Bases',matiere:'ma',niveau:'6e',icone:'➗',questions:[
{q:"Quelle fraction est égale à 1/2 ?",choices:["2/5","3/6","2/3","4/6"],ans:1,expl:"3/6 = 1/2."},
{q:"Calculez 1/4 + 2/4.",choices:["3/8","2/4","3/4","1/2"],ans:2,expl:"1/4 + 2/4 = 3/4."},
{q:"Quelle fraction est la plus grande : 2/3 ou 3/4 ?",choices:["2/3","3/4","Elles sont égales","Impossible"],ans:1,expl:"2/3=8/12 < 9/12=3/4."},
{q:"Calculez 5/6 − 1/6.",choices:["4/6","4/0","6/6","2/3"],ans:0,expl:"5/6 − 1/6 = 4/6."},
{q:"Combien vaut 3 × (2/5) ?",choices:["6/15","5/6","6/5","2/15"],ans:2,expl:"3 × 2/5 = 6/5."},
{q:"Forme simplifiée de 8/12 ?",choices:["4/6","2/3","3/4","1/2"],ans:1,expl:"PGCD(8,12)=4 → 2/3."},
{q:"Calculez 1/3 + 1/6.",choices:["2/9","1/2","2/6","3/6"],ans:1,expl:"1/3=2/6. 2/6+1/6=3/6=1/2."},
{q:"Numérateur de la fraction 7/9 ?",choices:["9","7","2","63"],ans:1,expl:"Numérateur/dénominateur → numérateur = 7."},
]},
{id:'ma6_geo1',titre:'Périmètres et Aires',matiere:'ma',niveau:'6e',icone:'📐',questions:[
{q:"Périmètre d'un carré de côté 5 cm ?",choices:["10 cm","20 cm","25 cm","15 cm"],ans:1,expl:"P = 4 × 5 = 20 cm."},
{q:"Aire d'un rectangle de 6 × 4 cm ?",choices:["10 cm²","20 cm²","24 cm²","48 cm²"],ans:2,expl:"A = 6 × 4 = 24 cm²."},
{q:"Périmètre d'un cercle r=3 cm (π≈3,14) ?",choices:["9,42 cm","18,84 cm","6 cm","28,26 cm"],ans:1,expl:"C = 2πr = 2×3,14×3 = 18,84 cm."},
{q:"Aire d'un triangle de base 8 cm et hauteur 5 cm ?",choices:["40 cm²","13 cm²","20 cm²","80 cm²"],ans:2,expl:"A = (8×5)/2 = 20 cm²."},
{q:"Périmètre d'un rectangle 7 × 3 cm ?",choices:["21 cm","10 cm","20 cm","14 cm"],ans:2,expl:"P = 2×(7+3) = 20 cm."},
{q:"Unité d'une aire ?",choices:["cm","cm²","cm³","m"],ans:1,expl:"Surface = unités carrées : cm², m²…"},
{q:"Aire d'un carré de côté 9 cm ?",choices:["36 cm²","81 cm²","18 cm²","72 cm²"],ans:1,expl:"A = 9² = 81 cm²."},
{q:"Aire d'un disque r=4 cm (π≈3,14) ?",choices:["12,56 cm²","25,12 cm²","50,24 cm²","100,48 cm²"],ans:2,expl:"A = π×r² = 3,14×16 = 50,24 cm²."},
]},
{id:'ma6_calc1',titre:'Calcul — Entiers & décimaux',matiere:'ma',niveau:'6e',icone:'🔢',questions:[
{q:"Calculez 15 × 12.",choices:["170","180","160","175"],ans:1,expl:"15×12 = 180."},
{q:"342 ÷ 6 = ?",choices:["57","56","58","67"],ans:0,expl:"6×57=342."},
{q:"3,7 + 2,15 = ?",choices:["5,85","5,22","6,85","5,5"],ans:0,expl:"3,70+2,15=5,85."},
{q:"2³ = ?",choices:["6","8","9","12"],ans:1,expl:"2×2×2=8."},
{q:"5² = ?",choices:["10","15","20","25"],ans:3,expl:"5×5=25."},
{q:"PGCD(12, 18) = ?",choices:["2","3","6","9"],ans:2,expl:"Plus grand commun = 6."},
{q:"0,5 × 0,4 = ?",choices:["0,2","2","0,02","0,9"],ans:0,expl:"0,5×0,4=0,2."},
{q:"7² − 3² = ?",choices:["40","16","49","32"],ans:0,expl:"49−9=40."},
]},
{id:'ma5_prop1',titre:'Proportionnalité',matiere:'ma',niveau:'5e',icone:'📊',questions:[
{q:"4 stylos coûtent 6 €. Prix de 10 stylos ?",choices:["12 €","15 €","20 €","18 €"],ans:1,expl:"1 stylo=1,5€. 10×1,5=15€."},
{q:"Échelle 1/25 000 : 4 cm → ?",choices:["25 m","100 m","1 km","4 km"],ans:2,expl:"4×25000=100000cm=1km."},
{q:"Réduction de 20 % sur 80 €. Nouveau prix ?",choices:["60 €","64 €","16 €","70 €"],ans:1,expl:"20% de 80=16. 80−16=64€."},
{q:"Coefficient de proportionnalité 2,5. x=4 → y=?",choices:["6,5","9","10","6"],ans:2,expl:"y=2,5×4=10."},
{q:"240 km en 3h → vitesse ?",choices:["60 km/h","70 km/h","80 km/h","90 km/h"],ans:2,expl:"v=240/3=80 km/h."},
{q:"3 carrés = 45 kcal. 7 carrés = ?",choices:["95","105","100","140"],ans:1,expl:"1 carré=15kcal. 7×15=105."},
{q:"Augmentation 15 % sur 40 €. Nouveau prix ?",choices:["45 €","46 €","55 €","41,5 €"],ans:1,expl:"15% de 40=6. 40+6=46€."},
{q:"Tableau proportionnel si x:2/4/6 et y:6/12/19 ?",choices:["Oui","Non","Impossible","Seulement les deux premiers"],ans:1,expl:"6/2=3, 12/4=3, 19/6≠3 → non proportionnel."},
]},
{id:'ma5_pyth1',titre:'Théorème de Pythagore',matiere:'ma',niveau:'5e',icone:'📐',questions:[
{q:"Triangle rectangle jambes 3 et 4 → hypoténuse ?",choices:["5","6","7","√7"],ans:0,expl:"3²+4²=25=5²."},
{q:"Pythagore s'applique seulement au triangle…",choices:["Isocèle","Équilatéral","Rectangle","Quelconque"],ans:2,expl:"Triangle rectangle uniquement."},
{q:"Triangle rectangle en C : AC=6, BC=8. AB=?",choices:["10","14","√28","√100"],ans:0,expl:"AB²=36+64=100. AB=10."},
{q:"Triangle côtés 5, 12, 13 → rectangle ?",choices:["Oui","Non","Impossible","Seulement si connu"],ans:0,expl:"5²+12²=169=13² → oui."},
{q:"L'hypoténuse est…",choices:["La plus petite jambe","Le côté adjacent","Le côté opposé à l'angle droit","La médiane"],ans:2,expl:"Hypoténuse = côté le plus long, opposé à l'angle droit."},
{q:"AB²=AC²+BC² est vrai si…",choices:["Triangle isocèle","Angle en A droit","Angle en C droit","Triangle équilatéral"],ans:2,expl:"Pythagore : angle droit en C."},
{q:"Hypoténuse d'un triangle rectangle côtés 5 et 5 ?",choices:["10","√50","5√2","25"],ans:2,expl:"√(25+25)=√50=5√2."},
{q:"Triangle côtés 4, 5, 6 → rectangle ?",choices:["Oui","Non","Seulement si connu","Impossible"],ans:1,expl:"4²+5²=41≠36=6² → non."},
]},
{id:'ma4_eq1',titre:'Équations du 1er degré',matiere:'ma',niveau:'4e',icone:'🔣',questions:[
{q:"Résolvez : 2x + 3 = 11",choices:["x=4","x=7","x=5","x=3"],ans:0,expl:"2x=8. x=4."},
{q:"Résolvez : 5x − 4 = 16",choices:["x=3","x=4","x=12","x=2,4"],ans:1,expl:"5x=20. x=4."},
{q:"Résolvez : 3(x + 2) = 15",choices:["x=3","x=5","x=7","x=1"],ans:0,expl:"3x+6=15. 3x=9. x=3."},
{q:"Résolvez : x/4 = 3",choices:["x=7","x=3/4","x=12","x=0,75"],ans:2,expl:"x=3×4=12."},
{q:"Résolvez : 2x + 1 = x + 5",choices:["x=4","x=6","x=2","x=3"],ans:0,expl:"x=4."},
{q:"Résolvez : 4(2x − 1) = 28",choices:["x=4","x=3,5","x=7","x=2"],ans:0,expl:"8x−4=28. 8x=32. x=4."},
{q:"Laquelle est une équation du 1er degré ?",choices:["x²=4","2x+3=7","x³=8","√x=2"],ans:1,expl:"Degré 1 = variable à la puissance 1."},
{q:"Résolvez : 10 − 3x = 1",choices:["x=3","x=9","x=11/3","x=−3"],ans:0,expl:"3x=9. x=3."},
]},
{id:'ma4_stat1',titre:'Statistiques',matiere:'ma',niveau:'4e',icone:'📈',questions:[
{q:"Moyenne de {4, 7, 9, 6} ?",choices:["6","6,5","7","26"],ans:1,expl:"(4+7+9+6)/4=26/4=6,5."},
{q:"Médiane de {2, 5, 7, 9, 11} ?",choices:["5","7","9","6"],ans:1,expl:"Valeur centrale de 5 valeurs = 7."},
{q:"Médiane de {3, 6, 8, 10} ?",choices:["6","8","7","9"],ans:2,expl:"(6+8)/2=7."},
{q:"Étendue de {2, 5, 3, 9, 1} ?",choices:["8","9","7","4"],ans:0,expl:"9−1=8."},
{q:"Mode de {8, 12, 15, 10, 15, 18} ?",choices:["12","15","13","18"],ans:1,expl:"15 apparaît 2 fois → mode."},
{q:"Moyenne de {10, 10, 10, 10} ?",choices:["0","10","40","5"],ans:1,expl:"40/4=10."},
{q:"Pour 7 valeurs ordonnées, la médiane est…",choices:["La 3e","La 4e","La 5e","La moyenne des 3e et 5e"],ans:1,expl:"7 valeurs → médiane = 4e valeur."},
{q:"Histogramme vs diagramme en barres : différence principale ?",choices:["Aucune","Histogramme = données continues","Barres n'ont pas d'axes","Histogramme n'a pas d'étiquettes"],ans:1,expl:"Histogramme = données quantitatives continues."},
]},
{id:'ma3_eq2',titre:'Équations du 2e degré',matiere:'ma',niveau:'3e',icone:'🔣',questions:[
{q:"Résolvez : x² = 25",choices:["x=5","x=±5","x=5 ou x=0","x=25"],ans:1,expl:"x=√25=5 ou x=−5."},
{q:"Résolvez : (x+2)(x−3) = 0",choices:["x=2 ou x=3","x=−2 ou x=3","x=2 ou x=−3","x=−2 et x=−3"],ans:1,expl:"x+2=0→x=−2 ou x−3=0→x=3."},
{q:"Si Δ < 0 pour ax²+bx+c=0…",choices:["2 solutions","1 solution double","Pas de solution réelle","Solution = 0"],ans:2,expl:"Δ<0 → pas de racine réelle."},
{q:"Δ pour x²−5x+6=0 ?",choices:["1","4","9","−1"],ans:0,expl:"Δ=25−24=1."},
{q:"Solutions de x²−5x+6=0 ?",choices:["x=2 et x=3","x=1 et x=6","x=−2 et x=−3","x=5 et x=1"],ans:0,expl:"x=(5±1)/2 → x=3 et x=2."},
{q:"(x+3)² développé ?",choices:["x²+9","x²+6x+9","x²+3x+9","x²+3"],ans:1,expl:"(a+b)²=a²+2ab+b²."},
{q:"Factorisez x² − 9.",choices:["(x−3)²","(x+3)(x−3)","(x+9)(x−1)","(x−3)(x−3)"],ans:1,expl:"a²−b²=(a+b)(a−b)."},
{q:"Si Δ = 0, l'équation a…",choices:["Aucune solution","Deux solutions","Une solution double x=−b/2a","Une infinité"],ans:2,expl:"Δ=0 → solution unique."},
]},
{id:'ma3_brevet1',titre:'Brevet — Calcul & Géométrie',matiere:'ma',niveau:'3e',icone:'🎓',questions:[
{q:"√169 = ?",choices:["12","13","14","11"],ans:1,expl:"13²=169."},
{q:"Distance A(1,2)→B(4,6) ?",choices:["5","√7","3","7"],ans:0,expl:"√(9+16)=√25=5."},
{q:"Volume cylindre r=3 cm, h=5 cm (π≈3,14) ?",choices:["141,3 cm³","47,1 cm³","188,4 cm³","94,2 cm³"],ans:0,expl:"π×9×5=141,3 cm³."},
{q:"(3×10⁴) × (2×10³) = ?",choices:["6×10⁷","6×10¹²","5×10⁷","6×10⁶"],ans:0,expl:"6×10⁷."},
{q:"Équation de la droite par (0,2) et (3,8) ?",choices:["y=2x","y=2x+2","y=3x+2","y=x+2"],ans:1,expl:"Pente=2, ordonnée=2 → y=2x+2."},
{q:"x+y=5 et x−y=1 → ?",choices:["x=3,y=2","x=2,y=3","x=4,y=1","x=1,y=4"],ans:0,expl:"2x=6→x=3. y=2."},
{q:"Arc angle 90°, r=6 cm = ?",choices:["3π cm","9π cm","6π cm","π cm"],ans:0,expl:"(90/360)×2πr=3π cm."},
{q:"(x²−4)/(x−2) = ?",choices:["x−2","x+2","x²+4","(x+2)(x−2)"],ans:1,expl:"x²−4=(x+2)(x−2) → x+2."},
]},
]; // fin ACAD_MODULES

// ══════════════════════════════════════════════════
// CONFIG EMAILJS
// ══════════════════════════════════════════════════
const EMAILJS_PUBLIC_KEY  = 'VOTRE_CLE_PUBLIQUE';
const EMAILJS_SERVICE_ID  = 'VOTRE_SERVICE_ID';
const EMAILJS_TEMPLATE_ID = 'VOTRE_TEMPLATE_ID';
const EMAIL_DESTINATAIRE  = 'aurelien.brulois@eclat-bfc.fr';
let _emailjsInit = false;
function initEmailJS(){
  if(_emailjsInit||EMAILJS_PUBLIC_KEY==='VOTRE_CLE_PUBLIQUE')return;
  try{emailjs.init({publicKey:EMAILJS_PUBLIC_KEY});_emailjsInit=true;}catch(e){}
}
function sendEmail(sujet,params){
  initEmailJS();if(!_emailjsInit)return;
  const p=Object.assign({destinataire:EMAIL_DESTINATAIRE,sujet,semaine:wk(new Date()),date:new Date().toLocaleString('fr-FR')},params);
  emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,p).catch(()=>{});
}
// ══════════════════════════════════════════════════
// CONSTANTES ANTI-TRICHE
// ══════════════════════════════════════════════════
const JETON_MAX       = 3;
const JETON_WARN      = 2;
const RECU_MAX        = 2;
const HIGH_VALUE_KEYS = ['mediation','creation'];
const HIGH_VALUE_XP   = 150;
const MAL_FAUX_DOUBLE = -1000;

const MAL={incivilite:{l:'Incivilite (-50)',x:-50},agressivite:{l:'Agressivite verbale (-150)',x:-150},degradation:{l:'Degradation materiel (-300)',x:-300},faux_temoignage:{l:'Faux temoignage (-500)',x:-500},reset_total:{l:'RESET total',x:0}};
const VIDEOS=(Array.isArray(window.PVS_VIDEOS)&&window.PVS_VIDEOS.length)?window.PVS_VIDEOS:[{id:'YT_01',title:'Video 01',url:'https://www.youtube.com/watch?v=dQw4w9WgXcQ',secret:'pHARe-SOLO',offer:20,reward:80},{id:'YT_02',title:'Video 02',url:'https://www.youtube.com/watch?v=dQw4w9WgXcQ',secret:'EMPREINTE-2022',offer:20,reward:80}];
const AUDIO_FILES=['Tous Ensemble Aujourd\u2019hui.mp3',"Tous Ensemble Aujourd'hui.mp3",'Tous_Ensemble_Aujourd_hui.mp3'];
let S={week:'',players:{},logs:[],seen:{},registry:[],registry_source:'',adults:[],adults_source:'',parents:[],parents_source:'',neg_reports:[],pos_reports:[],citizen_lists:{}},REG={j:{},t:{},p:{}},ADW={},PRW={},PRP={},cur='',mode='global',adminOn=false,isVisitor=false,tutoIdx=0,tutoFocusEl=null,syncRev=Number(localStorage.getItem(SYNC_REV_KEY)||0),syncOnline=false,syncMutePush=false,syncPushTimer=null,audioIdx=0,audioTryRaw=false,audioRetries=0;
const TUTO_STEPS=[
  {sel:'#profile',title:'1/10 Profil joueur',text:'Ici tu suis ton XP global, hebdo, citoyen, academie et videos.'},
  {sel:'#wCode',title:'2/10 Temoignage',text:'Saisis ton code temoin puis le code public cible pour reconnaitre un acte positif.'},
  {sel:'#btnWitnessSend',title:'3/10 Validation sociale',text:'Ce bouton enregistre l action positive et declenche le calcul de bonus temoin.'},
  {sel:'#btnNegHub',title:'4/10 Faits negatifs',text:'Acces au hub separe avec avertissement legal et pre-signalement CPE.'},
  {sel:'#hall',title:'5/10 Hall of Fame',text:'Le classement Top 10 affiche progression globale ou hebdomadaire.'},
  {sel:'#btnPixhare',title:'6/10 Academie PIXHARe',text:'Acces au hub pHARe; les validations de modules remontent vers le super-hub.'},
  {sel:'#btnPsc1',title:'7/10 Academie PSC1',text:'Acces au hub PSC1 avec suivi consolide dans le portail central.'},
  {sel:'#btnVideos',title:'8/10 Hub Videos',text:'Ouverture des missions video + validation par code secret.'},
  {sel:'#rulesTab',title:'9/10 Regles',text:'Acces rapide aux regles du jeu et au bareme officiel.'},
  {sel:'#tutorialTab',title:'10/10 Reouvrir le guide',text:'Ce bouton permet de relancer ce didacticiel a tout moment.'}
];
function stripAcc(v){return String(v||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')}function nCode(v){return stripAcc(String(v||'')).trim().replace(/\s+/g,'').toUpperCase()}function nHead(v){return stripAcc(String(v||'').trim().toLowerCase()).replace(/[^a-z0-9]+/g,'_')}function demojibake(v){const s=String(v||'');if(!/[ÃÂâ]/.test(s))return s;try{return decodeURIComponent(escape(s))}catch(e){return s}}
function defaultPublicCode(cj){const c=nCode(cj||'');if(!c)return'';const m=c.match(/(\d{1,4})$/);if(m)return `PUB-${String(m[1]).padStart(3,'0')}`;return `PUB-${c.slice(-4)}`}
function splitLine(line,delim){const out=[];let curS='';let q=false;for(let i=0;i<line.length;i+=1){const ch=line[i];if(ch==='"'){if(q&&line[i+1]==='"'){curS+='"';i+=1}else{q=!q}}else if(ch===delim&&!q){out.push(curS);curS=''}else{curS+=ch}}out.push(curS);return out}
function idxAny(heads,list){for(const k of list){const i=heads.indexOf(k);if(i>=0)return i}return -1}
function rowObjFromText(text){const raw=String(text||'').replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n').filter(x=>x.trim().length>0);if(raw.length<2)return null;const delim=raw[0].includes('\t')?'\t':(raw[0].includes(';')?';':',');const heads=splitLine(raw[0],delim).map(nHead);const vals=splitLine(raw[1],delim);const obj={};heads.forEach((h,i)=>{obj[h]=String(vals[i]??'')});return obj}
function numOr(v,d){const n=Number(v);return Number.isFinite(n)?n:Number(d||0)}
function parseCodesText(text){const raw=String(text||'').replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n').filter(x=>x.trim().length>0);if(!raw.length)return[];const delim=raw[0].includes('\t')?'\t':(raw[0].includes(';')?';':',');const heads=splitLine(raw[0],delim).map(nHead);const iNom=idxAny(heads,['nom','name']);const iPre=idxAny(heads,['prenom','first_name']);const iJ=idxAny(heads,['code_joueur','joueur','player_code']);const iT=idxAny(heads,['code_temoin','temoin','witness_code']);const iP=idxAny(heads,['code_public','public_code','code_public_joueur','code_public_eleve']);if(iJ<0)return[];const rows=[];for(let i=1;i<raw.length;i+=1){const cols=splitLine(raw[i],delim);const nom=demojibake(String(cols[iNom]||'').trim());const prenom=demojibake(String(cols[iPre]||'').trim());const cj=nCode(demojibake(cols[iJ]||''));const ct=nCode(demojibake((iT>=0?cols[iT]:'')||''));const cp=nCode(demojibake((iP>=0?cols[iP]:'')||''));if(!cj&&!ct)continue;rows.push({nom,prenom,code_joueur:cj,code_temoin:ct,code_public:cp||defaultPublicCode(cj)})}return rows}
function parseAdultsText(text){const raw=String(text||'').replace(/\uFEFF/g,'').replace(/\r/g,'').split('\n').filter(x=>x.trim().length>0);if(!raw.length)return[];const delim=raw[0].includes('\t')?'\t':(raw[0].includes(';')?';':',');const heads=splitLine(raw[0],delim).map(nHead);const iNom=idxAny(heads,['nom','name']);const iPre=idxAny(heads,['prenom','first_name']);const iT=idxAny(heads,['code_temoin','temoin','witness_code']);const iJ=idxAny(heads,['code_joueur','joueur','player_code','code_player']);if(iT<0)return[];const rows=[];for(let i=1;i<raw.length;i+=1){const cols=splitLine(raw[i],delim);const nom=demojibake(String(cols[iNom]||'').trim());const prenom=demojibake(String(cols[iPre]||'').trim());const ct=nCode(demojibake(cols[iT]||''));if(!ct)continue;const cj=iJ>=0?nCode(demojibake(cols[iJ]||'')):ct;rows.push({nom,prenom,code_temoin:ct,code_joueur:cj||ct})}return rows}
function ensureCitizenLists(){if(!S.citizen_lists||typeof S.citizen_lists!=='object')S.citizen_lists={};Object.keys(CIT).forEach(k=>{if(!Array.isArray(S.citizen_lists[k]))S.citizen_lists[k]=[];S.citizen_lists[k]=S.citizen_lists[k].map(nCode).filter(Boolean)})}
function mkP(code){return{code,witness:'',cp:{pixhare:0,psc1:0,sanctuaire:0,loge:0,autres:0},obj:{},socialG:0,socialW:0,wBonusG:0,wBonusW:0,videoG:0,videoW:0,malusG:0,malusW:0,witnessGiven:0,recognizedReceived:0,witnessGivenW:0,receivedW:0,pairW:{},flaggedExcess:0,acadDone:{},acadIds:[],up:new Date().toISOString(),_v2:1}}
function wk(d){const x=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const day=(x.getUTCDay()+6)%7;x.setUTCDate(x.getUTCDate()-day+3);const f=new Date(Date.UTC(x.getUTCFullYear(),0,4));const w=1+Math.round((x-f)/604800000);return `${x.getUTCFullYear()}-W${String(w).padStart(2,'0')}`}
function buildRegistry(){REG={j:{},t:{},p:{}};(S.registry||[]).forEach(r=>{const cj=nCode(r.code_joueur||'');const ct=nCode(r.code_temoin||'');const cp=nCode(r.code_public||'')||cj;if(!cj)return;REG.j[cj]={nom:r.nom||'',prenom:r.prenom||'',code_joueur:cj,code_temoin:ct,code_public:cp};if(ct)REG.t[ct]=cj;if(cp)REG.p[cp]=cj})}
function buildAdultMap(){
  ADW={};ADWP={};
  (S.adults||[]).forEach(a=>{
    const ct=nCode(a.code_temoin||'');
    const cj=nCode(a.code_joueur||'');
    if(ct&&cj&&ct!==cj){
      ADW[ct]=cj;    // temoin → joueur (resolveWitness)
      ADWP[cj]=ct;   // joueur → temoin (login)
    } else if(ct){
      ADW[ct]=ct;    // ancien format : code unique
      ADWP[ct]=ct;
    }
  });
}
function buildParentMap(){PRW={};PRP={};(S.parents||[]).forEach(p=>{const cj=nCode(p.code_joueur||'');const cp=nCode(p.code_public||'')||defaultPublicCode(cj);if(!cj)return;PRW[cj]={nom:p.nom||'',prenom:p.prenom||'',code_joueur:cj,code_public:cp};if(cp)PRP[cp]=cj})}
function norm(){ensureCitizenLists();Object.keys(S.players).forEach(code=>{const p=S.players[code]||{};if(!p.cp||typeof p.cp!=='object')p.cp={pixhare:0,psc1:0,sanctuaire:0,loge:0,autres:0};Object.keys(W).forEach(k=>p.cp[k]=Number(p.cp[k]||0));if(!p.obj||typeof p.obj!=='object')p.obj={};if(!p._v2){p.socialG=Number(p.socialG||0)+Number(p.sg||0);p.socialW=Number(p.socialW||0)+Number(p.sw||0);p.malusG=Number(p.malusG||0)+Number(p.mg||0);p.malusW=Number(p.malusW||0)+Number(p.mw||0);p._v2=1}else{p.socialG=Number(p.socialG||0);p.socialW=Number(p.socialW||0);p.malusG=Number(p.malusG||0);p.malusW=Number(p.malusW||0)}p.wBonusG=Number(p.wBonusG||0);p.wBonusW=Number(p.wBonusW||0);p.videoG=Number(p.videoG||0);p.videoW=Number(p.videoW||0);p.witnessGiven=Math.max(0,Number(p.witnessGiven||0));p.recognizedReceived=Math.max(0,Number(p.recognizedReceived||0));p.witness=String(p.witness||'');if(REG.j[code]&&REG.j[code].code_temoin)p.witness=REG.j[code].code_temoin;else if(ADW[code]&&!p.witness)p.witness=code;S.players[code]=p});if(!Array.isArray(S.logs))S.logs=[];if(!S.seen||typeof S.seen!=='object')S.seen={};if(!Array.isArray(S.registry))S.registry=[];S.registry=S.registry.map(r=>({nom:demojibake(String(r.nom||'').trim()),prenom:demojibake(String(r.prenom||'').trim()),code_joueur:nCode(r.code_joueur||''),code_temoin:nCode(r.code_temoin||''),code_public:nCode(r.code_public||'')||defaultPublicCode(r.code_joueur||'')})).filter(r=>r.code_joueur);if(!Array.isArray(S.adults))S.adults=[];S.adults=S.adults.map(a=>({nom:demojibake(String(a.nom||'').trim()),prenom:demojibake(String(a.prenom||'').trim()),code_temoin:nCode(a.code_temoin||'')})).filter(a=>a.code_temoin);if(!Array.isArray(S.parents))S.parents=[];S.parents=S.parents.map(p=>({nom:demojibake(String(p.nom||'').trim()),prenom:demojibake(String(p.prenom||'').trim()),code_joueur:nCode(p.code_joueur||''),code_public:nCode(p.code_public||'')||defaultPublicCode(p.code_joueur||'')})).filter(p=>p.code_joueur);if(!Array.isArray(S.neg_reports))S.neg_reports=[]}
function resetWeek(){const cw=wk(new Date());if(S.week!==cw){Object.values(S.players).forEach(p=>{p.socialW=0;p.wBonusW=0;p.videoW=0;p.malusW=0});S.week=cw}}
function load(){try{const j=localStorage.getItem(KEY);if(j){const p=JSON.parse(j);if(p&&typeof p==='object'){S={week:p.week||'',players:p.players||{},logs:Array.isArray(p.logs)?p.logs:[],seen:p.seen||{},registry:Array.isArray(p.registry)?p.registry:[],registry_source:String(p.registry_source||''),adults:Array.isArray(p.adults)?p.adults:[],adults_source:String(p.adults_source||''),parents:Array.isArray(p.parents)?p.parents:[],parents_source:String(p.parents_source||''),neg_reports:Array.isArray(p.neg_reports)?p.neg_reports:[],citizen_lists:p.citizen_lists||{}}}}}catch(e){S={week:'',players:{},logs:[],seen:{},registry:[],registry_source:'',adults:[],adults_source:'',parents:[],parents_source:'',neg_reports:[],citizen_lists:{}}}buildRegistry();norm();buildAdultMap();buildParentMap();resetWeek();save(false)}
function save(push=true){localStorage.setItem(KEY,JSON.stringify(S));if(push&&sessionStorage.getItem(SESSION_AUTH_KEY)==='1'){scheduleSyncPush();scheduleSbPush();scheduleSbGlobalPush()}}
function gp(code){const c=nCode(code);if(!c)return null;if(!S.players[c])S.players[c]=mkP(c);if(REG.j[c]&&REG.j[c].code_temoin)S.players[c].witness=REG.j[c].code_temoin;else if(ADW[c]&&!S.players[c].witness)S.players[c].witness=c;return S.players[c]}
function missionList(k){ensureCitizenLists();return S.citizen_lists[k]}
function hasMission(code,k){return missionList(k).includes(code)}
function missionXp(code){let n=0;Object.keys(CIT).forEach(k=>{if(hasMission(code,k))n+=CIT[k].xp});return n}
function cpTotal(p){return Object.keys(W).reduce((a,k)=>a+Number(p.cp[k]||0),0)}
function academyXp(p){return Object.keys(W).reduce((a,k)=>a+Number(p.cp[k]||0)*W[k],0)}
function videoXp(p){return Number(p.videoG||0)}
function socialRawG(p){return Number(p.socialG||0)+Number(p.wBonusG||0)}
function socialRawW(p){return Number(p.socialW||0)+Number(p.wBonusW||0)}
function socialValidG(p){return Number(p.witnessGiven||0)>0?socialRawG(p):0}
function socialValidW(p){return Number(p.witnessGiven||0)>0?socialRawW(p):0}
function socialPendingG(p){return Number(p.witnessGiven||0)>0?0:socialRawG(p)}
function citizenXp(p){return missionXp(p.code)+socialValidG(p)}
function acadCoeff(p){const n=Math.min(acadDoneCount(p),50);return Math.round((1+n*0.02)*100)/100}
function xg(p){const base=citizenXp(p)+academyXp(p)+videoXp(p)+Number(p.malusG||0);return Math.round(base*acadCoeff(p))}

// ── Fonctions Académiques ──────────────────────────
function acadDoneCount(p){return Object.keys(p.acadDone||{}).length}
function acadCoeff(p){return 1+Math.min(acadDoneCount(p)*ACAD_COEFF_STEP,ACAD_COEFF_MAX)}
function xgFinal(p){return Math.round(xg(p)*acadCoeff(p))}
function xwFinal(p){return Math.round(xw(p)*acadCoeff(p))}
function xw(p){return socialValidW(p)+Number(p.videoW||0)+Number(p.malusW||0)}
function roleLabel(code){if(isAdultPlayerCode(code))return 'Adulte equipe';if(isParentPlayerCode(code))return 'Parent';const ks=Object.keys(CIT).filter(k=>hasMission(code,k));if(!ks.length)return 'Citoyen';ks.sort((a,b)=>CIT[b].xp-CIT[a].xp);const m=CIT[ks[0]].label;return ks.length>1?`${m} +${ks.length-1}`:m}
function rank(m){const rows=Object.values(S.players).filter(p=>!isVisitorCode(p.code)).map(p=>({c:p.code,rl:roleLabel(p.code),cp:cpTotal(p),s:m==='global'?xgFinal(p):xwFinal(p)}));rows.sort((a,b)=>b.s-a.s||a.c.localeCompare(b.c));return rows}
function sm(id,txt,ok){const e=document.getElementById(id);if(!e)return;e.className=`msg ${ok?'ok':'bad'}`;e.textContent=txt}
function cm(id){const e=document.getElementById(id);if(!e)return;e.className='msg';e.textContent=''}
function clampN(v,min,max){return Math.max(min,Math.min(max,v))}
function getAudioEl(){return document.getElementById('bgAudio')}
function setAudioSource(idx,raw){const a=getAudioEl();if(!a)return;audioIdx=clampN(Number(idx)||0,0,AUDIO_FILES.length-1);audioTryRaw=Boolean(raw);const file=AUDIO_FILES[audioIdx];a.src=audioTryRaw?file:encodeURI(file);const info=document.getElementById('audioInfo');if(info)info.textContent=`Piste: ${file}${audioTryRaw?' (mode brut)':''}`;localStorage.setItem(AUDIO_SOURCE_KEY,String(audioIdx))}
function updateAudioUi(){const a=getAudioEl(),b=document.getElementById('audioToggle');if(!a||!b)return;b.textContent=a.paused?'Lancer':'Pause'}
async function playAudio(){const a=getAudioEl();if(!a)return false;try{await a.play();localStorage.setItem(AUDIO_PREF_KEY,'1');updateAudioUi();return true}catch(e){updateAudioUi();const info=document.getElementById('audioInfo');if(info)info.textContent='Lecture bloquee par le navigateur. Clique encore sur Lancer.';if(ev.type==='ACAD_COMPLETE'){
  const mid=String(ev.moduleId||'');
  if(!mid)return false;
  const ids=Array.isArray(p.acadIds)?p.acadIds:[];
  if(ids.includes(mid))return false; // déjà fait
  p.acadIds=ids;p.acadIds.push(mid);
  p.acadDone=(p.acadDone||0)+1;
  const coeff=acadCoeff(p);
  logEv(code,'ACAD_COMPLETE',mid,0);
  return true;
}
return false}}
function pauseAudio(){const a=getAudioEl();if(!a)return;a.pause();localStorage.setItem(AUDIO_PREF_KEY,'0');updateAudioUi()}
function toggleAudio(){const a=getAudioEl();if(!a)return;if(a.paused)playAudio();else pauseAudio()}
function onAudioError(){
  audioRetries+=1;
  if(!audioTryRaw){setAudioSource(audioIdx,true);playAudio();return}
  if(audioIdx<AUDIO_FILES.length-1){setAudioSource(audioIdx+1,false);playAudio();return}
  if(audioRetries<6){setAudioSource(0,false);playAudio();return}
  const info=document.getElementById('audioInfo');if(info)info.textContent='MP3 introuvable. Verifie le nom et l emplacement du fichier.';
  pauseAudio();
}
function initAudio(){const a=getAudioEl(),vol=document.getElementById('audioVol');if(!a||!vol)return;const vv=clampN(Number(localStorage.getItem(AUDIO_VOL_KEY)||35),0,100);vol.value=String(vv);a.volume=vv/100;vol.addEventListener('input',()=>{const v=clampN(Number(vol.value||35),0,100);a.volume=v/100;localStorage.setItem(AUDIO_VOL_KEY,String(v))});a.addEventListener('play',updateAudioUi);a.addEventListener('pause',updateAudioUi);a.addEventListener('error',onAudioError);audioRetries=0;setAudioSource(Number(localStorage.getItem(AUDIO_SOURCE_KEY)||0),false);updateAudioUi();if(localStorage.getItem(AUDIO_PREF_KEY)==='1')playAudio()}
function getSyncUrl(){return String(localStorage.getItem(SYNC_URL_KEY)||DEFAULT_SYNC_URL).trim().replace(/\/+$/,'')}
function updateSyncInfo(msg){const e=document.getElementById('syncInfo');if(!e)return;if(msg){e.textContent=msg;return}e.textContent=`Sync serveur: ${syncOnline?'connecte':'hors ligne'} | rev: ${Number(syncRev||0)} | URL: ${getSyncUrl()}`}
async function syncFetch(path,options){const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),2200);try{const res=await fetch(`${getSyncUrl()}${path}`,Object.assign({mode:'cors',cache:'no-store',signal:ctrl.signal},options||{}));clearTimeout(t);return res}catch(e){clearTimeout(t);throw e}}
function scheduleSyncPush(){if(syncMutePush)return;clearTimeout(syncPushTimer);syncPushTimer=setTimeout(()=>{syncPush(false)},550)}
async function syncPing(){try{const res=await syncFetch('/api/ping');if(!res.ok)throw new Error('http');const j=await res.json();if(j&&j.ok){syncOnline=true;if(Number(j.rev||0)>syncRev){syncRev=Number(j.rev||0);localStorage.setItem(SYNC_REV_KEY,String(syncRev))}updateSyncInfo();return true}}catch(e){syncOnline=false;updateSyncInfo();return false}return false}
async function syncPull(showMsg){try{const res=await syncFetch('/api/state');if(!res.ok)throw new Error('http');const j=await res.json();if(!(j&&j.ok&&j.state&&typeof j.state==='object'))throw new Error('bad');syncOnline=true;const rev=Number(j.rev||0);if(rev>Number(syncRev||0)){syncRev=rev;localStorage.setItem(SYNC_REV_KEY,String(syncRev));syncMutePush=true;try{S=j.state;buildRegistry();norm();resetWeek();localStorage.setItem(KEY,JSON.stringify(S));
          // Si les adults du state serveur sont en ancien format, les recharger
          if(!S.adults||!S.adults.length||!S.adults.some(a=>a.code_joueur)){
            loadDefaultAdults(false).then(()=>{refresh()});
          } else {
            buildAdultMap();refresh();
          }}finally{syncMutePush=false}}updateSyncInfo(showMsg?`Sync pull OK | rev ${syncRev}`:'');return true}catch(e){syncOnline=false;updateSyncInfo(showMsg?'Sync pull impossible (serveur hors ligne).':'');return false}}
async function syncPush(showMsg){if(syncMutePush)return false;try{const payload={state:S,client:cur||'ANON',source:'index.html',sent_at:new Date().toISOString(),base_rev:Number(syncRev||0)};const res=await syncFetch('/api/state',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});if(!res.ok)throw new Error('http');const j=await res.json();if(!(j&&j.ok))throw new Error('bad');syncOnline=true;syncRev=Number(j.rev||syncRev||0);localStorage.setItem(SYNC_REV_KEY,String(syncRev));updateSyncInfo(showMsg?`Sync push OK | rev ${syncRev}`:'');return true}catch(e){syncOnline=false;updateSyncInfo(showMsg?'Sync push impossible (serveur hors ligne).':'');return false}}
function isVisitorCode(code){return nCode(code)===VISITOR_CODE}
function hasRefCodes(){return Object.keys(REG.j).length>0||Object.keys(ADW).length>0||Object.keys(PRW).length>0}
function isAdultPlayerCode(code){const c=nCode(code);return !!(ADWP[c]||ADW[c])}
function isParentPlayerCode(code){const c=nCode(code);return !!PRW[c]}
function isKnownPlayerCode(code){const c=nCode(code);return !!(c&&(REG.j[c]||ADWP[c]||ADW[c]||PRW[c]))}
function showHub(show){const a=document.getElementById('authGate'),h=document.getElementById('hubScreen');if(a)a.style.display=show?'none':'flex';if(h)h.style.display=show?'block':'none'}
function renderAdminMode(){const c=document.getElementById('adminConsole'),h=document.getElementById('adminHint');if(c)c.style.display=adminOn?'block':'none';if(h)h.textContent=adminOn?'Mode admin actif.':'Mode admin inactif.'}
function openAuthGate(msg){adminOn=false;sessionStorage.removeItem(SESSION_AUTH_KEY);sessionStorage.removeItem(ADMIN_SESSION_KEY);showHub(false);closeVisitorArticle();closeTutorial();renderAdminMode();if(msg)sm('authMsg',msg,false);else cm('authMsg')}
function closeAuthGate(){showHub(true);cm('authMsg')}
function fillVisitorCode(){const e=document.getElementById('authCode'),a=document.getElementById('authAdmin');if(e)e.value='Visiteur-Viescolaire-ChateauRance';if(a)a.value='';cm('authMsg')}
function updateVisitorUi(){const tab=document.getElementById('visitorArticleTab');if(tab)tab.style.display=isVisitor?'inline-block':'none';if(!isVisitor){closeVisitorArticle()}}
function openVisitorArticle(){if(!isVisitor)return;const m=document.getElementById('visitorModal');if(m)m.style.display='block'}
function closeVisitorArticle(){const m=document.getElementById('visitorModal');if(m)m.style.display='none'}
function clearTutorialFocus(){if(tutoFocusEl&&tutoFocusEl.classList)tutoFocusEl.classList.remove('tutoFocus');tutoFocusEl=null}
function closeTutorial(){const b=document.getElementById('tutorialBubble');if(b)b.style.display='none';clearTutorialFocus()}
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
function placeTutorialBubble(el){const b=document.getElementById('tutorialBubble'),arr=document.getElementById('tutorialArrow');if(!b||!el)return;const r=el.getBoundingClientRect();const w=Math.min(360,window.innerWidth-24);b.style.width=`${w}px`;const prefRight=r.right+16;const prefLeft=r.left-w-16;let left=prefRight;if(left+w>window.innerWidth-8)left=prefLeft;if(left<8)left=8;let top=r.top+Math.max(6,Math.min(40,r.height*0.2));const maxTop=window.innerHeight-b.offsetHeight-8;if(top>maxTop)top=maxTop;if(top<8)top=8;b.style.left=`${left}px`;b.style.top=`${top}px`;if(arr){if(left>=r.right){arr.style.left='-8px';arr.style.right='';arr.style.transform='rotate(45deg)'}else{arr.style.left='';arr.style.right='-8px';arr.style.transform='rotate(225deg)'}}}
function renderTutorial(){const b=document.getElementById('tutorialBubble');if(!b||b.style.display==='none')return;const s=TUTO_STEPS[clamp(tutoIdx,0,TUTO_STEPS.length-1)];const t=document.getElementById('tutorialTitle'),x=document.getElementById('tutorialText'),p=document.getElementById('tutorialPage'),tg=document.getElementById('tutorialTarget');if(t)t.textContent=s.title;if(x)x.textContent=s.text;if(p)p.textContent=`${tutoIdx+1}/${TUTO_STEPS.length}`;const el=document.querySelector(s.sel);clearTutorialFocus();if(el){tutoFocusEl=el;el.classList.add('tutoFocus');if(tg)tg.textContent=`Zone: ${s.sel}`;placeTutorialBubble(el)}else{if(tg)tg.textContent='Zone temporairement indisponible';b.style.left='12px';b.style.top='80px'}}
function openTutorial(step){const b=document.getElementById('tutorialBubble');if(!b)return;tutoIdx=clamp(Number(step??tutoIdx)||0,0,TUTO_STEPS.length-1);b.style.display='block';renderTutorial()}
function nextTutorial(){openTutorial(tutoIdx+1)}
function prevTutorial(){openTutorial(tutoIdx-1)}
function logEv(player,type,target,xp){S.logs.unshift({d:new Date().toISOString(),p:player||'',t:type||'',target:target||'',xp:Number(xp||0)});if(S.logs.length>700)S.logs.length=700}
function renderHall(){const b=document.getElementById('hall');const rows=rank(mode).slice(0,10);b.innerHTML='';if(!rows.length){b.innerHTML='<tr><td colspan=\"5\">Aucun joueur enregistre.</td></tr>'}else{rows.forEach((r,i)=>{const cl=i===0?'style=\"color:#ffd700;font-weight:800\"':(i===1?'style=\"color:#d9d9d9;font-weight:800\"':(i===2?'style=\"color:#da9a57;font-weight:800\"':''));const tr=document.createElement('tr');tr.innerHTML=`<td ${cl}>${i+1}</td><td>${r.c}</td><td>${r.rl}</td><td>${r.cp}</td><td>${r.s}</td>`;b.appendChild(tr)})}document.getElementById('scoreHead').textContent=mode==='global'?'XP Global':'XP Hebdo';const realCount=Object.keys(S.players).filter(c=>!isVisitorCode(c)).length;document.getElementById('hallMeta').textContent=`Semaine: ${S.week} | Joueurs: ${realCount}`}

function renderAcademie(){
  const wrap=document.getElementById('acadGrid');
  if(!wrap)return;
  wrap.innerHTML='';
  const p=cur?S.players[cur]:null;
  const done=p&&Array.isArray(p.acadIds)?p.acadIds:[];
  const coeff=p?acadCoeff(p):1;
  // Titre coeff
  const cc=document.getElementById('acadCoeffDisp');
  if(cc)cc.textContent='Coefficient actuel : ×'+coeff.toFixed(2)+(done.length>0?' ('+done.length+' module'+(done.length>1?'s':'')+' accompli'+(done.length>1?'s':'')+')':'');
  // Filtre actif
  const fLevel=document.getElementById('acadFilterLevel');
  const fSubj=document.getElementById('acadFilterSubj');
  const lv=fLevel?fLevel.value:'';
  const sj=fSubj?fSubj.value:'';
  ACAD_REGISTRY.forEach(mod=>{
    if(lv&&mod.level!==lv)return;
    if(sj&&mod.subject!==sj)return;
    const isDone=done.includes(mod.id);
    const card=document.createElement('div');
    card.className='acad-card'+(isDone?' acad-done':'');
    card.innerHTML=`
      <div class="acad-icon">${mod.icon}</div>
      <div class="acad-meta"><span class="acad-level">${mod.level}</span> · <span class="acad-subj">${mod.subject}</span></div>
      <div class="acad-title">${mod.title}</div>
      <div class="acad-status">${isDone?'✅ Accompli':'⬜ À faire'}</div>
      <button class="acad-btn ${isDone?'acad-redo':''}" onclick="openAcadModule('${mod.id}','${mod.file}')">${isDone?'↩ Refaire':'▶ Commencer'}</button>
    `;
    wrap.appendChild(card);
  });
  if(!wrap.children.length)wrap.innerHTML='<p style="color:#aaa;font-size:0.8em">Aucun module pour ce filtre.</p>';
}

function openAcadModule(id,file){
  if(!cur&&!isVisitor){sm('acadMsg','Connecte-toi pour enregistrer ta progression.',false);return;}
  const code=cur||(isVisitor?VISITOR_CODE:'');
  const sep=file.includes('?')?'&':'?';
  const url=file+sep+'player='+encodeURIComponent(code)+'&moduleId='+encodeURIComponent(id);
  logEv(code||'ANON','OPEN_ACAD',id,0);save();
  window.open(url,'_blank','noopener');
}

function renderProfile(){const c=document.getElementById('profile'),h=document.getElementById('loginHint');if(!cur||!S.players[cur]){c.classList.remove('on');h.textContent=adminOn?'Session admin active.':'Session verrouillee. Authentification requise.';return}const p=S.players[cur];c.classList.add('on');h.textContent=`Joueur connecte: ${cur}`;document.getElementById('pCode').textContent=p.code;document.getElementById('pRole').textContent=roleLabel(p.code);document.getElementById('pXg').textContent=xg(p);document.getElementById('pXw').textContent=xw(p);document.getElementById('pCit').textContent=citizenXp(p);document.getElementById('pAca').textContent=academyXp(p);document.getElementById('pVid').textContent=videoXp(p);document.getElementById('pPend').textContent=socialPendingG(p);const ac=acadCoeff(p);
document.getElementById('pAcadCoeff').textContent='×'+ac.toFixed(2)+' ('+acadDoneCount(p)+' modules)';
document.getElementById('pCp').textContent=cpTotal(p);const nbAcad=acadDoneCount(p);const acadEl=document.getElementById('pAcadCoeff');if(acadEl)acadEl.textContent=nbAcad>0?`×${acadCoeff(p).toFixed(2)} (${nbAcad} module${nbAcad>1?'s':''})`:'×1,00 (aucun module)';const xgFEl=document.getElementById('pXgFinal');if(xgFEl)xgFEl.textContent=xgFinal(p);}
function renderLogs(){const b=document.getElementById('logBody');b.innerHTML='';const rows=S.logs.slice(0,140);if(!rows.length){b.innerHTML='<tr><td colspan=\"5\">Aucune action.</td></tr>';return}rows.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${new Date(r.d).toLocaleString('fr-FR')}</td><td>${r.p||'-'}</td><td>${r.t||'-'}</td><td>${r.target||'-'}</td><td>${r.xp||0}</td>`;b.appendChild(tr)})}
function renderPop(){const b=document.getElementById('popBody');const map={};S.logs.forEach(r=>{if(!map[r.target])map[r.target]={o:0,v:0};if(String(r.t||'').startsWith('OPEN_'))map[r.target].o+=1;if(r.t==='VALID_VIDEO')map[r.target].v+=1});const rows=Object.entries(map).sort((a,b)=>((b[1].o+b[1].v)-(a[1].o+a[1].v))).slice(0,12);b.innerHTML='';if(!rows.length){b.innerHTML='<tr><td colspan=\"3\">Aucune donnee.</td></tr>';return}rows.forEach(([k,v])=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${k||'-'}</td><td>${v.o}</td><td>${v.v}</td>`;b.appendChild(tr)})}
function updateCodesInfo(){const n=Object.keys(REG.j).length,np=Object.keys(PRW).length,na=Object.keys(ADW).length,src=S.registry_source?` | eleves: ${S.registry_source}`:'',srcA=S.adults_source?` | adultes: ${S.adults_source}`:'',srcP=S.parents_source?` | parents: ${S.parents_source}`:'';document.getElementById('codesInfo').textContent=(n||na||np)?`Referentiel charge: ${n} eleves + ${np} parents joueurs + ${na} adultes temoins/joueurs${src}${srcA}${srcP}`:'Referentiel codes: non charge.';updateSyncInfo()}

// ══════════════════════════════════════════════════
// INTRO VIDÉO
// ══════════════════════════════════════════════════
var _introSkipped=false;
function skipIntro(){
  if(_introSkipped)return;_introSkipped=true;
  var ov=document.getElementById('introOverlay');
  var vid=document.getElementById('introVideo');
  if(vid){try{vid.pause();}catch(e){}}
  if(ov){ov.classList.add('fade-out');setTimeout(function(){ov.style.display='none';},850);}
}
(function(){
  var _abs=setTimeout(skipIntro,9000);
  document.addEventListener('DOMContentLoaded',function(){
    var vid=document.getElementById('introVideo');
    if(!vid){clearTimeout(_abs);skipIntro();return;}
    var ov=document.getElementById('introOverlay');
    if(ov)ov.addEventListener('click',function(){clearTimeout(_abs);skipIntro();});
    vid.addEventListener('ended',function(){clearTimeout(_abs);skipIntro();});
    vid.addEventListener('error',function(){clearTimeout(_abs);skipIntro();});
    setTimeout(function(){if(!_introSkipped&&vid.readyState<1){clearTimeout(_abs);skipIntro();}},3000);
    var p=vid.play();
    if(p&&typeof p.catch==='function'){
      p.catch(function(){
        var btn=document.getElementById('introSkip');
        if(btn)btn.textContent='▶ Appuie pour continuer';
        setTimeout(function(){if(!_introSkipped)skipIntro();},5000);
      });
    }
  });
})();

// ══════════════════════════════════════════════════
// RÉCOMPENSES VIDÉO + JEU SECRET
// ══════════════════════════════════════════════════
const MILESTONES=[
  {xp:500,  file:'reward_apprenti.mp4',  title:'⚔️ L\'Apprenti Chevalier', label:'L\'Apprenti Chevalier',   sub:'Débloqué à 500 XP'},
  {xp:1000, file:'reward_ecuyere.mp4',   title:'🛡️ La Jeune Écuyère',      label:'La Jeune Écuyère',        sub:'Débloqué à 1 000 XP'},
  {xp:1500, file:'reward_chevalier.mp4', title:'⚔️ Le Jeune Chevalier',    label:'Le Jeune Chevalier',      sub:'Débloqué à 1 500 XP'},
  {xp:2000, file:'reward_paladine.mp4',  title:'✨ La Paladine Rayonnante', label:'La Paladine Rayonnante',  sub:'Débloqué à 2 000 XP'},
];
const SECRET_GAME={xp:500,file:'Chevaliers_Justice.html',title:'🎮 Les Chevaliers de la Justice',
  msg:'🏆 Tu as débloqué le jeu secret <strong>«&nbsp;Les Chevaliers de la Justice&nbsp;»</strong> !<br><br>Tous les 500 XP gagnés, ton personnage devient plus puissant !<br><br>⚔️ <em>Alors, progresse, jeune page !</em>'};
const REWARD_SEEN_KEY='pvs_rewards_seen';
function getSeenRewards(){try{return JSON.parse(localStorage.getItem(REWARD_SEEN_KEY)||'{}');}catch(e){return {};}}
function markRewardSeen(k){const s=getSeenRewards();s[String(k)]=1;localStorage.setItem(REWARD_SEEN_KEY,JSON.stringify(s));}
function isRewardSeen(k){return !!getSeenRewards()[String(k)];}
var rewardQueue=[],rewardPlaying=false;
function checkMilestones(){
  if(!cur||isVisitorCode(cur)||cur==='ADMIN')return;
  var p=gp(cur);if(!p)return;
  var xpNow=xg(p);
  MILESTONES.forEach(function(m){
    if(xpNow>=m.xp&&!isRewardSeen(m.xp)){
      markRewardSeen(m.xp);
      rewardQueue.push(m);
    }
  });
  if(SECRET_GAME&&xpNow>=SECRET_GAME.xp&&!isRewardSeen('game')){
    markRewardSeen('game');
    rewardQueue.push({isGame:true,...SECRET_GAME});
  }
  if(!rewardPlaying)playNextReward();
  renderRewardsSection();
}
function playNextReward(){
  if(!rewardQueue.length){rewardPlaying=false;return;}
  rewardPlaying=true;
  var m=rewardQueue.shift();
  if(m.isGame){
    var ov=document.getElementById('rewardOverlay');
    var t=document.getElementById('rewardTitle');
    if(t)t.innerHTML=m.title+'<br><small style="font-size:0.6em;color:#fff">'+m.msg+'</small>';
    if(ov){ov.classList.add('active');}
    setTimeout(function(){closeReward();},8000);
    return;
  }
  playRewardVideo(m.file,m.title);
}
function playRewardVideo(file,title){
  var ov=document.getElementById('rewardOverlay');
  var src=document.getElementById('rewardVideoSrc');
  var vid=document.getElementById('rewardVideo');
  var t=document.getElementById('rewardTitle');
  if(!ov||!src||!vid)return;
  src.src=file;vid.load();
  if(t)t.textContent=title||'';
  ov.classList.add('active');
  vid.play().catch(function(){});
  vid.addEventListener('ended',function(){closeReward();},{once:true});
}
function closeReward(){
  var ov=document.getElementById('rewardOverlay');
  var vid=document.getElementById('rewardVideo');
  if(vid){try{vid.pause();}catch(e){}}
  if(ov){ov.classList.add('fade-out');setTimeout(function(){ov.classList.remove('active','fade-out');},700);}
  rewardPlaying=false;
  setTimeout(playNextReward,800);
}
function renderRewardsSection(){
  var sec=document.getElementById('rewardsSection');
  var list=document.getElementById('rewardsList');
  var gameCard=document.getElementById('secretGameCard');
  if(!sec||!list)return;
  if(!cur||isVisitorCode(cur)){sec.style.display='none';return;}
  sec.style.display='block';
  var p=gp(cur);if(!p)return;
  var xpNow=xg(p);
  list.innerHTML='';
  MILESTONES.forEach(function(m){
    var unlocked=xpNow>=m.xp;
    var div=document.createElement('div');
    div.className='reward-item'+(unlocked?'':' ri-locked');
    var btn='';
    if(unlocked){
      var b=document.createElement('button');
      b.className='btn2';
      b.textContent='▶ Revoir';
      b.setAttribute('data-file',m.file);
      b.setAttribute('data-title',m.title);
      b.onclick=function(){playRewardVideo(this.getAttribute('data-file'),this.getAttribute('data-title'));};
      btn=b.outerHTML;
    }
    div.innerHTML='<span class="ri-icon">'+(unlocked?'🎬':'🔒')+'</span>'+
      '<div class="ri-info"><div class="ri-title">'+m.label+'</div>'+
      '<div class="ri-sub">'+(unlocked?m.sub:'??? · '+m.sub)+'</div></div>';
    if(unlocked){
      var b2=document.createElement('button');
      b2.className='btn2';
      b2.textContent='▶ Revoir';
      b2.setAttribute('data-file',m.file);
      b2.setAttribute('data-title',m.title);
      b2.onclick=function(){playRewardVideo(this.getAttribute('data-file'),this.getAttribute('data-title'));};
      div.appendChild(b2);
    }
    list.appendChild(div);
  });
  if(gameCard){
    if(xpNow>=SECRET_GAME.xp){
      gameCard.style.display='block';
      gameCard.innerHTML='<div style="background:linear-gradient(135deg,#1a1a2e,#2d1b69);border:2px solid #ffd700;border-radius:12px;padding:16px;text-align:center">'+
        '<div style="font-size:1.2em;font-weight:700;color:#ffd700;margin-bottom:8px">🎮 Jeu Secret Débloqué !</div>'+
        '<a href="Chevaliers_Justice.html?player='+encodeURIComponent(cur)+'" target="_blank" style="display:inline-block;margin-top:6px;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#000;padding:10px 24px;border-radius:10px;font-weight:700;text-decoration:none">⚔️ Jouer aux Chevaliers de la Justice</a></div>';
    } else {
      gameCard.style.display='block';
      gameCard.innerHTML='<div style="opacity:0.4;text-align:center;padding:10px;font-size:0.85em">🔒 Jeu secret — débloqué à '+SECRET_GAME.xp+' XP</div>';
    }
  }
}
function refresh(){resetWeek();save();renderAdminMode();renderHall();renderProfile();renderLogs();renderPop();renderMissionAdmin();renderNegReports();renderPosReports();renderAcademie();renderRewardsSection();checkMilestones();updateCodesInfo();updateVisitorUi();renderTutorial()}
function fill(){const as=document.getElementById('aType');as.innerHTML='';Object.entries(ACT).forEach(([k,v])=>as.innerHTML+=`<option value=\"${k}\">${v.l} (+${v.x})</option>`);const ms=document.getElementById('malType');ms.innerHTML='';Object.entries(MAL).forEach(([k,v])=>ms.innerHTML+=`<option value=\"${k}\">${v.l}</option>`)}
function switchHall(m){mode=m;document.getElementById('tg').classList.toggle('on',m==='global');document.getElementById('tw').classList.toggle('on',m==='week');renderHall()}
function withPlayer(url){if(!cur)return url;const s=url.includes('?')?'&':'?';return `${url}${s}player=${encodeURIComponent(cur)}`}
async function loginPlayer(){cm('loginMsg');const c=nCode((document.getElementById('authCode')||{}).value);if(!c){sm('authMsg','Entrer un identifiant joueur valide.',false);return}
adminOn=false;sessionStorage.removeItem(ADMIN_SESSION_KEY);const a=document.getElementById('authAdmin');if(a)a.value='';
if(isVisitorCode(c)){cur=VISITOR_CODE;isVisitor=true;gp(cur);localStorage.setItem(ACTIVE_PLAYER_KEY,cur);sessionStorage.setItem(SESSION_AUTH_KEY,'1');logEv(cur,'LOGIN_VISITOR','SUPERHUB',0);closeAuthGate();save(false);refresh();sm('loginMsg','Mode visiteur active.',true);openVisitorArticle();return}
if(hasRefCodes()&&!isKnownPlayerCode(c)){sm('authMsg','Code joueur absent du referentiel officiel.',false);return}
// Créer profil local marqué comme "à jour: jamais" pour que le cloud gagne toujours
const pLocal=gp(c);pLocal.up=new Date(0).toISOString();
cur=c;isVisitor=false;
localStorage.setItem(ACTIVE_PLAYER_KEY,c);sessionStorage.setItem(SESSION_AUTH_KEY,'1');
logEv(c,'LOGIN','SUPERHUB',0);closeAuthGate();
// Sauvegarder localement SANS push Supabase — le profil local est vide/stale
save(false);refresh();
sm('loginMsg',`Connexion active: ${c} — synchronisation cloud en cours…`,true);
// PULL EN PREMIER : attendre que Supabase réponde avant tout push
try{
  await syncPull(false);
  await sbPullCurrent(false);
}catch(e){}
// Maintenant sauvegarder (push Supabase) avec les vraies données cloud mergées
save(false); // persist local seulement, pas de push immédiat
sm('loginMsg',`Connexion active: ${c}`,true);
if(!localStorage.getItem(TUTORIAL_SEEN_KEY)){openTutorial(0);localStorage.setItem(TUTORIAL_SEEN_KEY,'1')}
else if(!localStorage.getItem(RULES_SEEN_KEY)){openRules();localStorage.setItem(RULES_SEEN_KEY,'1')}
if(isVisitor&&!localStorage.getItem(VISITOR_ARTICLE_SEEN_KEY))localStorage.setItem(VISITOR_ARTICLE_SEEN_KEY,'1')
}
function loginAdmin(){cm('loginMsg');const a=document.getElementById('authAdmin');const pass=String((a||{}).value||'');if(pass!==ADMIN_PASS){sm('authMsg','Identifiant admin invalide.',false);return}cur='';isVisitor=false;adminOn=true;localStorage.removeItem(ACTIVE_PLAYER_KEY);sessionStorage.setItem(SESSION_AUTH_KEY,'1');sessionStorage.setItem(ADMIN_SESSION_KEY,'1');if(a)a.value='';closeAuthGate();save();refresh();sm('loginMsg','Mode admin actif.',true);syncPull(false)}
function logoutPlayer(){cur='';isVisitor=false;adminOn=false;localStorage.removeItem(ACTIVE_PLAYER_KEY);sessionStorage.removeItem(SESSION_AUTH_KEY);sessionStorage.removeItem(ADMIN_SESSION_KEY);cm('loginMsg');closeVisitorArticle();closeTutorial();renderProfile();updateVisitorUi();openAuthGate('Session verrouillee. Identifie-toi pour continuer.')}
function guardPlayerBackup(){if(!cur||!S.players[cur]||isVisitor){sm('pbMsg','Connexion joueur requise (mode visiteur exclu).',false);return false}cm('pbMsg');return true}
function getPlayerRef(code){const c=nCode(code||'');if(!c)return null;return ((S.registry||[]).find(r=>nCode(r.code_joueur||'')===c)||null)}
function downloadPlayerBackup(){if(!guardPlayerBackup())return;const p=S.players[cur]||gp(cur);if(!p){sm('pbMsg','Profil joueur introuvable.',false);return}const r=getPlayerRef(cur)||{nom:'',prenom:'',code_joueur:cur,code_temoin:p.witness||'',code_public:defaultPublicCode(cur)};const head=['Nom','Prenom','Code_Joueur','Code_Temoin','Code_Public','CP_PIXHARE','CP_PSC1','CP_SANCTUAIRE','CP_LOGE','CP_AUTRES','SocialG','SocialW','WBonusG','WBonusW','VideoG','VideoW','MalusG','MalusW','WitnessGiven','RecognizedReceived','Obj_JSON','Saved_At'];const row=[esc(r.nom||''),esc(r.prenom||''),esc(cur),esc(r.code_temoin||p.witness||''),esc(r.code_public||defaultPublicCode(cur)),Math.floor(numOr(p.cp.pixhare,0)),Math.floor(numOr(p.cp.psc1,0)),Math.floor(numOr(p.cp.sanctuaire,0)),Math.floor(numOr(p.cp.loge,0)),Math.floor(numOr(p.cp.autres,0)),numOr(p.socialG,0),numOr(p.socialW,0),numOr(p.wBonusG,0),numOr(p.wBonusW,0),numOr(p.videoG,0),numOr(p.videoW,0),numOr(p.malusG,0),numOr(p.malusW,0),Math.max(0,Math.floor(numOr(p.witnessGiven,0))),Math.max(0,Math.floor(numOr(p.recognizedReceived,0))),esc(JSON.stringify(p.obj||{})),esc(new Date().toISOString())];const csv='\uFEFF'+head.join(',')+'\n'+row.join(',');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);const d=new Date();a.download=`backup_${cur}_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.csv`;a.click();URL.revokeObjectURL(a.href);logEv(cur,'BACKUP_EXPORT','LOCAL',0);save();refresh();sm('pbMsg','Sauvegarde joueur telechargee.',true)}
function importPlayerBackup(){if(!guardPlayerBackup())return;const el=document.getElementById('playerBackupFile');if(!el||!el.files||!el.files[0]){sm('pbMsg','Choisir un fichier .csv.',false);return}const f=el.files[0],rd=new FileReader();rd.onload=()=>{try{const row=rowObjFromText(rd.result||'');if(!row)throw new Error('row');const code=nCode(row.code_joueur||row.joueur||row.player_code||'');if(!code||code!==cur){sm('pbMsg','Le fichier ne correspond pas au joueur connecte.',false);return}const p=gp(cur);p.cp.pixhare=Math.max(0,Math.floor(numOr(row.cp_pixhare,p.cp.pixhare)));p.cp.psc1=Math.max(0,Math.floor(numOr(row.cp_psc1,p.cp.psc1)));p.cp.sanctuaire=Math.max(0,Math.floor(numOr(row.cp_sanctuaire,p.cp.sanctuaire)));p.cp.loge=Math.max(0,Math.floor(numOr(row.cp_loge,p.cp.loge)));p.cp.autres=Math.max(0,Math.floor(numOr(row.cp_autres,p.cp.autres)));p.socialG=numOr(row.socialg,p.socialG);p.socialW=numOr(row.socialw,p.socialW);p.wBonusG=numOr(row.wbonusg,p.wBonusG);p.wBonusW=numOr(row.wbonusw,p.wBonusW);p.videoG=numOr(row.videog,p.videoG);p.videoW=numOr(row.videow,p.videoW);p.malusG=numOr(row.malusg,p.malusG);p.malusW=numOr(row.malusw,p.malusW);p.witnessGiven=Math.max(0,Math.floor(numOr(row.witnessgiven,p.witnessGiven)));p.recognizedReceived=Math.max(0,Math.floor(numOr(row.recognizedreceived,p.recognizedReceived)));const witnessRaw=nCode(row.code_temoin||'');if(witnessRaw)p.witness=witnessRaw;const objRaw=String(row.obj_json||row.obj||'').trim();if(objRaw){try{const o=JSON.parse(objRaw);if(o&&typeof o==='object')p.obj=o}catch(e){}}p.up=new Date().toISOString();logEv(cur,'BACKUP_IMPORT','LOCAL',0);save();refresh();sm('pbMsg','Sauvegarde joueur importee.',true)}catch(e){sm('pbMsg','Fichier de sauvegarde invalide.',false)}};rd.onerror=()=>sm('pbMsg','Lecture du fichier impossible.',false);rd.readAsText(f)}
function resolveWitness(wc){const c=nCode(wc);if(!c)return null;if(REG.t[c])return {kind:'student',player:REG.t[c],code:c};if(ADW[c])return {kind:'adult',code:c,player:ADW[c]||c};if(hasRefCodes())return null;for(const k of Object.keys(S.players)){if(nCode(S.players[k].witness)===c)return {kind:'student',player:k,code:c}}return null}
function resolvePublicTarget(v){const c=nCode(v);if(!c)return '';if(REG.p[c])return REG.p[c];if(PRP[c])return PRP[c];if(REG.j[c]||PRW[c]||ADW[c])return c;if(hasRefCodes())return '';return c}
function witnessAction(){
  cm('wMsg');
  if(isVisitor){
    const targetDemo=nCode(document.getElementById('tCode').value),kDemo=document.getElementById('aType').value,aDemo=ACT[kDemo];
    if(!targetDemo||!aDemo){sm('wMsg','Mode visiteur: renseigner une cible et une action.',false);return}
    sm('wMsg',`Mode visiteur: simulation (+${aDemo.x} XP pour ${targetDemo}), sans impact reel.`,true);return;
  }
  if(isParentPlayerCode(cur)){sm('wMsg','Les comptes parents ne peuvent pas temoigner.',false);return}
  const rawW=document.getElementById('wCode').value;
  const rawT=document.getElementById('tCode').value;
  const k=document.getElementById('aType').value;
  const desc=(document.getElementById('wDesc')||{}).value||'';
  const w=resolveWitness(rawW);
  if(!w){
    const wc=nCode(rawW);
    if(!wc)sm('wMsg','⚠ Code temoin vide.',false);
    else if(hasRefCodes())sm('wMsg',`⚠ Code temoin "${wc}" non reconnu dans le referentiel.`,false);
    else sm('wMsg',`⚠ Code temoin "${wc}" introuvable.`,false);
    return;
  }
  const targetPublic=nCode(rawT),t=resolvePublicTarget(targetPublic);
  if(!t){
    if(!targetPublic)sm('wMsg','⚠ Code public cible vide.',false);
    else if(hasRefCodes())sm('wMsg',`⚠ Code "${targetPublic}" absent du referentiel.`,false);
    else sm('wMsg',`⚠ Code "${targetPublic}" introuvable.`,false);
    return;
  }
  if(hasRefCodes()&&!isKnownPlayerCode(t)){sm('wMsg','⚠ Code public cible absent du referentiel.',false);return}
  if(w.kind==='student'&&hasRefCodes()&&!REG.j[w.player]){sm('wMsg','⚠ Code temoin eleve absent du referentiel.',false);return}
  if(w.kind==='student'&&w.player===t){sm('wMsg','⚠ Temoin et cible doivent etre differents.',false);return}
  const a=ACT[k];if(!a){sm('wMsg','⚠ Action invalide.',false);return}
  const tp=gp(t);
  const cw=wk(new Date());
  if(w.kind==='adult'){
    const gain=Math.max(1,Math.round(a.x/2));
    tp.socialG+=gain;tp.socialW+=gain;tp.recognizedReceived+=1;tp.receivedW=(tp.receivedW||0)+1;
    logEv(w.code,'WITNESS_ADULT',targetPublic||t,gain);
    sendEmail('✅ Temoignage ADULTE positif',{type:'Temoignage positif (adulte)',temoin:w.code,cible:targetPublic||t,action:a.l,points:gain,description:desc,statut:'Applique immediatement'});
    save();refresh();
    sm('wMsg',`Temoignage adulte enregistre : +${gain} XP pour ${t}.`,true);return;
  }
  const wp=gp(w.player);
  wp.witnessGivenW=Number(wp.witnessGivenW||0);
  wp.pairW=wp.pairW||{};
  tp.receivedW=Number(tp.receivedW||0);
  tp.pairW=tp.pairW||{};
  // RÈGLE 1 — Paire symétrique
  if(tp.pairW[w.player]===cw){
    sm('wMsg','⛔ ANTI-TRICHE : Ce camarade t\'a deja valide cette semaine. Validation reciproque interdite.',false);return;
  }
  // RÈGLE 2 — Jetons témoin
  if(wp.witnessGivenW>=JETON_MAX){
    wp.flaggedExcess=(wp.flaggedExcess||0)+1;
    logEv(w.player,'JETON_DEPASSE',t,0);save();refresh();
    sm('wMsg',`⛔ Tu as atteint ta limite de ${JETON_MAX} temoignages cette semaine. `+
      `Tu es convoque${wp.flaggedExcess>1?' (RECIDIVE)':''} par M. Brulois pour argumenter tes choix. `+
      `Faux temoignage = -500 XP minimum.`,false);
    sendEmail('⚠ DEPASSEMENT JETONS TEMOIN',{type:'Alerte anti-triche — depassement jetons',temoin:w.player,cible:targetPublic||t,action:a.l,description:desc,statut:`DEPASSEMENT (${wp.witnessGivenW}/${JETON_MAX}) — Convocation requise`,recidive:wp.flaggedExcess>1?'OUI':'NON'});
    return;
  }
  // RÈGLE 3 — Plafond reçu
  if(tp.receivedW>=RECU_MAX){
    sm('wMsg',`⛔ ${t} a deja recu le maximum de ${RECU_MAX} validations cette semaine.`,false);return;
  }
  // RÈGLE 4 — Double témoin requis ?
  const needDouble=HIGH_VALUE_KEYS.includes(k)||a.x>=HIGH_VALUE_XP||tp.receivedW>=1;
  if(needDouble){
    const existing=(S.pos_reports||[]).find(r=>
      r.status==='pending_2nd'&&r.target_player===t&&r.action_key===k&&
      r.witness1_player!==w.player&&r.week===cw);
    if(existing){
      applyPosReportWith2nd(existing.id,w,wp,desc);return;
    }
    const dupW=(S.pos_reports||[]).find(r=>
      r.status==='pending_2nd'&&r.target_player===t&&r.witness1_player===w.player&&r.week===cw);
    if(dupW){sm('wMsg','⚠ Tu as deja soumis un pre-temoignage pour cette cible cette semaine. Un 2e temoin independant doit valider.',false);return;}
    if(!S.pos_reports)S.pos_reports=[];
    const rep={id:Date.now()+'_'+Math.random().toString(36).slice(2),
      d:new Date().toISOString(),week:cw,status:'pending_2nd',
      target_player:t,target_code:targetPublic||t,
      action_key:k,action_label:a.l,xp:a.x,
      witness1_player:w.player,witness1_code:rawW,description1:desc};
    S.pos_reports.push(rep);save();refresh();
    sm('wMsg',`⏳ Pre-temoignage enregistre pour ${t} (${a.l}). En attente d\'un 2e temoin independant.`,true);
    sendEmail('⏳ Pre-temoignage en attente 2e temoin',{type:'Double temoin requis',temoin:w.player,cible:targetPublic||t,action:a.l,description:desc,statut:'EN ATTENTE 2e temoin'});
    return;
  }
  // Validation simple immédiate
  applyPosReport(t,w,wp,a,targetPublic,desc,cw);
}

function applyPosReport(t,w,wp,a,targetPublic,desc,cw){
  const tp=gp(t);
  tp.socialG+=a.x;tp.socialW+=a.x;tp.recognizedReceived+=1;tp.receivedW=(tp.receivedW||0)+1;
  wp.witnessGiven+=1;wp.witnessGivenW+=1;
  wp.pairW=wp.pairW||{};wp.pairW[t]=cw;
  tp.pairW=tp.pairW||{};tp.pairW[w.player]=cw;
  let bonus=0;
  if(Number(wp.recognizedReceived||0)>0){bonus=Math.max(1,Math.round(a.x*0.10));wp.wBonusG+=bonus;wp.wBonusW+=bonus;}
  logEv(w.player,'WITNESS',targetPublic||t,a.x);
  if(bonus>0)logEv(w.player,'WITNESS_BONUS',w.player,bonus);
  save();refresh();
  sendEmail('✅ Temoignage positif validé',{type:'Temoignage positif immediat',temoin:w.player,cible:targetPublic||t,action:a.l,points:a.x,bonus,description:desc,statut:'Applique immediatement'});
  sm('wMsg',bonus>0?`+${a.x} XP pour ${t} | +${bonus} XP bonus pour ${w.player}`:`+${a.x} XP pour ${t}.`,true);
}
function applyPosReportWith2nd(id,w,wp,desc2){
  const r=findPosRep(id);
  if(!r){sm('wMsg','⚠ Pre-temoignage introuvable.',false);return}
  r.witness2_code=w.code||w.player;r.witness2_player=w.player;
  r.description2=desc2;r.status='applied';r.processed_at=new Date().toISOString();
  const tp=gp(r.target_player);
  const a=ACT[r.action_key]||{x:r.xp||0,l:r.action_label||''};
  const cw=r.week;
  tp.socialG+=a.x;tp.socialW+=a.x;tp.recognizedReceived+=1;tp.receivedW=(tp.receivedW||0)+1;
  const wp1=gp(r.witness1_player);
  wp1.witnessGiven+=1;wp1.witnessGivenW=(wp1.witnessGivenW||0)+1;
  wp1.pairW=wp1.pairW||{};wp1.pairW[r.target_player]=cw;
  tp.pairW=tp.pairW||{};tp.pairW[r.witness1_player]=cw;
  wp.witnessGiven+=1;wp.witnessGivenW=(wp.witnessGivenW||0)+1;
  let bonus=0;
  if(Number(wp1.recognizedReceived||0)>0){bonus=Math.max(1,Math.round(a.x*0.10));wp1.wBonusG+=bonus;wp1.wBonusW+=bonus;}
  logEv(r.witness1_player,'WITNESS',r.target_code||r.target_player,a.x);
  logEv(w.player,'WITNESS_2ND',r.target_code||r.target_player,0);
  save();refresh();
  sendEmail('✅ Double temoignage validé',{type:'Validation double temoin',temoin1:r.witness1_player,temoin2:w.player,cible:r.target_code||r.target_player,action:a.l,points:a.x,description1:r.description1||'',description2:desc2,statut:'Applique — 2 temoins independants'});
  sm('wMsg',`✅ Double temoignage valide ! +${a.x} XP pour ${r.target_player}.`,true);
}
function findPosRep(id){return(S.pos_reports||[]).find(r=>r.id==id)}
function flagFalsePosReport(id){
  const r=findPosRep(id);if(!r)return;
  [r.witness1_player,r.witness2_player].forEach(function(code){
    if(!code)return;
    const p=gp(code);if(!p)return;
    p.malusG+=-MAL_FAUX_DOUBLE;p.malusW+=-MAL_FAUX_DOUBLE;
    logEv(code,'FAUX_TEMOIGNAGE',r.target_player,MAL_FAUX_DOUBLE);
  });
  r.status='false_report';save();refresh();
  sm('sMsg',`Faux temoignage signal. Malus ${MAL_FAUX_DOUBLE} XP applique aux temoins.`,false);
}
function renderPosReports(){
  const b=document.getElementById('posBody');if(!b)return;
  b.innerHTML='';
  const rows=(S.pos_reports||[]).filter(r=>r.status==='pending_2nd').slice(0,150);
  if(!rows.length){b.innerHTML='<tr><td colspan="7">Aucun pre-temoignage en attente.</td></tr>';return}
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    const d=new Date(r.d||Date.now()).toLocaleDateString('fr-FR');
    tr.innerHTML=`<td>${d}</td><td>${r.witness1_player||''}</td><td>—</td><td>${r.target_code||r.target_player||''}</td><td>${r.action_label||r.action_key||''}</td><td>⏳ En attente</td>` +
      `<td><button class="btnNuclear" style="font-size:0.75em;padding:4px 8px" onclick="flagFalsePosReport('${r.id}')">🚨 Faux ×2</button></td>`;
    b.appendChild(tr);
  });
}
function updateJetonDisplay(){
  const el=document.getElementById('jetonCount');if(!el)return;
  const rawW=document.getElementById('wCode');if(!rawW)return;
  const wc=nCode(rawW.value||'');
  const p=wc?S.players[wc]:null;
  if(!p){el.textContent=JETON_MAX+' jetons';el.style.color='';return;}
  const used=Number(p.witnessGivenW||0);
  const left=Math.max(0,JETON_MAX-used);
  el.textContent=left+' jeton'+(left>1?'s':'')+' restant'+(left>1?'s':'');
  el.style.color=left===0?'#f44':left===1?'#ff9800':'#4caf50';
}
function needCur(){if(!cur||!S.players[cur]){sm('sMsg','Connecter un joueur avant cette action.',false);return null}cm('sMsg');return S.players[cur]}
function syncPixhare(){const p=needCur();if(!p)return;const v=['NUM','JUR','GRO','HIS'].map(k=>Number(localStorage.getItem(`PROG_${k}`)||0)).reduce((a,b)=>a+b,0);p.cp.pixhare=v;logEv(cur,'SYNC_PIXHARE','LOCAL',v*W.pixhare);save();refresh();sm('sMsg',`CP PIXHARe importes: ${v}`,true)}
function syncPsc1(){const p=needCur();if(!p)return;let v=0;try{const d=JSON.parse(localStorage.getItem('psc1_progression')||'{}');v+=(Array.isArray(d.p1)?d.p1.length:0)+(Array.isArray(d.p2)?d.p2.length:0)+(Array.isArray(d.p3)?d.p3.length:0)+(Array.isArray(d.p4)?d.p4.length:0)+(Array.isArray(d.p5)?d.p5.length:0)}catch(e){v=0}p.cp.psc1=v;logEv(cur,'SYNC_PSC1','LOCAL',v*W.psc1);save();refresh();sm('sMsg',`CP PSC1 importes: ${v}`,true)}
function openTracked(scope,target,url){cm('vMsg');const actor=cur||(adminOn?'ADMIN':(isVisitor?VISITOR_CODE:''));if(!actor){sm('vMsg','Connecter un joueur, visiteur ou admin avant ouverture.',false);return}const linkCode=cur||(isVisitor?VISITOR_CODE:'');const sep=url.includes('?')?'&':'?';const openUrl=linkCode?(url+sep+'player='+encodeURIComponent(linkCode)):url;logEv(actor,'OPEN_'+scope.toUpperCase(),target,0);save();refresh();window.open(openUrl,'_blank','noopener')}
function openNegativeHub(){const url=withPlayer('hub_temoignages_negatifs.html');if(cur){logEv(cur,'OPEN_NEGATIVE','NEGATIVE_HUB',0);save();refresh()}window.open(url,'_blank','noopener')}
function guardAdmin(){if(!adminOn){sm('aMsg','Connexion admin requise.',false);return false}return true}
function adCode(){return nCode(document.getElementById('adCode').value)}
function setCp(){if(!guardAdmin())return;const c=adCode(),h=document.getElementById('adHub').value,v=Number(document.getElementById('adCp').value||0);if(!c||!(h in W)||v<0){sm('aMsg','Parametres CP invalides.',false);return}if(hasRefCodes()&&!isKnownPlayerCode(c)){sm('aMsg','Code absent du referentiel.',false);return}const p=gp(c);p.cp[h]=Math.floor(v);logEv(c,'CP_SET',h,p.cp[h]*W[h]);save();refresh();sm('aMsg',`CP ${h} definis a ${p.cp[h]} pour ${c}.`,true)}
function addCp(){if(!guardAdmin())return;const c=adCode(),h=document.getElementById('adHub').value,v=Number(document.getElementById('adCp').value||0);if(!c||!(h in W)||v<0){sm('aMsg','Parametres CP invalides.',false);return}if(hasRefCodes()&&!isKnownPlayerCode(c)){sm('aMsg','Code absent du referentiel.',false);return}const p=gp(c);p.cp[h]=Math.max(0,Number(p.cp[h]||0)+Math.floor(v));logEv(c,'CP_ADD',h,Math.floor(v)*W[h]);save();refresh();sm('aMsg',`CP ${h} augmentes a ${p.cp[h]} pour ${c}.`,true)}
function applyMalus(){if(!guardAdmin())return;const c=adCode(),k=document.getElementById('malType').value;if(!c||!MAL[k]){sm('aMsg','Code ou malus invalide.',false);return}if(hasRefCodes()&&!isKnownPlayerCode(c)){sm('aMsg','Code absent du referentiel.',false);return}const p=gp(c);if(k==='reset_total'){p.cp={pixhare:0,psc1:0,sanctuaire:0,loge:0,autres:0};p.socialG=0;p.socialW=0;p.wBonusG=0;p.wBonusW=0;p.videoG=0;p.videoW=0;p.malusG=0;p.malusW=0;p.witnessGivenW=0;p.receivedW=0;p.pairW={};p.witnessGiven=0;p.recognizedReceived=0;p.obj={}}else{p.malusG+=MAL[k].x;p.malusW+=MAL[k].x}logEv(c,'MALUS',k,MAL[k].x);save();refresh();sm('aMsg',`Malus applique a ${c}.`,true)}
function parseMultiCodes(raw){return String(raw||'').split(/[\s,;|]+/).map(nCode).filter(Boolean)}
function addMissionPlayers(key){if(!guardAdmin())return;if(!CIT[key])return;const input=document.getElementById(`mIn_${key}`);const codes=parseMultiCodes(input?input.value:'');if(!codes.length){sm('aMsg','Entrer au moins un code joueur.',false);return}let add=0,skip=0;const list=missionList(key);codes.forEach(c=>{if(hasRefCodes()&&!isKnownPlayerCode(c)){skip+=1;return}if(!list.includes(c)){list.push(c);gp(c);add+=1;logEv(c,'MISSION_ADD',key,CIT[key].xp)}});if(input)input.value='';save();refresh();sm('aMsg',`${add} ajout(s) dans ${CIT[key].title}${skip?` | ${skip} ignore(s)`:''}.`,add>0)}
function removeMissionPlayer(key,code){if(!guardAdmin())return;const c=nCode(code),list=missionList(key),i=list.indexOf(c);if(i<0){sm('aMsg','Code non trouve.',false);return}list.splice(i,1);logEv(c,'MISSION_REMOVE',key,0);save();refresh();sm('aMsg',`${c} retire de ${CIT[key].title}.`,true)}
function removeMissionSelected(key){if(!guardAdmin())return;const sel=document.getElementById(`mSel_${key}`),code=nCode(sel&&sel.value||'');if(!code){sm('aMsg','Choisir un inscrit a desinscrire.',false);return}removeMissionPlayer(key,code)}
function renderMissionAdmin(){const root=document.getElementById('missionAdmin');if(!root)return;root.innerHTML='';if(!adminOn){root.innerHTML='<article class=\"card\"><div class=\"hint\">Connecte-toi en mode admin pour gerer les categories.</div></article>';return}Object.keys(CIT).forEach(k=>{const m=CIT[k],list=missionList(k).slice().sort();const box=document.createElement('article');box.className='card';const opts=list.length?list.map(code=>{const ref=REG.j[code];const who=ref?`${ref.nom||''} ${ref.prenom||''}`.trim():'-';return `<option value=\"${code}\">${code} - ${who||'-'}</option>`}).join(''):'<option value=\"\">Aucun eleve</option>';box.innerHTML=`<h3>${m.title} (+${m.xp})</h3><div class=\"row\"><label for=\"mIn_${k}\">Ajouter des codes joueurs</label><input id=\"mIn_${k}\" placeholder=\"CODE1 CODE2 ...\"></div><div class=\"rw\"><button class=\"btn2\" onclick=\"addMissionPlayers('${k}')\">Enregistrer</button></div><div class=\"row\"><label for=\"mSel_${k}\">Inscrits (${list.length})</label><select id=\"mSel_${k}\" size=\"6\">${opts}</select></div><div class=\"rw\"><button class=\"btn2\" onclick=\"removeMissionSelected('${k}')\">Desinscrire selection</button></div>`;root.appendChild(box)})}
function renderNegReports(){const b=document.getElementById('negBody');if(!b)return;b.innerHTML='';const rows=(S.neg_reports||[]).slice(0,120);if(!rows.length){b.innerHTML='<tr><td colspan=\"6\">Aucun pre-signalement.</td></tr>';return}rows.forEach(r=>{const tr=document.createElement('tr');const d=new Date(r.d||Date.now()).toLocaleString('fr-FR');const tw=r.witness_kind==='adult'?`ADULTE:${r.witness_code}`:`ELEVE:${r.witness_player||r.witness_code}`;const tg=r.target_player||r.target_public||'-';const st=r.status||'pending';const acts=st==='pending'?`<button class=\"btn2\" onclick=\"applyNegToTarget('${r.id}')\">Appliquer</button> <button class=\"btn2\" onclick=\"flagFalseReport('${r.id}')\">Faux -500</button>`:'-';tr.innerHTML=`<td>${d}</td><td>${tw}</td><td>${tg}</td><td>${r.incident||'-'}</td><td>${st}</td><td>${acts}</td>`;b.appendChild(tr)})}
function findNeg(id){return (S.neg_reports||[]).find(r=>r.id===id)}
function applyNegToTarget(id){if(!guardAdmin())return;const r=findNeg(id);if(!r){sm('aMsg','Signalement introuvable.',false);return}if(r.status&&r.status!=='pending'){sm('aMsg','Signalement deja traite.',false);return}let t=nCode(r.target_player||'');if(!t&&r.target_public){t=resolvePublicTarget(nCode(r.target_public));if(t)r.target_player=t}if(!t){sm('aMsg',`Cible non resolue (public: ${r.target_public||'?'}). Charge le referentiel complet en admin.`,false);return}const p=gp(t),k=(r.incident in MAL)?r.incident:'incivilite';if(k==='reset_total'){p.cp={pixhare:0,psc1:0,sanctuaire:0,loge:0,autres:0};p.socialG=0;p.socialW=0;p.wBonusG=0;p.wBonusW=0;p.videoG=0;p.videoW=0;p.malusG=0;p.malusW=0;p.witnessGiven=0;p.recognizedReceived=0;p.obj={}}else{p.malusG+=MAL[k].x;p.malusW+=MAL[k].x}r.status='applique';r.processed_at=new Date().toISOString();logEv(t,'NEG_MALUS',k,MAL[k].x);save();refresh();sm('aMsg',`Malus negatif applique a ${t}.`,true)}
function flagFalseReport(id){if(!guardAdmin())return;const r=findNeg(id);if(!r){sm('aMsg','Signalement introuvable.',false);return}if(r.status&&r.status!=='pending'){sm('aMsg','Signalement deja traite.',false);return}if(r.witness_kind!=='student'||!r.witness_player){r.status='faux_non_sanctionne';r.processed_at=new Date().toISOString();save();refresh();sm('aMsg','Temoin adulte: aucun -500 applique.',true);return}const p=gp(r.witness_player);p.malusG+=MAL.faux_temoignage.x;p.malusW+=MAL.faux_temoignage.x;r.status='faux';r.processed_at=new Date().toISOString();logEv(r.witness_player,'FALSE_REPORT','NEGATIVE',MAL.faux_temoignage.x);save();refresh();sm('aMsg',`-500 XP applique a ${r.witness_player}.`,true)}
function setRegistry(rows,source){S.registry=(rows||[]).filter(r=>nCode(r.code_joueur||'')).map(r=>({nom:demojibake(String(r.nom||'').trim()),prenom:demojibake(String(r.prenom||'').trim()),code_joueur:nCode(r.code_joueur),code_temoin:nCode(r.code_temoin||''),code_public:nCode(r.code_public||'')||defaultPublicCode(r.code_joueur)}));S.registry_source=String(source||'').trim();buildRegistry();Object.keys(REG.j).forEach(code=>{const p=gp(code);p.witness=REG.j[code].code_temoin||p.witness});norm();save();refresh()}
async function loadDefaultCodes(showMsg){try{const res=await fetch(DEFAULT_CODES_FILE,{cache:'no-store'});if(!res.ok)throw new Error('http');const txt=await res.text();const rows=parseCodesText(txt);if(!rows.length)throw new Error('empty');setRegistry(rows,DEFAULT_CODES_FILE);if(showMsg)sm('aMsg',`Referentiel charge: ${rows.length} lignes.`,true)}catch(e){if(showMsg)sm('aMsg','Chargement auto impossible. Importer manuellement en admin.',false)}}
function importCodesFile(){if(!guardAdmin())return;const el=document.getElementById('codesFile');if(!el||!el.files||!el.files[0]){sm('aMsg','Choisir un fichier TSV/CSV.',false);return}const f=el.files[0],rd=new FileReader();rd.onload=()=>{const rows=parseCodesText(rd.result||'');if(!rows.length){sm('aMsg','Aucune ligne code detectee.',false);return}setRegistry(rows,f.name);sm('aMsg',`Referentiel importe: ${rows.length} lignes.`,true)};rd.onerror=()=>sm('aMsg','Lecture impossible.',false);rd.readAsText(f)}
function setAdults(rows,source){S.adults=(rows||[]).map(a=>({nom:demojibake(String(a.nom||'').trim()),prenom:demojibake(String(a.prenom||'').trim()),code_temoin:nCode(a.code_temoin||''),code_joueur:nCode(a.code_joueur||a.code_temoin||'')})).filter(a=>a.code_temoin);S.adults_source=String(source||'').trim();buildAdultMap();save();refresh()}
function setParents(rows,source){S.parents=(rows||[]).map(p=>({nom:demojibake(String(p.nom||'').trim()),prenom:demojibake(String(p.prenom||'').trim()),code_joueur:nCode(p.code_joueur||''),code_public:nCode(p.code_public||'')||defaultPublicCode(p.code_joueur||'')})).filter(p=>p.code_joueur);S.parents_source=String(source||'').trim();buildParentMap();save();refresh()}
async function loadDefaultAdults(showMsg){try{const res=await fetch(ADULT_DEFAULT_FILE,{cache:'no-store'});if(!res.ok)throw new Error('http');const txt=await res.text();const rows=parseAdultsText(txt);if(!rows.length)throw new Error('empty');setAdults(rows,ADULT_DEFAULT_FILE);if(showMsg)sm('aMsg',`Temoins adultes charges: ${rows.length} lignes.`,true)}catch(e){if(showMsg)sm('aMsg','Chargement adultes impossible. Importer manuellement.',false)}}
function importAdultFile(){if(!guardAdmin())return;const el=document.getElementById('adultFile');if(!el||!el.files||!el.files[0]){sm('aMsg','Choisir un fichier adultes TSV/CSV.',false);return}const f=el.files[0],rd=new FileReader();rd.onload=()=>{const rows=parseAdultsText(rd.result||'');if(!rows.length){sm('aMsg','Aucun temoin adulte detecte.',false);return}setAdults(rows,f.name);sm('aMsg',`Temoins adultes importes: ${rows.length} lignes.`,true)};rd.onerror=()=>sm('aMsg','Lecture adultes impossible.',false);rd.readAsText(f)}
async function loadDefaultParents(showMsg){try{const res=await fetch(PARENT_DEFAULT_FILE,{cache:'no-store'});if(!res.ok)throw new Error('http');const txt=await res.text();const rows=parseCodesText(txt);if(!rows.length)throw new Error('empty');setParents(rows,PARENT_DEFAULT_FILE);if(showMsg)sm('aMsg',`Parents joueurs charges: ${rows.length} lignes.`,true)}catch(e){if(showMsg)sm('aMsg','Chargement parents impossible.',false)}}
function importParentFile(){if(!guardAdmin())return;const el=document.getElementById('parentFile');if(!el||!el.files||!el.files[0]){sm('aMsg','Choisir un fichier parents TSV/CSV.',false);return}const f=el.files[0],rd=new FileReader();rd.onload=()=>{const rows=parseCodesText(rd.result||'');if(!rows.length){sm('aMsg','Aucun compte parent detecte.',false);return}setParents(rows,f.name);sm('aMsg',`Parents importes: ${rows.length} lignes.`,true)};rd.onerror=()=>sm('aMsg','Lecture parents impossible.',false);rd.readAsText(f)}
function openRules(){const m=document.getElementById('rulesModal');if(m)m.style.display='block'}
function closeRules(){const m=document.getElementById('rulesModal');if(m)m.style.display='none'}
function exportData(){if(!guardAdmin())return;document.getElementById('jsonBox').value=JSON.stringify(S,null,2);sm('aMsg','Export JSON genere.',true)}
function importData(){if(!guardAdmin())return;try{const p=JSON.parse(document.getElementById('jsonBox').value);if(!p||typeof p!=='object'||typeof p.players!=='object')throw new Error('bad');S={week:String(p.week||''),players:p.players||{},logs:Array.isArray(p.logs)?p.logs:[],seen:p.seen||{},registry:Array.isArray(p.registry)?p.registry:[],registry_source:String(p.registry_source||''),adults:Array.isArray(p.adults)?p.adults:[],adults_source:String(p.adults_source||''),parents:Array.isArray(p.parents)?p.parents:[],parents_source:String(p.parents_source||''),neg_reports:Array.isArray(p.neg_reports)?p.neg_reports:[],citizen_lists:p.citizen_lists||{}};buildRegistry();norm();buildAdultMap();buildParentMap();resetWeek();save();refresh();sm('aMsg','Import JSON applique.',true)}catch(e){sm('aMsg','Import JSON invalide.',false)}}
function downloadStateFile(){if(!guardAdmin())return;const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);const d=new Date();a.download=`superhub_snapshot_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.json`;a.click();URL.revokeObjectURL(a.href);sm('aMsg','Snapshot global telecharge.',true)}
function importStateFile(){if(!guardAdmin())return;const el=document.getElementById('stateFile');if(!el||!el.files||!el.files[0]){sm('aMsg','Choisir un snapshot .json.',false);return}const f=el.files[0],rd=new FileReader();rd.onload=()=>{try{const p=JSON.parse(String(rd.result||''));if(!p||typeof p!=='object'||typeof p.players!=='object')throw new Error('bad');S={week:String(p.week||''),players:p.players||{},logs:Array.isArray(p.logs)?p.logs:[],seen:p.seen||{},registry:Array.isArray(p.registry)?p.registry:[],registry_source:String(p.registry_source||''),adults:Array.isArray(p.adults)?p.adults:[],adults_source:String(p.adults_source||''),neg_reports:Array.isArray(p.neg_reports)?p.neg_reports:[],citizen_lists:p.citizen_lists||{}};buildRegistry();norm();buildAdultMap();resetWeek();save();refresh();sm('aMsg','Snapshot global importe.',true)}catch(e){sm('aMsg','Snapshot invalide.',false)}};rd.onerror=()=>sm('aMsg','Lecture snapshot impossible.',false);rd.readAsText(f)}
function esc(v){return `\"${String(v??'').replace(/\"/g,'\"\"')}\"`}
function downloadCsv(){if(!guardAdmin())return;const head=['Nom','Prenom','Code_Joueur','Code_Temoin','Code_Public','Points_Citoyen_Investi','Points_Academie','Points_Videos_Validees','XP_Global','XP_Hebdo','Temoignages_Donnes','Reconnaissances_Recues','Social_En_Attente','CP_PIXHARE','CP_PSC1','CP_Sanctuaire','CP_Loge','CP_Autres','Videos_Validees_Count'];const rows=[head.join(',')];const map={},base=[];const add=(r)=>{const c=nCode(r.code_joueur||'');if(!c||map[c])return;map[c]=1;base.push({nom:r.nom||'',prenom:r.prenom||'',code_joueur:c,code_temoin:nCode(r.code_temoin||''),code_public:nCode(r.code_public||'')||defaultPublicCode(c)})};(S.registry||[]).forEach(r=>add(r));(S.parents||[]).forEach(r=>add({nom:r.nom||'',prenom:r.prenom||'',code_joueur:r.code_joueur||'',code_temoin:'',code_public:r.code_public||''}));(S.adults||[]).forEach(r=>add({nom:r.nom||'',prenom:r.prenom||'',code_joueur:r.code_temoin||'',code_temoin:r.code_temoin||'',code_public:r.code_temoin||''}));Object.keys(S.players||{}).forEach(k=>add({nom:'',prenom:'',code_joueur:k,code_temoin:S.players[k].witness||'',code_public:defaultPublicCode(k)}));base.forEach(r=>{const code=nCode(r.code_joueur||''),p=S.players[code]||mkP(code),vCount=Object.values(p.obj||{}).filter(x=>x&&x.valid).length;rows.push([esc(r.nom||''),esc(r.prenom||''),esc(code),esc(r.code_temoin||p.witness||''),esc(r.code_public||code),citizenXp(p),academyXp(p),videoXp(p),xg(p),xw(p),Number(p.witnessGiven||0),Number(p.recognizedReceived||0),socialPendingG(p),p.cp.pixhare||0,p.cp.psc1||0,p.cp.sanctuaire||0,p.cp.loge||0,p.cp.autres||0,vCount].join(','))});const blob=new Blob(['\uFEFF'+rows.join('\n')],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);const d=new Date();a.download=`superhub_points_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.csv`;a.click();URL.revokeObjectURL(a.href);sm('aMsg','CSV telecharge (UTF-8 BOM).',true)}
function downloadLogsCsv(){if(!guardAdmin())return;const rows=['date,joueur,type,cible,xp'];S.logs.forEach(r=>rows.push([esc(r.d),esc(r.p),esc(r.t),esc(r.target),r.xp||0].join(',')));const blob=new Blob(['\uFEFF'+rows.join('\n')],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);const d=new Date();a.download=`superhub_logs_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.csv`;a.click();URL.revokeObjectURL(a.href);sm('aMsg','Logs CSV telecharges.',true)}
function getVideo(id){const k=nCode(id||'');return VIDEOS.find(v=>nCode(v.id||'')===k)||null}
function bridgeApply(ev){
if(!ev||!ev.id||S.seen[ev.id])return false;
S.seen[ev.id]=1;
if(ev.type==='NEGATIVE_REPORT'){
  const wCode=nCode(ev.witness_code||'');
  const targetPublic=nCode(ev.target_public||'');
  const targetPlayer=resolvePublicTarget(targetPublic);
  const wRes=resolveWitness(wCode);
  const item={id:String(ev.id),d:ev.d||new Date().toISOString(),witness_code:wCode,witness_kind:wRes?(wRes.kind||'unknown'):'unknown',witness_player:wRes&&wRes.player?wRes.player:'',target_public:targetPublic,target_player:targetPlayer,incident:String(ev.incident||'incivilite'),details:String(ev.details||''),status:'pending'};
  if(!Array.isArray(S.neg_reports))S.neg_reports=[];
  S.neg_reports.unshift(item);
  if(S.neg_reports.length>400)S.neg_reports.length=400;
  logEv(wCode||'REPORT','NEGATIVE_REPORT',targetPublic||'-',0);
  return true;
}
const code=nCode(ev.player||'');
if(!code)return false;
if(hasRefCodes()&&!isKnownPlayerCode(code)&&!isVisitorCode(code))return false;
const p=gp(code);
if(!p)return false;
if(ev.type==='PIXHARE_PROGRESS'){const b=Number(p.cp.pixhare||0),a=Math.max(b,Number(ev.cpTotal||b));if(a!==b){p.cp.pixhare=a;logEv(code,'PIXHARE_CODE',String(ev.module||'MODULE'),(a-b)*W.pixhare);return true}return false}
if(ev.type==='PSC1_PROGRESS'){const b=Number(p.cp.psc1||0),a=Math.max(b,Number(ev.cpTotal||b));if(a!==b){p.cp.psc1=a;logEv(code,'PSC1_CODE',String(ev.module||'MODULE'),(a-b)*W.psc1);return true}return false}
if(ev.type==='EGALITE_PROGRESS'){const b=Number(p.cp.autres||0),a=Math.max(b,Number(ev.cpTotal||b));if(a!==b){p.cp.autres=a;logEv(code,'EGALITE_CODE',String(ev.module||'MODULE'),(a-b)*W.autres);return true}return false}
if(ev.type==='VIDEO_OPEN'){const v=getVideo(ev.module||'')||{id:String(ev.module||'VIDEO'),offer:Number(ev.offer||0)},k=nCode(v.id);if(!p.obj[k])p.obj[k]={open:false,valid:false};let xp=0;if(!p.obj[k].open){p.obj[k].open=true;xp=Number((ev.offer ?? v.offer) || 0);p.videoG+=xp;p.videoW+=xp}logEv(code,'OPEN_VIDEO',k,xp);return true}
if(ev.type==='VIDEO_VALID'){const v=getVideo(ev.module||'')||{id:String(ev.module||'VIDEO'),reward:Number(ev.reward||0)},k=nCode(v.id);if(!p.obj[k])p.obj[k]={open:false,valid:false};if(p.obj[k].valid)return false;p.obj[k].valid=true;p.obj[k].open=true;const xp=Number((ev.reward ?? v.reward) || 0);p.videoG+=xp;p.videoW+=xp;logEv(code,'VALID_VIDEO',k,xp);return true}
return false}
function processBridge(){try{const arr=JSON.parse(localStorage.getItem(BRIDGE_KEY)||'[]');if(!Array.isArray(arr))return;let changed=false;arr.forEach(ev=>{if(bridgeApply(ev))changed=true});if(changed){save();refresh()}}catch(e){}}
document.addEventListener('DOMContentLoaded',async()=>{
fill();load();
initAudio();
if(!S.registry.length){await loadDefaultCodes(false)}else{buildRegistry();norm();updateCodesInfo()}
if(!S.parents||!S.parents.length){await loadDefaultParents(false)}else{buildParentMap()}
await loadDefaultAdults(false);  // Toujours recharger pour garantir le format code_joueur
await syncPing();
initSupabase();await syncPull(false);await sbPullAllPlayers(false);await sbPullGlobal(false);sbPullCurrent(false);
const q=nCode(new URLSearchParams(window.location.search).get('player')||'');if(q)localStorage.setItem(ACTIVE_PLAYER_KEY,q);
const remembered=nCode(localStorage.getItem(ACTIVE_PLAYER_KEY)||'');
const authInput=document.getElementById('authCode');
const authAdmin=document.getElementById('authAdmin');
if(authInput&&remembered)authInput.value=isVisitorCode(remembered)?'Visiteur-Viescolaire-ChateauRance':remembered;
const hasSession=sessionStorage.getItem(SESSION_AUTH_KEY)==='1';
const hasAdminSession=sessionStorage.getItem(ADMIN_SESSION_KEY)==='1';
if(hasSession&&hasAdminSession){
  cur='';isVisitor=false;adminOn=true;closeAuthGate();refresh();
}
else if(hasSession&&remembered){
  adminOn=false;
  cur=remembered;isVisitor=isVisitorCode(cur);
  if(cur&&hasRefCodes()&&!isKnownPlayerCode(cur)&&!isVisitor){cur='';isVisitor=false;refresh();openAuthGate('Session expiree ou identifiant invalide.');}
  else{if(cur&&!S.players[cur])gp(cur);closeAuthGate();refresh()}
}else{
  cur='';isVisitor=false;adminOn=false;refresh();openAuthGate()
}
processBridge();
if(authInput)authInput.addEventListener('keypress',e=>{if(e.key==='Enter')loginPlayer()});
if(authAdmin)authAdmin.addEventListener('keypress',e=>{if(e.key==='Enter')loginAdmin()});
window.addEventListener('resize',()=>renderTutorial());
window.addEventListener('scroll',()=>renderTutorial(),{passive:true});
});
window.addEventListener('storage',e=>{if(e.key===BRIDGE_KEY)processBridge()});
window.addEventListener('focus',()=>{processBridge();syncPull(false);sbPullAllPlayers(false)});

// --- Supabase hybrid sync (cloud + local) ---
const BRIDGE_ALT_KEY='SUPER_HUB_BRIDGE';
const SB_URL_DEFAULT='https://zmeicqjkylxdaldiovxg.supabase.co';
const SB_KEY_DEFAULT='sb_publishable_fvY1_6Pu7lMTNNBeBvI7Dw_jXLjv4oH';
const SB_URL_KEY='pvs_supabase_url';
const SB_PUBLISHABLE_KEY='pvs_supabase_publishable_key';
var sbClient=null,sbOnline=false,sbPushTimer=null,sbBusyPush=false,sbBusyPull=false,sbGlobalPushTimer=null,sbBusyGlobalPush=false,sbBusyGlobalPull=false;

function getSbUrl(){return String(localStorage.getItem(SB_URL_KEY)||SB_URL_DEFAULT).trim().replace(/\/+$/,'')}
function getSbKey(){return String(localStorage.getItem(SB_PUBLISHABLE_KEY)||SB_KEY_DEFAULT).trim()}
function isCloudPlayer(code){const c=nCode(code||'');return !!(c&&!isVisitorCode(c)&&c!=='ADMIN')}
function initSupabase(){try{if(window.supabase&&typeof window.supabase.createClient==='function'&&getSbUrl()&&getSbKey()){sbClient=window.supabase.createClient(getSbUrl(),getSbKey())}else{sbClient=null}}catch(e){sbClient=null}updateSyncInfo()}
function scheduleSbPush(){if(!sbClient)return;clearTimeout(sbPushTimer);sbPushTimer=setTimeout(()=>{sbPushCurrent(false)},900)}
function scheduleSbGlobalPush(){if(!sbClient)return;clearTimeout(sbGlobalPushTimer);sbGlobalPushTimer=setTimeout(()=>{sbPushGlobal(false)},8000)}
async function sbPullAllPlayers(showMsg){
  if(!sbClient||sbBusyGlobalPull)return false;
  sbBusyGlobalPull=true;
  try{
    const{data,error}=await sbClient.from('pvs_sync').select('player_id,full_state,updated_at');
    if(error)throw error;
    if(!data||!data.length){sbOnline=true;updateSyncInfo(showMsg?'Cloud: aucun joueur en base':'');return true}
    let changed=false;
    data.forEach(row=>{
      const code=nCode(row.player_id||'');
      if(code&&!isVisitorCode(code)&&code!=='ADMIN'&&row.full_state){
        if(mergeCloudPlayer(code,row.full_state))changed=true;
      }
    });
    if(changed){norm();buildRegistry();buildAdultMap();buildParentMap();localStorage.setItem(KEY,JSON.stringify(S));refresh()}
    sbOnline=true;
    updateSyncInfo(showMsg?`Cloud pull OK | ${data.length} joueurs charges`:'');
    return true;
  }catch(e){sbOnline=false;updateSyncInfo(showMsg?'Cloud pull impossible: '+e.message:'');return false}
  finally{sbBusyGlobalPull=false}
}
async function sbPushGlobal(showMsg){
  if(!sbClient||sbBusyGlobalPush)return false;sbBusyGlobalPush=true;
  try{
    const payload={state_id:'GLOBAL',full_state:{week:S.week,citizen_lists:S.citizen_lists,neg_reports:(S.neg_reports||[]).slice(0,200),registry:S.registry,registry_source:S.registry_source,adults:S.adults,adults_source:S.adults_source,parents:S.parents,parents_source:S.parents_source},updated_at:new Date().toISOString()};
    const{error}=await sbClient.from('pvs_global_state').upsert(payload,{onConflict:'state_id'});
    if(error)throw error;
    sbOnline=true;updateSyncInfo(showMsg?'Cloud push global OK':'');return true;
  }catch(e){sbOnline=false;updateSyncInfo(showMsg?'Cloud push impossible: '+e.message:'');return false}
  finally{sbBusyGlobalPush=false}
}
async function sbPullGlobal(showMsg){
  if(!sbClient||sbBusyGlobalPull)return false;sbBusyGlobalPull=true;
  try{
    const{data,error}=await sbClient.from('pvs_global_state').select('full_state,updated_at').eq('state_id','GLOBAL').maybeSingle();
    if(error)throw error;
    if(!data||!data.full_state){sbOnline=true;return true}
    const remote=data.full_state;let changed=false;
    if(remote.citizen_lists&&typeof remote.citizen_lists==='object'){ensureCitizenLists();Object.keys(remote.citizen_lists).forEach(k=>{if(Array.isArray(remote.citizen_lists[k])){const merged=[...new Set([...(S.citizen_lists[k]||[]),...remote.citizen_lists[k].map(nCode).filter(Boolean)])];if(merged.length!==(S.citizen_lists[k]||[]).length){S.citizen_lists[k]=merged;changed=true}}})}
    if(Array.isArray(remote.neg_reports)&&remote.neg_reports.length){const ids=new Set((S.neg_reports||[]).map(r=>r.id));remote.neg_reports.forEach(r=>{if(r.id&&!ids.has(r.id)){(S.neg_reports=S.neg_reports||[]).push(r);changed=true}})}
    if((!S.registry||!S.registry.length)&&Array.isArray(remote.registry)&&remote.registry.length){S.registry=remote.registry;S.registry_source=remote.registry_source||'cloud';changed=true}
    if(Array.isArray(remote.adults)&&remote.adults.length&&(!S.adults||!S.adults.length||!S.adults.some(a=>a.code_joueur))){S.adults=remote.adults;S.adults_source=remote.adults_source||'cloud';changed=true}
    if(changed){buildRegistry();norm();buildAdultMap();buildParentMap();localStorage.setItem(KEY,JSON.stringify(S));refresh()}
    sbOnline=true;updateSyncInfo(showMsg?'Cloud pull config OK':'');return true;
  }catch(e){sbOnline=false;updateSyncInfo(showMsg?'Cloud pull config impossible: '+e.message:'');return false}
  finally{sbBusyGlobalPull=false}
}
function mergeCloudPlayer(code,remote){
  if(!remote||typeof remote!=='object')return false;
  const local=gp(code);if(!local)return false;
  const lts=Date.parse(local.up||0)||0,rts=Date.parse(remote.up||0)||0;
  // Base = profil le plus récent
  const base=rts>=lts?remote:local;
  const other=rts>=lts?local:remote;
  const merged=Object.assign(mkP(code),base,{code});
  // ── Fusion ADDITIVE des champs académiques ──────────────────────
  // acadDone : union des deux objets (garder toutes les validations)
  const dBase=base.acadDone&&typeof base.acadDone==='object'?base.acadDone:{};
  const dOther=other.acadDone&&typeof other.acadDone==='object'?other.acadDone:{};
  merged.acadDone=Object.assign({},dOther,dBase); // base prioritaire pour les dates
  // acadIds : union des deux tableaux
  const iBase=Array.isArray(base.acadIds)?base.acadIds:[];
  const iOther=Array.isArray(other.acadIds)?other.acadIds:[];
  merged.acadIds=[...new Set([...iOther,...iBase])];
  // pairW : union (anti-triche hebdo)
  merged.pairW=Object.assign({},other.pairW||{},base.pairW||{});
  // Champs numériques : prendre le max (ne jamais perdre des XP gagnés)
  ['socialG','wBonusG','videoG','witnessGiven','recognizedReceived'].forEach(k=>{
    merged[k]=Math.max(Number(base[k]||0),Number(other[k]||0));
  });
  // Champs CP : max par hub
  merged.cp=merged.cp||{};
  const cpB=base.cp||{},cpO=other.cp||{};
  Object.keys(Object.assign({},cpB,cpO)).forEach(k=>{
    merged.cp[k]=Math.max(Number(cpB[k]||0),Number(cpO[k]||0));
  });
  // Timestamp = le plus récent
  merged.up=rts>=lts?(base.up||remote.up):(other.up||local.up);
  S.players[code]=merged;
  return true;
}
async function sbPullPlayer(code,showMsg){if(!sbClient||!isCloudPlayer(code)||sbBusyPull)return false;sbBusyPull=true;try{const {data,error}=await sbClient.from('pvs_sync').select('player_id,full_state,updated_at').eq('player_id',code).maybeSingle();if(error)throw error;let changed=false;if(data&&data.full_state&&typeof data.full_state==='object'){changed=mergeCloudPlayer(code,data.full_state)}if(changed){norm();localStorage.setItem(KEY,JSON.stringify(S));refresh()}sbOnline=true;updateSyncInfo(showMsg?`Supabase pull OK | ${code}`:'');return true}catch(e){sbOnline=false;updateSyncInfo(showMsg?'Supabase pull impossible.':'');return false}finally{sbBusyPull=false}}
async function sbPushPlayer(code,showMsg){if(!sbClient||!isCloudPlayer(code)||sbBusyPush)return false;const p=S.players[code];if(!p)return false;sbBusyPush=true;try{const payload={player_id:code,full_state:p,updated_at:new Date().toISOString()};const {error}=await sbClient.from('pvs_sync').upsert(payload,{onConflict:'player_id'});if(error)throw error;sbOnline=true;updateSyncInfo(showMsg?`Supabase push OK | ${code}`:'');return true}catch(e){sbOnline=false;updateSyncInfo(showMsg?'Supabase push impossible.':'');return false}finally{sbBusyPush=false}}
function sbPullCurrent(showMsg){const code=nCode(cur||'');if(!isCloudPlayer(code))return Promise.resolve(false);return sbPullPlayer(code,showMsg)}
function sbPushCurrent(showMsg){const code=nCode(cur||'');if(!isCloudPlayer(code))return Promise.resolve(false);return sbPushPlayer(code,showMsg)}

function updateSyncInfo(msg){const e=document.getElementById('syncInfo');if(!e)return;const sb=`Supabase: ${sbClient?(sbOnline?'connecte':'hors ligne'):'non configure'}`;if(msg){e.textContent=`${msg} | ${sb}`;return}e.textContent=`Sync serveur: ${syncOnline?'connecte':'hors ligne'} | rev: ${Number(syncRev||0)} | ${sb} | URL: ${getSyncUrl()}`}
function save(push=true){localStorage.setItem(KEY,JSON.stringify(S));if(push&&sessionStorage.getItem(SESSION_AUTH_KEY)==='1'){scheduleSyncPush();scheduleSbPush();scheduleSbGlobalPush()}}
function processBridge(){try{const a=JSON.parse(localStorage.getItem(BRIDGE_KEY)||'[]'),b=JSON.parse(localStorage.getItem(BRIDGE_ALT_KEY)||'[]');const arr=[...(Array.isArray(a)?a:[]),...(Array.isArray(b)?b:[])];if(!arr.length)return;let changed=false;arr.forEach(ev=>{if(bridgeApply(ev))changed=true});localStorage.setItem(BRIDGE_KEY,'[]');localStorage.setItem(BRIDGE_ALT_KEY,'[]');if(changed){save();refresh()}}catch(e){}}

window.addEventListener('DOMContentLoaded',()=>{initSupabase();if(cur)sbPullCurrent(false)});
window.addEventListener('storage',e=>{if(e.key===BRIDGE_ALT_KEY)processBridge()});
window.addEventListener('focus',()=>{sbPullAllPlayers(false);sbPullCurrent(false)});
</script>

<!-- ══════════════════════════ Récompenses ══ -->
<section id="rewardsSection" style="display:none">
  <div class="card">
    <button id="rewardsToggle" onclick="var l=document.getElementById('rewardsList');l.style.display=l.style.display==='none'?'block':'none'">🏆 Mes Récompenses &amp; Jeu Secret</button>
    <div id="rewardsList" style="margin-top:8px"></div>
    <div id="secretGameCard" style="margin-top:10px"></div>
  </div>
</section>

</body>
</html>











