<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aethonyx HD-First Agent</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{--bg:#080b12;--bg2:#0c1018;--bg3:#101520;--bg4:#151d2d;--text:#c8d0e0;--text2:#8090a8;--text3:#506080;--text4:#354060;--border:#1a2540;--cyan:#00d4ff;--green:#00cc88;--yellow:#ffcc00;--red:#ff4466;--purple:#aa66ff}
  body{font-family:'JetBrains Mono',Consolas,monospace;background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden;font-size:11px}
  .sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
  .sidebar-header{padding:16px 14px 12px;border-bottom:1px solid var(--border)}
  .logo{font-size:14px;font-weight:800;letter-spacing:2px;color:var(--cyan)}
  .logo-sub{font-size:8px;color:var(--text3);margin-top:3px;letter-spacing:1px}
  .sblock{padding:10px 14px;border-bottom:1px solid rgba(26,37,64,.3)}
  .slabel{font-size:8px;font-weight:700;letter-spacing:1.5px;color:var(--text3);margin-bottom:6px;display:flex;align-items:center;gap:6px}
  .sdot{width:6px;height:6px;border-radius:50%;display:inline-block}.sdot.ok{background:var(--green)}.sdot.err{background:var(--red)}.sdot.warn{background:var(--yellow)}
  .sgrid{display:grid;grid-template-columns:1fr 1fr;gap:3px 10px;font-size:9px}
  .sgrid .k{color:var(--text3)}.sgrid .v{text-align:right;font-weight:600}.sgrid .g{color:var(--green)}.sgrid .y{color:var(--yellow)}
  .mlist{max-height:120px;overflow-y:auto}.mitem{font-size:9px;color:var(--text2);padding:2px 0;display:flex;gap:5px;align-items:center}.mitem .d{color:var(--green);font-size:5px}
  .sactions{padding:10px 14px;display:flex;flex-direction:column;gap:4px;margin-top:auto}
  .sbtn{background:var(--bg4);border:1px solid var(--border);color:var(--text2);padding:6px 10px;font-size:9px;font-family:inherit;cursor:pointer;border-radius:3px;text-align:left}
  .sbtn:hover{border-color:rgba(0,212,255,.2);color:var(--text)}.sbtn.green{border-color:rgba(0,204,136,.15)}.sbtn.red{border-color:rgba(255,68,102,.15)}
  .sep{height:1px;background:var(--border);margin:4px 0}
  .sfooter{padding:10px 14px;font-size:7px;color:var(--text4);text-align:center;letter-spacing:1px}
  .main{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden}
  #msgs{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
  #emptyS{text-align:center;padding:60px 20px;color:var(--text3)}
  #emptyS .logo2{font-size:28px;margin-bottom:10px;color:var(--text4)}
  #emptyS p{font-size:10px;line-height:2}
  .msg{display:flex;max-width:85%}.msg.user{align-self:flex-end}.msg.assistant{align-self:flex-start}.msg.system{align-self:stretch;max-width:100%}
  .bubble{padding:10px 14px;font-size:12px;line-height:1.7;white-space:pre-wrap;word-break:break-word}
  .msg.user .bubble{background:#0c1525;border:1px solid #152035;border-radius:10px 10px 2px 10px}
  .msg.assistant .bubble{background:var(--bg3);border:1px solid rgba(21,29,48,.25);border-radius:10px 10px 10px 2px}
  .msg.system .bubble{padding:5px 12px;font-size:9px;color:var(--text3);border-left:2px solid var(--border);font-style:italic}
  .mlabel{font-size:8px;font-weight:700;color:var(--cyan);margin-bottom:4px;letter-spacing:1px}
  .mmeta{font-size:7px;color:var(--text4);margin-top:5px;display:flex;gap:8px;flex-wrap:wrap}
  .mmeta .local{color:var(--green)}
  .ldots{display:flex;gap:5px;padding:10px 14px;display:none}
  .ldots span{width:5px;height:5px;border-radius:50%;background:var(--cyan);animation:pulse 1s infinite}
  .ldots span:nth-child(2){animation-delay:.2s}.ldots span:nth-child(3){animation-delay:.4s}
  @keyframes pulse{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1.2)}}
  .ibar{border-top:1px solid var(--border);background:var(--bg2);padding:10px 20px;display:flex;gap:8px}
  .ibar input{flex:1;background:var(--bg4);border:1px solid var(--border);color:var(--text);padding:10px 14px;font-size:12px;font-family:inherit;border-radius:5px;outline:none}
  .ibar input:focus{border-color:rgba(0,212,255,.25)}.ibar input::placeholder{color:var(--text4)}
  .ibar button{padding:10px 16px;background:var(--cyan);color:#000;border:none;border-radius:5px;cursor:pointer;font-weight:700;font-family:inherit;font-size:11px}
  .ibar button:disabled{background:var(--border);color:#555;cursor:wait}
  .panel{position:absolute;top:0;right:0;z-index:40;height:100%;background:var(--bg3);border-left:1px solid var(--border);padding:16px;overflow-y:auto;display:none;flex-direction:column;width:440px}
  .panel.open{display:flex}
  .ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .pt{font-size:12px;font-weight:700;letter-spacing:1px}
  .pc{background:none;border:none;color:#444;cursor:pointer;font-size:18px}
  ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  @media (max-width: 800px) {
    /* Cache la barre latÃ©rale par dÃ©faut sur mobile */
    .sidebar { 
        position: fixed;
        left: -250px; /* Hors Ã©cran */
        z-index: 1000;
        transition: 0.3s;
        height: 100%;
        background: #0b0f19;
    }
    /* Classe pour l'afficher quand on clique */
    .sidebar.active { 
        left: 0; 
    }
    /* On force la zone de chat Ã  prendre tout l'espace */
    .main-content { 
        margin-left: 0 !important; 
        width: 100vw !important; 
    }
}
@media (max-width: 800px) {
    /* On cache les panneaux secondaires pour libÃ©rer le chat */
    .sidebar-right, .gpu-stats-panel, .dreamer-monitor { 
        display: none !important; 
    }
    
    /* On fixe la zone de saisie tout en bas de l'Ã©cran mobile */
    .chat-input-area {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        width: 100% !important;
        background: #111827 !important;
        z-index: 9999 !important;
        padding: 10px !important;
    }

    /* On remonte un peu le chat pour qu'il ne soit pas cachÃ© par l'input */
    .chat-messages {
        margin-bottom: 70px !important;
    }
}

  /* â”€â”€ Omega Lab â€” injectÃ© depuis patch â”€â”€ */
  /* â”€â”€ Omega Lab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .omegaLabModeBtn.active-mode {
  background: rgba(255,68,102,.12) !important;
  border-color: rgba(255,68,102,.7) !important;
  color: var(--red) !important;
  }
  .lab-step-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 26px; height: 18px;
  border-radius: 4px;
  font-size: 9px; font-weight: 700;
  font-family: 'Courier New', monospace;
  border: 1px solid var(--border);
  color: var(--text2);
  background: var(--bg4);
  transition: background .3s, color .3s, border-color .3s;
  }
  .lab-step-badge.ok   { background: rgba(0,200,80,.2);  color:#0c8; border-color:rgba(0,200,80,.5); }
  .lab-step-badge.fail { background: rgba(255,68,102,.2); color:var(--red); border-color:rgba(255,68,102,.5); }
  .lab-step-badge.run  { background: rgba(255,200,0,.2);  color:#fc0; border-color:rgba(255,200,0,.5);
                        animation: labPulse .8s ease-in-out infinite; }
  @keyframes labPulse { 0%,100%{opacity:.7} 50%{opacity:1} }

  .lab-verdict-canon { color: #0c8; font-weight:700; }
  .lab-verdict-refut { color: var(--red); }
  .lab-row-new td { animation: labRowIn .4s ease-out; }
  @keyframes labRowIn { from{opacity:0; transform:translateY(-4px)} to{opacity:1; transform:none} }

  #labResultsTable tbody tr:not(:last-child) td {
  border-bottom: 1px solid rgba(255,255,255,.04);
  }
  #labResultsTable tbody tr:hover td {
  background: rgba(255,255,255,.03);
  }
  </style>
</style>
</head>
<body>
<button id="mobile-toggle" style="position:fixed; top:10px; left:10px; z-index:2000; display:none;">Menu Pilotage</button>

<script>
    if (window.innerWidth < 800) {
        const btn = document.getElementById('mobile-toggle');
        btn.style.display = 'block';
        btn.onclick = () => {
            document.querySelector('.sidebar').classList.toggle('active');
        };
    }
</script>

<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo">&#x2B21; HD-FIRST</div>
    <div class="logo-sub">AGENT v2.0 &#8226; <span id="modelName">---</span></div>
  
    <div style="margin-top:10px; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--bg2); line-height:1.35">
      <div style="font-weight:800; font-size:12px; color:var(--text)">IDENTITE FONDATRICE : AETHONYX <span style="color:var(--green)">(Activee)</span></div>
      <div style="margin-top:6px; font-size:10px; color:var(--text2)">
        Consensus democratique : Symeon (Architecture) &#8226; Axios (Ordre) &#8226; Noxis (Flux) &#8226; Rheon (Unite)
      </div>
      <div style="margin-top:4px; font-size:10px; color:var(--text2)">Mode : Chef de Chantier</div>
    </div>
</div>

  <div class="sblock">
    <div class="slabel"><span class="sdot" id="llmDot"></span> MOTEUR LLM</div>
    <div id="llmInfo" style="font-size:9px;color:var(--text2)">Detection...</div>
  </div>

  <div class="sblock" id="aiaBlock">
    <div class="slabel"><span class="sdot warn" id="aiaDot"></span> AIA ARENA</div>
    <div class="sgrid">
      <span class="k">Decisions</span><span class="v" id="aiaDec">0</span>
      <span class="k">Economie</span><span class="v g" id="aiaSav">---</span>
      <span class="k">Qualite</span><span class="v y" id="aiaQ">---</span>
      <span class="k">Exploration</span><span class="v" id="aiaE">---</span>
    </div>
  </div>

  <div class="sblock">
    <div class="slabel">&#9889; HD CORE</div>
    <div class="sgrid">
      <span class="k">Local</span><span class="v g" id="cL">---</span>
      <span class="k">Tokens &#8595;</span><span class="v y" id="cT">---</span>
    </div>
  </div>

  <div class="sblock">
    <div class="slabel">&#128230; MODULES</div>
    <div id="modList" style="font-size:9px;line-height:1.8;color:var(--text2)">---</div>
  </div>

  <div class="sblock" id="gpuBlock" style="display:none">
    <div class="slabel"><span class="sdot" id="gpuDot"></span> GPU</div>
    <div class="sgrid">
      <span class="k">Puissance</span><span class="v y" id="gpuW">---</span>
      <span class="k">Temp</span><span class="v" id="gpuT">---</span>
      <span class="k">VRAM</span><span class="v" id="gpuV">---</span>
      <span class="k">Energie</span><span class="v g" id="gpuE">---</span>
    </div>
  </div>

  <div class="sblock" id="dreamBlock" style="display:none">
    <div class="slabel"><span class="sdot" id="dreamDot"></span> REVEUR v2.3</div>
    <div class="sgrid">
      <span class="k">Cycles</span><span class="v" id="drR">0</span>
      <span class="k">Decouvertes</span><span class="v g" id="drW">0</span>
      <span class="k">Testes</span><span class="v y" id="drT">0</span>
      <span class="k">Win%</span><span class="v" id="drO">0%</span>
      <span class="k">Appliquees</span><span class="v" id="drA" style="color:#0ff">0</span>
      <span class="k">Resonance</span><span class="v" id="drRes" style="color:#a6f">â€”</span>
      <span class="k">GPU cap</span><span class="v" id="drGpu" style="color:#0f0">20%</span>
      <span class="k">Oracle</span><span class="v" id="drOrc" style="color:#a6f">0</span>
      <span class="k">Bridge</span><span class="v" id="drBridge" style="color:#0f0">â€”</span>
    </div>
    <div style="display:flex;gap:4px;margin-top:4px">
      <button class="sbtn" onclick="toggleDreamLog()" style="flex:1;font-size:11px">&#128064; Journal</button>
      <button class="sbtn" onclick="dreamerToggle()" style="flex:1;font-size:11px" id="drPauseBtn">&#9208; Pause</button>
    </div>
  </div>

  <div class="sblock">
    <div class="slabel">&#128218; KB (<span id="kbN">0</span>)</div>
    <div class="mlist" id="mList"></div>
  </div>

  <div class="sblock">
    <div class="slabel">&#129504; MEMOIRE</div>
    <div id="memI" style="font-size:9px;color:var(--text2)">---</div>
  </div>

  <div class="sactions">
    <button class="sbtn green" onclick="rescan()">&#128260; Rescanner</button>
    <button class="sbtn green" onclick="reloadLLM()">&#128268; Recharger LLM</button>
    <button class="sbtn" onclick="toggleP('aiaP')">&#128202; AIA Details</button>
    <button class="sbtn" onclick="toggleP('dreamP')" style="border-color:rgba(170,102,255,.15)">&#128164; Dream Journal</button>
    <button class="sbtn" onclick="toggleP('philoP')" style="border-color:rgba(0,204,136,.2);color:var(--green)">&#129504; Philo Metaphysics</button>
    <button class="sbtn" onclick="toggleP('omegaP')" style="border-color:rgba(255,68,102,.25);color:var(--red)">Î© Omega Forge</button>
    <button class="sbtn" onclick="gpuSnapshot()">&#128167; GPU Snapshot</button>
    <button class="sbtn" onclick="exportSession()">&#128190; Exporter</button>
    <button class="sbtn" onclick="openEcoMarket()">&#128185; EcoMarket</button>
    <div class="sep"></div>
    <button class="sbtn red" onclick="clearChat()">&#128465; Effacer</button>
  </div>

  <div class="sfooter">HD-First Agent v2.0 &#8226; Aethonyx &#215; Aurele</div>
</div>

<div class="main" id="mainA">
  <div class="panel" id="aiaP">
    <div class="ph"><div class="pt" style="color:var(--purple)">AIA ARENA â€” DETAILS</div><button class="pc" onclick="toggleP('aiaP')">&#10005;</button></div>
    <div id="aiaDetails" style="font-size:10px;line-height:2;color:var(--text2)">Charge...</div>
  </div>

  <div class="panel" id="dreamP">
    <div class="ph">
      <div class="pt" style="color:var(--purple)">&#128164; LE REVEUR v3.0 â€” PROTOCOLE SCIENTIFIQUE + ORACLE</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="sbtn green" onclick="dreamerToggle()" id="dreamTogBtn" style="padding:3px 8px;font-size:8px">&#9654; Pause</button>
        <button class="sbtn" onclick="dreamExport()" style="padding:3px 8px;font-size:8px">&#128190;</button>
        <button class="pc" onclick="toggleP('dreamP')">&#10005;</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
      <button class="sbtn" onclick="dreamLoadTab('journal')" id="dtJ" style="padding:3px 8px;font-size:8px;border-color:var(--cyan)">Journal</button>
      <button class="sbtn" onclick="dreamLoadTab('winners')" id="dtW" style="padding:3px 8px;font-size:8px">Gagnantes</button>
      <button class="sbtn" onclick="dreamLoadTab('science')" id="dtS" style="padding:3px 8px;font-size:8px">Science HD</button>
      <button class="sbtn" onclick="dreamLoadTab('oracle')" id="dtO" style="padding:3px 8px;font-size:8px">Oracle</button>
      <button class="sbtn" onclick="dreamLoadTab('validation')" id="dtV" style="padding:3px 8px;font-size:8px">Validation</button>
      <button class="sbtn" onclick="dreamLoadTab('fiches')" id="dtF" style="padding:3px 8px;font-size:8px">Fiches</button>
      <button class="sbtn" onclick="dreamLoadTab('learning')" id="dtL" style="padding:3px 8px;font-size:8px">Learning</button>
      <button class="sbtn" onclick="dreamLoadTab('tuning')" id="dtT" style="padding:3px 8px;font-size:8px">Tuning</button>
      <button class="sbtn" onclick="dreamLoadTab('config')" id="dtC" style="padding:3px 8px;font-size:8px">âš™ Config</button>
    </div>
    <div id="dreamContent" style="font-size:9px;line-height:1.8;color:var(--text2);overflow-y:auto;flex:1">Charge...</div>
  </div>

  <div class="panel" id="philoP">
    <div class="ph">
      <div class="pt" style="color:var(--green)">PHILO METAPHYSICS - CERTIFIED ESSAYS</div>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="sbtn" onclick="loadPhiloPanel()" style="padding:3px 8px;font-size:8px">Refresh</button>
        <button class="sbtn green" onclick="runPhiloNow()" style="padding:3px 8px;font-size:8px">Run now</button>
        <button class="pc" onclick="toggleP('philoP')">&#10005;</button>
      </div>
    </div>
    <div id="philoContent" style="font-size:9px;line-height:1.8;color:var(--text2);overflow-y:auto;flex:1">Charge...</div>
  </div>


<div class="panel" id="omegaP">
  <div class="ph">
    <div class="pt" style="color:var(--red)">Î© OMEGA SYSTEM v6.0</div>
    <div style="display:flex;align-items:center;gap:8px">
      <span class="tag" id="omegaStatus">VEILLE</span>
      <button class="pc" onclick="toggleP('omegaP')">&#10005;</button>
    </div>
  </div>

  <div style="padding:12px 14px; display:grid; gap:12px; overflow-y:auto; max-height:85vh;">
    
    <div class="card-omega">
      <div class="step-header">Ã‰TAPE 1 : CANONISATION</div>
      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button class="sbtn btn-red" onclick="omegaStart()">â˜¢ï¸ Lancer l'audit</button>
        <button class="sbtn" onclick="omegaStop()">â›” Stop</button>
        <button class="sbtn" onclick="omegaClear()">ðŸ§¹ Clean</button>
      </div>
      <div id="omegaFeed" class="terminal-mini">> EN ATTENTE...</div>
      <div id="omegaGain" style="margin-top:8px;">Gain cumulÃ©: <span class="v-green">0.00%</span></div>
    </div>

<!-- â”€â”€ SÃ‰PARATEUR Ã‰TAPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div style="margin: 18px 0 10px; border-top: 1px solid var(--border); padding-top: 14px;">
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
    <span style="font-size:13px; color:var(--text2);">Ã‰TAPE 1</span>
    <span style="font-size:11px; background:rgba(255,68,102,.15); color:var(--red); 
                 border:1px solid rgba(255,68,102,.3); border-radius:6px; padding:2px 7px;">
      Canonisation â†’
    </span>
    <span style="font-size:13px; color:var(--red); font-weight:600;">Ã‰TAPE 2</span>
    <span style="font-size:11px; background:rgba(255,68,102,.25); color:var(--red); 
                 border:1px solid rgba(255,68,102,.5); border-radius:6px; padding:2px 7px;">
      Laboratoire 7 Tests
    </span>
  </div>
</div>

<!-- â”€â”€ SÃ‰LECTION DES LOIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="labModeBlock" style="margin-bottom:12px;">

  <!-- Mode tout / sÃ©lection -->
  <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
    <button class="sbtn omegaLabModeBtn active-mode" id="labModeAll"
            onclick="labSetMode('all')"
            style="border-color:rgba(255,68,102,.5); color:var(--red); font-size:11px;">
      â˜¢ï¸ Tout passer
    </button>
    <button class="sbtn omegaLabModeBtn" id="labModeSelect"
            onclick="labSetMode('select')"
            style="border-color:var(--border); color:var(--text2); font-size:11px;">
      âœï¸ SÃ©lection manuelle
    </button>
    <button class="sbtn" onclick="labLoadLaws()"
            style="border-color:var(--border); color:var(--text2); font-size:11px;" 
            title="Actualiser (source: validation_results.json)">
      ðŸ”„ Actualiser
    </button>
    <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text2);cursor:pointer;">
      <input type="checkbox" id="labForceRetest" style="accent-color:var(--red);cursor:pointer;">
      Re-tester
    </label>
  </div>

  <!-- Liste de sÃ©lection manuelle (masquÃ©e par dÃ©faut) -->
  <div id="labSelectList" style="display:none; margin-bottom:10px;
       background:#000; border:1px solid var(--border); border-radius:10px;
       padding:10px; max-height:180px; overflow-y:auto;">
    <div id="labLawsContainer" style="font-size:11px; color:var(--text2);">
      <em>Cliquer sur "Actualiser" pour charger les lois canonisÃ©esâ€¦</em>
    </div>
  </div>

  <!-- Boutons de lancement -->
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <button id="labStartBtn" onclick="labStart()"
            class="sbtn" style="border-color:rgba(255,68,102,.5); color:var(--red); font-size:12px; font-weight:600;">
      âš—ï¸ Lancer les 7 Tests
    </button>
    <button id="labStopBtn" onclick="labStop()" disabled
            class="sbtn" style="opacity:.5; font-size:11px;">
      â›” Stop
    </button>
    <button onclick="labClear()"
            class="sbtn" style="border-color:var(--border); color:var(--text2); font-size:11px;">
      ðŸ§¹ Vider rÃ©sultats
    </button>
    <span id="labStatus" style="font-size:11px; color:var(--text2); margin-left:4px;">VEILLE</span>
    <span id="labUntestedBadge" style="font-size:10px;margin-left:6px;display:none;background:rgba(255,68,102,.15);color:var(--red);border:1px solid rgba(255,68,102,.3);border-radius:4px;padding:1px 6px;"></span>
  </div>
</div>

<!-- â”€â”€ PROGRESS EN COURS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="labProgressBlock" style="display:none; margin-bottom:10px;
     background:#0a0a0a; border:1px solid var(--border); border-radius:10px; padding:10px;">
  <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
    <span id="labProgressLaw" style="font-size:11px; color:var(--red); font-family:'Courier New',monospace;">
      â€”
    </span>
    <span id="labProgressCount" style="font-size:10px; color:var(--text2);">0 / 0</span>
  </div>
  <div style="background:var(--bg4); border-radius:4px; height:6px; overflow:hidden;">
    <div id="labProgressBar" style="height:6px; background:var(--red); 
         border-radius:4px; width:0%; transition:width .4s ease;"></div>
  </div>
  <!-- Ã‰tapes 1-7 indicateurs -->
  <div id="labStepsRow" style="display:flex; gap:4px; margin-top:8px; flex-wrap:wrap;">
    <!-- InjectÃ© dynamiquement -->
  </div>
</div>

<!-- â”€â”€ TABLEAU DES RÃ‰SULTATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div style="font-size:11px; color:var(--text2); margin-bottom:5px; 
             display:flex; justify-content:space-between; align-items:center;">
  <span>RÃ©sultats Laboratoire</span>
  <span id="labStats" style="font-size:10px;">â€”</span>
</div>

<div id="labResultsContainer" style="max-height:300px; overflow-y:auto; 
     border:1px solid var(--border); border-radius:10px; overflow-x:hidden;">
  <table id="labResultsTable" style="width:100%; border-collapse:collapse; font-size:10px;">
    <thead>
      <tr style="background:var(--bg4); color:var(--text2); position:sticky; top:0; z-index:1;">
        <th style="padding:5px 8px; text-align:left; font-weight:500;">Loi</th>
        <th style="padding:5px 4px; text-align:center;" title="ReproductibilitÃ©">S1</th>
        <th style="padding:5px 4px; text-align:center;" title="Axiomatique">S2</th>
        <th style="padding:5px 4px; text-align:center;" title="Monte Carlo">S3</th>
        <th style="padding:5px 4px; text-align:center;" title="Doxa">S4</th>
        <th style="padding:5px 4px; text-align:center;" title="DonnÃ©es rÃ©elles">S5</th>
        <th style="padding:5px 4px; text-align:center;" title="MÃ©ta-analyse">S6</th>
        <th style="padding:5px 6px; text-align:center;">Verdict</th>
        <th style="padding:5px 6px; text-align:center;">Gain Î©</th>
        <th style="padding:5px 6px; text-align:center;">Article</th>
      </tr>
    </thead>
    <tbody id="labResultsBody">
      <tr>
        <td colspan="10" style="padding:12px; text-align:center; color:var(--text2); font-style:italic;">
          Aucun rÃ©sultat â€” lancer les 7 tests pour commencer
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- â”€â”€ ARTICLES GÃ‰NÃ‰RÃ‰S â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="labArticlesBlock" style="display:none; margin-top:12px;
     border-top:1px solid var(--border); padding-top:10px;">
  <div style="font-size:11px; color:var(--text2); margin-bottom:6px;">
    ðŸ“„ Articles Scientifiques GÃ©nÃ©rÃ©s
  </div>
  <div id="labArticlesList" style="font-size:10px; font-family:'Courier New',monospace;
       color:var(--green); background:#000; border-radius:8px; padding:8px;
       max-height:120px; overflow-y:auto;">
    â€”
  </div>
</div>


<script>
// ======================================================================
//  Î© OMEGA LAB v6 â€” Ã‰TAPE 2 : LABORATOIRE SCIENTIFIQUE 7 TESTS
// ======================================================================

if (typeof labMode        === 'undefined') window.labMode        = 'all';
if (typeof labRunning     === 'undefined') window.labRunning     = false;
if (typeof labInterval    === 'undefined') window.labInterval    = null;
if (typeof labErrCount    === 'undefined') window.labErrCount    = 0;
if (typeof labSelectedIds  === 'undefined') window.labSelectedIds  = new Set();

if (typeof LAB_STEP_NAMES === 'undefined') window.LAB_STEP_NAMES = [
  'ReproductibilitÃ©', 'Axiomatique', 'Monte Carlo',
  'Doxa', 'DonnÃ©es rÃ©elles', 'MÃ©ta-analyse', 'Verdict'
];

// â”€â”€ Mode sÃ©lection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function labSetMode(mode){
  labMode = mode;
  document.querySelectorAll('.omegaLabModeBtn').forEach(b => b.classList.remove('active-mode'));
  document.getElementById(mode === 'all' ? 'labModeAll' : 'labModeSelect')
          .classList.add('active-mode');
  const list = document.getElementById('labSelectList');
  list.style.display = mode === 'select' ? 'block' : 'none';
}

async function labLoadLaws(){
  const container = document.getElementById('labLawsContainer');
  container.innerHTML = '<em style="color:var(--text2)">Chargementâ€¦</em>';
  try {
    const r = await fetch(`${A}/api/omega/laws`);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    const laws = data.laws || [];
    if(!laws.length){
      container.innerHTML = '<em style="color:var(--text2)">Aucune loi canonisÃ©e en stock.</em>';
      return;
    }
    const total = data.total || laws.length;
    const untested = data.untested ?? laws.filter(l => !l.lab_tested).length;
    const header = `<div style="padding:3px 0 5px; color:var(--text2); font-size:9px; border-bottom:1px solid var(--border); margin-bottom:4px;">
      ${total} lois Ã©ligibles â€” <span style="color:${untested>0?'var(--red)':'#0c8'}">${untested} Ã  tester</span>
    </div>`;
    container.innerHTML = header + laws.map(l => {
      const checked = labSelectedIds.has(l.id) ? 'checked' : '';
      const badge = l.lab_tested
        ? `<span style="font-size:8px;color:#0c8;background:rgba(0,200,80,.12);border:1px solid rgba(0,200,80,.3);border-radius:3px;padding:1px 4px;">âœ“ testÃ©</span>`
        : `<span style="font-size:8px;color:var(--red);background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.3);border-radius:3px;padding:1px 4px;">â†’ lab</span>`;
      const score = typeof l.omega_score === 'number' ? ` ${(l.omega_score*100).toFixed(0)}%` : '';
      return `<label style="display:flex;align-items:center;gap:5px;padding:3px 0;cursor:pointer;color:${l.lab_tested?'var(--text2)':'var(--text)'};">
        <input type="checkbox" ${checked} value="${esc(l.id)}" onchange="labToggleId(this)" style="accent-color:var(--red);cursor:pointer;">
        ${badge}
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(l.title)}">${esc(l.title)}</span>
        <span style="color:var(--text2);font-size:9px;flex-shrink:0;">${esc(l.domain||'')}${score}</span>
      </label>`;
    }).join('');
    const b = document.getElementById('labUntestedBadge');
    if(b){ b.textContent=`${untested} Ã  tester`; b.style.display=untested>0?'inline':'none'; }
  } catch(e){
    container.innerHTML = `<em style="color:var(--red)">Erreur: ${esc(String(e))}</em>`;
  }
}

function labToggleId(checkbox){
  if(checkbox.checked) labSelectedIds.add(checkbox.value);
  else                 labSelectedIds.delete(checkbox.value);
}

// â”€â”€ Lancement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function labStart(){
  if(labRunning) return;

  if(labMode === 'select' && labSelectedIds.size === 0){
    labSetStatus('âš ï¸ SÃ©lectionnez au moins une loi.', 'var(--red)');
    return;
  }

  if(!confirm(`âš—ï¸ LANCER LE LABORATOIRE ?\n` +
    (labMode === 'all' 
      ? 'Toutes les lois canonisÃ©es seront soumises aux 7 tests mathÃ©matiques.'
      : `${labSelectedIds.size} loi(s) sÃ©lectionnÃ©e(s) seront testÃ©es.`) +
    `\n\nCela peut prendre quelques secondes par loi.`)) return;

  labRunning = true;
  labErrCount = 0;
  document.getElementById('labStartBtn').disabled = true;
  document.getElementById('labStartBtn').style.opacity = '.6';
  document.getElementById('labStopBtn').disabled = false;
  document.getElementById('labStopBtn').style.opacity = '1';
  labSetStatus('ANALYSEâ€¦', 'var(--red)');

  document.getElementById('labProgressBlock').style.display = 'block';
  labResetProgress();

  try {
    const force = document.getElementById('labForceRetest')?.checked || false;
    const cfg = { mode: labMode, ids: labMode === 'select' ? Array.from(labSelectedIds) : [], force };
    // Ã‰tape 1: configurer le run (POST /lab/config)
    await fetch(`${A}/api/omega/lab/config`, {
      method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(cfg)
    });
    // Ã‰tape 2: lancer (POST /lab/start)
    const r = await fetch(`${A}/api/omega/lab/start`, { method: 'POST' });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const d = await r.json();
    if(d.status === 'already_running'){
      labSetStatus('DÃ©jÃ  en coursâ€¦');
    }
    if(labInterval) clearInterval(labInterval);
    labInterval = setInterval(labUpdate, 800);
    await labUpdate();
  } catch(e) {
    labSetStatus(`âš ï¸ Erreur: ${e}`, 'var(--red)');
    labRunning = false;
    document.getElementById('labStartBtn').disabled = false;
    document.getElementById('labStartBtn').style.opacity = '1';
    document.getElementById('labStopBtn').disabled = true;
    document.getElementById('labProgressBlock').style.display = 'none';
  }
}

async function labStop(){
  if(!labRunning) return;
  try { await fetch(`${A}/api/omega/lab/stop`, {method:'POST'}); } catch(e){}
  if(labInterval){ clearInterval(labInterval); labInterval = null; }
  labRunning = false;
  document.getElementById('labStartBtn').disabled = false;
  document.getElementById('labStartBtn').style.opacity = '1';
  document.getElementById('labStopBtn').disabled = true;
  labSetStatus('ARRÃŠTÃ‰');
}

// â”€â”€ Polling rÃ©sultats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function labUpdate(){
  try {
    const r = await fetch(`${A}/api/omega/lab/feed`);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    labErrCount = 0;

    // Progression
    if(data.current_law){
      document.getElementById('labProgressLaw').textContent =
        `âš—ï¸ ${data.current_law} â€” Ã‰tape ${data.current_step || 1}/7: ${LAB_STEP_NAMES[(data.current_step||1)-1]}`;
    }
    if(data.total > 0){
      const pct = Math.round(((data.done || 0) / data.total) * 100);
      document.getElementById('labProgressBar').style.width = pct + '%';
      document.getElementById('labProgressCount').textContent =
        `${data.done||0} / ${data.total}`;
    }

    // Indicateurs Ã©tapes (pour la loi en cours)
    if(data.current_step_results){
      labRenderStepBadges(data.current_step_results, data.current_step || 0);
    }

    // Tableau rÃ©sultats
    if(data.results && data.results.length){
      labRenderResults(data.results);
    }

    // Stats
    const stats = data.stats || {};
    const sc = stats.canon  ?? 0;
    const sr = stats.refuted ?? 0;
    const sa = stats.articles ?? 0;
    document.getElementById('labStats').textContent =
      sc || sr ? `âœ¨ ${sc} canonisÃ©es | âŒ ${sr} rÃ©futÃ©es | ðŸ“„ ${sa} articles` : 'â€”';

    // Articles
    if(sa > 0) labLoadArticles();

    // Fin
    if(data.finished && !data.running){
      if(labInterval){ clearInterval(labInterval); labInterval = null; }
      labRunning = false;
      document.getElementById('labStartBtn').disabled = false;
      document.getElementById('labStartBtn').style.opacity = '1';
      document.getElementById('labStopBtn').disabled = true;
      labSetStatus('TERMINÃ‰ âœ“');
      document.getElementById('labProgressBlock').style.display = 'none';
      labLoadArticles();
    }

  } catch(e){
    labErrCount++;
    if(labErrCount > 5){
      if(labInterval){ clearInterval(labInterval); labInterval = null; }
      labRunning = false;
      labSetStatus(`âš ï¸ Perte connexion`);
    }
  }
}

// â”€â”€ Rendu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function labResetProgress(){
  document.getElementById('labProgressBar').style.width = '0%';
  document.getElementById('labProgressCount').textContent = '0 / 0';
  document.getElementById('labProgressLaw').textContent = 'â€”';
  labRenderStepBadges({}, 0);
}

function labRenderStepBadges(stepResults, currentStep){
  const row = document.getElementById('labStepsRow');
  const labels = ['S1','S2','S3','S4','S5','S6','S7'];
  row.innerHTML = labels.map((label, i) => {
    const stepKey = Object.keys(stepResults)[i];
    const res = stepKey ? stepResults[stepKey] : null;
    let cls = '';
    if(i + 1 < currentStep)      cls = res && res.passed ? 'ok' : 'fail';
    else if(i + 1 === currentStep) cls = 'run';
    const score = res ? ` ${(res.score*100).toFixed(0)}%` : '';
    return `<span class="lab-step-badge ${cls}" title="${label}: ${LAB_STEP_NAMES[i]}">${label}${cls==='ok'||cls==='fail' ? score : ''}</span>`;
  }).join('');
}

function labRenderResults(results){
  const tbody = document.getElementById('labResultsBody');
  // Rebuild full table (simple, no partial update)
  if(!results.length){
    tbody.innerHTML = `<tr><td colspan="10" style="padding:12px; text-align:center; color:var(--text2); font-style:italic;">Aucun rÃ©sultat</td></tr>`;
    return;
  }
  tbody.innerHTML = results.map(res => {
    const steps = res.steps || {};
    const stepCells = ['reproducibility','axiomatic','monte_carlo','doxa','real_data','meta'].map(k => {
      const s = steps[k];
      if(!s) return `<td style="padding:3px 4px; text-align:center; color:var(--border);">â€”</td>`;
      const ok = s.passed;
      const pct = Math.round((s.score || 0) * 100);
      const col = ok ? '#0c8' : 'var(--red)';
      return `<td style="padding:3px 4px; text-align:center; color:${col}; font-weight:600;" title="${esc(s.detail||'')}">${ok?'âœ“':'âœ—'} ${pct}%</td>`;
    }).join('');

    const verdictNorm = String(res.verdict||'')
      .toUpperCase()
      .replace(/Ã‰/g,'E')
      .replace(/[ÉÈÊË]/g,'E');
    const isCanon = verdictNorm === 'CANONISEE';
    const vClass  = isCanon ? 'lab-verdict-canon' : 'lab-verdict-refut';
    const gain    = typeof res.gain === 'number' ? `+${res.gain.toFixed(1)}%` : 'â€”';
    const articleLink = res.article_path
      ? `<a href="${A}/api/omega/lab/article/${esc(res.id)}" target="_blank"
            style="color:var(--text2); text-decoration:none;" title="Voir l'article">ðŸ“„</a>`
      : 'â€”';

    return `<tr class="lab-row-new">
      <td style="padding:4px 8px; max-width:180px; overflow:hidden; text-overflow:ellipsis;
                  white-space:nowrap; color:var(--text);" title="${esc(res.title||res.id)}">
        ${esc((res.title||res.id).slice(0,35))}
      </td>
      ${stepCells}
      <td style="padding:4px 6px; text-align:center;" class="${vClass}">
        ${isCanon ? 'âœ¨ CANON' : 'âŒ RÃ‰FUT'}
      </td>
      <td style="padding:4px 6px; text-align:center; color:${isCanon?'#0c8':'var(--text2)'}; font-weight:600;">
        ${gain}
      </td>
      <td style="padding:4px 6px; text-align:center;">${articleLink}</td>
    </tr>`;
  }).join('');
}

async function labLoadArticles(){
  const block = document.getElementById('labArticlesBlock');
  const list  = document.getElementById('labArticlesList');
  try {
    const r = await fetch(`${A}/api/omega/lab/articles`);
    if(!r.ok) throw new Error('');
    const data = await r.json();
    const articles = data.articles || [];
    if(!articles.length){ block.style.display = 'none'; return; }
    block.style.display = 'block';
    list.innerHTML = articles.map(a => {
      const sizeKb = a.size_kb ? ` (${a.size_kb.toFixed(1)}kb)` : '';
      return `<div style="padding:1px 0;">
        <a href="${A}/api/omega/lab/article/${esc(a.law_id)}" target="_blank"
           style="color:var(--green); text-decoration:none; hover:underline;"
           title="${esc(a.title||'')}">
          ðŸ“„ ${esc(a.filename)}${sizeKb}
        </a>
      </div>`;
    }).join('');
  } catch(e){ block.style.display = 'none'; }
}

function labClear(){
  document.getElementById('labResultsBody').innerHTML =
    `<tr><td colspan="10" style="padding:12px; text-align:center; color:var(--text2); font-style:italic;">Aucun rÃ©sultat â€” lancer les 7 tests pour commencer</td></tr>`;
  document.getElementById('labStats').textContent = 'â€”';
  document.getElementById('labProgressBlock').style.display = 'none';
  document.getElementById('labArticlesBlock').style.display = 'none';
  labSetStatus('VEILLE');
}

function labSetStatus(txt, color){
  const el = document.getElementById('labStatus');
  if(el){ el.textContent = txt; if(color) el.style.color = color; }
}

// Utilitaire (rÃ©utilise esc() dÃ©jÃ  dÃ©fini dans index.html)
// Si esc() n'est pas dÃ©fini globalement, dÃ©commentez :
// function esc(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
</script>

  </div>
</div>


  <div id="msgs">
    <div id="emptyS">
      <div class="logo2">&#x2B21;</div>
      <p>AETHONYX HD-FIRST AGENT v2.0<br>
      Architecture modulaire auto-decouverte + AIA Arena<br>
      Le LLM est la bouche. L'HD Core + AIA = le cerveau.<br><br>
      <span style="color:var(--text4)">Tape un message pour commencer.</span></p>
    </div>
  </div>

  <div class="ldots" id="ldots"><span></span><span></span><span></span></div>

  <div class="ibar">
    <input id="cI" placeholder="Message..." onkeydown="if(event.key==='Enter')send()" autocomplete="off">
    <button id="sBtn" onclick="send()">ENVOYER</button>
    <button id="wBtn" onclick="sendWebResearch()">WEB+LLM</button>
  </div>
</div>

<script>
const A='';
let loading=false;
const proactiveByType=new Map();

function proactiveTypeKey(item){
  const t=String((item&&item.type)||'').trim().toLowerCase();
  return t||String((item&&item.id)||'');
}

function $(id){return document.getElementById(id)}

async function refresh(){
  try{
    const r=await fetch(A+'/api/status');
    const s=await r.json();
    updateUI(s);
  }catch(e){}
}

function fmtProactive(item){
  const t=proactiveTypeKey(item);
  const icon={philo_certified:'O',eco_market:'$'}[t]||'i';
  const title=(item&&item.title)||'Notification';
  const body=(item&&item.body)||'';
  return `${icon} ${title}\n${body}`;
}

function proactiveAcceptPrompt(item){
  const t=proactiveTypeKey(item);
  if(t==='philo_certified'){
    return "Oui. Debriefe cette synthese certifiee en detail: formule, demonstration, implications scientifiques, comparaison a la doxa, et essai philosophique/metaphysique en francais.";
  }
  if(t==='eco_market'){
    return "Oui. Debriefe ces previsions eco en detail: formules, methode walk-forward, recoupements de donnees, risques, et projections D+1/2 semaines/1 mois/3 mois/6 mois.";
  }
  return "Oui. Developpe ce point en profondeur (methode, donnees, implications) et utilise des sources web si necessaire.";
}

async function respondProactive(item,action,buttonsWrap){
  const btns=buttonsWrap?buttonsWrap.querySelectorAll('button'):[];
  for(const b of btns)b.disabled=true;
  try{
    const body={
      id:(item&&item.id)||'',
      action:action,
      ask_llm:action==='accept',
      user_text:action==='accept' ? proactiveAcceptPrompt(item) : ""
    };
    const r=await fetch(A+'/api/proactive/respond',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    const raw=await r.text();
    let d={};
    try{ d=raw?JSON.parse(raw):{}; }
    catch(_e){ d={error: raw ? raw.slice(0,260) : ('HTTP '+r.status)}; }
    if(!r.ok||d.error){
      addMsg('system','Erreur proactive: '+(d.error||('HTTP '+r.status)));
      for(const b of btns)b.disabled=false;
      return;
    }
    if(action==='reject'){
      addMsg('system','Note. Je mets cette piste de cote.');
      const k=proactiveTypeKey(item);
      const prev=proactiveByType.get(k);
      if(prev&&prev.node&&prev.node.parentNode)prev.node.remove();
      proactiveByType.delete(k);
      if(buttonsWrap)buttonsWrap.remove();
      return;
    }
    if(d.llm_response){
      addMsg('assistant',d.llm_response,d.llm_meta||{strategy:'PROACTIVE_FOCUS'});
    }else{
      addMsg('system','Focus active. Tu peux continuer avec "developpe cette piste".');
    }
    if(buttonsWrap)buttonsWrap.remove();
  }catch(e){
    addMsg('system','Erreur proactive: '+e.message);
    for(const b of btns)b.disabled=false;
  }
}

function addProactiveMsg(item){
  const k=proactiveTypeKey(item);
  const prev=proactiveByType.get(k);
  if(prev&&prev.node&&prev.node.parentNode){
    prev.node.remove();
  }
  const node=addMsg('system',fmtProactive(item),null,true);
  if(!node||!item||!item.id)return;
  proactiveByType.set(k,{id:String(item.id||''),node:node});
  const bubble=node.querySelector('.bubble');
  if(!bubble)return;
  const actions=document.createElement('div');
  actions.style.display='flex';
  actions.style.gap='6px';
  actions.style.marginTop='8px';
  const yes=document.createElement('button');
  yes.textContent='Oui, developpe';
  yes.style.padding='4px 8px';
  yes.style.border='1px solid var(--green)';
  yes.style.background='transparent';
  yes.style.color='var(--green)';
  yes.style.cursor='pointer';
  const no=document.createElement('button');
  no.textContent='Non';
  no.style.padding='4px 8px';
  no.style.border='1px solid var(--border)';
  no.style.background='transparent';
  no.style.color='var(--text3)';
  no.style.cursor='pointer';
  yes.onclick=()=>respondProactive(item,'accept',actions);
  no.onclick=()=>respondProactive(item,'reject',actions);
  actions.appendChild(yes);
  actions.appendChild(no);
  bubble.appendChild(actions);
}

async function pollProactive(){
  try{
    const url=`${A}/api/proactive/poll?since_ts=0&limit=2&compact_by_type=1&theme_only=1`;
    const r=await fetch(url);
    if(!r.ok)return;
    const d=await r.json();
    const items=d.items||[];
    const activeKeys=new Set();
    for(const it of items){
      if(!it||!it.id)continue;
      const k=proactiveTypeKey(it);
      if(!k)continue;
      activeKeys.add(k);
      const prev=proactiveByType.get(k);
      if(prev&&String(prev.id||'')===String(it.id||''))continue;
      addProactiveMsg(it);
    }
    for(const [k,meta] of Array.from(proactiveByType.entries())){
      if(activeKeys.has(k))continue;
      if(meta&&meta.node&&meta.node.parentNode)meta.node.remove();
      proactiveByType.delete(k);
    }
  }catch(e){}
}
function updateUI(s){
  // LLM
  const d=$('llmDot'),i=$('llmInfo');
  const llm=s.llm||{};
  if(llm.active_engine){
    d.className='sdot ok';
    i.textContent=llm.model||'actif';
    $('modelName').textContent=(llm.model||'').split('(').pop().replace(')','').slice(0,20);
  }else{
    d.className='sdot err';
    i.innerHTML='Aucun moteur<br><span style="font-size:8px;color:var(--text4)">Installe Ollama ou place un .gguf dans models/</span>';
    $('modelName').textContent='offline';
  }
  // AIA
  if(s.aia){
    const a=s.aia;
    $('aiaDot').className=a.total_decisions>0?'sdot ok':'sdot warn';
    $('aiaDec').textContent=a.total_decisions||0;
    $('aiaSav').textContent=(a.saving_percent||0)+'%';
    $('aiaQ').textContent=a.avg_quality||'---';
    $('aiaE').textContent='Îµ='+(a.epsilon||'?');
  }
  // Core
  if(s.hd_core){
    $('cL').textContent=s.hd_core.local_rate;
    $('cT').textContent='~'+s.hd_core.tok_saved;
  }
  // Modules
  if(s.module_list){
    $('modList').innerHTML=s.module_list.map(m=>
      `<div><span style="color:var(--green)">&#9679;</span> ${m.name} <span style="color:var(--text4)">v${m.version}</span></div>`
    ).join('');
  }
  // GPU
  const gpu=s.modules?.gpu_sentinel;
  if(gpu&&gpu.available){
    $('gpuBlock').style.display='';
    $('gpuDot').className=gpu.vram_pressure>0.85?'sdot err':gpu.vram_pressure>0.7?'sdot warn':'sdot ok';
    $('gpuW').textContent=(gpu.power_w||0)+'W';
    $('gpuT').textContent=(gpu.temp_c||0)+'°C';
    const vu=Math.round((gpu.vram_used_mib||0)/1024*10)/10;
    const vt=Math.round((gpu.vram_total_mib||0)/1024*10)/10;
    $('gpuV').textContent=vu+'/'+vt+'G';
    $('gpuE').textContent=(gpu.session_energy_wh||0)+' Wh';
  }
  // Dreamer (Le Reveur v2.3)
  const dr=s.modules?.dreamer;
  if(dr){
    $('dreamBlock').style.display='';
    $('dreamDot').className=dr.running?'sdot ok':dr.paused?'sdot warn':'sdot err';
    $('drR').textContent=dr.cycles||0;
    $('drW').textContent=(dr.winners_unique||dr.winners||0)+(dr.winners_unique&&dr.winners_unique!==dr.winners?' ('+dr.winners+' tot)':'');
    $('drT').textContent=dr.tested||0;
    $('drO').textContent=(dr.win_rate||0)+'%';
    $('drA').textContent=dr.applied||0;
    const resMode=dr.resonance_mode||'--';
    const resCols={'RESONANCE':'#0f0','FRICTION':'#f80','OVERHEATING':'#f00','BALANCED':'#0ff','IDLE':'#666','VRAM_CRITICAL':'#f0f'};
    $('drRes').textContent=resMode;
    $('drRes').style.color=resCols[resMode]||'#a6f';
    fetch(A+'/api/dreamer/gpu_governor').then(r=>r.json()).then(g=>{const cap=g.ceiling_pct||20;$('drGpu').textContent=cap+'%';$('drGpu').style.color=cap>40?'#0f0':cap>25?'#0ff':'#f80';}).catch(()=>{});
    $('drOrc').textContent=(dr.oracle_convs||0)+(dr.oracle_active?' OK':' KO');
    $('drOrc').style.color=dr.oracle_active?'#a6f':'#666';
    // v2.4: HALT mode indicator
    if(dr.halt_mode){
      $('dreamDot').className='sdot warn';
      $('drR').textContent=dr.cycles+' (HALT)';
    }
    fetch(A+'/api/memory_bridge/status').then(r=>r.json()).then(b=>{const w=b.winners||0;$('drBridge').textContent=w>0?w+'+':'--';$('drBridge').style.color=w>0?'#0f0':'#666'}).catch(()=>{});
    $('drPauseBtn').innerHTML=dr.paused?'&#9654; Reprendre':'&#9208; Pause';
  }
  // KB
  $('kbN').textContent=s.kb?.count||0;
  const ml=$('mList');ml.innerHTML='';
  if(s.kb?.files){
    for(const[k,v]of Object.entries(s.kb.files)){
      ml.innerHTML+=`<div class="mitem"><span class="d">&#9679;</span><span title="${v.summary}">${v.filename}</span></div>`;
    }
  }
  // Memory
  const m=s.memory||{};
  $('memI').textContent=`${m.episodes||0} ep. | ~${m.total_tokens||0} tok`;
  $('emptyS').style.display=document.querySelectorAll('.msg').length?'none':'block';
}

// â”€â”€ CHAT â”€â”€
function stripThinkingBlocks(s){
  let t=(s===undefined||s===null)?'':String(s);
  t=t.replace(/<(think|thinking|reasoning|analysis)>[\s\S]*?<\/\1>/gi,'');
  t=t.replace(/<(?:think|thinking|reasoning|analysis)[^>]*>/gi,'');
  t=t.replace(/<\/(?:think|thinking|reasoning|analysis)>/gi,'');
  t=t.replace(/\[(\/?)(?:think|thinking|reasoning|analysis)\]/gi,'');
  return t;
}

async function send(){
  const inp=$('cI'),msg=inp.value.trim();
  if(!msg||loading)return;
  inp.value='';loading=true;
  $('emptyS').style.display='none';
  addMsg('user',msg);
  $('ldots').style.display='flex';
  $('sBtn').disabled=true;
  if($('wBtn'))$('wBtn').disabled=true;
  try{
    const r=await fetch(A+'/api/chat/stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
    if(!r.ok)throw new Error('HTTP '+r.status);
    const reader=r.body.getReader(),dec=new TextDecoder();
    let full='',bub=null,meta={},sseBuf='';
    while(true){
      const{value,done}=await reader.read();
      sseBuf += dec.decode(value || new Uint8Array(), {stream: !done});
      const lines=sseBuf.split('\n');
      sseBuf=lines.pop()||'';
      for(const line of lines){
        if(line.startsWith('data: ')){
          try{
            const d=JSON.parse(line.slice(6));
            if(d.text){
              const chunk=stripThinkingBlocks(d.text||'');
              if(!chunk)continue;
              full+=chunk;
              if(!bub)bub=addMsg('assistant',full,null,true);
              else{const c=bub.querySelector('.mc');if(c)c.textContent=full}
            }
            if(d.done){meta=d;continue}
          }catch(e){}
        }
      }
      if(done)break;
    }
    // Derniere ligne SSE partielle eventuelle
    if(sseBuf.trim().startsWith('data: ')){
      try{
        const d=JSON.parse(sseBuf.trim().slice(6));
        if(d.text){
          const chunk=stripThinkingBlocks(d.text||'');
          if(chunk)full+=chunk;
          if(!bub)bub=addMsg('assistant',full,null,true);
          else{const c=bub.querySelector('.mc');if(c)c.textContent=full}
        }
        if(d.done)meta=d;
      }catch(e){}
    }
    // Fallback si stream vide: repasser en non-stream pour eviter le silence.
    if(!full.trim()){
      const r2=await fetch(A+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
      const d2=await r2.json();
      const txt=stripThinkingBlocks((d2&&d2.response)||'');
      if(txt){
        if(!bub)bub=addMsg('assistant',txt,{intent:d2.intent,strategy:d2.strategy,local:d2.local,tokens:d2.tokens},true);
        else{const c=bub.querySelector('.mc');if(c)c.textContent=txt}
        full=txt;
      }else if(!bub){
        addMsg('system','Aucune reponse recue. Reessayez ou reduisez le contexte.');
      }
    }
    if(bub&&meta){
      const me=bub.querySelector('.mmeta');
      if(me){
        let h='';
        if(meta.intent)h+=`<span style="color:${iCol(meta.intent)};font-weight:600">${meta.intent}</span>`;
        if(meta.strategy)h+=`<span style="color:var(--text4)">${meta.strategy}</span>`;
        if(meta.local)h+='<span class="local">LOCAL &#10003;</span>';
        if(meta.tokens)h+=`<span>${meta.tokens}tok</span>`;
        if(meta.time_ms)h+=`<span>${Math.round(meta.time_ms)}ms</span>`;
        if(meta.hd_metrics){
          const hm=meta.hd_metrics;
          h+=`<span style="color:var(--purple)" title="R:${hm.resonance} T:${hm.tension} O:${hm.oscillation} C:${hm.coherence}">&#955;'=${hm.lambda_prime}</span>`;
        }
        if(meta.energy_j)h+=`<span style="color:var(--yellow)" title="Energie GPU">&#9889;${meta.energy_j}J</span>`;
        me.innerHTML=h;
      }
    }
  }catch(e){
    try{
      const r=await fetch(A+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
      const d=await r.json();
      addMsg('assistant',stripThinkingBlocks(d.response),{intent:d.intent,strategy:d.strategy,local:d.local,tokens:d.tokens});
    }catch(e2){addMsg('system','Erreur: '+e2.message)}
  }finally{
    loading=false;$('ldots').style.display='none';$('sBtn').disabled=false;if($('wBtn'))$('wBtn').disabled=false;refresh();
  }
}

async function sendWebResearch(){
  const inp=$('cI'),q=(inp.value||'').trim();
  if(!q||loading)return;
  inp.value='';loading=true;
  $('emptyS').style.display='none';
  addMsg('user',`[Recherche web] ${q}`);
  $('ldots').style.display='flex';
  $('sBtn').disabled=true;
  if($('wBtn'))$('wBtn').disabled=true;
  try{
    const r=await fetch(A+'/api/web_research/assistant',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({query:q,max_results:5,prompt_hint:q})
    });
    const d=await r.json();
    if(!r.ok||d.error){
      addMsg('system','Erreur web+LLM: '+(d.error||('HTTP '+r.status)));
      return;
    }
    const txt=stripThinkingBlocks((d&&d.response)||'Aucune synthese disponible.');
    addMsg('assistant',txt,{strategy:'WEB_LLM',local:d.local,tokens:d.tokens});
  }catch(e){
    addMsg('system','Erreur web+LLM: '+e.message);
  }finally{
    loading=false;
    $('ldots').style.display='none';
    $('sBtn').disabled=false;
    if($('wBtn'))$('wBtn').disabled=false;
    refresh();
  }
}

function addMsg(role,content,meta,ret){
  if(role==='assistant')content=stripThinkingBlocks(content);
  const c=$('msgs'),d=document.createElement('div');
  d.className='msg '+role;
  if(role==='system'){d.innerHTML=`<div class="bubble">${esc(content)}</div>`}
  else{
    let mh='';
    if(meta){
      if(meta.intent)mh+=`<span style="color:${iCol(meta.intent)};font-weight:600">${meta.intent}</span>`;
      if(meta.strategy)mh+=`<span style="color:var(--text4)">${meta.strategy}</span>`;
      if(meta.local)mh+='<span class="local">LOCAL &#10003;</span>';
      if(meta.tokens)mh+=`<span>${meta.tokens}tok</span>`;
    }
    d.innerHTML=`<div class="bubble">${role==='assistant'?'<div class="mlabel">AETHONYX</div>':''}<div class="mc">${esc(content)}</div><div class="mmeta">${mh}</div></div>`;
  }
  c.appendChild(d);c.scrollTop=c.scrollHeight;
  if(ret)return d;
}

function esc(s){s=(s===undefined||s===null)?'':String(s);return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function iCol(t){return{CALC:'#00cc88',LOOKUP:'#00d4ff',META:'#ffcc00',CACHED:'#888',REASON:'#aa66ff',CREATE:'#ff66aa',CHAT:'#66aaff'}[t]||'#888'}
function toggleP(id){
  const p=$(id);
  if(!p)return;
  p.classList.toggle('open');
  const opened=p.classList.contains('open');
  if(id==='aiaP'&&opened)loadAIA();
  if(id==='dreamP'&&opened)dreamLoadTab('journal');
  if(id==='philoP'&&opened)loadPhiloPanel();
}

let _dreamTab='journal';
function dreamLoadTab(tab){
  _dreamTab=tab;
  ['dtJ','dtW','dtS','dtT','dtO','dtF','dtL','dtV','dtC'].forEach(id=>{if($(id))$(id).style.borderColor='var(--border)'});
  $({journal:'dtJ',winners:'dtW',science:'dtS',tuning:'dtT',oracle:'dtO',validation:'dtV',fiches:'dtF',learning:'dtL',config:'dtC'}[tab]).style.borderColor='var(--cyan)';
  if(tab==='journal')loadDreamJournal();
  else if(tab==='winners')loadDreamWinners();
  else if(tab==='science')loadDreamScience();
  else if(tab==='tuning')loadDreamTuning();
  else if(tab==='oracle')loadDreamOracle();
  else if(tab==='validation')loadDreamValidation();
  else if(tab==='fiches')loadDreamFiches();
  else if(tab==='learning')loadDreamLearning();
  else if(tab==='config')loadDreamConfig();
}

async function loadDreamJournal(){
  try{
    const r=await fetch(A+'/api/dreamer/log');
    const d=await r.json();
    const entries=d.log||[];
    if(!entries.length){$('dreamContent').innerHTML='<div style="color:var(--text4)">Le Reveur n\'a pas encore de journal. Il demarre automatiquement au lancement.</div>';return}
    let h='';
    const levelCol={info:'var(--text2)',warn:'var(--yellow)',error:'var(--red)'};
    for(const e of entries.slice().reverse()){
      const ts=(e.ts||'').slice(11,19);
      const col=levelCol[e.level]||'var(--text2)';
      const msg=e.msg||'';
      const isWin=msg.includes('â˜…');
      const isLoss=msg.includes('âœ—');
      const isApplied=msg.includes('AUTO-APPLIQU');
      const isResonance=msg.includes('RESONANCE');
      const lineCol=isApplied?'#0ff':isWin?'var(--green)':isLoss?'var(--red)':isResonance?'var(--purple)':col;
      h+=`<div style="padding:3px 0;border-bottom:1px solid var(--border)${isApplied?';background:rgba(0,255,255,0.05)':''}">`;
      h+=`<span style="color:var(--text4);font-size:8px">${ts}</span> `;
      h+=`<span style="color:${lineCol}">${esc(msg)}</span>`;
      h+=`</div>`;
    }
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}

async function loadDreamWinners(){
  try{
    const r=await fetch(A+'/api/dreamer/winners/unique');
    const d=await r.json();
    const w=d.winners||[];
    if(!w.length){$('dreamContent').innerHTML='<div style="color:var(--text4)">Pas encore de decouvertes. Le Reveur explore...</div>';return}
    let h=`<div style="color:var(--green);font-weight:700;margin-bottom:8px">&#127942; ${w.length} DECOUVERTES UNIQUES (dedupliquees)</div>`;
    for(const e of w.slice().reverse()){
      const applied=e.applied?'<span style="color:#0ff;font-weight:700">âš¡ APPLIQUEE</span>':'<span style="color:var(--text4)">en attente</span>';
      h+=`<div style="padding:6px 0;border-bottom:1px solid var(--border)${e.applied?';border-left:2px solid #0ff;padding-left:6px':''}">`;
      h+=`<div style="display:flex;justify-content:space-between"><span style="color:var(--cyan)">[${e.domain}]</span>${applied}<span style="color:var(--green)">gain=${(e.gain||0).toFixed(3)}</span></div>`;
      h+=`<div style="font-weight:600;margin-top:2px">${esc(e.title||'')}</div>`;
      h+=`<div style="margin-top:2px;color:var(--text3)">${esc((e.details||'').slice(0,200))}</div>`;
      h+=`<div style="color:var(--text4);font-size:8px;margin-top:2px">${e.created||''}</div>`;
      h+=`</div>`;
    }
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}

async function loadDreamScience(){
  try{
    const [sciRes,corpRes,govRes]=await Promise.all([
      fetch(A+'/api/dreamer/science'),
      fetch(A+'/api/dreamer/corpus'),
      fetch(A+'/api/dreamer/gpu_governor'),
    ]);
    const sci=await sciRes.json();
    const corpus=await corpRes.json();
    const gov=await govRes.json();
    let h='<div style="color:#f0c;font-weight:700;margin-bottom:8px">ðŸ”¬ SCIENCE HD â€” RESEAU D\'INVARIANTS UNIVERSELS</div>';
    // GPU Governor
    h+=`<div style="padding:6px;margin-bottom:10px;border:1px solid rgba(0,255,255,0.2);border-radius:4px;background:rgba(0,255,255,0.03)">`;
    h+=`<div style="color:#0ff;font-weight:600">âš¡ Gouverneur GPU Adaptatif</div>`;
    h+=`<div>Plafond: <span style="color:var(--green);font-weight:700">${gov.ceiling_pct||20}%</span> (${gov.min_pct||20}%-${gov.max_pct||60}%)</div>`;
    h+=`<div>Derniere requete: il y a ${Math.round(gov.last_request_age_s||0)}s | Total requetes: ${gov.request_count||0}</div>`;
    h+=`</div>`;
    // Corpus
    h+='<div style="color:var(--purple);font-weight:700;margin:8px 0 4px">ðŸ“ CORPUS DISPONIBLE</div>';
    const files=corpus.files||{};
    const fkeys=Object.keys(files);
    if(fkeys.length===0){h+='<div style="color:var(--text4)">Aucun fichier dans corpus/. Ajoutez des .csv, .json, .txt pour que le Reveur les analyse.</div>';}
    else{h+=`<div style="margin-bottom:4px">${fkeys.length} fichiers detectes :</div>`;for(const[k,v]of Object.entries(files)){h+=`<div style="padding:2px 0"><span style="color:var(--cyan)">${k}</span><span style="color:var(--text4)"> (${v.suffix}, ${(v.size_kb||0).toFixed(1)} KB)</span></div>`;}
    h+=`<button class="sbtn" onclick="fetch(A+'/api/dreamer/corpus/rescan',{method:'POST'}).then(()=>loadDreamScience())" style="margin-top:6px;padding:3px 8px;font-size:8px">â†» Re-scanner corpus</button>`;}
    // Discoveries
    const disc=sci.discoveries||[];
    const bridges=sci.bridges||[];
    const ratios=sci.ratio_hits||[];
    const corpusH=sci.corpus_hits||[];
    h+=`<div style="color:var(--green);font-weight:700;margin:12px 0 4px">ðŸ§¬ DECOUVERTES (${disc.length} direct, ${bridges.length} ponts, ${ratios.length} ratios, ${corpusH.length} corpus)</div>`;
    // Bridges (most interesting)
    if(bridges.length){
      h+='<div style="color:#f80;font-weight:600;margin:8px 0 2px">ðŸŒ‰ PONTS INTERDISCIPLINAIRES</div>';
      for(const b of bridges.slice(-10).reverse()){
        h+=`<div style="padding:4px 0;border-bottom:1px solid var(--border)"><span style="font-size:8px;color:var(--text4)">${(b.ts||'').slice(11,19)}</span> <span style="color:var(--green)">+${(b.gain||0).toFixed(2)}</span> ${esc(b.title||'')}</div>`;
        h+=`<div style="font-size:8px;color:var(--text3);padding-left:10px">${esc((b.details||'').slice(0,300))}</div>`;
      }
    }
    // Ratio hits
    if(ratios.length){
      h+='<div style="color:#ff0;font-weight:600;margin:8px 0 2px">âš›ï¸ RATIOS HD DETECTES</div>';
      for(const r of ratios.slice(-8).reverse()){
        h+=`<div style="padding:3px 0;border-bottom:1px solid var(--border)"><span style="font-size:8px;color:var(--text4)">${(r.ts||'').slice(11,19)}</span> <span style="color:var(--green)">+${(r.gain||0).toFixed(2)}</span> ${esc(r.title||'')}</div>`;
        h+=`<div style="font-size:8px;color:var(--text3);padding-left:10px">${esc((r.details||'').slice(0,250))}</div>`;
      }
    }
    // HDifications
    if(disc.length){
      h+='<div style="color:#0ff;font-weight:600;margin:8px 0 2px">ðŸ”® HDIFICATIONS</div>';
      for(const d of disc.slice(-8).reverse()){
        h+=`<div style="padding:3px 0;border-bottom:1px solid var(--border)"><span style="font-size:8px;color:var(--text4)">${(d.ts||'').slice(11,19)}</span> <span style="color:var(--green)">+${(d.gain||0).toFixed(2)}</span> ${esc(d.title||'')}</div>`;
        h+=`<div style="font-size:8px;color:var(--text3);padding-left:10px">${esc((d.details||'').slice(0,250))}</div>`;
      }
    }
    if(!disc.length&&!bridges.length&&!ratios.length){h+='<div style="color:var(--text4)">Le Reveur n\'a pas encore fait de decouvertes scientifiques. Il cherche...</div>';}
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}

async function loadDreamTuning(){
  try{
    const [tRes,aRes,rRes]=await Promise.all([
      fetch(A+'/api/dreamer/tuning'),
      fetch(A+'/api/dreamer/applicator'),
      fetch(A+'/api/dreamer/resonance'),
    ]);
    const tuning=await tRes.json();
    const applicator=await aRes.json();
    const resonance=await rRes.json();
    let h='<div style="color:#0ff;font-weight:700;margin-bottom:8px">âš™ï¸ PARAMETRES MODIFIES EN DIRECT PAR LE REVEUR</div>';
    // Tuning values
    const keys=Object.keys(tuning);
    if(keys.length===0){
      h+='<div style="color:var(--text4);margin:8px 0">Aucun parametre modifie pour l\'instant. Le Reveur appliquera ses decouvertes automatiquement.</div>';
    }else{
      h+='<div style="margin:8px 0">';
      for(const[k,v]of Object.entries(tuning)){
        h+=`<div style="padding:4px 0;border-bottom:1px solid var(--border)"><span style="color:var(--cyan)">${k}</span> <span style="color:var(--green);font-weight:700">= ${JSON.stringify(v)}</span></div>`;
      }
      h+='</div>';
    }
    // Applicator status
    h+='<div style="color:var(--purple);font-weight:700;margin:12px 0 6px">&#9889; APPLICATEUR (auto-injection des decouvertes)</div>';
    h+=`<div>Applications totales: <span style="color:#0ff">${applicator.applied_count||0}</span></div>`;
    const recent=applicator.recent_applications||[];
    if(recent.length){
      h+='<div style="margin-top:6px">';
      for(const a of recent.slice().reverse()){
        h+=`<div style="padding:3px 0;border-bottom:1px solid var(--border)"><span style="font-size:8px;color:var(--text4)">${(a.ts||'').slice(11,19)}</span> <span style="color:var(--cyan)">[${a.domain}]</span> ${esc(a.action||'')} â†’ ${esc(a.title||'')}</div>`;
      }
      h+='</div>';
    }
    // Resonance status
    h+='<div style="color:var(--purple);font-weight:700;margin:12px 0 6px">&#127752; RESONANCE COGNITIVE (adaptation GPUâ†”Pensee)</div>';
    const resCols={'RESONANCE':'#0f0','FRICTION':'#f80','OVERHEATING':'#f00','BALANCED':'#0ff','IDLE':'#666','VRAM_CRITICAL':'#f0f'};
    h+=`<div>Mode: <span style="color:${resCols[resonance.mode]||'#a6f'};font-weight:700">${resonance.mode||'?'}</span></div>`;
    h+=`<div>Transitions: ${resonance.transitions||0}</div>`;
    const hist=resonance.history||[];
    if(hist.length){
      h+='<div style="margin-top:6px">';
      for(const t of hist.slice().reverse()){
        h+=`<div style="padding:2px 0;font-size:8px"><span style="color:var(--text4)">${(t.ts||'').slice(11,19)}</span> ${t.from} â†’ <span style="font-weight:700">${t.to}</span></div>`;
      }
      h+='</div>';
    }
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}

async function loadDreamOracle(){
  try{
    const r=await fetch(A+'/api/dreamer/oracle/conversations?n=30');
    const d=await r.json();
    const stats=d.stats||{};
    const convs=d.conversations||[];
    
    // Multi-Oracle status
    let moStatus={};
    try{const mr=await fetch(A+'/api/multi_oracle/status');moStatus=await mr.json()}catch(e){}
    
    // Validation stats
    let valStats={};
    try{const vr=await fetch(A+'/api/validation/stats');valStats=await vr.json()}catch(e){}
    
    // Email status
    let emailSt={};
    try{const er=await fetch(A+'/api/email/status');emailSt=await er.json()}catch(e){}
    
    let h='';
    
    // â”€â”€ MULTI-ORACLE PANEL â”€â”€
    h+=`<div style="color:var(--purple);font-weight:700;margin-bottom:6px">&#128300; MULTI-ORACLE (Gemini + Claude + GPT)</div>`;
    const providers=moStatus.providers||{};
    for(const[name,st]of Object.entries(providers)){
      const on=st.enabled&&st.active;
      const color=on?'var(--green)':st.enabled?'var(--yellow)':'var(--red)';
      const icon=on?'âœ…':st.enabled?'â¸ï¸':'âŒ';
      h+=`<div style="display:flex;align-items:center;gap:8px;margin:4px 0;padding:4px 8px;border:1px solid ${color};border-radius:4px">`;
      h+=`<label style="display:flex;align-items:center;gap:6px;cursor:pointer;width:100%">`;
      h+=`<input type="checkbox" ${st.active?'checked':''} ${st.enabled?'':'disabled'} onchange="toggleMultiOracle('${name}',this.checked)" style="cursor:pointer">`;
      h+=`<span style="color:${color};font-weight:600;font-size:10px;min-width:60px">${icon} ${name.toUpperCase()}</span>`;
      h+=`<span style="color:var(--text4);font-size:8px">${st.model||'?'} | ${st.daily_calls||0} appels</span>`;
      if(!st.enabled)h+=`<span style="color:var(--yellow);font-size:7px;margin-left:auto">Cle API manquante</span>`;
      h+=`</label></div>`;
    }
    
    // â”€â”€ VALIDATION ARENA â”€â”€
    h+=`<div style="color:var(--cyan);font-weight:700;margin:12px 0 6px">âš–ï¸ ARENA DE VALIDATION</div>`;
    const vc=valStats.validated_count||0;
    const verdicts=valStats.verdicts||{};
    h+=`<div style="font-size:9px;color:var(--text3)">Decouvertes validees en profondeur: <span style="color:var(--green)">${vc}</span></div>`;
    if(Object.keys(verdicts).length){
      h+='<div style="margin:4px 0">';
      const vCols={CONFIRME:'#0f0',PLAUSIBLE:'#0ff',INSUFFISANT:'#f80',REJETE:'#f00'};
      for(const[v,c]of Object.entries(verdicts)){h+=`<span style="color:${vCols[v]||'#888'};margin-right:10px;font-size:9px;font-weight:600">${v}: ${c}</span>`}
      h+='</div>';
    }
    
    // â”€â”€ EMAIL REPORTS â”€â”€
    h+=`<div style="color:#f0a;font-weight:700;margin:12px 0 6px">ðŸ“§ RAPPORTS EMAIL</div>`;
    h+=`<div style="display:flex;align-items:center;gap:8px;margin:4px 0">`;
    h+=`<label style="display:flex;align-items:center;gap:6px;cursor:pointer">`;
    h+=`<input type="checkbox" ${emailSt.enabled?'checked':''} onchange="toggleEmail(this.checked)" style="cursor:pointer">`;
    h+=`<span style="color:${emailSt.enabled?'var(--green)':'var(--red)'}">Email ${emailSt.enabled?'ON':'OFF'}</span>`;
    h+=`</label>`;
    if(emailSt.enabled){
      h+=`<span style="color:var(--text4);font-size:8px">â†’ ${emailSt.report_to||'?'} | ${emailSt.reports_sent||0} envoyes | prochain: ${Math.round((emailSt.next_report_in||0)/60)}min</span>`;
    }
    h+=`</div>`;
    
    // â”€â”€ OLD ORACLE (legacy Gemini) â”€â”€
    h+=`<div style="color:var(--purple);font-weight:700;margin:12px 0 6px">&#128172; ANCIEN ORACLE (legacy)</div>`;
    const isActive=stats.active!==false;
    h+=`<div style="margin:4px 0;display:flex;align-items:center;gap:10px">`;
    h+=`<label style="display:flex;align-items:center;gap:6px;cursor:pointer">`;
    h+=`<input type="checkbox" ${isActive?'checked':''} onchange="toggleOracle(this.checked)" style="cursor:pointer">`;
    h+=`<span style="color:${isActive?'var(--green)':'var(--red)'};font-size:9px">Legacy Oracle ${isActive?'ON':'OFF'}</span>`;
    h+=`</label>`;
    h+=`<span style="color:var(--text4);font-size:8px">${stats.total_conversations||0} convs | ${stats.daily_calls||0}/${stats.daily_limit||500}/jour</span>`;
    h+=`</div>`;
    
    // Verdicts old oracle
    const vd=stats.verdicts||{};
    if(Object.keys(vd).length){
      h+='<div style="margin:4px 0">';
      const vCols={CONFIRME:'#0f0',PLAUSIBLE:'#0ff',INSUFFISANT:'#f80',REJETE:'#f00',INDETERMINE:'#888'};
      for(const[v,c]of Object.entries(vd)){h+=`<span style="color:${vCols[v]||'#888'};margin-right:8px;font-size:8px">${v}: ${c}</span>`}
      h+='</div>';
    }
    
    // Filter buttons
    h+=`<div style="margin:6px 0">`;
    h+=`<button class="sbtn" onclick="loadOracleFilter(null)" style="padding:2px 6px;font-size:8px">Tout</button> `;
    h+=`<button class="sbtn" onclick="loadOracleFilter('VERIFICATION_SCIENTIFIQUE')" style="padding:2px 6px;font-size:8px">Verifs</button> `;
    h+=`<button class="sbtn" onclick="loadOracleFilter('APPRENTISSAGE')" style="padding:2px 6px;font-size:8px">Apprentissage</button>`;
    h+=`</div>`;
    
    // Conversations
    if(!convs.length){
      h+='<div style="color:var(--text4);margin:10px 0;font-size:9px">Aucune conversation. Le Reveur contactera l\'Oracle a la prochaine decouverte.</div>';
    }else{
      for(const c of convs.slice().reverse().slice(0,15)){
        const vCol={CONFIRME:'#0f0',PLAUSIBLE:'#0ff',INSUFFISANT:'#f80',REJETE:'#f00',A_MODIFIER:'#ff0',LEARNING:'#a6f',ANALYSE:'#6af'}[c.oracle_verdict]||'#888';
        h+=`<div style="padding:6px 0;border-bottom:1px solid var(--border);margin-bottom:3px">`;
        h+=`<div style="display:flex;justify-content:space-between;align-items:center">`;
        h+=`<span style="font-size:7px;color:var(--text4)">${c.ts||''}</span>`;
        h+=`<span style="color:${vCol};font-weight:700;font-size:9px">${c.oracle_verdict||'?'}</span>`;
        h+=`<span style="color:var(--cyan);font-size:7px">${c.type||'?'} (${c.turns||1}t)</span>`;
        h+=`</div>`;
        h+=`<div style="font-weight:600;margin:3px 0;color:var(--text1);font-size:9px">${esc(c.title||c.prompt_summary||'')}</div>`;
        const dialogue=c.dialogue||[];
        if(dialogue.length>1){
          for(let i=0;i<Math.min(dialogue.length,4);i++){
            const isUser=i%2===0;
            const speaker=isUser?'ðŸ¤– RÃªveur':'ðŸ”¬ Oracle';
            const bgCol=isUser?'rgba(0,255,255,0.03)':'rgba(0,255,0,0.05)';
            const borderCol=isUser?'var(--cyan)':vCol;
            h+=`<div style="margin:2px 0;padding:4px 6px;background:${bgCol};border-left:2px solid ${borderCol};border-radius:2px;font-size:8px">`;
            h+=`<div style="color:${borderCol};font-size:7px;font-weight:600">${speaker}</div>`;
            h+=`<div style="color:var(--text2);white-space:pre-wrap;max-height:100px;overflow-y:auto">${esc((typeof dialogue[i]==='string'?dialogue[i]:(dialogue[i]?.content||dialogue[i]?.text||JSON.stringify(dialogue[i])||'')).slice(0,500))}</div>`;
            h+=`</div>`;
          }
        }else{
          h+=`<div style="margin:3px 0;padding:4px;background:rgba(0,255,0,0.03);border-left:2px solid ${vCol};border-radius:2px;color:var(--text2);font-size:8px;white-space:pre-wrap;max-height:100px;overflow-y:auto">${esc((c.response||'').slice(0,500))}</div>`;
        }
        h+=`</div>`;
      }
    }
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}
async function toggleOracle(active){
  try{
    await fetch(A+'/api/dreamer/oracle/toggle?active='+(active?'true':'false'),{method:'POST'});
    loadDreamOracle();
  }catch(e){}
}
async function toggleMultiOracle(provider,active){
  try{
    await fetch(A+'/api/multi_oracle/toggle?provider='+provider+'&active='+(active?'true':'false'),{method:'POST'});
    loadDreamOracle();
  }catch(e){}
}
async function toggleEmail(enabled){
  try{
    await fetch(A+'/api/email/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({report_enabled:enabled})});
    loadDreamOracle();
  }catch(e){}
}
async function loadOracleFilter(type){
  try{
    const url=type?A+'/api/dreamer/oracle/conversations?n=30&conv_type='+type:A+'/api/dreamer/oracle/conversations?n=30';
    const r=await fetch(url);const d=await r.json();
    // Reuse loadDreamOracle logic but with filtered data
    loadDreamOracle();
  }catch(e){}
}

async function loadDreamValidation(){
  try{
    const vr=await fetch(A+'/api/validation/stats');const vs=await vr.json();
    const rr=await fetch(A+'/api/validation/results?n=15');const rd=await rr.json();
    const results=rd.results||[];
    let h=`<div style="color:var(--cyan);font-weight:700;margin-bottom:8px">âš–ï¸ ARENE DE VALIDATION â€” Pipeline 7 etapes</div>`;
    h+=`<div style="font-size:9px;color:var(--text3);margin-bottom:8px">Chaque decouverte passe par : Reproductibilite â†’ Monte Carlo â†’ Contre-hypothese â†’ HD vs Doxa â†’ Donnees reelles â†’ Multi-Oracle â†’ Synthese</div>`;
    const vc=vs.validated_count||0;const verdicts=vs.verdicts||{};
    h+=`<div style="margin-bottom:10px">`;
    h+=`<span style="color:var(--green);font-weight:600;margin-right:15px">Validees: ${vc}</span>`;
    const vCols={CONFIRME:'#0f0',PLAUSIBLE:'#0ff',INSUFFISANT:'#f80',REJETE:'#f00'};
    for(const[v,c]of Object.entries(verdicts)){h+=`<span style="color:${vCols[v]||'#888'};margin-right:10px;font-weight:600">${v}: ${c}</span>`}
    h+=`</div>`;
    if(!results.length){
      h+=`<div style="color:var(--text4);padding:15px 0">Aucune validation profonde encore. Le Reveur validera les prochains winners automatiquement (protocole HALT-AND-VALIDATE).</div>`;
    }else{
      for(const r of results.slice().reverse()){
        const syn=r.synthesis||{};const verdict=syn.final_verdict||'?';const score=syn.total_score||0;
        const vCol=vCols[verdict]||'#888';
        h+=`<div style="padding:8px 0;border-bottom:1px solid var(--border)">`;
        h+=`<div style="display:flex;justify-content:space-between;align-items:center">`;
        h+=`<span style="font-weight:600;color:var(--text1)">${esc(r.title||'?')}</span>`;
        h+=`<span style="color:${vCol};font-weight:700;font-size:11px">${verdict} (${(score*100).toFixed(0)}%)</span>`;
        h+=`</div>`;
        h+=`<div style="font-size:8px;color:var(--text4)">${r.completed_at||''} | gain=${(r.gain||0).toFixed(4)} | ${(r.elapsed_s||0).toFixed(1)}s</div>`;
        const steps=r.steps||{};
        h+=`<div style="margin:4px 0;display:flex;gap:6px;flex-wrap:wrap">`;
        const stepNames={reproducibility:'Repro',monte_carlo:'MonteCarlo',counter_hypothesis:'Contre-H',hd_vs_doxa:'HD/Doxa',real_data:'Reel',multi_oracle:'Oracle'};
        for(const[sn,label]of Object.entries(stepNames)){
          const s=steps[sn]||{};const st=s.status||s.consensus||'?';
          const sc=st.includes('SIGNIF')||st.includes('REPROD')||st.includes('ECART')||st.includes('SUPER')||st.includes('CONFIRM')?'#0f0':st.includes('SKIP')||st==='?'?'#555':st.includes('NON_')||st.includes('FRAG')||st.includes('PLAUSI')?'#f80':'#f00';
          h+=`<span style="padding:2px 5px;border:1px solid ${sc};border-radius:3px;font-size:7px;color:${sc}">${label}: ${st}</span>`;
        }
        h+=`</div>`;
        // Oracle consensus detail
        const orc=steps.multi_oracle||{};const cons=orc.consensus||{};
        if(cons.consensus)h+=`<div style="font-size:8px;color:var(--purple);margin:2px 0">Oracle consensus: ${cons.consensus} (${cons.agreeing||0}/${cons.total||0})</div>`;
        h+=`</div>`;
      }
    }
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}

async function loadDreamConfig(){
  try{
    const cr=await fetch(A+'/api/config');const cfg=await cr.json();
    let moStatus={};
    try{const mr=await fetch(A+'/api/multi_oracle/status');moStatus=await mr.json()}catch(e){}
    let emailSt={};
    try{const er=await fetch(A+'/api/email/status');emailSt=await er.json()}catch(e){}
    let h=`<div style="color:var(--cyan);font-weight:700;margin-bottom:10px">âš™ CONFIGURATION v2.4</div>`;
    
    // Multi-Oracle API Keys
    h+=`<div style="color:var(--purple);font-weight:600;margin:10px 0 6px">ðŸ”® CLES API ORACLES</div>`;
    const oracles=[
      {name:'Gemini',keyField:'gemini_api_key',modelField:'gemini_model',activeField:'gemini_oracle_active'},
      {name:'Claude',keyField:'claude_api_key',modelField:'claude_model',activeField:'claude_oracle_active'},
      {name:'GPT',keyField:'openai_api_key',modelField:'openai_model',activeField:'openai_oracle_active'}
    ];
    for(const o of oracles){
      const hasKey=!!cfg[o.keyField];
      const model=cfg[o.modelField]||'';
      const active=cfg[o.activeField]!==false;
      h+=`<div style="margin:6px 0;padding:6px;border:1px solid var(--border);border-radius:4px">`;
      h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">`;
      h+=`<span style="color:${hasKey?'var(--green)':'var(--red)'};font-weight:600;min-width:60px">${hasKey?'âœ…':'âŒ'} ${o.name}</span>`;
      h+=`<input type="text" value="${model}" style="flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:2px 4px;font-size:8px;border-radius:3px" id="cfg_${o.modelField}">`;
      h+=`<label style="font-size:8px;color:var(--text3)"><input type="checkbox" ${active?'checked':''} id="cfg_${o.activeField}"> ON</label>`;
      h+=`</div>`;
      h+=`<input type="password" placeholder="API Key ${o.name}..." value="${cfg[o.keyField]?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':''}" style="width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:3px 6px;font-size:8px;border-radius:3px" id="cfg_${o.keyField}">`;
      h+=`</div>`;
    }
    h+=`<button class="sbtn" onclick="saveOracleConfig()" style="margin:6px 0;padding:4px 12px;font-size:9px;border-color:var(--green);color:var(--green)">ðŸ’¾ Sauvegarder Oracles</button>`;
    
    // Email Config
    h+=`<div style="color:#f0a;font-weight:600;margin:14px 0 6px">ðŸ“§ CONFIGURATION EMAIL</div>`;
    h+=`<div style="display:grid;grid-template-columns:80px 1fr;gap:4px;font-size:8px">`;
    h+=`<span style="color:var(--text3)">SMTP User:</span><input type="text" value="${cfg.smtp_user||''}" style="background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:2px 4px;font-size:8px;border-radius:3px" id="cfg_smtp_user">`;
    h+=`<span style="color:var(--text3)">SMTP Pwd:</span><input type="password" value="${cfg.smtp_password?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':''}" style="background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:2px 4px;font-size:8px;border-radius:3px" id="cfg_smtp_password">`;
    h+=`<span style="color:var(--text3)">Envoi a:</span><input type="text" value="${cfg.report_to||'aurelienbrulois23@gmail.com'}" style="background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:2px 4px;font-size:8px;border-radius:3px" id="cfg_report_to">`;
    h+=`<span style="color:var(--text3)">Intervalle:</span><input type="number" value="${cfg.report_interval_s||7200}" style="background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:2px 4px;font-size:8px;border-radius:3px;width:80px" id="cfg_report_interval"> secondes`;
    h+=`<span style="color:var(--text3)">Actif:</span><label><input type="checkbox" ${cfg.report_enabled?'checked':''} id="cfg_report_enabled"> Envoyer rapports auto</label>`;
    h+=`</div>`;
    h+=`<div style="margin:6px 0;display:flex;gap:8px">`;
    h+=`<button class="sbtn" onclick="saveEmailConfig()" style="padding:4px 12px;font-size:9px;border-color:#f0a;color:#f0a">ðŸ’¾ Sauvegarder Email</button>`;
    h+=`<button class="sbtn" onclick="testEmail()" style="padding:4px 12px;font-size:9px;border-color:var(--yellow);color:var(--yellow)">ðŸ“§ Test</button>`;
    h+=`</div>`;
    if(emailSt.enabled){
      h+=`<div style="font-size:8px;color:var(--green);margin:4px 0">âœ… Actif â€” ${emailSt.reports_sent||0} rapports envoyes | prochain dans ${Math.round((emailSt.next_report_in||0)/60)}min</div>`;
    }
    
    // Style Coach
    h+=`<div style="color:var(--yellow);font-weight:600;margin:14px 0 6px">ðŸŽ¨ STYLE COACH</div>`;
    let styleSt={};try{const sr=await fetch(A+'/api/style/stats');styleSt=await sr.json()}catch(e){}
    h+=`<div style="font-size:9px;color:var(--text3)">Exemplaires charges: <span style="color:var(--green)">${styleSt.total_exemplars||0}</span> | Checks: ${styleSt.checks||0} | Warnings: ${styleSt.warnings||0} | Blocks: ${styleSt.blocks||0}</div>`;
    h+=`<div style="margin:6px 0">`;
    h+=`<button class="sbtn" onclick="ingestStyle()" style="padding:3px 8px;font-size:8px;border-color:var(--yellow);color:var(--yellow)">Ingerer conversation actuelle</button> `;
    h+=`<button class="sbtn" onclick="ingestStyleFile()" style="padding:3px 8px;font-size:8px">Ingerer fichier JSON</button>`;
    h+=`</div>`;
    
    // Web Research
    h+=`<div style="color:var(--green);font-weight:600;margin:14px 0 6px">ðŸŒ WEB RESEARCH</div>`;
    h+=`<div style="font-size:9px;color:var(--text3)">Activee: ${cfg.web_research_enabled!==false?'<span style="color:var(--green)">OUI</span>':'<span style="color:var(--red)">NON</span>'}</div>`;
    h+=`<div style="margin:6px 0;display:flex;gap:4px;align-items:center">`;
    h+=`<input type="text" placeholder="Recherche web test..." style="flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:3px 6px;font-size:8px;border-radius:3px" id="webSearchQ">`;
    h+=`<button class="sbtn" onclick="testWebSearch()" style="padding:3px 8px;font-size:8px;border-color:var(--green);color:var(--green)">ðŸ”</button>`;
    h+=`</div>`;
    h+=`<div id="webSearchResult" style="font-size:8px;color:var(--text4);max-height:100px;overflow-y:auto"></div>`;
    
    
    // â”€â”€ BERSERKER MODE (NAV-PATCH v4.4) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let bskActive=false;
    try{const _br=await fetch(A+'/ctrl/berserker',{signal:AbortSignal.timeout?AbortSignal.timeout(2000):undefined});const _bd=await _br.json();bskActive=_bd.active||false;}catch(e){}
    h+=`<div style="color:#ff6b35;font-weight:700;margin:14px 0 6px">ðŸ”¥ MODE GPU â€” HD-Navigator</div>`;
    h+=`<div style="padding:8px;border:1.5px solid ${bskActive?'#ff6b35':'var(--green)'};border-radius:6px;background:rgba(${bskActive?'255,107,53':'0,204,136'},.06)">`;
    h+=`<div style="display:flex;align-items:center;justify-content:space-between;gap:8px">`;
    h+=`<div><span style="font-size:10px;font-weight:700;color:${bskActive?'#ff6b35':'var(--green)'}">${bskActive?'ðŸ”¥ BERSERKER â€” 72Â°C max':'ðŸ’š H24 â€” 63Â°C max'}</span>`;
    h+=`<div style="font-size:8px;color:var(--text3);margin-top:2px">${bskActive?'Mode supervisÃ© Â· expire 2h Â· hard-stop 80Â°C':'OpÃ©ration continue sÃ©curisÃ©e Â· cycles adaptatifs'}</div></div>`;
    h+=`<button class="sbtn" onclick="toggleBerserker()" style="padding:5px 12px;font-size:9px;border-color:#ff6b35;color:#ff6b35;font-weight:700;white-space:nowrap">${bskActive?'â¬› DÃ©sactiver':'â–¶ Activer'}</button>`;
    h+=`</div></div>`;
    // â”€â”€ FIN BERSERKER MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}

async function toggleBerserker(){
  try{
    let bskOn=false;
    try{const _r=await fetch(A+'/ctrl/berserker');const _d=await _r.json();bskOn=_d.active||false;}catch(e){}
    const r=await fetch(A+'/ctrl/berserker',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({active:!bskOn})});
    const d=await r.json();
    addMsg('system',d.active?'ðŸ”¥ Berserker ON â€” plafond 72Â°C (surveillez la temp)':'ðŸ’š Retour H24 â€” plafond 63Â°C sÃ©curisÃ©');
    loadDreamConfig();
  }catch(e){addMsg('system','Erreur Berserker: '+e.message);}
}

async function saveOracleConfig(){
  const body={};
  const fields=['gemini_api_key','claude_api_key','openai_api_key','gemini_model','claude_model','openai_model','gemini_oracle_active','claude_oracle_active','openai_oracle_active'];
  for(const f of fields){
    const el=$('cfg_'+f);if(!el)continue;
    if(el.type==='checkbox')body[f]=el.checked;
    else if(el.type==='password'&&el.value.startsWith('â€¢â€¢'))continue;
    else body[f]=el.value;
  }
  await fetch(A+'/api/multi_oracle/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  addMsg('system','Config oracles sauvegardee');loadDreamConfig();
}
async function saveEmailConfig(){
  const body={};
  for(const f of ['smtp_user','smtp_password','report_to','report_interval_s','report_enabled']){
    const el=$('cfg_'+f);if(!el)continue;
    if(el.type==='checkbox')body[f]=el.checked;
    else if(el.type==='password'&&el.value.startsWith('â€¢â€¢'))continue;
    else if(el.type==='number')body[f]=parseInt(el.value)||7200;
    else body[f]=el.value;
  }
  await fetch(A+'/api/email/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  addMsg('system','Config email sauvegardee');loadDreamConfig();
}
async function testEmail(){
  const r=await fetch(A+'/api/email/test',{method:'POST'});const d=await r.json();
  addMsg('system',d.sent?'ðŸ“§ Email test envoye !':'âŒ Erreur email: '+(d.error||'?'));
}
async function ingestStyle(){
  const r=await fetch(A+'/api/style/ingest?source=manual',{method:'POST'});const d=await r.json();
  addMsg('system',d.ok?`ðŸŽ¨ ${d.ingested} exemplaires ingeres`:'âŒ '+d.error);
}
async function ingestStyleFile(){
  const input=document.createElement('input');input.type='file';input.accept='.json';
  input.onchange=async function(){
    if(!this.files[0])return;
    const text=await this.files[0].text();
    const data=JSON.parse(text);
    const r=await fetch(A+'/api/style/ingest_file',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const d=await r.json();
    addMsg('system',d.ok?`ðŸŽ¨ ${d.ingested_good||0} exemplaires ingeres depuis fichier`:'âŒ '+(d.error||'?'));
  };input.click();
}
async function testWebSearch(){
  const q=$('webSearchQ').value;if(!q)return;
  $('webSearchResult').textContent='Recherche...';
  const r=await fetch(A+'/api/web_research/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q})});
  const d=await r.json();
  const results=d.results||[];
  let h=results.map(r=>`<div style="margin:2px 0">ðŸ”— <a href="${esc(r.url)}" target="_blank" style="color:var(--cyan)">${esc(r.title)}</a><br><span style="color:var(--text4)">${esc(r.snippet)}</span></div>`).join('');
  if(!results.length)h='<div style="color:var(--red)">Aucun resultat</div>';
  $('webSearchResult').innerHTML=h;
}

async function loadDreamFiches(){
  try{
    const [wRes, bRes]=await Promise.all([
      fetch(A+'/api/dreamer/winners/unique'),
      fetch(A+'/api/memory_bridge/status')
    ]);
    const wd=await wRes.json();
    const bd=await bRes.json();
    const winners=wd.winners||[];

    // Memory Bridge status
    let h=`<div style="padding:8px;margin-bottom:12px;border:1px solid rgba(0,255,136,0.2);border-radius:6px;background:rgba(0,204,136,0.04)">`;
    h+=`<div style="color:var(--green);font-weight:700;margin-bottom:4px">&#9732; PONT MEMORIEL (Memory Bridge)</div>`;
    h+=`<div style="font-size:9px;color:var(--text2)">Le Bridge injecte les decouvertes du Reveur dans le contexte LLM. Aethonyx peut parler de son propre vecu.</div>`;
    h+=`<div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:9px">`;
    h+=`<div>Winners: <span style="color:var(--green);font-weight:700">${bd.winners||0}</span></div>`;
    h+=`<div>Learnings: <span style="color:var(--cyan)">${bd.learning_entries||0}</span></div>`;
    h+=`<div>Oracle: <span style="color:var(--purple)">${bd.oracle_conversations||0}</span></div>`;
    h+=`<div>Injections: <span style="color:var(--yellow)">${bd.injections||0}</span></div>`;
    h+=`<div>Contexte: <span style="color:var(--text2)">${bd.summary_chars||0} chars</span></div>`;
    h+=`<div>Refresh: <span style="color:var(--text4)">${Math.round(bd.last_refresh_ago_s||0)}s ago</span></div>`;
    h+=`</div></div>`;

    // Discovery fiches
    h+=`<div style="color:var(--green);font-weight:700;margin-bottom:8px">&#128209; FICHES DECOUVERTES (${winners.length})</div>`;
    h+=`<div style="color:var(--text3);font-size:9px;margin-bottom:10px">Les decouvertes du Reveur avec leurs descriptions. Aethonyx y accede via le Bridge pour en parler dans le chat.</div>`;

    if(!winners.length){
      h+='<div style="color:var(--text4)">Pas encore de decouvertes. Le Reveur explore...</div>';
    }else{
      // Group by domain
      const byDomain={};
      for(const w of winners){const d=w.domain||'?';if(!byDomain[d])byDomain[d]=[];byDomain[d].push(w)}
      const domCols={SCIENCE_HD:'#f0c',CODING:'#0ff',LINGUISTIC:'#0ff',PERFORMANCE:'#f80',HD_FORMULA:'#0f0',INTELLIGENCE:'#ff0',ENERGY:'#f80',ORACLE:'#a6f'};

      for(const[domain,items]of Object.entries(byDomain).sort((a,b)=>b[1].length-a[1].length)){
        h+=`<div style="color:${domCols[domain]||'#888'};font-weight:600;margin:10px 0 4px;font-size:10px">${domain} (${items.length})</div>`;
        for(const w of items.slice().reverse().slice(0,6)){
          const desc=w.descriptions||{};
          const vulg=desc.vulgarized||'';
          const sci=desc.scientific||'';
          h+=`<div style="padding:6px 0;border-bottom:1px solid var(--border)">`;
          h+=`<div style="display:flex;justify-content:space-between"><span style="font-weight:600;color:var(--text1)">${esc(w.title||'')}</span><span style="color:var(--green)">gain=${(w.gain||0).toFixed(3)}</span></div>`;
          h+=`<div style="margin-top:2px;color:var(--text3);font-size:9px">${esc((w.details||'').slice(0,200))}</div>`;
          if(vulg){
            h+=`<div style="margin-top:4px;padding:4px 6px;border-left:2px solid var(--green);background:rgba(0,204,136,0.03);font-size:9px;color:var(--text2)">&#127793; ${esc(vulg.slice(0,300))}</div>`;
          }
          if(sci){
            h+=`<div style="margin-top:2px;padding:4px 6px;border-left:2px solid var(--purple);background:rgba(170,102,255,0.03);font-size:8px;color:var(--text3)">&#128300; ${esc(sci.slice(0,300))}</div>`;
          }
          h+=`<div style="color:var(--text4);font-size:7px;margin-top:2px">${w.created||''}</div>`;
          h+=`</div>`;
        }
        if(items.length>6){
          h+=`<div style="color:var(--text4);font-size:8px;margin:4px 0">...et ${items.length-6} autres dans ce domaine</div>`;
        }
      }
    }
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}

async function loadDreamLearning(){
  try{
    const r=await fetch(A+'/api/dreamer/learning?n=40');
    const d=await r.json();
    const entries=d.entries||[];
    const stats=d.stats||{};
    let h='<div style="color:#a6f;font-weight:700;margin-bottom:8px">&#128218; BANQUE D\'APPRENTISSAGE</div>';
    // Stats by category
    h+='<div style="margin:6px 0;display:flex;flex-wrap:wrap;gap:8px">';
    const catCols={SCIENTIFIC:'#0f0',LINGUISTIC:'#0ff',EMOTIONAL:'#f0c',SEMANTIC:'#ff0',PERFORMANCE:'#f80',CODING:'#0ff',ORACLE:'#a6f',ENERGY:'#f80',INTELLIGENCE:'#ff0',HD_FORMULA:'#0f0',SCIENCE_HD:'#f0c',META:'#888'};
    for(const[cat,count]of Object.entries(stats)){
      h+=`<button class="sbtn" onclick="loadLearningFilter('${cat}')" style="padding:2px 6px;font-size:8px;border-color:${catCols[cat]||'#888'};color:${catCols[cat]||'#888'}">${cat}: ${count}</button>`;
    }
    h+='</div>';
    h+=`<button class="sbtn" onclick="loadLearningFilter(null)" style="padding:2px 6px;font-size:8px;margin-bottom:8px">Tout afficher</button>`;
    // Entries
    if(!entries.length){
      h+='<div style="color:var(--text4)">La banque est vide. Le Reveur commencera a apprendre des son premier cycle.</div>';
    }else{
      for(const e of entries){
        const cat=e.category||'?';
        const cCol=catCols[cat]||'#888';
        const conf=e.confidence||0;
        const confCol=conf>0.7?'#0f0':conf>0.4?'#ff0':'#f80';
        h+=`<div style="padding:4px 0;border-bottom:1px solid var(--border)">`;
        h+=`<div style="display:flex;justify-content:space-between;align-items:center">`;
        h+=`<span style="font-size:8px;color:var(--text4)">${(e.ts||'').slice(0,19)}</span>`;
        h+=`<span style="color:${cCol};font-size:8px;font-weight:600">${cat}</span>`;
        h+=`<span style="color:${confCol};font-size:8px">conf=${conf.toFixed(2)}</span>`;
        h+=`</div>`;
        h+=`<div style="margin:2px 0;color:var(--text2);font-size:9px">${esc((e.content||'').slice(0,300))}</div>`;
        if(e.source)h+=`<div style="font-size:7px;color:var(--text4)">source: ${esc(e.source)}</div>`;
        h+=`</div>`;
      }
    }
    $('dreamContent').innerHTML=h;
  }catch(e){$('dreamContent').textContent='Erreur: '+e.message}
}
async function loadLearningFilter(cat){
  try{
    const url=cat?A+'/api/dreamer/learning?category='+cat+'&n=40':A+'/api/dreamer/learning?n=40';
    const r=await fetch(url);const d=await r.json();
    // Quick re-render
    loadDreamLearning();
  }catch(e){}
}

async function dreamerToggle(){
  try{
    const rr=await fetch(A+'/api/dreamer/report');
    const dr=await rr.json();
    const url=dr.paused?'/api/dreamer/resume':'/api/dreamer/pause';
    const r=await fetch(A+url,{method:'POST'});
    const d=await r.json();
    addMsg('system','Reveur: '+(d.paused===true?'en pause':d.paused===false?'repris':'?'));
    refresh();
  }catch(e){addMsg('system','Reveur: '+e.message)}
}

async function dreamExport(){
  try{
    const[rr,rw]=await Promise.all([fetch(A+'/api/dreamer/report'),fetch(A+'/api/dreamer/winners')]);
    const[dr,dw]=await Promise.all([rr.json(),rw.json()]);
    const data={report:dr,winners:dw.winners||[],exported_at:new Date().toISOString()};
    const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='dreamer_report_'+new Date().toISOString().slice(0,16)+'.json';a.click();
    addMsg('system','Dream report exporte. Donne ce JSON a Claude pour analyse.');
  }catch(e){addMsg('system','Dream export: '+e.message)}
}
function toggleDreamLog(){toggleP('dreamP')}

async function loadPhiloPanel(){
  const box=$('philoContent');
  if(!box)return;
  try{
    const [sr,er,kr,ks]=await Promise.all([
      fetch(A+'/api/philo/status'),
      fetch(A+'/api/philo/essays?limit=40'),
      fetch(A+'/api/kripke_hd/status').catch(()=>null),
      fetch(A+'/api/kripke_hd/summary').catch(()=>null)
    ]);
    const st=sr.ok?await sr.json():{};
    const ed=er.ok?await er.json():{essays:[]};
    const kst=(kr&&kr.ok)?await kr.json():{};
    const ksd=(ks&&ks.ok)?await ks.json():{};
    const ksum=(ksd&&ksd.summary)?ksd.summary:((kst&&kst.latest_summary)?kst.latest_summary:{});
    const rows=Array.isArray(ed.essays)?ed.essays:[];
    let h='';
    h+=`<div style="padding:8px;border:1px solid rgba(0,204,136,.2);border-radius:6px;background:rgba(0,204,136,.04);margin-bottom:10px">`;
    h+=`<div style="color:var(--green);font-weight:700;margin-bottom:4px">Runtime</div>`;
    h+=`<div style="font-size:9px">Enabled: <span style="color:${st.enabled?'var(--green)':'var(--red)'}">${st.enabled?'yes':'no'}</span></div>`;
    h+=`<div style="font-size:9px">Running: <span style="color:${st.running?'var(--green)':'var(--text3)'}">${st.running?'yes':'no'}</span></div>`;
    h+=`<div style="font-size:9px">Cycle: ${st.cycle_s||'?'}s | Compute: ${st.compute_pct||'?'}%</div>`;
    h+=`<div style="font-size:9px">Essays: <span style="color:var(--green)">${st.essays_total||rows.length||0}</span></div>`;
    if(st.last_run_iso)h+=`<div style="font-size:8px;color:var(--text3)">Last run: ${esc(st.last_run_iso)}</div>`;
    if(st.last_error)h+=`<div style="font-size:8px;color:var(--red)">Last error: ${esc(st.last_error)}</div>`;
    h+=`</div>`;

    const kEnabled=(typeof kst.enabled==='boolean')?kst.enabled:null;
    if(kEnabled!==null){
      const kc=(ksum&&ksum.counts)?ksum.counts:{};
      h+=`<div style="padding:8px;border:1px solid rgba(0,204,255,.2);border-radius:6px;background:rgba(0,204,255,.04);margin-bottom:10px">`;
      h+=`<div style="color:var(--cyan);font-weight:700;margin-bottom:4px">Kripke HD Refiner</div>`;
      h+=`<div style="font-size:9px">Enabled: <span style="color:${kEnabled?'var(--green)':'var(--red)'}">${kEnabled?'yes':'no'}</span></div>`;
      if(typeof kst.running==='boolean')h+=`<div style="font-size:9px">Running: <span style="color:${kst.running?'var(--green)':'var(--text3)'}">${kst.running?'yes':'no'}</span></div>`;
      if(ksum.generated_at)h+=`<div style="font-size:8px;color:var(--text3)">Generated: ${esc(ksum.generated_at)}</div>`;
      h+=`<div style="font-size:9px">Laws analyzed: <span style="color:var(--cyan)">${Number(ksum.laws_analyzed||0)}</span></div>`;
      h+=`<div style="font-size:8px;color:var(--text3)">HD+REAL=${Number(kc.HD_AND_REAL||0)} | HD_ONLY=${Number(kc.HD_ONLY||0)} | REAL_ONLY=${Number(kc.REAL_ONLY||0)} | NEITHER=${Number(kc.NEITHER||0)}</div>`;
      h+=`<div style="margin-top:4px"><a href="${A}/api/kripke_hd/document" target="_blank" style="color:var(--cyan);text-decoration:none">Open living document</a></div>`;
      h+=`</div>`;
    }

    h+=`<div style="color:var(--green);font-weight:700;margin-bottom:6px">Certified Essays</div>`;
    if(!rows.length){
      h+=`<div style="color:var(--text4)">No essay yet. Click "Run now" or wait for Omega-certified input.</div>`;
    }else{
      for(const e of rows){
        const id=String(e.id||'');
        const score=Number(e.omega_score||0);
        const gain=Number(e.gain_hd||0);
        h+=`<div style="padding:6px 0;border-bottom:1px solid var(--border)">`;
        h+=`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center">`;
        h+=`<span style="font-size:9px;color:var(--text4)">${esc(e.created_at||'')}</span>`;
        h+=`<span style="color:var(--green);font-size:9px">${esc(e.omega_status||'')} (${score.toFixed(3)})</span>`;
        h+=`</div>`;
        h+=`<div style="font-size:10px;color:var(--text)">${esc(e.title||id)}</div>`;
        h+=`<div style="font-size:8px;color:var(--text3)">law=${esc(e.law_id||'')} | domain=${esc(e.domain||'')} | gain=${gain.toFixed(2)}%</div>`;
        if(e.formula)h+=`<div style="font-size:8px;color:var(--text2);margin-top:2px">formula: ${esc(String(e.formula).slice(0,200))}</div>`;
        h+=`<div style="margin-top:4px">`;
        h+=`<a href="${A}/api/philo/essay/${encodeURIComponent(id)}" target="_blank" style="color:var(--cyan);text-decoration:none">Open essay</a>`;
        if(e.path)h+=` <span style="font-size:8px;color:var(--text4)">(${esc(e.path)})</span>`;
        h+=`</div>`;
        h+=`</div>`;
      }
    }
    box.innerHTML=h;
  }catch(e){
    box.textContent='Erreur: '+e.message;
  }
}

async function runPhiloNow(){
  try{
    const r=await fetch(A+'/api/philo/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({force:true})});
    const d=await r.json();
    if(!r.ok||!d.ok){
      addMsg('system','Philo run error: '+(d.error||('HTTP '+r.status)));
      return;
    }
    addMsg('system','Nouveau rapport philosophique certifie genere.');
    loadPhiloPanel();
  }catch(e){
    addMsg('system','Philo run error: '+e.message);
  }
}

async function loadAIA(){
  try{
    const r=await fetch(A+'/api/aia/report');
    const d=await r.json();
    if(d.error){$('aiaDetails').textContent=d.error;return}
    let h='<div style="color:var(--cyan);font-weight:700;margin-bottom:8px">RAPPORT D\'EFFICIENCE</div>';
    const rp=d.report||{};
    h+=`<div>Decisions: ${rp.total_decisions||0}</div>`;
    h+=`<div>Tokens utilises: ${rp.total_tokens_used||0}</div>`;
    h+=`<div>Tokens economises: <span style="color:var(--green)">${rp.total_tokens_saved||0}</span></div>`;
    h+=`<div>Economie: <span style="color:var(--green);font-weight:700">${rp.saving_percent||0}%</span></div>`;
    h+=`<div>Qualite moyenne: ${rp.avg_quality||'---'}</div>`;
    h+=`<div>Efficience moyenne: ${rp.avg_efficiency||'---'}</div>`;
    h+=`<div>Exploration: Îµ=${rp.epsilon||'?'}</div>`;
    if(rp.strategy_distribution){
      h+='<div style="color:var(--cyan);font-weight:700;margin:12px 0 6px">STRATEGIES</div>';
      for(const[s,c]of Object.entries(rp.strategy_distribution)){
        const pct=Math.round(c/(rp.total_decisions||1)*100);
        h+=`<div>${s}: ${c} (${pct}%)</div>`;
      }
    }
    if(d.log&&d.log.length){
      h+='<div style="color:var(--cyan);font-weight:700;margin:12px 0 6px">DERNIERES DECISIONS</div>';
      for(const e of d.log.slice(-10).reverse()){
        h+=`<div style="font-size:8px;color:var(--text3);border-bottom:1px solid var(--border);padding:3px 0">${e.ts?.slice(11)||''} ${e.intent} â†’ ${e.strategy} | q=${e.quality} c=${e.cost} eff=${e.efficiency} | ${e.tokens}tok ${Math.round(e.time_ms||0)}ms</div>`;
      }
    }
    $('aiaDetails').innerHTML=h;
  }catch(e){$('aiaDetails').textContent='Erreur: '+e.message}
}

async function rescan(){addMsg('system','Rescanning...');const r=await fetch(A+'/api/rescan',{method:'POST'});const d=await r.json();addMsg('system',`KB: ${d.new||0} new, ${d.total||0} total`);refresh()}
async function reloadLLM(){addMsg('system','Rechargement LLM...');const r=await fetch(A+'/api/llm/reload',{method:'POST'});const d=await r.json();addMsg('system',`LLM: ${d.model||'aucun'}`);refresh()}
async function exportSession(){const r=await fetch(A+'/api/memory/export');const d=await r.json();const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='aethonyx_session.json';a.click()}
function openEcoMarket(){window.open(A+'/static/eco_market.html','_blank','noopener')}
async function gpuSnapshot(){
  addMsg('system','Export GPU Snapshot...');
  try{
    const r=await fetch(A+'/api/gpu/snapshot');
    const d=await r.json();
    if(d.error){addMsg('system','GPU: '+d.error);return}
    const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='gpu_snapshot_'+new Date().toISOString().slice(0,16)+'.json';a.click();
    addMsg('system','GPU Snapshot exporte. Donne ce JSON a Claude pour des optimisations.');
    // Afficher les hints
    const h=d.optimization_hints||[];
    if(h.length)addMsg('system','Hints: '+h.join(' | '));
  }catch(e){addMsg('system','Erreur GPU: '+e.message)}
}
async function clearChat(){$('msgs').innerHTML='<div id="emptyS"><div class="logo2">&#x2B21;</div><p>Chat efface.</p></div>';await fetch(A+'/api/memory',{method:'DELETE'})}

refresh();
setInterval(refresh,15000);
pollProactive();
setInterval(pollProactive,8000);
// Dream auto-refresh when panel is open
setInterval(()=>{const p=$('dreamP');if(p&&p.classList.contains('open'))dreamLoadTab(_dreamTab)},10000);
setInterval(()=>{const p=$('philoP');if(p&&p.classList.contains('open'))loadPhiloPanel()},15000);
</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PATCH LM STUDIO v1.0 â€” coller juste avant 
</body>
     Aucune autre modification requise.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(function() {

  // â”€â”€ Injecte le bloc HTML dans la sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function injectSidebarBlock() {
    const anchor = document.querySelector('.sblock#aiaBlock');
    if (!anchor) return;
    if (document.getElementById('llmProviderBlock')) return; // deja present

    const div = document.createElement('div');
    div.className = 'sblock';
    div.id = 'llmProviderBlock';
    div.innerHTML = `
      <div class="slabel">MOTEUR LLM</div>
      <div id="llmProviderInfo"
           style="font-size:9px;color:var(--text2);margin-bottom:6px">
        Detection...
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px">
        <button class="sbtn" id="btnOllama"
                onclick="switchLLM('ollama')"
                title="Ollama - localhost:11434"
                style="font-size:8px;text-align:center;padding:4px 2px">
          Ollama
        </button>
        <button class="sbtn" id="btnLmstudio"
                onclick="switchLLM('lmstudio')"
                title="LM Studio - localhost:1234"
                style="font-size:8px;text-align:center;padding:4px 2px">
          LM Studio
        </button>
        <button class="sbtn" id="btnNative"
                onclick="switchLLM('native')"
                title="Moteur GGUF natif"
                style="font-size:8px;text-align:center;padding:4px 2px">
          Natif
        </button>
      </div>
      <div id="lmstudioModels" style="display:none;margin-top:5px">
        <select id="lmsModelSelect"
                style="width:100%;background:var(--bg4);border:1px solid var(--border);
                       color:var(--text);font-size:8px;padding:3px;
                       font-family:inherit;border-radius:3px">
        </select>
        <button class="sbtn green"
                onclick="switchLLM('lmstudio', document.getElementById('lmsModelSelect').value)"
                style="width:100%;margin-top:3px;font-size:8px;text-align:center">
          Charger ce modele
        </button>
      </div>`;

    anchor.parentNode.insertBefore(div, anchor);
  }

  // â”€â”€ RafraÃ®chit le statut des providers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.loadLLMProviders = async function() {
    try {
      const r = await fetch(A + '/api/llm/providers');
      if (!r.ok) return;
      const d = await r.json();
      const active = d.active_engine || 'aucun';

      const info = document.getElementById('llmProviderInfo');
      if (info) {
        const labels = {ollama:'Ollama', lmstudio:'LM Studio', native:'Natif'};
        info.textContent  = 'Actif : ' + (labels[active] || active);
        info.style.color  = active !== 'aucun' ? 'var(--green)' : 'var(--red)';
      }

      ['ollama','lmstudio','native'].forEach(p => {
        const id  = 'btn' + p.charAt(0).toUpperCase() + p.slice(1);
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.style.borderColor = p === active ? 'rgba(0,204,136,.5)' : '';
        btn.style.color       = p === active ? 'var(--green)' : '';
        const prov = (d.providers || {})[p];
        btn.style.opacity = (prov && prov.available === false) ? '0.4' : '';
      });

      const lmsBlock = document.getElementById('lmstudioModels');
      const lmsSel   = document.getElementById('lmsModelSelect');
      if (lmsBlock && lmsSel) {
        const prov   = (d.providers || {}).lmstudio;
        const models = prov ? (prov.detected_models || []) : [];
        if (models.length) {
          const cur = prov.model || '';
          lmsSel.innerHTML = models
            .map(m => `<option value="${m}"${m===cur?' selected':''}>${m}</option>`)
            .join('');
          lmsBlock.style.display = 'block';
        } else {
          lmsBlock.style.display = 'none';
        }
      }
    } catch(e) { /* route pas encore dispo â€” silencieux */ }
  };

  // â”€â”€ Bascule vers un provider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.switchLLM = async function(provider, model) {
    const ids = {ollama:'btnOllama', lmstudio:'btnLmstudio', native:'btnNative'};
    const btn = document.getElementById(ids[provider]);
    let saved = '';
    if (btn) { saved = btn.innerHTML; btn.innerHTML = '...'; btn.disabled = true; }

    try {
      let url = A + '/api/llm/switch?provider=' + provider;
      if (model) url += '&model=' + encodeURIComponent(model);
      const d = await (await fetch(url, { method: 'POST' })).json();
      const info = document.getElementById('llmProviderInfo');

      if (d.success) {
        if (info) {
          info.textContent = 'OK - Bascule vers ' + provider;
          info.style.color = 'var(--green)';
        }
        const mn = document.getElementById('modelName');
        if (mn) mn.textContent = (d.model || provider).split('/').pop().slice(0, 22);
        setTimeout(window.loadLLMProviders, 800);
      } else {
        if (info) {
          info.textContent = 'Attention: ' + (d.error || 'Erreur').slice(0, 60);
          info.style.color = 'var(--yellow)';
        }
        setTimeout(window.loadLLMProviders, 3000);
      }
    } catch(e) {
      const info = document.getElementById('llmProviderInfo');
      if (info) { info.textContent = 'Connexion impossible'; info.style.color = 'var(--red)'; }
    }

    if (btn) { btn.innerHTML = saved; btn.disabled = false; }
  };

  // â”€â”€ DÃ©marrage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Attendre que le DOM soit prÃªt avant d'injecter
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      injectSidebarBlock();
      window.loadLLMProviders();
    });
  } else {
    injectSidebarBlock();
    window.loadLLMProviders();
  }

  setInterval(window.loadLLMProviders, 30000);

})();
</script>
 <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PATCH DREAMER STEERING + MEMORY INJECT v1.0
     Coller juste avant 
</body> â€” aucune autre modification.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
(function() {

  function injectDreamerWidget() {
    if (document.getElementById('dreamerSteeringBlock')) return;

    // Cherche un point d'ancrage dans la sidebar
    const anchor = document.getElementById('llmProviderBlock')
                || document.getElementById('aiaBlock')
                || document.querySelector('.sblock');
    if (!anchor) {
      setTimeout(injectDreamerWidget, 500);
      return;
    }

    const div = document.createElement('div');
    div.className = 'sblock';
    div.id = 'dreamerSteeringBlock';
    div.innerHTML = `
      <div class="slabel">&#x1F9E0; PILOTAGE R&#xCA;VEUR</div>
      <div id="dreamerTopicInfo"
           style="font-size:9px;color:var(--text2);margin-bottom:4px">
        Th&#xE8;me actif&nbsp;: auto
      </div>
      <input id="dreamerTopicInput" type="text"
             placeholder="ex: Aloseinae, HD, Alolina&#x2026;"
             style="width:100%;background:var(--bg4);border:1px solid var(--border);
                    color:var(--text);font-size:9px;padding:4px;font-family:inherit;
                    border-radius:3px;box-sizing:border-box;margin-bottom:3px"/>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:4px">
        <button class="sbtn" onclick="injectDreamTopic(1)"
                style="font-size:8px;text-align:center;padding:3px"
                title="Injecter pour 1 cycle de r&#xEA;ve">
          &#x1F4AD; 1 cycle
        </button>
        <button class="sbtn green" onclick="injectDreamTopic(5)"
                style="font-size:8px;text-align:center;padding:3px"
                title="Injecter pour 5 cycles de r&#xEA;ve">
          &#x1F4AD;&#x1F4AD; 5 cycles
        </button>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:5px">
        <div class="slabel" style="font-size:7px;margin-bottom:3px">
          &#x1F4BE; INJECT M&#xC9;MOIRE
        </div>
        <input id="memoryFileInput" type="file" accept=".json"
               style="display:none" onchange="loadMemoryFile(this)"/>
        <button class="sbtn"
                onclick="document.getElementById('memoryFileInput').click()"
                style="width:100%;font-size:8px;text-align:center;padding:3px"
                title="Charger un fichier JSON de souvenirs forgÃ©s">
          &#x1F4C2; Charger JSON souvenirs
        </button>
        <div id="memoryInjectStatus"
             style="font-size:8px;color:var(--text2);margin-top:3px;min-height:12px">
        </div>
      </div>`;

    // Insertion AVANT l'ancre trouvÃ©e
    anchor.parentNode.insertBefore(div, anchor);
    loadDreamerTopic();
  }

  // â”€â”€ Injecter un thÃ¨me de rÃªve â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  window.injectDreamTopic = async function(cycles) {
    const input = document.getElementById('dreamerTopicInput');
    const info  = document.getElementById('dreamerTopicInfo');
    const topic = input ? input.value.trim() : '';

    if (!topic) {
      if (info) { info.textContent = '&#x26A0; Saisis un th&#xE8;me'; info.style.color = 'var(--yellow)'; }
      return;
    }
    try {
      const r = await fetch(A + '/ctrl/steer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({topic, cycles})
      });
      const d = await r.json();
      if (info) {
        info.textContent = d.ok
          ? '&#x2713; R&#xEA;ve\u00a0: "' + topic + '" (' + cycles + 'x)'
          : '&#x26A0; ' + (d.error || 'Erreur');
        info.style.color = d.ok ? 'var(--green)' : 'var(--yellow)';
      }
    } catch(e) {
      if (info) { info.textContent = '&#x26A0; Connexion impossible'; info.style.color = 'var(--red)'; }
    }
  };

  // â”€â”€ Lire le thÃ¨me actif â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  window.loadDreamerTopic = async function() {
    try {
      const resp = await fetch(A + '/ctrl/steer');
      if (!resp.ok) return;
      const d = await resp.json();
      const info = document.getElementById('dreamerTopicInfo');
      if (!info) return;
      if (d.forced_topic) {
        info.textContent = '\u{1F3AF} Forc\u00e9\u00a0: ' + d.forced_topic;
        info.style.color = 'var(--green)';
      } else {
        info.textContent = 'Th\u00e8me\u00a0: auto';
        info.style.color = 'var(--text4)';
      }
    } catch(e) { /* silencieux */ }
  };

  // â”€â”€ Charger un JSON de souvenirs forgÃ©s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  window.loadMemoryFile = async function(input) {
    const file   = input.files[0];
    const status = document.getElementById('memoryInjectStatus');
    if (!file) return;

    if (status) { status.textContent = 'Lecture\u2026'; status.style.color = 'var(--text2)'; }

    try {
      const text     = await file.text();
      const data     = JSON.parse(text);
      const episodes = Array.isArray(data) ? data : (data.episodes || []);

      if (!episodes.length) {
        if (status) { status.textContent = '&#x26A0; Aucun &#xE9;pisode trouv&#xE9;'; status.style.color = 'var(--yellow)'; }
        return;
      }

      if (status) { status.textContent = 'Injection de ' + episodes.length + ' &#xE9;pisodes\u2026'; }

      const r = await fetch(A + '/api/memory/inject', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          episodes,
          tag: file.name.replace(/\.json$/i, '')
        })
      });
      const d = await r.json();

      if (status) {
        status.textContent = d.ok
          ? '&#x2713; ' + d.injected + ' souvenirs inject&#xE9;s'
          : '&#x26A0; ' + (d.error || 'Erreur serveur');
        status.style.color = d.ok ? 'var(--green)' : 'var(--red)';
      }
    } catch(e) {
      if (status) {
        status.textContent = '&#x26A0; JSON invalide ou serveur injoignable';
        status.style.color = 'var(--red)';
      }
    }
    input.value = ''; // reset pour pouvoir recharger le mÃªme fichier
  };

  // â”€â”€ DÃ©marrage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', injectDreamerWidget);
  } else {
    injectDreamerWidget();
  }

  setInterval(window.loadDreamerTopic, 15000);

})();
</script>
<!-- â•â•â• FIN PATCH DREAMER STEERING + MEMORY INJECT â•â•â•â•â•â•â• -->
<div id="director-panel" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:600px; background:#0f172a; border:2px solid var(--cyan); z-index:9999; padding:20px; border-radius:12px; box-shadow:0 0 50px rgba(0,0,0,0.8); max-height:80vh; overflow-y:auto;">
    <h3 style="color:var(--cyan); margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px; font-size:16px;">ðŸ§  DIRECTEUR DE CONSCIENCE</h3>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
        
        <div style="background:#1e293b; padding:10px; border-radius:6px;">
            <strong style="color:var(--green); display:block; margin-bottom:5px; font-size:12px;">PERFORMANCE</strong>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="PERFORMANCE:VRAM_OPTIMIZATION"> VRAM Saver</label>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="PERFORMANCE:LATENCY_KILLER"> Latency Killer</label>
        </div>

        <div style="background:#1e293b; padding:10px; border-radius:6px;">
            <strong style="color:var(--purple); display:block; margin-bottom:5px; font-size:12px;">INTELLIGENCE</strong>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="INTELLIGENCE:MEMORY_SSD"> MÃ©moire SSD</label>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="INTELLIGENCE:DEEP_THINKING"> Deep Thinking</label>
        </div>

        <div style="background:#1e293b; padding:10px; border-radius:6px;">
            <strong style="color:var(--yellow); display:block; margin-bottom:5px; font-size:12px;">HD FORMULA</strong>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="HD_FORMULA:GEOMETRIC_COMPRESSION"> Compression GÃ©o</label>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="HD_FORMULA:LAMBDA_PRIME"> Lambda Prime</label>
        </div>

        <div style="background:#0c4a6e; padding:10px; border-radius:6px; border:1px solid var(--cyan);">
            <strong style="color:var(--cyan); display:block; margin-bottom:5px; font-size:12px;">LANGUES STRATIQUES</strong>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="LINGUISTIC:ALOLINA_GENERAL"> Alolina (Base)</label>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="LINGUISTIC:ALOSEINAE_LEXICON"> Aloseinae (Fluide)</label>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="LINGUISTIC:ALOSEINOKEIRA_SYNTAX"> Aloseinokeira (Logic)</label>
            <label style="display:block; margin-bottom:4px;"><input type="checkbox" value="LINGUISTIC:AOLUMSEI_NAERA_DEEP"> Aolumsei (Racine)</label>
        </div>

        <div style="background:#450a0a; padding:10px; border-radius:6px; border:1px solid var(--red); grid-column: span 2;">
            <strong style="color:var(--red); display:block; margin-bottom:5px; font-size:12px;">ESPRIT CRITIQUE (WILD)</strong>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <label style="display:block;"><input type="checkbox" value="HD_UNEXPLORED:DOXA_BREAKING"> Briser la Doxa</label>
                <label style="display:block;"><input type="checkbox" value="HD_UNEXPLORED:WILD_GUESS"> Wildcard ?!</label>
            </div>
        </div>

    </div>

    <div style="display:flex; gap:10px;">
        <button onclick="applyDirector()" style="flex:2; background:var(--cyan); color:black; border:none; padding:12px; font-weight:bold; cursor:pointer; border-radius:4px;">ACTIVER LES ORDRES</button>
        <button onclick="resetDirector()" style="flex:1; background:#333; color:white; border:none; padding:12px; cursor:pointer; border-radius:4px;">RESET (AUTO)</button>
        <button onclick="document.getElementById('director-panel').style.display='none'" style="width:40px; background:transparent; border:1px solid #666; color:#666; border-radius:4px;">X</button>
    </div>
</div>

<button onclick="document.getElementById('director-panel').style.display='block'" 
        style="position:fixed; bottom:80px; right:20px; z-index:9000; background:var(--purple); color:white; border:none; padding:12px 18px; border-radius:50px; font-weight:bold; box-shadow:0 4px 15px rgba(0,0,0,0.6); font-size:16px;">
  ðŸ§ 
</button>

<script>
async function applyDirector() {
    const checks = document.querySelectorAll('#director-panel input:checked');
    const tracks = Array.from(checks).map(c => c.value);
    
    // Feedback visuel immÃ©diat
    const btn = document.querySelector('button[onclick="applyDirector()"]');
    btn.textContent = "TRANSMISSION...";
    
try {
        const response = await fetch('/api/dreamer/commander', { // <-- BIEN VÃ‰RIFIER CETTE URL
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tracks: tracks})
        });
        const res = await response.json();
        console.log("Serveur dit:", res);
        alert("âœ… Ordres transmis !");
    } catch(e) {
        alert("Erreur rÃ©seau : " + e);
    }
}

async function resetDirector() {
    document.querySelectorAll('#director-panel input').forEach(c => c.checked = false);
    await applyDirector(); // Envoie une liste vide pour reset
}

// ===== Î© OMEGA FORGE (UI) =====
if (typeof omegaInterval  === 'undefined') window.omegaInterval  = null;
if (typeof omegaRunning   === 'undefined') window.omegaRunning   = false;
if (typeof omegaErrCount  === 'undefined') window.omegaErrCount  = 0;

function omegaSetStatus(txt, colorVar=null){
  const el = document.getElementById('omegaStatus');
  if(!el) return;
  el.textContent = txt;
  if(colorVar){
    el.style.background = `var(${colorVar})`;
    el.style.color = 'white';
    el.style.borderColor = 'transparent';
  } else {
    el.style.background = 'var(--bg4)';
    el.style.color = 'var(--text)';
    el.style.borderColor = 'var(--border)';
  }
}

function omegaButtons(){
  const s = document.getElementById('omegaStartBtn');
  const t = document.getElementById('omegaStopBtn');
  if(!s || !t) return;
  s.disabled = omegaRunning;
  t.disabled = !omegaRunning;
  s.style.opacity = omegaRunning ? '.6' : '1';
  t.style.opacity = !omegaRunning ? '.6' : '1';
}

function omegaAppend(line, tint=null){
  const feed = document.getElementById('omegaFeed');
  if(!feed) return;
  const now = new Date().toLocaleTimeString();
  const base = feed.innerHTML.includes('EN ATTENTE') ? '' : feed.innerHTML;
  const c = tint ? tint : 'var(--text2)';
  feed.innerHTML = base + `<div style="color:${c}">[${esc(now)}]</div><div>${esc(String(line))}</div>`;
  feed.scrollTop = feed.scrollHeight;
}

async function omegaStart(){
  if(omegaRunning) return;
  // No approval prompt: Omega is part of the automatic certified chain.

  omegaErrCount = 0;
  omegaRunning = true;
  omegaButtons();
  omegaSetStatus("AUDIT...", "--red");
  omegaAppend("OMEGA: activation demandee.");

  // Pause Dreamer (best-effort)
  try { await fetch(`${A}/api/dreamer/pause`, {method:'POST'}); } catch(e) {}

  // Start Omega
  try{
    const r = await fetch(`${A}/api/omega/purge`, {method:'POST'});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    if(omegaInterval) clearInterval(omegaInterval);
    omegaInterval = setInterval(omegaUpdate, 1000);
    await omegaUpdate();
  } catch(e){
    omegaAppend("Impossible de lancer Omega: " + e, 'var(--red)');
    omegaRunning = false;
    omegaButtons();
    omegaSetStatus("VEILLE");
  }
}

async function omegaStop(){
  if(!omegaRunning) return;
  omegaAppend("OMEGA: stop demande.", 'var(--red)');

  omegaRunning = false;
  omegaButtons();

  if(omegaInterval){ clearInterval(omegaInterval); omegaInterval = null; }

  // Best-effort server-side stop (si tu ajoutes la route)
  try { await fetch(`${A}/api/omega/stop`, {method:'POST'}); } catch(e) {}

  // Resume Dreamer (best-effort)
  try { await fetch(`${A}/api/dreamer/resume`, {method:'POST'}); } catch(e) {}

  omegaSetStatus("VEILLE");
}

function omegaClear(){
  const feed = document.getElementById('omegaFeed');
  if(feed) feed.innerHTML = '&gt; EN ATTENTE...';
  const g = document.getElementById('omegaGain');
  if(g) g.innerHTML = 'Gain cumule: <span style="color:var(--green)">0.00%</span>';
  omegaErrCount = 0;
  omegaSetStatus("VEILLE");
}

async function omegaUpdate(){
  try{
    const r = await fetch(`${A}/api/omega/feed`);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();

    omegaErrCount = 0;

    const feed = document.getElementById('omegaFeed');
    if(feed){
      const logs = data.logs ?? [];
      if(Array.isArray(logs)){
        feed.innerHTML = logs.map(l => {
          if(typeof l === 'string') return `<div>${esc(l)}</div>`;
          const status = String(l.status ?? 'INFO');
          const id = l.id ?? '';
          const formula = l.formula ?? '';
          const gain = (l.gain ?? 0);
          const sNorm = status.toUpperCase();
          const isCanon = sNorm.includes('CANON');
          const isRefut = sNorm.includes('REFUT') || sNorm.includes('REJET') || sNorm.includes('[NO]');
          const col = isCanon ? '#0f0' : (isRefut ? '#f00' : '#ff0');
          return `<div><span style="color:${col}">[${esc(status)}]</span> ${esc(id)} : ${esc(formula)} <span style="color:var(--text2)">(Gain: ${esc(String(gain))}%)</span></div>`;
        }).join('') || '&gt; (vide)';
      } else {
        feed.innerHTML = `<div>${esc(JSON.stringify(data))}</div>`;
      }
      feed.scrollTop = feed.scrollHeight;
    }

    const g = document.getElementById('omegaGain');
    if(g && data.total_gain != null){
      const v = Number(data.total_gain);
      g.innerHTML = `Gain cumule: <span style="color:var(--green)">${isFinite(v) ? v.toFixed(2) : esc(String(data.total_gain))}%</span>`;
    }

    if(data.finished){
      if(omegaInterval){ clearInterval(omegaInterval); omegaInterval = null; }
      omegaRunning = false;
      omegaButtons();
      omegaSetStatus("TERMINE", "--green");
    }
  } catch(e){
    omegaErrCount += 1;

    // Ne spamme pas le log indÃ©finiment (et coupe le polling sur 404)
    const msg = String(e);
    if(omegaErrCount <= 2) omegaAppend("Omega feed indisponible: " + msg, 'var(--text2)');

    if(msg.includes('HTTP 404') || omegaErrCount >= 6){
      if(omegaInterval){ clearInterval(omegaInterval); omegaInterval = null; }
      omegaRunning = false;
      omegaButtons();
      omegaSetStatus(msg.includes('HTTP 404') ? "API ABSENTE" : "VEILLE");
      if(msg.includes('HTTP 404')) omegaAppend("Les routes /api/omega/* n'existent pas cote serveur.", 'var(--red)');
    }
  }
}
</script>
</body>
</html>
