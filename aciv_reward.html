<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ACIV â€” Civilisations Antiques | RÃ©compense PVS</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --pvs-dark:   #070b17;
  --pvs-panel:  #0d1628;
  --pvs-border: rgba(255,255,255,0.12);
  --pvs-cyan:   #00d4ff;
  --pvs-gold:   #ffd700;
  --pvs-red:    #ff4466;
  --parchment:  #c8a55a;
  --stone:      #8a9bae;
  --marble:     rgba(200,165,90,0.08);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--pvs-dark);
  color: #e8eaf0;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Texture d'arriÃ¨re-plan subtile */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse at 8% 12%, rgba(0,212,255,0.06) 0%, transparent 40%),
    radial-gradient(ellipse at 92% 88%, rgba(255,215,0,0.05) 0%, transparent 40%),
    repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(255,255,255,0.01) 40px, rgba(255,255,255,0.01) 41px),
    repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(255,255,255,0.01) 40px, rgba(255,255,255,0.01) 41px);
  pointer-events: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GATE XP (Ã©cran verrou)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#xpGate {
  position: fixed; inset: 0; z-index: 9000;
  display: flex; align-items: center; justify-content: center;
  background: radial-gradient(circle at 50% 40%, #0d1e3a, #03060e);
}
#xpGate.hidden { display: none; }

.gate-card {
  max-width: 520px; width: 90%;
  border: 1px solid var(--pvs-gold);
  background: rgba(10, 15, 30, 0.95);
  padding: 40px 36px;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.gate-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, var(--pvs-cyan), var(--pvs-gold), var(--pvs-cyan));
}
.gate-lock { font-size: 3.5rem; margin-bottom: 16px; filter: drop-shadow(0 0 12px rgba(255,215,0,0.4)); }
.gate-title {
  font-family: 'Cinzel', serif;
  font-size: 1.6rem; color: var(--pvs-gold);
  text-shadow: 0 0 20px rgba(255,215,0,0.3);
  margin-bottom: 8px;
}
.gate-sub { color: var(--stone); font-size: 0.9rem; margin-bottom: 24px; line-height: 1.6; }

.xp-progress-wrap {
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--pvs-border);
  border-radius: 4px;
  padding: 16px 20px;
  margin-bottom: 20px;
}
.xp-bar-track {
  height: 8px; background: rgba(255,255,255,0.1);
  border-radius: 4px; overflow: hidden; margin: 8px 0;
}
.xp-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--pvs-cyan), var(--pvs-gold));
  border-radius: 4px;
  transition: width 1.2s cubic-bezier(0.4,0,0.2,1);
}
.xp-values { font-family: 'Orbitron', monospace; font-size: 0.85rem; color: var(--pvs-cyan); }

.gate-hint { font-size: 0.78rem; color: #667; line-height: 1.5; }

.btn-portal {
  display: inline-block; margin-top: 20px;
  padding: 10px 24px;
  background: linear-gradient(135deg, var(--pvs-cyan), var(--pvs-gold));
  color: #000; font-weight: 700; border: none; cursor: pointer;
  font-family: 'Orbitron', monospace; font-size: 0.75rem;
  text-transform: uppercase; letter-spacing: 1px;
  border-radius: 4px; transition: filter 0.2s;
}
.btn-portal:hover { filter: brightness(1.2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT PRINCIPAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#mainWrapper {
  display: none;
  flex-direction: column;
  min-height: 100vh;
  position: relative; z-index: 1;
}
#mainWrapper.visible { display: flex; }

/* HEADER */
#siteHeader {
  background: rgba(7,11,23,0.95);
  border-bottom: 1px solid var(--pvs-border);
  padding: 10px 16px;
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 10px;
  position: sticky; top: 0; z-index: 200;
  backdrop-filter: blur(8px);
}
.header-left { display: flex; align-items: center; gap: 14px; }
.pvs-badge {
  font-family: 'Orbitron', monospace; font-size: 0.62rem;
  background: linear-gradient(135deg, var(--pvs-cyan), var(--pvs-gold));
  color: #000; padding: 3px 8px; border-radius: 3px; font-weight: 700;
}
.header-title {
  font-family: 'Cinzel', serif;
  font-size: 1.1rem; color: var(--pvs-gold);
  text-shadow: 0 0 12px rgba(255,215,0,0.3);
}
.header-right {
  display: flex; align-items: center; gap: 12px; font-size: 0.8rem;
}
.player-chip {
  background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.3);
  padding: 4px 10px; border-radius: 3px; font-family: 'Share Tech Mono', monospace;
  font-size: 0.75rem; color: var(--pvs-cyan);
}
.xp-chip {
  background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3);
  padding: 4px 10px; border-radius: 3px; font-family: 'Orbitron', monospace;
  font-size: 0.75rem; color: var(--pvs-gold);
}
.btn-small {
  background: rgba(255,255,255,0.06); border: 1px solid var(--pvs-border);
  color: #aaa; padding: 4px 10px; cursor: pointer; border-radius: 3px;
  font-size: 0.74rem; font-family: 'Rajdhani', sans-serif; font-weight: 600;
  transition: background 0.2s, color 0.2s;
}
.btn-small:hover { background: rgba(255,255,255,0.12); color: #fff; }

/* CORPS PRINCIPAL â€” 3 colonnes */
#arena {
  flex: 1;
  display: grid;
  grid-template-columns: 300px 1fr 300px;
  gap: 0;
  align-items: stretch;
}

@media (max-width: 1100px) {
  #arena { grid-template-columns: 240px 1fr 240px; }
}
@media (max-width: 880px) {
  #arena {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto;
  }
  #gameCenter { order: 1; }
  #panelLeft  { order: 2; }
  #panelRight { order: 3; }
}

/* PANNEAUX LATÃ‰RAUX */
.side-panel {
  background: rgba(10,14,25,0.85);
  border-right: 1px solid var(--pvs-border);
  overflow-y: auto;
  max-height: calc(100vh - 52px);
  position: sticky; top: 52px;
}
#panelRight { border-right: none; border-left: 1px solid var(--pvs-border); }

.panel-header {
  background: linear-gradient(135deg, rgba(0,212,255,0.06), rgba(255,215,0,0.04));
  border-bottom: 1px solid var(--pvs-border);
  padding: 12px 14px;
  position: sticky; top: 0; z-index: 10;
  backdrop-filter: blur(4px);
}
.panel-header-title {
  font-family: 'Cinzel', serif;
  font-size: 0.78rem; color: var(--parchment);
  text-transform: uppercase; letter-spacing: 1.5px;
}
.panel-header-sub { font-size: 0.68rem; color: var(--stone); margin-top: 2px; }

/* ACCORDION */
.accord-item { border-bottom: 1px solid rgba(255,255,255,0.06); }
.accord-btn {
  width: 100%; background: none; border: none;
  padding: 11px 14px;
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; text-align: left; transition: background 0.2s;
  color: #dde;
}
.accord-btn:hover { background: rgba(255,255,255,0.04); }
.accord-btn.open { background: rgba(200,165,90,0.06); }
.accord-icon { font-size: 1.2rem; margin-right: 9px; }
.accord-label { font-family: 'Cinzel', serif; font-size: 0.78rem; flex: 1; line-height: 1.4; }
.accord-civ-tag {
  font-size: 0.6rem; padding: 1px 5px; border-radius: 2px;
  font-family: 'Rajdhani', sans-serif; font-weight: 700;
  background: rgba(200,165,90,0.15); color: var(--parchment);
  border: 1px solid rgba(200,165,90,0.25); white-space: nowrap;
}
.accord-arrow {
  color: var(--parchment); font-size: 0.7rem; margin-left: 8px;
  transition: transform 0.25s;
}
.accord-btn.open .accord-arrow { transform: rotate(180deg); }

.accord-body {
  display: none;
  padding: 12px 14px 14px;
  background: rgba(0,0,0,0.2);
  border-top: 1px solid rgba(200,165,90,0.1);
}
.accord-body.open { display: block; }

.accord-body p { font-size: 0.78rem; line-height: 1.65; color: #bbc; margin-bottom: 8px; }
.accord-body p:last-child { margin-bottom: 0; }

.fact-box {
  background: rgba(200,165,90,0.07);
  border-left: 2px solid var(--parchment);
  padding: 8px 10px; margin: 8px 0;
  border-radius: 0 3px 3px 0;
}
.fact-box .fact-label {
  font-size: 0.63rem; color: var(--parchment);
  text-transform: uppercase; letter-spacing: 1px;
  font-weight: 700; margin-bottom: 4px;
}
.fact-box p { font-size: 0.76rem; color: #ccc; margin: 0; }

.civ-dates {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.68rem; color: var(--pvs-cyan);
  margin-bottom: 8px;
  display: flex; gap: 6px; flex-wrap: wrap;
}
.date-tag {
  background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.2);
  padding: 2px 6px; border-radius: 2px;
}

.in-game-note {
  background: rgba(0,212,255,0.05); border: 1px solid rgba(0,212,255,0.2);
  padding: 7px 10px; border-radius: 3px; margin-top: 8px;
  font-size: 0.72rem; color: #8ce8ff; line-height: 1.5;
}
.in-game-note .ign-label {
  font-size: 0.62rem; color: var(--pvs-cyan);
  text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
  margin-bottom: 3px;
}

/* TIMELINE gaming */
.timeline { padding: 4px 0; }
.tl-item {
  display: flex; gap: 10px;
  padding: 10px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  transition: background 0.2s;
}
.tl-item:hover { background: rgba(255,255,255,0.03); }
.tl-dot-col { display: flex; flex-direction: column; align-items: center; }
.tl-dot {
  width: 10px; height: 10px; border-radius: 50%;
  border: 2px solid; flex-shrink: 0; margin-top: 3px;
}
.tl-line {
  width: 1px; flex: 1; min-height: 20px;
  background: linear-gradient(to bottom, var(--pvs-border), transparent);
  margin: 3px 0;
}
.tl-content { flex: 1; }
.tl-year {
  font-family: 'Orbitron', monospace;
  font-size: 0.68rem; color: var(--pvs-gold);
  margin-bottom: 2px;
}
.tl-title { font-size: 0.78rem; font-weight: 700; color: #dde; margin-bottom: 3px; }
.tl-desc { font-size: 0.72rem; color: var(--stone); line-height: 1.5; }
.tl-highlight {
  font-size: 0.65rem; margin-top: 5px;
  padding: 3px 7px; border-radius: 2px;
  display: inline-block;
}
.tl-item.active .tl-dot { border-color: var(--pvs-gold); box-shadow: 0 0 8px rgba(255,215,0,0.5); }
.tl-item.active .tl-highlight { background: rgba(255,215,0,0.12); color: var(--pvs-gold); border: 1px solid rgba(255,215,0,0.3); }

/* CENTRE â€” JEU */
#gameCenter {
  display: flex; flex-direction: column;
  background: #000;
  border-left: none; border-right: none;
}

#gameTopBar {
  background: rgba(5,8,18,0.98);
  border-bottom: 1px solid var(--pvs-border);
  padding: 8px 16px;
  display: flex; align-items: center; justify-content: space-between;
  gap: 10px; flex-wrap: wrap;
}
.gtb-title {
  font-family: 'Orbitron', monospace;
  font-size: 0.72rem; color: var(--pvs-cyan);
  letter-spacing: 1px;
}
.session-xp {
  font-family: 'Share Tech Mono', monospace; font-size: 0.72rem;
  color: var(--pvs-gold);
}

#dosContainer {
  flex: 1;
  min-height: 400px;
  position: relative;
  background: #000;
  display: flex; align-items: center; justify-content: center;
}

/* Placeholder quand js-dos pas encore chargÃ© */
#gameLoading {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 12px; color: #446; text-align: center; padding: 40px;
}
.loading-glyph {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.8rem; color: #224;
  line-height: 1.8; letter-spacing: 2px;
}
.scan-line {
  width: 200px; height: 2px;
  background: linear-gradient(90deg, transparent, var(--pvs-cyan), transparent);
  animation: scan 2s ease-in-out infinite;
}
@keyframes scan { 0%,100% { opacity: 0.2; } 50% { opacity: 1; } }

/* js-dos iframe si chargÃ© */
#jsdosCanvas {
  width: 100%; height: 100%;
  min-height: 480px;
  display: none;
  border: none;
}

/* BARRE BAS */
#bottomBar {
  background: rgba(5,8,18,0.96);
  border-top: 1px solid var(--pvs-border);
  padding: 8px 16px;
  display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
}
.bb-item {
  display: flex; align-items: center; gap: 6px;
  font-size: 0.72rem; color: var(--stone);
}
.bb-val {
  font-family: 'Orbitron', monospace;
  font-size: 0.7rem; color: var(--pvs-gold);
}
.bb-sep { color: var(--pvs-border); }
.tip-text {
  flex: 1; font-size: 0.7rem; color: #557;
  font-family: 'Share Tech Mono', monospace;
}

/* OBJECTIFS */
.objectives { padding: 10px 14px; }
.obj-title {
  font-family: 'Cinzel', serif;
  font-size: 0.72rem; color: var(--parchment);
  text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 8px; padding-bottom: 6px;
  border-bottom: 1px solid rgba(200,165,90,0.2);
}
.obj-item {
  display: flex; align-items: flex-start; gap: 8px;
  padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
  font-size: 0.74rem; color: #aab; line-height: 1.5;
}
.obj-icon { font-size: 0.9rem; flex-shrink: 0; margin-top: 1px; }
.obj-xp {
  font-family: 'Orbitron', monospace; font-size: 0.62rem;
  color: var(--pvs-gold); white-space: nowrap; margin-top: 2px;
}
.obj-done { color: #4d8; }
.obj-done .obj-icon::after { content: ' âœ“'; color: #4d8; font-size: 0.65rem; }

/* Notification XP */
#xpNotif {
  position: fixed; bottom: 60px; right: 20px; z-index: 1000;
  background: rgba(255,215,0,0.12);
  border: 1px solid rgba(255,215,0,0.4);
  padding: 10px 16px; border-radius: 6px;
  font-family: 'Orbitron', monospace; font-size: 0.76rem; color: var(--pvs-gold);
  display: none;
  animation: fadeSlide 0.3s ease;
  backdrop-filter: blur(6px);
}
@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Scrollbar */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
</style>
</head>

<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Ã‰CRAN VERROU XP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="xpGate">
  <div class="gate-card">
    <div class="gate-lock">ğŸ›ï¸</div>
    <div class="gate-title">Civilisations Antiques</div>
    <p class="gate-sub">
      Cette rÃ©compense se dÃ©bloque aprÃ¨s avoir accompli suffisamment
      de missions dans le Portail Vie Scolaire.<br>
      Montre que tu mÃ©rites l'accÃ¨s Ã  cette archive.
    </p>

    <div class="xp-progress-wrap">
      <div class="xp-values">
        <span id="gateCurrentXP">0</span>
        <span style="color:#445"> / </span>
        <span id="gateThreshold">500</span> XP requis
      </div>
      <div class="xp-bar-track">
        <div class="xp-bar-fill" id="gateBar" style="width:0%"></div>
      </div>
      <div style="font-size:0.72rem; color:#667; margin-top:4px">
        Joueur : <span id="gatePlayerName" style="color:#00d4ff;">â€”</span>
      </div>
    </div>

    <p class="gate-hint">
      Continue tes missions pHARe, DÃ©lÃ©guÃ©s et Hub VidÃ©os pour accumuler des XP.<br>
      Reviens quand tu atteins le seuil !
    </p>
    <button class="btn-portal" onclick="goPortal()">â† Retour au Portail</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INTERFACE PRINCIPALE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainWrapper">

  <!-- HEADER COLLANT -->
  <header id="siteHeader">
    <div class="header-left">
      <div class="pvs-badge">PVS â­ RÃ‰COMPENSE</div>
      <div class="header-title">Advanced Civilization â€” 1995</div>
    </div>
    <div class="header-right">
      <div class="player-chip">ğŸ® <span id="headerPlayer">â€”</span></div>
      <div class="xp-chip">âš¡ <span id="headerXP">0</span> XP</div>
      <button class="btn-small" onclick="togglePanels()">Panneaux</button>
      <button class="btn-small" onclick="goPortal()">â† Portail</button>
    </div>
  </header>

  <!-- ARÃˆNE PRINCIPALE -->
  <div id="arena">

    <!-- PANNEAU GAUCHE â€” CIVILISATIONS -->
    <aside class="side-panel" id="panelLeft">

      <div class="panel-header">
        <div class="panel-header-title">ğŸ“œ EncyclopÃ©die</div>
        <div class="panel-header-sub">Civilisations mÃ©diterranÃ©ennes antiques</div>
      </div>

      <!-- Introduction -->
      <div style="padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.06);">
        <p style="font-size:0.74rem; color:#9aabb; line-height:1.6;">
          Le jeu se dÃ©roule de l'<span style="color:var(--parchment)">Ã‚ge de Pierre</span>
          Ã  l'<span style="color:var(--parchment)">Ã‚ge du Fer</span> autour du bassin
          mÃ©diterranÃ©en â€” le berceau des premiÃ¨res grandes civilisations.
        </p>
      </div>

      <!-- MÃ‰SOPOTAMIE -->
      <div class="accord-item">
        <button class="accord-btn" onclick="toggleAccord(this)">
          <span class="accord-icon">ğŸŒŠ</span>
          <span class="accord-label">MÃ©sopotamie</span>
          <span class="accord-civ-tag">5e HIS</span>
          <span class="accord-arrow">â–¼</span>
        </button>
        <div class="accord-body">
          <div class="civ-dates">
            <span class="date-tag">~3500 av. J.-C.</span>
            <span class="date-tag">Sumer â†’ Babylone</span>
          </div>
          <p>Entre le Tigre et l'Euphrate (actuel Irak) surgissent les premiÃ¨res citÃ©s-Ã‰tats : <strong>Ur, Uruk, Nippur</strong>. Les SumÃ©riens inventent l'Ã©criture cunÃ©iforme vers 3200 av. J.-C. â€” le premier systÃ¨me d'Ã©criture connu.</p>
          <div class="fact-box">
            <div class="fact-label">ğŸ’¡ Ã€ retenir</div>
            <p>Le <strong>Code d'Hammurabi</strong> (vers 1750 av. J.-C.) est l'un des premiers codes de lois Ã©crits. 282 articles gravÃ©s sur une stÃ¨le de basalte.</p>
          </div>
          <p>Babylone, sous Nabuchodonosor II (605â€“562), devient une mÃ©tropole de 200 000 habitants avec ses fameux <em>Jardins suspendus</em>.</p>
          <div class="in-game-note">
            <div class="ign-label">ğŸ® Dans le jeu</div>
            La civilisation <strong>Babylon</strong> commence en MÃ©sopotamie. Les Technologies (TOOLS) Pottery et Grain correspondent aux innovations rÃ©elles de la VallÃ©e des Deux Fleuves.
          </div>
        </div>
      </div>

      <!-- Ã‰GYPTE -->
      <div class="accord-item">
        <button class="accord-btn" onclick="toggleAccord(this)">
          <span class="accord-icon">ğ“‚€</span>
          <span class="accord-label">Ã‰gypte Pharaonique</span>
          <span class="accord-civ-tag">6e HIS</span>
          <span class="accord-arrow">â–¼</span>
        </button>
        <div class="accord-body">
          <div class="civ-dates">
            <span class="date-tag">~3100 av. J.-C.</span>
            <span class="date-tag">Ancien Empire â†’ Ã‰poque tardive</span>
          </div>
          <p>UnifiÃ©e par Narmer vers 3100 av. J.-C., l'Ã‰gypte dÃ©veloppe une civilisation centrÃ©e sur le Nil. Le fleuve, en crue annuelle, dÃ©pose un limon fertile qui nourrit l'empire pendant 3000 ans.</p>
          <div class="fact-box">
            <div class="fact-label">ğŸ’¡ Ã€ retenir</div>
            <p>Les <strong>pyramides de Gizeh</strong> (2550â€“2490 av. J.-C.) sont construites sous KhÃ©ops, KhÃ©phren et MykÃ©rinos. La Grande Pyramide reste l'une des 7 merveilles du monde antique encore debout.</p>
          </div>
          <p>L'Ã©criture <em>hiÃ©roglyphique</em> compte plus de 700 signes. Elle sera dÃ©chiffrÃ©e par Champollion en 1822 grÃ¢ce Ã  la Pierre de Rosette.</p>
          <div class="in-game-note">
            <div class="ign-label">ğŸ® Dans le jeu</div>
            <strong>Egypt</strong> dÃ©marre dans la vallÃ©e du Nil. Son accÃ¨s aux ressources agricoles lui donne un avantage pour construire des CitÃ©s dÃ¨s les premiÃ¨res manches.
          </div>
        </div>
      </div>

      <!-- GRÃˆCE -->
      <div class="accord-item">
        <button class="accord-btn" onclick="toggleAccord(this)">
          <span class="accord-icon">ğŸº</span>
          <span class="accord-label">GrÃ¨ce Antique</span>
          <span class="accord-civ-tag">5e HIS</span>
          <span class="accord-arrow">â–¼</span>
        </button>
        <div class="accord-body">
          <div class="civ-dates">
            <span class="date-tag">~800 av. J.-C.</span>
            <span class="date-tag">Ã‰poque archaÃ¯que â†’ hellÃ©nistique</span>
          </div>
          <p>La GrÃ¨ce n'est pas un Ã‰tat uni mais un archipel de <strong>citÃ©s-Ã‰tats</strong> (<em>poleis</em>) : AthÃ¨nes, Sparte, Corinthe, ThÃ¨bes... Chacune avec ses institutions, sa monnaie, ses lois.</p>
          <div class="fact-box">
            <div class="fact-label">ğŸ’¡ Ã€ retenir</div>
            <p>AthÃ¨nes invente la <strong>dÃ©mocratie</strong> sous ClisthÃ¨ne (508 av. J.-C.) : chaque citoyen vote directement Ã  l'AssemblÃ©e. Attention : les esclaves, femmes et Ã©trangers en sont exclus.</p>
          </div>
          <p>Les Grecs colonisent tout le bassin mÃ©diterranÃ©en de la mer Noire Ã  l'Espagne. Ils fondent Marseille (<em>Massalia</em>) vers 600 av. J.-C.</p>
          <div class="in-game-note">
            <div class="ign-label">ğŸ® Dans le jeu</div>
            <strong>Greece</strong> est une civilisation cÃ´tiÃ¨re par excellence. Le TOOL <em>Astronomy</em> lui permet d'envoyer ses navires Ã  plus grande distance â€” exactement comme les vrais Grecs avec leur colonisation maritime.
          </div>
        </div>
      </div>

      <!-- PHÃ‰NICIE / CARTHAGE -->
      <div class="accord-item">
        <button class="accord-btn" onclick="toggleAccord(this)">
          <span class="accord-icon">âš“</span>
          <span class="accord-label">PhÃ©nicie & Carthage</span>
          <span class="accord-civ-tag">5e HIS</span>
          <span class="accord-arrow">â–¼</span>
        </button>
        <div class="accord-body">
          <div class="civ-dates">
            <span class="date-tag">~1200 av. J.-C.</span>
            <span class="date-tag">Liban actuel â†’ Afrique du Nord</span>
          </div>
          <p>Les PhÃ©niciens (Tyr, Sidon, Byblos) sont les navigateurs et marchands du monde antique. Ils inventent l'<strong>alphabet consonantique</strong> â€” le modÃ¨le de tous nos alphabets modernes.</p>
          <div class="fact-box">
            <div class="fact-label">ğŸ’¡ Ã€ retenir</div>
            <p><strong>Carthage</strong>, fondÃ©e en 814 av. J.-C. prÃ¨s de Tunis, devient la rivale de Rome en MÃ©diterranÃ©e. Les <em>Guerres Puniques</em> (264â€“146 av. J.-C.) opposent les deux puissances. Hannibal traverse les Alpes avec ses Ã©lÃ©phants.</p>
          </div>
          <div class="in-game-note">
            <div class="ign-label">ğŸ® Dans le jeu</div>
            <strong>Carthage</strong> commence en Afrique du Nord avec un accÃ¨s immÃ©diat aux routes maritimes. Le TOOL <em>Trade</em> reflÃ¨te l'Ã¢me mÃªme de la civilisation phÃ©nicienne.
          </div>
        </div>
      </div>

      <!-- CRÃˆTE MINOENNE -->
      <div class="accord-item">
        <button class="accord-btn" onclick="toggleAccord(this)">
          <span class="accord-icon">ğŸ‚</span>
          <span class="accord-label">CrÃ¨te Minoenne</span>
          <span class="accord-civ-tag">6e HIS</span>
          <span class="accord-arrow">â–¼</span>
        </button>
        <div class="accord-body">
          <div class="civ-dates">
            <span class="date-tag">~2700 av. J.-C.</span>
            <span class="date-tag">Bronze moyen â†’ fin</span>
          </div>
          <p>PremiÃ¨re grande civilisation europÃ©enne, centrÃ©e sur l'Ã®le de CrÃ¨te. Le palais de <strong>Cnossos</strong> â€” dÃ©couvert par Arthur Evans en 1900 â€” rÃ©vÃ¨le une sociÃ©tÃ© sophistiquÃ©e avec plomberie, fresques et stockage de richesses.</p>
          <div class="fact-box">
            <div class="fact-label">ğŸ’¡ Mythe et rÃ©alitÃ©</div>
            <p>Le mythe du <strong>Minotaure</strong> dans son labyrinthe pourrait reflÃ©ter le souvenir de ces palais complexes aux couloirs enchevÃªtrÃ©s, et du rÃ´le central du taureau dans la religion minoenne.</p>
          </div>
          <p>Leur Ã©criture, le <em>LinÃ©aire A</em>, n'a toujours pas Ã©tÃ© dÃ©chiffrÃ©e. Le <em>LinÃ©aire B</em> (mycÃ©nien) l'a Ã©tÃ© en 1952 par Michael Ventris.</p>
        </div>
      </div>

      <!-- PERSE -->
      <div class="accord-item">
        <button class="accord-btn" onclick="toggleAccord(this)">
          <span class="accord-icon">ğŸ¦</span>
          <span class="accord-label">Empire Perse</span>
          <span class="accord-civ-tag">5e HIS</span>
          <span class="accord-arrow">â–¼</span>
        </button>
        <div class="accord-body">
          <div class="civ-dates">
            <span class="date-tag">~550 av. J.-C.</span>
            <span class="date-tag">Cyrus le Grand â†’ Darius III</span>
          </div>
          <p>Cyrus II fonde le premier Empire achÃ©mÃ©nide en 550 av. J.-C. Ã€ son apogÃ©e sous Darius Ier, l'empire s'Ã©tend de l'Indus Ã  l'Ã‰gypte â€” le plus grand de l'AntiquitÃ©.</p>
          <div class="fact-box">
            <div class="fact-label">ğŸ’¡ Ã€ retenir</div>
            <p>La <strong>Route Royale</strong> (2700 km, de Suse Ã  Sardes) permet de traverser l'empire en 7 jours grÃ¢ce Ã  un systÃ¨me de relais de chevaux. PremiÃ¨re infrastructure de communication de masse.</p>
          </div>
          <p>Les guerres mÃ©diques (490â€“479 av. J.-C.) opposent la Perse Ã  la GrÃ¨ce. Marathon, Salamine, PlatÃ©es : les Grecs rÃ©sistent contre toute attente.</p>
          <div class="in-game-note">
            <div class="ign-label">ğŸ® Dans le jeu</div>
            <strong>Persia</strong> commence Ã  l'Est de la carte mais peut s'Ã©tendre rapidement grÃ¢ce Ã  sa forte population initiale. Le TOOL <em>Law</em> reflÃ¨te la sophistication administrative de l'empire.
          </div>
        </div>
      </div>

      <!-- BILAN PROGRAMME -->
      <div style="padding:12px 14px; background:rgba(0,212,255,0.04); border-top:1px solid rgba(0,212,255,0.15); margin-top:4px;">
        <div style="font-family:'Cinzel',serif; font-size:0.68rem; color:var(--pvs-cyan); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">
          Programme d'histoire
        </div>
        <p style="font-size:0.72rem; color:#8aaccc; line-height:1.6;">
          <strong style="color:#aac;">6e :</strong> PremiÃ¨res civilisations, invention de l'Ã©criture, Ã‰gypte<br>
          <strong style="color:#aac;">5e :</strong> GrÃ¨ce, Persia, Carthage, dÃ©buts de Rome<br>
          <strong style="color:#aac;">CompÃ©tences :</strong> localiser dans le temps et l'espace, lire une carte historique, analyser un document.
        </p>
      </div>

    </aside><!-- /panelLeft -->

    <!-- CENTRE â€” JEU -->
    <main id="gameCenter">

      <div id="gameTopBar">
        <div class="gtb-title">DOS Â· ACIV.EXE Â· 640Ã—480 Â· 256 couleurs</div>
        <div class="session-xp">Session : <span id="sessionXP">0</span> XP gagnÃ©s</div>
        <button class="btn-small" onclick="loadGame()" id="btnLoadGame">â–¶ Lancer le jeu</button>
        <button class="btn-small" onclick="expandGame()">â›¶ Plein Ã©cran</button>
      </div>

      <div id="dosContainer">
        <div id="gameLoading">
          <div style="font-size:2.5rem; margin-bottom:12px; opacity:0.3;">ğŸ›ï¸</div>
          <div class="loading-glyph">
            ADVANCED CIVILIZATION<br>
            AVALON HILL Â· 1995<br>
            DOS Â· PC Â· 486+
          </div>
          <div class="scan-line"></div>
          <p style="font-size:0.72rem; color:#334; margin-top:16px; max-width:300px; line-height:1.6;">
            Clique sur <strong style="color:#00d4ff">â–¶ Lancer le jeu</strong> pour dÃ©marrer.<br>
            Les fichiers de jeu doivent Ãªtre Ã  la racine du site (mÃªme dossier que ce fichier HTML).
          </p>
          <div id="gameSetupNote" style="margin-top:12px; padding:12px; background:rgba(255,215,0,0.04); border:1px solid rgba(255,215,0,0.15); border-radius:4px; font-size:0.7rem; color:#887; max-width:360px; line-height:1.6; text-align:left;">
            <strong style="color:#ffd700;">âš™ Configuration GitHub Pages :</strong><br>
            Placer <code>aciv.jsdos</code> Ã  la racine du site (mÃªme niveau que ce HTML).
            Voir README pour crÃ©er le bundle js-dos.
          </div>
        </div>
        <!-- js-dos s'injecte ici -->
        <div id="jsdosMount" style="width:100%;height:100%;display:none;"></div>
      </div>

      <div id="bottomBar">
        <div class="bb-item">â± Session <span class="bb-val" id="sessionTime">00:00</span></div>
        <div class="bb-sep">|</div>
        <div class="bb-item">ğŸ™ CitÃ©s construites <span class="bb-val" id="statCities">0</span></div>
        <div class="bb-sep">|</div>
        <div class="bb-item">ğŸ“š Technologies <span class="bb-val" id="statTools">0</span></div>
        <div class="bb-sep">|</div>
        <div class="tip-text" id="tipText">ğŸ’¡ Construis des citÃ©s dans les cases rouges/jaunes pour gagner des cartes de commerce.</div>
      </div>

    </main><!-- /gameCenter -->

    <!-- PANNEAU DROIT â€” HISTOIRE DU GAMING -->
    <aside class="side-panel" id="panelRight">

      <div class="panel-header">
        <div class="panel-header-title">ğŸ•¹ï¸ Histoire du Jeu</div>
        <div class="panel-header-sub">De l'Agora au pixel</div>
      </div>

      <div class="timeline">

        <div class="tl-item">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:#8a7060;"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">1954</div>
            <div class="tl-title">Civilization â€” Jeu de plateau</div>
            <div class="tl-desc">Francis Tresham (Hartland Trefoil) crÃ©e le jeu de plateau <em>Civilization</em> en Angleterre. 6 Ã  8 joueurs, une partie dure toute une journÃ©e.</div>
          </div>
        </div>

        <div class="tl-item">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:#6a806a;"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">1980</div>
            <div class="tl-title">Advanced Civilization â€” Avalon Hill</div>
            <div class="tl-desc"><strong>Avalon Hill</strong> publie la version avancÃ©e : 8 civilisations, carte MÃ©diterranÃ©e, systÃ¨me de cartes de commerce, avancÃ©es technologiques. RÃ©putation lÃ©gendaire dans les cercles wargame.</div>
          </div>
        </div>

        <div class="tl-item">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:#7a7aaa;"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">1991</div>
            <div class="tl-title">Sid Meier's Civilization â€” PC</div>
            <div class="tl-desc"><strong>Sid Meier</strong> chez MicroProse crÃ©e le jeu vidÃ©o qui rÃ©volutionne le genre. Il a jouÃ© au jeu d'Avalon Hill et s'en est inspirÃ© explicitement â€” notamment pour le systÃ¨me de technologies et les Merveilles du Monde.</div>
            <div class="tl-highlight">ğŸ’¬ "L'un des jeux qui a le plus influencÃ© ma carriÃ¨re" â€” Sid Meier</div>
          </div>
        </div>

        <div class="tl-item active">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:var(--pvs-gold);"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">1995</div>
            <div class="tl-title">ACIV â€” Version PC DOS</div>
            <div class="tl-desc">Avalon Hill adapte son jeu de plateau mythique sur PC. Graphismes SVGA 640Ã—480 256 couleurs, jusqu'Ã  8 joueurs humains ou IA. DÃ©veloppÃ© pour <strong>486+</strong> sous MS-DOS.</div>
            <div class="tl-highlight">ğŸ“€ C'est ce fichier que tu joues en ce moment !</div>
          </div>
        </div>

        <div class="tl-item">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:#5a8a8a;"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">1998</div>
            <div class="tl-title">Hasbro rachÃ¨te Avalon Hill</div>
            <div class="tl-desc">Avalon Hill, en difficultÃ© financiÃ¨re, est rachetÃ© par <strong>Hasbro</strong>. La plupart de leurs jeux cessent d'Ãªtre commercialisÃ©s. ACIV entre progressivement dans la catÃ©gorie abandonware.</div>
          </div>
        </div>

        <div class="tl-item">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:#6a5a8a;"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">2016 â†’</div>
            <div class="tl-title">Abandonware France â€” PrÃ©servation</div>
            <div class="tl-desc">Des bÃ©nÃ©voles passionnÃ©s de la communautÃ© abandonware.fr numÃ©risent et packagisent ACIV avec DOSBox pour le rendre jouable sur les ordinateurs modernes. Travail de mÃ©moire culturelle.</div>
          </div>
        </div>

        <div class="tl-item">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:#4a8a5a;"></div>
            <div class="tl-line"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">2008â€“2024</div>
            <div class="tl-title">DOSBox â†’ WebAssembly</div>
            <div class="tl-desc"><strong>DOSBox</strong> (open source) est compilÃ© en WebAssembly par js-dos. RÃ©sultat : des jeux DOS de 1995 tournent dans un navigateur de 2026, sans installation.</div>
            <div class="tl-highlight">âš¡ La technologie web peut dÃ©sormais Ã©muler du hardware des annÃ©es 90</div>
          </div>
        </div>

        <div class="tl-item active">
          <div class="tl-dot-col">
            <div class="tl-dot" style="border-color:var(--pvs-cyan); box-shadow:0 0 8px rgba(0,212,255,0.4);"></div>
          </div>
          <div class="tl-content">
            <div class="tl-year">2026</div>
            <div class="tl-title">Toi, maintenant, ici</div>
            <div class="tl-desc">Un jeu de 1995, sur un moteur de 1980, inspirant un genre entier depuis 44 ans, tournant dans ton navigateur. Tu es au bout d'une chaÃ®ne qui va de l'Agora athÃ©nienne Ã  JavaScript.</div>
            <div class="tl-highlight">ğŸ›ï¸ L'histoire du jeu est une histoire de civilisation</div>
          </div>
        </div>

      </div><!-- /timeline -->

      <!-- OBJECTIFS DE SESSION -->
      <div class="objectives">
        <div class="obj-title">Objectifs de session</div>

        <div class="obj-item" id="obj1">
          <span class="obj-icon">ğŸ•</span>
          <div style="flex:1">
            <div>Jouer 5 minutes</div>
          </div>
          <div class="obj-xp">+15 XP</div>
        </div>

        <div class="obj-item" id="obj2">
          <span class="obj-icon">ğŸ•‘</span>
          <div style="flex:1">
            <div>Jouer 20 minutes</div>
          </div>
          <div class="obj-xp">+35 XP</div>
        </div>

        <div class="obj-item" id="obj3">
          <span class="obj-icon">ğŸ™</span>
          <div style="flex:1">
            <div>Construire une citÃ© (saisir le code)</div>
            <div style="margin-top:4px; display:flex; gap:6px;">
              <input type="text" id="cityCode" placeholder="Code citÃ©" style="width:100px; padding:4px 8px; background:#111; border:1px solid #333; color:#fff; font-size:0.7rem; border-radius:3px; font-family:'Share Tech Mono',monospace;">
              <button onclick="validateObjective('CITY')" style="padding:4px 10px; background:rgba(255,215,0,0.15); border:1px solid rgba(255,215,0,0.3); color:var(--pvs-gold); font-size:0.7rem; cursor:pointer; border-radius:3px;">Valider</button>
            </div>
          </div>
          <div class="obj-xp">+25 XP</div>
        </div>

        <div class="obj-item" id="obj4">
          <span class="obj-icon">ğŸ“š</span>
          <div style="flex:1">
            <div>AcquÃ©rir une technologie (saisir le code)</div>
            <div style="margin-top:4px; display:flex; gap:6px;">
              <input type="text" id="techCode" placeholder="Code techno" style="width:100px; padding:4px 8px; background:#111; border:1px solid #333; color:#fff; font-size:0.7rem; border-radius:3px; font-family:'Share Tech Mono',monospace;">
              <button onclick="validateObjective('TECH')" style="padding:4px 10px; background:rgba(255,215,0,0.15); border:1px solid rgba(255,215,0,0.3); color:var(--pvs-gold); font-size:0.7rem; cursor:pointer; border-radius:3px;">Valider</button>
            </div>
          </div>
          <div class="obj-xp">+25 XP</div>
        </div>

      </div><!-- /objectives -->

      <!-- NOTE PÃ‰DAGOGIQUE -->
      <div style="padding:12px 14px; background:rgba(200,165,90,0.04); border-top:1px solid rgba(200,165,90,0.15);">
        <div style="font-family:'Cinzel',serif; font-size:0.68rem; color:var(--parchment); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Note de jeu</div>
        <p style="font-size:0.72rem; color:#8a9b88; line-height:1.6;">
          ACIV n'a aucune part de hasard. Chaque conflit se rÃ©sout en supprimant des unitÃ©s des deux cÃ´tÃ©s en nombre Ã©gal. Le gagnant est celui qui a su construire plus de citÃ©s et acquÃ©rir plus de technologies â€” pas celui qui a eu de la chance.
        </p>
        <p style="font-size:0.72rem; color:#8a9b88; line-height:1.6; margin-top:6px;">
          La demo est limitÃ©e Ã  16 tours. Pas de sauvegarde.
        </p>
      </div>

    </aside><!-- /panelRight -->

  </div><!-- /arena -->

</div><!-- /mainWrapper -->

<!-- NOTIFICATION XP -->
<div id="xpNotif">+<span id="xpNotifVal">0</span> XP !</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JS-DOS CDN â€” chargÃ© dynamiquement
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';
/* â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const XP_THRESHOLD    = 500;   // XP requis pour dÃ©bloquer
const GAME_BUNDLE_URL = 'aciv.jsdos'; // bundle Ã  la racine, mÃªme niveau que ce HTML // chemin du bundle relatif au HTML
const SECRET_CITY     = 'CITAIVOK';        // code secret objectif citÃ©
const SECRET_TECH     = 'TOOLSAC95';       // code secret objectif techno

const TIPS = [
  'ğŸ’¡ Construis des citÃ©s dans les cases rouges/jaunes pour gagner des cartes de commerce.',
  'ğŸ’¡ Les cartes de commerce plus Ã©levÃ©es viennent des civilisations qui ont plus de citÃ©s.',
  'ğŸ’¡ Le but n\'est pas de conquÃ©rir la carte, mais d\'avancer sur l\'AST (piste d\'Ã¢ges).',
  'ğŸ’¡ Sans le TOOL Astronomy, tes navires ne peuvent aller qu\'en eau cÃ´tiÃ¨re.',
  'ğŸ’¡ Chaque conflit = autant de pertes des deux cÃ´tÃ©s. La guerre est coÃ»teuse.',
  'ğŸ’¡ Les TOOLS artistiques et philosophiques valent autant que les TOOLS militaires pour l\'AST.',
  'ğŸ’¡ La population en excÃ¨s est automatiquement supprimÃ©e en fin de tour.',
];

/* â”€â”€â”€ Ã‰TAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const BRIDGE_KEY = 'pvs_bridge_events';
const PLAYER_KEY = 'pvs_current_player';

let cur        = '';
let sessionXP  = 0;
let sessionSec = 0;
let timerInt   = null;
let objectives = { time5: false, time20: false, city: false, tech: false };
let tipIdx     = 0;

/* â”€â”€â”€ UTILITAIRES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nCode(v) {
  return String(v||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .trim().replace(/\s+/g,'').toUpperCase();
}

function getParam(k) {
  return new URLSearchParams(window.location.search).get(k) || '';
}

function pushBridge(payload) {
  try {
    const raw  = localStorage.getItem(BRIDGE_KEY);
    const list = raw ? JSON.parse(raw) : [];
    list.push(payload);
    if (list.length > 700) list.splice(0, list.length - 700);
    localStorage.setItem(BRIDGE_KEY, JSON.stringify(list));
  } catch(e) {}
}

function eventId(prefix) {
  return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
}

/* â”€â”€â”€ CALCUL XP JOUEUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function calcPlayerXP(playerCode) {
  const code = nCode(playerCode);
  if (!code) return 0;

  // â”€â”€ Lecture 1 : state PVS complet (source principale) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const raw = localStorage.getItem('pvs_hof_v2');
    if (raw) {
      const S = JSON.parse(raw);
      const p = S && S.players && S.players[code];
      if (p) {
        // W identique au super-hub
        const W = {pixhare:60,psc1:60,sanctuaire:60,loge:60,autres:60,liberte:60,agora:60};
        const acadXP = Object.keys(W).reduce((a,k)=>a+Math.floor(Number(p.cp&&p.cp[k]||0))*W[k],0);
        // acadDone XP (modules de cours)
        const acadDone = p.acadDone ? Object.keys(p.acadDone).length * 15 : 0;
        const xpTotal = acadXP
          + acadDone
          + Number(p.socialG || 0)
          + Number(p.wBonusG || 0)
          + Number(p.videoG  || 0)
          + Number(p.malusG  || 0); // malusG est nÃ©gatif
        if (xpTotal > 0) return xpTotal;
      }
    }
  } catch(e) {}

  // â”€â”€ Lecture 2 : fallback sur pvs_bridge_events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const raw  = localStorage.getItem(BRIDGE_KEY);
    const evts = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(evts)) return 0;
    return evts
      .filter(e => nCode(e.player) === code)
      .reduce((sum, e) => {
        const r = Number(e.reward || e.offer || e.xp || 0);
        return sum + (isNaN(r) ? 0 : r);
      }, 0);
  } catch(e) { return 0; }
}

/* â”€â”€â”€ INITIALISATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function init() {
  // RÃ©cupÃ©rer le joueur
  const fromUrl = getParam('player');
  if (fromUrl) {
    localStorage.setItem(PLAYER_KEY, nCode(fromUrl));
  }
  cur = nCode(localStorage.getItem(PLAYER_KEY) || '');

  const xp = calcPlayerXP(cur);

  // Mettre Ã  jour la gate
  document.getElementById('gatePlayerName').textContent = cur || '(non connectÃ©)';
  document.getElementById('gateCurrentXP').textContent  = xp;
  document.getElementById('gateThreshold').textContent  = XP_THRESHOLD;
  const pct = Math.min(100, Math.round(xp / XP_THRESHOLD * 100));
  document.getElementById('gateBar').style.width = pct + '%';

  if (xp >= XP_THRESHOLD || cur === '') {
    // DÃ©verrouillÃ© (ou pas de joueur = mode dÃ©mo/admin)
    unlock();
  }
  // sinon gate reste visible
}

function unlock() {
  document.getElementById('xpGate').classList.add('hidden');
  document.getElementById('mainWrapper').classList.add('visible');

  const xp = calcPlayerXP(cur);
  document.getElementById('headerPlayer').textContent = cur || 'Visiteur';
  document.getElementById('headerXP').textContent     = xp;

  startSessionTimer();
  rotateTip();
  setInterval(rotateTip, 18000);

  // Log d'ouverture
  if (cur) {
    pushBridge({
      id: eventId('ACIV_OPEN'), type: 'ACIV_OPEN',
      player: cur, d: new Date().toISOString()
    });
  }
}

/* â”€â”€â”€ TIMER DE SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startSessionTimer() {
  timerInt = setInterval(() => {
    sessionSec++;
    const m = String(Math.floor(sessionSec / 60)).padStart(2, '0');
    const s = String(sessionSec % 60).padStart(2, '0');
    document.getElementById('sessionTime').textContent = `${m}:${s}`;

    // Objectif 5 min
    if (sessionSec === 300 && !objectives.time5) {
      objectives.time5 = true;
      awardXP(15, 'TIME5', 'Jouer 5 minutes');
      markObjective('obj1');
    }
    // Objectif 20 min
    if (sessionSec === 1200 && !objectives.time20) {
      objectives.time20 = true;
      awardXP(35, 'TIME20', 'Jouer 20 minutes');
      markObjective('obj2');
    }
  }, 1000);
}

/* â”€â”€â”€ RÃ‰COMPENSE XP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function awardXP(amount, type, label) {
  sessionXP += amount;
  document.getElementById('sessionXP').textContent = sessionXP;
  document.getElementById('headerXP').textContent  =
    (calcPlayerXP(cur) + sessionXP);

  if (cur) {
    pushBridge({
      id: eventId('ACIV_XP'), type: 'ACIV_XP',
      player: cur, subtype: type, label: label,
      reward: amount, d: new Date().toISOString()
    });
  }

  showXPNotif(amount);
}

function showXPNotif(val) {
  const n = document.getElementById('xpNotif');
  document.getElementById('xpNotifVal').textContent = val;
  n.style.display = 'block';
  setTimeout(() => { n.style.display = 'none'; }, 2500);
}

function markObjective(id) {
  const el = document.getElementById(id);
  if (el) el.classList.add('obj-done');
}

/* â”€â”€â”€ VALIDATION OBJECTIFS MANUELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function validateObjective(type) {
  if (type === 'CITY') {
    const code = nCode(document.getElementById('cityCode').value);
    if (code !== nCode(SECRET_CITY)) {
      alert('Code incorrect. Demande le code secret Ã  ton professeur aprÃ¨s avoir construit une citÃ© dans le jeu.'); return;
    }
    if (objectives.city) { alert('Objectif dÃ©jÃ  validÃ© !'); return; }
    objectives.city = true;
    document.getElementById('statCities').textContent =
      parseInt(document.getElementById('statCities').textContent || '0') + 1;
    awardXP(25, 'CITY_BUILT', 'PremiÃ¨re citÃ© construite');
    markObjective('obj3');
  }
  if (type === 'TECH') {
    const code = nCode(document.getElementById('techCode').value);
    if (code !== nCode(SECRET_TECH)) {
      alert('Code incorrect. Demande le code secret Ã  ton professeur aprÃ¨s avoir acquis une technologie.'); return;
    }
    if (objectives.tech) { alert('Objectif dÃ©jÃ  validÃ© !'); return; }
    objectives.tech = true;
    document.getElementById('statTools').textContent =
      parseInt(document.getElementById('statTools').textContent || '0') + 1;
    awardXP(25, 'TECH_ACQUIRED', 'PremiÃ¨re technologie acquise');
    markObjective('obj4');
  }
}

/* â”€â”€â”€ ACCORDION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleAccord(btn) {
  const body = btn.nextElementSibling;
  const isOpen = btn.classList.contains('open');

  // Fermer tous
  document.querySelectorAll('.accord-btn.open').forEach(b => {
    b.classList.remove('open');
    b.nextElementSibling.classList.remove('open');
  });

  if (!isOpen) {
    btn.classList.add('open');
    body.classList.add('open');
  }
}

/* â”€â”€â”€ TIPS ROTATIFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function rotateTip() {
  document.getElementById('tipText').textContent = TIPS[tipIdx % TIPS.length];
  tipIdx++;
}

/* â”€â”€â”€ PANNEAUX TOGGLE (mobile / focus jeu) â”€â”€â”€â”€â”€â”€â”€â”€ */
let panelsVisible = true;
function togglePanels() {
  panelsVisible = !panelsVisible;
  const l = document.getElementById('panelLeft');
  const r = document.getElementById('panelRight');
  l.style.display = panelsVisible ? '' : 'none';
  r.style.display = panelsVisible ? '' : 'none';
}

/* â”€â”€â”€ PLEIN Ã‰CRAN JEU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function expandGame() {
  const el = document.getElementById('dosContainer');
  if (el.requestFullscreen) el.requestFullscreen();
}

/* â”€â”€â”€ CHARGEMENT JEU (js-dos) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadGame() {
  const btn = document.getElementById('btnLoadGame');
  btn.textContent = 'â³ Chargementâ€¦';
  btn.disabled = true;

  // CDN js-dos â€” cascade de fallbacks
  const JSDOS_URLS = [
    'https://v8.js-dos.com/latest/js-dos.js',
    'https://v8.js-dos.com/8.0.0/js-dos.js',
    'https://cdn.jsdelivr.net/npm/js-dos@8.0.0/dist/js-dos.js',
    'https://unpkg.com/js-dos@8.0.0/dist/js-dos.js',
  ];

  function tryLoad(idx) {
    if (idx >= JSDOS_URLS.length) {
      btn.textContent = 'â–¶ Lancer le jeu';
      btn.disabled = false;
      alert('Impossible de charger le moteur DOSBox.\n\nEssayez :\nâ€¢ DÃ©sactiver votre bloqueur de publicitÃ©s\nâ€¢ VÃ©rifier votre connexion internet\nâ€¢ Recharger la page');
      return;
    }
    const script = document.createElement('script');
    script.src = JSDOS_URLS[idx];
    script.onload = () => initJsDos();
    script.onerror = () => tryLoad(idx + 1);
    document.head.appendChild(script);
  }
  tryLoad(0);
}

function initJsDos() {
  const mount = document.getElementById('jsdosMount');
  const loading = document.getElementById('gameLoading');

  loading.style.display = 'none';
  mount.style.display = 'block';

  try {
    // CrÃ©er le canvas js-dos
    const canvas = document.createElement('canvas');
    canvas.style.width  = '100%';
    canvas.style.height = '100%';
    canvas.style.maxWidth  = '800px';
    canvas.style.maxHeight = '600px';
    canvas.style.display   = 'block';
    canvas.style.margin    = 'auto';
    mount.appendChild(canvas);

    // Initialisation Dos()
    // eslint-disable-next-line no-undef
    Dos(canvas, {
      wdosboxUrl: 'https://v8.js-dos.com/8.0.0/wdosbox.js',
    }).ready((fs, main) => {
      fs.extract(GAME_BUNDLE_URL).then(() => {
        main(['-c', 'C:', '-c', 'ACIV.EXE']);
      }).catch(err => {
        showGameError(`Bundle introuvable (${GAME_BUNDLE_URL}). Placez aciv.jsdos dans le dossier game/.`);
      });
    });

    document.getElementById('btnLoadGame').textContent = 'âœ… Jeu lancÃ©';
  } catch(e) {
    showGameError('Erreur js-dos : ' + e.message);
  }
}

function showGameError(msg) {
  const loading = document.getElementById('gameLoading');
  const mount   = document.getElementById('jsdosMount');
  mount.style.display   = 'none';
  loading.style.display = 'flex';
  loading.innerHTML = `
    <div style="font-size:2rem;margin-bottom:12px;opacity:0.4;">âš ï¸</div>
    <div style="font-size:0.8rem;color:#aa4;text-align:center;max-width:320px;line-height:1.7;">${msg}</div>
    <button onclick="document.getElementById('gameLoading').innerHTML='';loadGame()" 
      style="margin-top:14px;padding:8px 20px;background:rgba(0,212,255,0.1);
             border:1px solid rgba(0,212,255,0.3);color:#00d4ff;cursor:pointer;border-radius:3px;">
      RÃ©essayer
    </button>`;
  document.getElementById('btnLoadGame').textContent = 'â–¶ Lancer le jeu';
  document.getElementById('btnLoadGame').disabled = false;
}

/* â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function goPortal() {
  const suffix = cur ? `?player=${encodeURIComponent(cur)}` : '';
  window.location.href = `index.html${suffix}`;
}

/* â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
