<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ExpÃ©dition Ã  Fontainebleau â€” L'Ordre des Ã‰cuyers</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
<style>
:root {
  --or:#c9a84c; --or-clair:#e8c97a; --or-sombre:#8a6a1f;
  --encre:#e8dfc8; --encre-2:#c8bfa8;
  --parchemin:#120e0a; --parchemin-2:#1e1710; --parchemin-3:#2a2218;
  --rouge:#7a2020; --bleu-royal:#0e1a30; --vert-foret:#0e1e0e;
  --radius:8px;
  /* Couleurs modules */
  --c1:#5a3a1a; --c2:#1a2a5a; --c3:#4a1a2a; --c4:#1a3a1a; --c5:#2a1a4a;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--parchemin);color:var(--encre);font-family:'Crimson Text',Georgia,serif;font-size:1.05em;line-height:1.75;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 70% 50% at 15% 25%,rgba(90,58,26,0.08) 0%,transparent 60%),
    radial-gradient(ellipse 50% 70% at 85% 75%,rgba(26,42,90,0.07) 0%,transparent 60%);}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--parchemin)}
::-webkit-scrollbar-thumb{background:rgba(201,168,76,0.3);border-radius:3px}

/* â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â• */


.auth-card{width:min(460px,92vw);background:var(--parchemin-2);border:1px solid rgba(201,168,76,0.35);border-radius:12px;padding:36px;text-align:center;box-shadow:0 0 60px rgba(0,0,0,0.6),0 0 20px rgba(201,168,76,0.1);animation:card-in 0.6s ease;}
@keyframes card-in{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.auth-portal-img{font-size:3em;margin-bottom:12px;filter:drop-shadow(0 0 16px rgba(201,168,76,0.5))}
.auth-title{font-family:'Cinzel',serif;font-size:1.3em;color:var(--or-clair);margin-bottom:4px;letter-spacing:2px}
.auth-sub{font-style:italic;color:var(--encre-2);font-size:0.88em;margin-bottom:20px;opacity:0.75;line-height:1.5}
.auth-input{width:100%;padding:11px 15px;background:rgba(255,255,255,0.04);border:1px solid rgba(201,168,76,0.3);border-radius:6px;color:var(--encre);font-family:'Crimson Text',serif;font-size:1em;text-align:center;letter-spacing:2px;text-transform:uppercase;outline:none;transition:border-color 0.2s;margin-bottom:14px;}
.auth-input:focus{border-color:var(--or);box-shadow:0 0 16px rgba(201,168,76,0.25)}
.btn-primary{width:100%;padding:11px;background:linear-gradient(135deg,rgba(201,168,76,0.25),rgba(201,168,76,0.1));border:1px solid var(--or);border-radius:6px;color:var(--or-clair);font-family:'Cinzel',serif;font-size:0.82em;letter-spacing:2px;cursor:pointer;transition:all 0.2s;}
.btn-primary:hover{background:rgba(201,168,76,0.35)}
.auth-msg{margin-top:10px;font-size:0.82em;min-height:1.4em;color:#e88}
.back-link{display:inline-block;margin-top:16px;color:var(--encre-2);font-size:0.8em;opacity:0.6;cursor:pointer;text-decoration:none;transition:opacity 0.2s;}
.back-link:hover{opacity:1;color:var(--or)}

/* â•â•â•â•â•â•â•â•â•â• PORTAIL INTRO â•â•â•â•â•â•â•â•â•â• */
#hubMain{display:none}
#hubMain.visible{display:block}
.portal-header{position:relative;z-index:1;padding:40px 24px 0;max-width:1100px;margin:0 auto}
.portal-tag{font-family:'Cinzel',serif;font-size:0.63em;letter-spacing:5px;color:var(--or);opacity:0.7;text-transform:uppercase;margin-bottom:10px}
.portal-title{font-family:'Cinzel',serif;font-size:clamp(1.8em,5vw,2.6em);font-weight:700;color:var(--or-clair);text-shadow:0 0 40px rgba(201,168,76,0.3);line-height:1.2;margin-bottom:6px}
.portal-sub{font-style:italic;color:var(--encre-2);opacity:0.7;margin-bottom:20px}
.player-bar{display:flex;align-items:center;gap:14px;flex-wrap:wrap;padding:10px 14px;background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:6px;margin-bottom:28px;font-size:0.82em;}
.pb-item{color:var(--encre-2)}.pb-val{color:var(--or-clair);font-weight:600;margin-left:4px}
.pb-sep{color:rgba(201,168,76,0.3)}
.btn-sm{padding:5px 14px;background:transparent;border:1px solid rgba(201,168,76,0.25);border-radius:4px;color:var(--encre-2);font-size:0.82em;cursor:pointer;transition:all 0.2s;margin-left:auto}
.btn-sm:hover{border-color:var(--or);color:var(--or)}

/* â•â•â•â•â•â•â•â•â•â• INTRO NARRATIVE â•â•â•â•â•â•â•â•â•â• */
.narrative-intro{max-width:740px;margin:0 auto 40px;padding:0 24px;position:relative;z-index:1;}
.ni-card{background:linear-gradient(135deg,rgba(90,58,26,0.15),rgba(26,42,90,0.1));border:1px solid rgba(201,168,76,0.25);border-radius:var(--radius);padding:24px 28px;position:relative;overflow:hidden;}
.ni-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(201,168,76,0.6),transparent)}
.ni-rune{font-size:0.65em;letter-spacing:4px;color:var(--or);font-family:'Cinzel',serif;opacity:0.7;margin-bottom:12px;text-transform:uppercase}
.ni-text{font-style:italic;font-size:0.95em;line-height:1.85;color:var(--encre-2)}
.ni-text p{margin-bottom:1em}
.ni-text em{color:var(--encre);font-style:normal;font-weight:600}
.ni-voice{margin-top:12px;padding:10px 14px;background:rgba(201,168,76,0.06);border-left:2px solid rgba(201,168,76,0.3);font-size:0.87em;line-height:1.7}

/* â•â•â•â•â•â•â•â•â•â• GRILLE MODULES â•â•â•â•â•â•â•â•â•â• */
.modules-section{max-width:1100px;margin:0 auto;padding:0 24px 60px;position:relative;z-index:1}
.section-label{font-family:'Cinzel',serif;font-size:0.7em;letter-spacing:4px;color:var(--or);text-transform:uppercase;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid rgba(201,168,76,0.2);display:flex;align-items:center;gap:10px}
.section-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(201,168,76,0.2),transparent)}
.modules-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px}
.module-card{background:var(--parchemin-2);border:1px solid rgba(201,168,76,0.18);border-radius:var(--radius);padding:20px;cursor:pointer;transition:transform 0.2s,border-color 0.2s,box-shadow 0.2s;position:relative;overflow:hidden;}
.module-card:hover{transform:translateY(-3px);border-color:rgba(201,168,76,0.45);box-shadow:0 8px 30px rgba(0,0,0,0.4),0 0 12px rgba(201,168,76,0.12)}
.module-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--mc-accent,#c9a84c),transparent)}
.module-card.done::after{content:'âœ“';position:absolute;top:12px;right:14px;color:var(--or);opacity:0.7;font-size:0.8em}
.mc-icon{font-size:1.9em;margin-bottom:10px;display:block}
.mc-num{font-family:'Cinzel',serif;font-size:0.6em;letter-spacing:3px;color:var(--or);opacity:0.6;margin-bottom:4px;text-transform:uppercase}
.mc-title{font-family:'Cinzel',serif;font-size:0.92em;font-weight:600;color:var(--or-clair);line-height:1.3;margin-bottom:6px}
.mc-lyam{font-style:italic;font-size:0.8em;color:var(--encre-2);border-left:2px solid rgba(201,168,76,0.2);padding-left:8px;margin-bottom:10px;line-height:1.6}
.mc-footer{display:flex;align-items:center;justify-content:space-between;font-size:0.72em}
.mc-tag{color:var(--or);opacity:0.7}
.mc-cta{color:var(--encre-2);opacity:0.6}
.mc-ldvelh{display:inline-block;padding:2px 8px;background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.3);border-radius:3px;font-size:0.9em;color:var(--or-clair)}

/* â•â•â•â•â•â•â•â•â•â• MODALE MODULE â•â•â•â•â•â•â•â•â•â• */
#moduleModal{position:fixed;inset:0;z-index:9500;background:rgba(10,8,5,0.97);display:none;overflow-y:auto;}
#moduleModal.open{display:block}
.mm-wrap{max-width:760px;margin:0 auto;padding:28px 24px 60px}
.mm-nav{display:flex;align-items:center;gap:12px;margin-bottom:24px;flex-wrap:wrap}
.btn-back{padding:7px 16px;background:transparent;border:1px solid rgba(201,168,76,0.3);border-radius:4px;color:var(--encre-2);cursor:pointer;font-size:0.8em;transition:all 0.2s;}
.btn-back:hover{border-color:var(--or);color:var(--or)}
.mm-chapter{font-family:'Cinzel',serif;font-size:0.72em;letter-spacing:2px;color:var(--or);opacity:0.8}
.mm-content{animation:fade-in 0.4s ease}
@keyframes fade-in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

/* â”€â”€ Section "Regard de Lyam" â”€â”€ */
.lyam-block{background:linear-gradient(135deg,rgba(90,58,26,0.2),rgba(26,42,90,0.15));border:1px solid rgba(201,168,76,0.25);border-radius:var(--radius);padding:20px 22px;margin-bottom:28px;position:relative;}
.lyam-block::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(201,168,76,0.5),transparent)}
.lb-tag{font-family:'Cinzel',serif;font-size:0.62em;letter-spacing:3px;color:var(--or);opacity:0.75;margin-bottom:10px;text-transform:uppercase}
.lb-text{font-style:italic;font-size:0.92em;line-height:1.85;color:var(--encre-2)}
.lb-text p{margin-bottom:0.9em}

/* â”€â”€ Section "Ce que c'est vraiment" â”€â”€ */
.reality-block{margin-bottom:28px}
.rb-tag{font-family:'Cinzel',serif;font-size:0.62em;letter-spacing:3px;color:#7ab;opacity:0.75;margin-bottom:14px;text-transform:uppercase;border-bottom:1px solid rgba(120,160,180,0.2);padding-bottom:6px}
.rb-text{font-size:0.95em;line-height:1.85}
.rb-text p{margin-bottom:1.1em;text-align:justify}
.rb-text strong{color:var(--or-clair)}
.rb-text em{color:var(--encre-2);font-style:italic}
.rb-text h3{font-family:'Cinzel',serif;font-size:0.85em;color:var(--or);margin:20px 0 10px;letter-spacing:1px}
.fact-box{background:rgba(201,168,76,0.05);border:1px solid rgba(201,168,76,0.15);border-radius:6px;padding:14px 16px;margin:16px 0;font-size:0.85em;color:var(--encre-2)}
.fact-box strong{color:var(--or-clair);display:block;margin-bottom:4px}

/* â”€â”€ Quiz â”€â”€ */
.quiz-block{margin-top:32px}
.quiz-tag{font-family:'Cinzel',serif;font-size:0.62em;letter-spacing:3px;color:#a7c;opacity:0.75;margin-bottom:16px;text-transform:uppercase;border-bottom:1px solid rgba(160,120,200,0.2);padding-bottom:6px}
.quiz-q{margin-bottom:20px}
.qq-text{font-size:0.92em;margin-bottom:10px;font-weight:600;color:var(--encre)}
.qq-choices{display:flex;flex-direction:column;gap:7px}
.qq-btn{padding:10px 14px;text-align:left;background:rgba(255,255,255,0.03);border:1px solid rgba(201,168,76,0.2);border-radius:5px;color:var(--encre-2);font-family:'Crimson Text',serif;font-size:0.9em;cursor:pointer;transition:all 0.15s;}
.qq-btn:hover:not(.answered){background:rgba(201,168,76,0.1);border-color:rgba(201,168,76,0.4);color:var(--encre)}
.qq-btn.correct{background:rgba(26,58,26,0.5);border-color:rgba(100,180,100,0.5);color:#b8e8b8}
.qq-btn.wrong{background:rgba(58,26,26,0.5);border-color:rgba(180,80,80,0.4);color:#e8b8b8}
.qq-feedback{margin-top:8px;font-size:0.82em;font-style:italic;min-height:1.2em;color:var(--encre-2)}
.quiz-result{margin-top:20px;padding:16px;border-radius:6px;text-align:center;display:none}
.quiz-result.visible{display:block}
.quiz-result.ok{background:rgba(26,58,26,0.4);border:1px solid rgba(100,180,100,0.35)}
.quiz-result.ok .qr-title{color:#8fe888}
.quiz-result.nok{background:rgba(58,26,26,0.4);border:1px solid rgba(180,80,80,0.35)}
.quiz-result.nok .qr-title{color:#e88888}
.qr-title{font-family:'Cinzel',serif;font-size:0.9em;letter-spacing:1px;margin-bottom:6px}
.qr-xp{font-size:1.1em;font-weight:600;margin:6px 0}
.qr-text{font-size:0.82em;color:var(--encre-2);font-style:italic}
.btn-retry-quiz{margin-top:10px;padding:8px 20px;background:rgba(201,168,76,0.1);border:1px solid var(--or);border-radius:4px;color:var(--or-clair);cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;letter-spacing:1px;transition:all 0.2s}
.btn-retry-quiz:hover{background:rgba(201,168,76,0.25)}

/* â•â•â•â•â•â•â•â•â•â• LDVELH INTÃ‰GRÃ‰ â•â•â•â•â•â•â•â•â•â• */
.ldvelh-section{margin-top:32px;border-top:1px solid rgba(201,168,76,0.15);padding-top:28px}
.ldvelh-tag{font-family:'Cinzel',serif;font-size:0.62em;letter-spacing:3px;color:#ca7;opacity:0.75;margin-bottom:16px;text-transform:uppercase}
.ldv-progress{display:flex;gap:4px;margin-bottom:24px}
.ldv-step{height:3px;flex:1;border-radius:2px;background:rgba(201,168,76,0.15);transition:background 0.3s}
.ldv-step.done{background:rgba(201,168,76,0.7)}.ldv-step.current{background:var(--or)}
.passage{display:none;animation:fade-in 0.4s ease}.passage.active{display:block}
.p-num{font-family:'Cinzel',serif;font-size:0.62em;letter-spacing:3px;color:var(--or);opacity:0.5;margin-bottom:16px}
.p-mood{text-align:center;font-size:2.8em;margin:16px 0;filter:drop-shadow(0 0 12px rgba(201,168,76,0.4))}
.p-text{font-size:1.05em;line-height:1.9;margin-bottom:24px}
.p-text p{margin-bottom:1.1em;text-align:justify}
.p-text em{color:var(--encre-2);font-style:italic}
.choices{display:flex;flex-direction:column;gap:9px}
.choice-btn{width:100%;padding:13px 16px;text-align:left;background:rgba(201,168,76,0.05);border:1px solid rgba(201,168,76,0.22);border-radius:6px;color:var(--encre);font-family:'Crimson Text',serif;font-size:0.97em;line-height:1.5;cursor:pointer;transition:all 0.2s}
.choice-btn::before{content:'â–¸ ';color:var(--or);opacity:0.6}
.choice-btn:hover{background:rgba(201,168,76,0.12);border-color:rgba(201,168,76,0.45);color:var(--or-clair);transform:translateX(4px)}
.ldv-result{margin-top:20px;padding:20px;border-radius:8px;text-align:center}
.ldv-result.success{background:linear-gradient(135deg,rgba(26,58,26,0.6),rgba(42,74,26,0.4));border:1px solid rgba(100,180,100,0.4)}
.ldv-result.fail{background:linear-gradient(135deg,rgba(58,26,26,0.6),rgba(74,42,26,0.4));border:1px solid rgba(180,80,80,0.4)}
.lr-icon{font-size:2.2em;display:block;margin-bottom:10px}
.lr-title{font-family:'Cinzel',serif;font-size:0.95em;margin-bottom:6px}
.ldv-result.success .lr-title{color:#8fe888}.ldv-result.fail .lr-title{color:#e88888}
.lr-xp{font-size:1.15em;font-weight:600;margin:8px 0}
.ldv-result.success .lr-xp{color:#b8e8b8}.ldv-result.fail .lr-xp{color:#e8b8b8}
.lr-text{font-size:0.84em;color:var(--encre-2);font-style:italic;margin-bottom:12px}
.btn-close-mod{padding:9px 22px;background:transparent;border:1px solid rgba(255,255,255,0.15);border-radius:4px;color:var(--encre-2);cursor:pointer;font-size:0.82em;margin-right:8px;transition:all 0.2s}
.btn-close-mod:hover{border-color:rgba(255,255,255,0.4)}
.btn-retry-ldv{padding:9px 22px;background:rgba(201,168,76,0.1);border:1px solid var(--or);border-radius:4px;color:var(--or-clair);cursor:pointer;font-family:'Cinzel',serif;font-size:0.75em;letter-spacing:1px;transition:all 0.2s}
.btn-retry-ldv:hover{background:rgba(201,168,76,0.25)}

/* â•â•â•â•â•â•â•â•â•â• NOTIF XP â•â•â•â•â•â•â•â•â•â• */
.xp-notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;padding:11px 26px;border-radius:8px;font-weight:600;font-size:0.92em;text-align:center;pointer-events:none;animation:ni-in 0.4s ease, ni-out 0.5s ease 4s forwards}
.xp-notif.ok{background:linear-gradient(135deg,#1a3a1a,#2a4a1a);border:1px solid rgba(100,200,100,0.5);color:#b8e8b8;box-shadow:0 0 20px rgba(100,200,100,0.3)}
.xp-notif.fail{background:linear-gradient(135deg,#3a1a1a,#4a1a1a);border:1px solid rgba(200,80,80,0.5);color:#e8b8b8}
@keyframes ni-in{from{opacity:0;top:0}to{opacity:1;top:20px}}
@keyframes ni-out{from{opacity:1}to{opacity:0}}

@media(max-width:600px){.portal-header,.modules-section,.narrative-intro{padding-left:14px;padding-right:14px}.mm-wrap{padding:20px 14px 40px}.modules-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

    <h1 class="auth-title">ChÃ¢teau de Fontainebleau</h1>
    <p class="auth-sub">ExpÃ©dition au-delÃ  du portail de la BibliothÃ¨que de Valdurne.<br><em>Il te faut 400 XP pour traverser.</em></p>
    <button class="btn-primary" onclick="tryLogin()">Franchir le Portail â–¸</button>
    <div class="auth-msg" id="authMsg"></div>
    <a class="back-link" href="hub_narration.html">â† Retourner Ã  la BibliothÃ¨que de Valdurne</a>
  </div>
</div>

<!-- HUB PRINCIPAL -->
<div id="hubMain" style="display:none">
  <div class="portal-header">
    <div class="portal-tag">ExpÃ©dition au-delÃ  du Portail Â· BibliothÃ¨que de Valdurne</div>
    <h1 class="portal-title">ChÃ¢teau de Fontainebleau</h1>
    <p class="portal-sub">Huit siÃ¨cles d'histoire â€” vus Ã  travers les yeux d'un Ã©cuyer de Valdurne.</p>
    <div class="player-bar">
      <span class="pb-item">Ã‰cuyer : <span class="pb-val" id="playerName">â€”</span></span>
      <span class="pb-sep">Â·</span>
      <span class="pb-item">XP : <span class="pb-val" id="playerXP">0</span></span>
      <span class="pb-sep">Â·</span>
      <span class="pb-item">Modules : <span class="pb-val" id="moduleDone">0</span> / 5</span>
      <button class="btn-sm" onclick="logout()">Quitter</button>
    </div>
  </div>

  <!-- Intro narrative -->
  <div class="narrative-intro">
    <div class="ni-card">
      <div class="ni-rune">ğŸ“– Journal de Lyam â€” ExpÃ©dition I</div>
      <div class="ni-text">
        <p>C'est RÃ©na qui a trouvÃ© le grimoire. Il Ã©tait glissÃ© derriÃ¨re le rayon des cartes militaires, dans la partie de la BibliothÃ¨que oÃ¹ les moisissures avaient presque effacÃ© les titres. La couverture ne portait aucun symbole familier. Les lettres Ã  l'intÃ©rieur ressemblaient Ã  notre Ã©criture, mais formaient des mots que ni lui ni moi ne comprenions.</p>
        <p>MaÃ®tre Aldric nous a regardÃ©s l'un aprÃ¨s l'autre. <em>Â« Ce sont des traces d'un autre monde. Un monde qui existe en mÃªme temps que le nÃ´tre, mais que nous ne pouvons pas toucher â€” sauf par certains passages. Â»</em></p>
        <p>Il a posÃ© le doigt sur une enluminure reprÃ©sentant un chÃ¢teau aux toits en ardoise et aux fenÃªtres claires comme de l'eau gelÃ©e. <em>Â« Ils l'appellent Fontainebleau. Trente-quatre rois et deux empereurs y ont rÃ©gnÃ©. Dans leur monde, c'est du passÃ©. Dans le nÃ´tre, c'est une lÃ©gende. Â»</em></p>
        <p>Le portail s'est ouvert le lendemain matin. Nous avons traversÃ©.</p>
      </div>
      <div class="ni-voice">
        <em>Ce que Lyam ne savait pas :</em> le chÃ¢teau Ã©tait plein de visiteurs modernes. Et l'un d'eux levait un petit rectangle plat et brillant en direction des fresques. L'objet a Ã©mis un dÃ©clic. Lyam a reculÃ© d'un pas. Il croyait avoir assistÃ© Ã  une capture d'Ã¢me.
      </div>
    </div>
  </div>

  <!-- Modules -->
  <div class="modules-section">
    <div class="section-label">ğŸ° Les Cinq Salles de l'ExpÃ©dition</div>
    <div class="modules-grid" id="modulesGrid"></div>
  </div>
</div>

<!-- MODALE MODULE -->
<div id="moduleModal">
  <div class="mm-wrap">
    <div class="mm-nav">
      <button class="btn-back" onclick="closeModule()">â† Retour au chÃ¢teau</button>
      <span class="mm-chapter" id="modalTitle"></span>
    </div>
    <div class="mm-content" id="modalContent"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” identique au superhub
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KEY = 'pvs_hof_v2';
const ACTIVE_PLAYER_KEY = 'pvs_current_player';
const XP_PENDING_KEY = 'pvs_narration_xp';
const DONE_KEY = 'pvs_font_done';
const XP_MIN = 400;
const XP_BON = 50;
const XP_MAL = -25;
const W = {pixhare:60,psc1:60,sanctuaire:60,loge:60,autres:60};
const CIT = {representant_ca:{xp:500}};

function getS(){try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch{return{}}}
function saveS(S){try{localStorage.setItem(KEY,JSON.stringify(S))}catch(e){}}
function getPlayer(c){const S=getS();return S.players&&S.players[c]?S.players[c]:null}
function nCode(v){return String(v||'').trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'')}
function missionXp(code){const S=getS();const lists=S.citizen_lists||{};let n=0;Object.keys(CIT).forEach(k=>{if((lists[k]||[]).includes(code))n+=CIT[k].xp});return n}
function socialRawG(p){return Number(p.socialG||0)+Number(p.wBonusG||0)}
function socialValidG(p){return Number(p.witnessGiven||0)>0?socialRawG(p):0}
function citizenXp(p){return missionXp(p.code)+socialValidG(p)}
function academyXp(p){const cp=p.cp||{};return Object.keys(W).reduce((a,k)=>a+Number(cp[k]||0)*W[k],0)}
function videoXp(p){return Number(p.videoG||0)}
function acadCoeff(p){const n=Math.min(Number(p.acadDone||0),50);return Math.round((1+n*0.02)*100)/100}
function xpTotal(p){if(!p)return 0;const base=citizenXp(p)+academyXp(p)+videoXp(p)+Number(p.malusG||0);return Math.round(base*acadCoeff(p))}

function getDone(){try{return JSON.parse(localStorage.getItem(DONE_KEY)||'{}')}catch{return{}}}
function markDone(id){const d=getDone();d[id]=Date.now();localStorage.setItem(DONE_KEY,JSON.stringify(d))}
function isDone(id){return !!getDone()[id]}

function creditXP(code,amount,reason){
  if(!code)return;
  const S=getS();if(!S.players||!S.players[code])return;
  const p=S.players[code];const now=new Date().toISOString();
  if(!Array.isArray(S.logs))S.logs=[];
  S.logs.unshift({d:now,p:code,t:reason,target:'FONTAINEBLEAU',xp:Number(amount)});
  if(S.logs.length>700)S.logs.length=700;
  if(amount>0){p.wBonusG=(Number(p.wBonusG||0)+(amount/10));p.wBonusW=(Number(p.wBonusW||0)+(amount/10))}
  else{p.malusG=(Number(p.malusG||0)+amount);p.malusW=(Number(p.malusW||0)+amount)}
  p.up=now;saveS(S);
  const pending=JSON.parse(localStorage.getItem(XP_PENDING_KEY)||'[]');
  pending.push({code,amount,reason,d:now});
  localStorage.setItem(XP_PENDING_KEY,JSON.stringify(pending));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cur='';
function openHub(code,p){
  cur=code;
  
  document.getElementById('hubMain').classList.add('visible');
  renderHub(p);
}
function logout(){ window.location.href='index.html'; }

(function(){
  var raw = localStorage.getItem('pvs_current_player') || '';
  if(!raw){ window.location.href='index.html'; return; }
  cur = raw.trim().toUpperCase();
  var p = getPlayer(cur);
  if(!p){ window.location.href='index.html'; return; }
  document.getElementById('hubMain').style.display='block';
  renderHub(p);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENU DES MODULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODULES = [
  {
    id:'m1', icon:'ğŸ—¼', num:'Salle I', accent:'#c9a84c',
    title:'Le Donjon Familier',
    lyam_preview:'Il reconnaÃ®t quelque chose dans ces murs. Mais certains dÃ©tails l\'arrÃªtent â€” une petite plaque de mÃ©tal avec des chiffres. Un fil rouge en velours qui interdit l\'accÃ¨s.',
    tag:'Origines mÃ©diÃ©vales Â· 1137â€”1527',
    lyam:[
      `Le chÃ¢teau ressemble Ã  Valdurne. Pas identique â€” les pierres sont d'une couleur plus claire, le mortier plus rÃ©gulier â€” mais Lyam reconnaÃ®t la logique du donjon massif, les cours imbriquÃ©es, les meurtriÃ¨res tournÃ©es vers la forÃªt.`,
      `Il s'arrÃªte devant une petite plaque de mÃ©tal fixÃ©e sur la pierre. Elle porte des chiffres gravÃ©s : <em>1268</em>. Rien d'autre. Dans son monde, on aurait sculptÃ© une Ã©pÃ©e, un blason, un saint. Ici, juste des chiffres â€” comme si la date seule suffisait Ã  tout expliquer.`,
      `Et ce fil rouge en velours tendu entre deux poteaux dorÃ©s : il comprend que c'est une frontiÃ¨re. On ne passe pas. Mais il n'y a personne pour la garder. Dans son monde, une frontiÃ¨re sans garde, c'est une invitation.`,
      `Il n'a pas franchi le fil. Mais il y a pensÃ© trÃ¨s fort.`,
    ],
    reality_title:'Fontainebleau mÃ©diÃ©val â€” La maison des siÃ¨cles',
    reality:[
      {type:'text',content:`Le chÃ¢teau de Fontainebleau est l'un des rares monuments d'Europe Ã  avoir servi de rÃ©sidence royale de maniÃ¨re quasi ininterrompue pendant **huit siÃ¨cles**. Sa premiÃ¨re mention remonte Ã  1137, sous Louis VII, mais l'Ã©difice Ã©tait probablement antÃ©rieur â€” un donjon de chasse au cÅ“ur d'une forÃªt giboyeuse.`},
      {type:'fact',title:'1268 â€” La naissance du roi de fer',content:`Philippe le Bel naÃ®t au chÃ¢teau cette annÃ©e-lÃ . Il mourra dans ce mÃªme donjon en 1314, des suites d'une chute de cheval. Ce roi qui Â« figerait Â» l'or sur son passage aura vÃ©cu et terminÃ© sa vie entre ces murs.`},
      {type:'text',content:`Saint Louis y installe des moines trinitaires en 1259 â€” une communautÃ© chargÃ©e de racheter les croisÃ©s capturÃ©s. La chapelle de la TrinitÃ© que l'on voit aujourd'hui est l'hÃ©ritiÃ¨re directe de ce couvent. Les CapÃ©tiens considÃ©raient Fontainebleau comme un refuge, loin du tumulte de Paris â€” ce que Saint Louis appelait <em>ses dÃ©serts</em>.`},
      {type:'fact',title:'1527 â€” La prestigieuse ruine',content:`Ã€ cette date, le chÃ¢teau est dans un Ã©tat de dÃ©labrement avancÃ©. FranÃ§ois Ier, de retour de captivitÃ© en Espagne, dÃ©cide alors de tout reconstruire. Ce qui semblait une fin deviendra le dÃ©but de la plus grande transformation du palais.`},
      {type:'text',content:`Ce premier chÃ¢teau mÃ©diÃ©val survit partiellement aujourd'hui dans la **Cour Ovale**, le cÅ“ur originel du domaine. Autour de ce noyau, huit siÃ¨cles de rois et d'empereurs ont empilÃ© leurs ambitions architecturales â€” chacun ajoutant une couche sans dÃ©truire celle d'en dessous.`},
    ],
    quiz:[
      {q:'En quelle annÃ©e est nÃ©e la premiÃ¨re mention Ã©crite du chÃ¢teau ?',choices:['1068','1137','1259','1314'],correct:1,feedback:'1137 â€” sous Louis VII, premier roi Ã  mentionner le chÃ¢teau dans des textes officiels.'},
      {q:'Comment Saint Louis appelait-il Fontainebleau ?',choices:['Son trÃ©sor','Ses dÃ©serts','La vraie demeure','Le refuge royal'],correct:1,feedback:'"Ses dÃ©serts" â€” un lieu de retrait et de silence, loin de l\'agitation parisienne.'},
      {q:'Que reprÃ©sente la plaque "1268" que voit Lyam sur le mur ?',choices:['L\'annÃ©e de construction du donjon','L\'annÃ©e de naissance de Philippe le Bel','Le numÃ©ro de la salle','L\'annÃ©e d\'un traitÃ©'],correct:1,feedback:'1268 â€” annÃ©e de naissance de Philippe le Bel, "le roi de fer", dans ce chÃ¢teau.'},
    ]
  },
  {
    id:'m2', icon:'ğŸ¨', num:'Salle II', accent:'#4a7aaa',
    title:'La Galerie des SortilÃ¨ges',
    lyam_preview:'Des murs entiers couverts de corps humains en or et en couleurs. Ni dieux, ni saints â€” des crÃ©atures nues Ã  la peau de nacre. Lyam pense Ã  des enchantements d\'illusionniste figÃ©s dans la pierre.',
    tag:'Renaissance Â· Ã‰cole de Fontainebleau Â· 1527â€”1610',
    lyam:[
      `La galerie n'a pas de fin visible. Lyam entre et reste clouÃ© sur place.`,
      `Les murs ne sont pas des murs. Ce sont des rÃªves durcis. Des corps humains â€” il n'y a pas d'autre mot â€” grandeur nature, certains en relief comme s'ils voulaient sortir de la pierre, d'autres peints avec une prÃ©cision qui lui donne le vertige. Ni dieux, ni saints. Des crÃ©atures Ã  la peau de nacre, dans des positions qu'aucun enlumineur de Valdurne n'aurait osÃ©.`,
      `Il touche un cadre de plÃ¢tre peint. Du relief. Des feuilles, des anneaux, des visages souriant. <em>Comment ?</em> Il ne connaÃ®t pas la technique. Dans son monde, les murs restent des murs.`,
      `Un panneau sur pied explique quelque chose dans la langue de ce monde. Il ne lit pas cette langue. Mais les chiffres â€” 1533, 1540 â€” il les comprend. Sept ans de travail pour un seul couloir. Il murmure Ã  RÃ©na : <em>Â« Ces gens devaient vraiment vouloir que leur roi soit content. Â»</em>`,
    ],
    reality_title:'La Galerie FranÃ§ois Ier â€” naissance de la Renaissance franÃ§aise',
    reality:[
      {type:'text',content:`Quand FranÃ§ois Ier dÃ©cide de transformer Fontainebleau en palais digne de ses ambitions, il fait appel Ã  des artistes italiens. En 1530, **Rosso Fiorentino** arrive. En 1532, c'est **Le Primatice** qui le rejoint. Ensemble, ils inventent quelque chose d'inÃ©dit en Europe du Nord.`},
      {type:'fact',title:'Le stuc et la fresque â€” une rÃ©volution technique',content:`La Galerie FranÃ§ois Ier (1533-1540) combine deux techniques : la fresque peinte directement sur l'enduit humide du mur, et le stuc â€” un mÃ©lange de plÃ¢tre, de marbre broyÃ© et de colle â€” modelÃ© en haut-relief. Les cadres de stuc dÃ©bordent sur les peintures, effaÃ§ant la frontiÃ¨re entre sculpture et image. C'Ã©tait inconnu en France.`},
      {type:'text',content:`Les thÃ¨mes sont dÃ©libÃ©rÃ©ment cryptiques et mythologiques â€” **l'Ã‰lÃ©phant au caparaÃ§on**, **le Sacrifice**, **la DanaÃ©**. Chaque tableau est une allÃ©gorie de la gloire royale, mais suffisamment codÃ©e pour que seuls les lettrÃ©s de la cour puissent la lire. Le reste admirait les formes et les couleurs sans forcÃ©ment comprendre le message.`},
      {type:'fact',title:'L\'Ã‰cole de Fontainebleau â€” une influence continentale',content:`Ce style maniÃ©riste â€” Ã©lÃ©gance des formes allongÃ©es, complexitÃ© des poses, richesse ornementale â€” va se rÃ©pandre dans toute l'Europe via des estampes gravÃ©es et copiÃ©es. La cour d'Angleterre (Hampton Court), les princes allemands (Munich) et mÃªme les peintres flamands s'en emparent. Fontainebleau devient "la nouvelle Rome" du Nord.`},
      {type:'text',content:`Sous Henri IV (1593-1610), une **Seconde Ã‰cole de Fontainebleau** prolonge ce travail avec des artistes franÃ§ais comme Toussaint Dubreuil et Martin FrÃ©minet, qui dÃ©core la voÃ»te de la chapelle de la TrinitÃ©. Le chÃ¢teau reste pendant un siÃ¨cle entier le laboratoire artistique de la France.`},
    ],
    quiz:[
      {q:'Quel artiste arrive en premier Ã  Fontainebleau, en 1530 ?',choices:['Le Primatice','Rosso Fiorentino','Gilles Le Breton','NiccolÃ² dell\'Abate'],correct:1,feedback:'Rosso Fiorentino (Giovanni Battista di Jacopo) arrive en 1530, suivi du Primatice deux ans plus tard.'},
      {q:'Quelle technique nouvelle associÃ©e Ã  la Galerie FranÃ§ois Ier combine relief et peinture ?',choices:['La mosaÃ¯que','L\'huile sur toile','Le stuc et la fresque','La tempera'],correct:2,feedback:'Le stuc â€” mÃ©lange de plÃ¢tre et marbre â€” est modelÃ© en haut-relief autour des fresques. C\'est une innovation venue d\'Italie.'},
      {q:'Pourquoi les thÃ¨mes de la Galerie sont-ils "cryptiques" ?',choices:['Pour ne pas choquer les visiteurs','Pour cacher des plans secrets du roi','Pour que seuls les lettrÃ©s comprennent les allÃ©gories royales','Parce que les artistes ne parlaient pas franÃ§ais'],correct:2,feedback:'Les allÃ©gories mythologiques servaient de langage codÃ© entre le roi et les courtisans cultivÃ©s. La beautÃ© visuelle touchait tout le monde â€” le sens profond, seulement quelques-uns.'},
    ]
  },
  {
    id:'m3', icon:'ğŸ‘‘', num:'Salle III', accent:'#7a2020',
    title:'Le TrÃ´ne et les Adieux',
    lyam_preview:'Un escalier qui ressemble Ã  un fer Ã  cheval de cheval gÃ©ant. Et une piÃ¨ce oÃ¹ l\'atmosphÃ¨re est si chargÃ©e que Lyam arrÃªte de parler.',
    tag:'Bourbons Â· NapolÃ©on Â· 1610â€”1814',
    lyam:[
      `L'escalier en Fer-Ã -Cheval est la premiÃ¨re chose vraiment grande qu'il voit â€” pas grande comme une tour de guet, grande autrement. Deux rampes de pierre qui s'Ã©cartent, s'arrondissent, se retrouvent en bas sur la mÃªme marche. Personne dans son monde n'aurait gaspillÃ© de la pierre pour faire Ã§a. On aurait fait un escalier droit. Efficace.`,
      `Il comprend plus tard que l'inefficacitÃ© Ã©tait le message. Le roi descendait lentement. Les courtisans le regardaient descendre. La magnificence, Ã§a prend du temps.`,
      `La Salle du TrÃ´ne est petite. Il s'y attendait Ã  quelque chose d'Ã©crasant â€” comme la grande salle de Valdurne en fÃªte. Mais c'est presque intime. Et pourtant il ne peut pas rester longtemps dedans. Il y a quelque chose dans l'air, une prÃ©sence lourde. RÃ©na lui dit qu'un homme y a signÃ© sa propre capitulation. Lyam ne sait pas ce qu'est une capitulation. Quand RÃ©na lui explique, il reste silencieux un long moment.`,
    ],
    reality_title:'Des Bourbons Ã  NapolÃ©on â€” le chÃ¢teau comme thÃ©Ã¢tre du pouvoir',
    reality:[
      {type:'text',content:`Henri IV fait de Fontainebleau sa rÃ©sidence favorite et entreprend de **doubler la surface du chÃ¢teau** entre 1593 et 1610. Il fait creuser le **Grand Canal**, long de 1,2 kilomÃ¨tre, prÃ©cÃ©dant de soixante ans celui de Versailles. Une fille naÃ®t au chÃ¢teau en 1601 : le futur Louis XIII.`},
      {type:'fact',title:'L\'Escalier en Fer-Ã -Cheval â€” 1632-1634',content:`ConÃ§u par Jean Androuet du Cerceau, cet escalier extÃ©rieur en forme de fer Ã  cheval remplace un escalier Renaissance vÃ©tuste. Sa double volÃ©e incurvÃ©e en fait un chef-d'Å“uvre de gÃ©omÃ©trie baroque. Il sera copiÃ© au Palais de Monaco et Ã  la cour Visconti du Louvre. C'est lÃ  que NapolÃ©on prononcera ses Adieux en 1814.`},
      {type:'text',content:`Louis XIV, bien qu'il ait transfÃ©rÃ© le centre du pouvoir Ã  Versailles, continue les **"voyages Ã  Fontainebleau"** chaque automne. C'est dans le cabinet de sa favorite, Mme de Maintenon, qu'il signe en 1685 l'**Ã‰dit de Fontainebleau** â€” rÃ©voquant l'Ã‰dit de Nantes et interdisant le culte protestant. 200 000 huguenots s'exilent.`},
      {type:'fact',title:'NapolÃ©on â€” "la vraie demeure des rois"',content:`L'Empereur dÃ©pense des millions pour remeubler le palais vidÃ© par la RÃ©volution. Il crÃ©e l'unique Salle du TrÃ´ne impÃ©rial encore conservÃ©e en France dans son dÃ©cor d'origine. Des passages secrets d'acajou lui permettent de circuler entre ses bureaux et les appartements officiels.`},
      {type:'text',content:`Le 20 avril 1814, au pied de l'escalier en Fer-Ã -Cheval, NapolÃ©on prononce ses derniers mots Ã  sa Vieille Garde avant l'exil Ã  l'Ã®le d'Elbe. La nuit prÃ©cÃ©dente, il avait tentÃ© de s'empoisonner dans son appartement. Son mÃ©decin le sauva. L'escalier est depuis un **lieu de mÃ©moire nationale**.`},
    ],
    quiz:[
      {q:'Que signe Louis XIV Ã  Fontainebleau en 1685 ?',choices:['Le traitÃ© de paix avec l\'Angleterre','L\'Ã‰dit rÃ©voquant l\'Ã‰dit de Nantes','L\'acte de vente de la Louisiane','La crÃ©ation de Versailles'],correct:1,feedback:'L\'Ã‰dit de Fontainebleau rÃ©voque l\'Ã‰dit de Nantes (1598) et interdit le protestantisme. 200 000 protestants fuiront la France.'},
      {q:'Qu\'est-ce que l\'Escalier en Fer-Ã -Cheval a d\'exceptionnel gÃ©omÃ©triquement ?',choices:['Il descend en spirale','Il est creusÃ© dans le roc','Sa double volÃ©e incurvÃ©e qui se rejoint en bas','Il n\'a pas de rampe'],correct:2,feedback:'Deux rampes courbes s\'Ã©cartent au sommet et se rejoignent en un seul palier au bas â€” une forme en fer Ã  cheval. CopiÃ©e depuis Ã  Monaco et au Louvre.'},
      {q:'Qu\'arrive-t-il Ã  NapolÃ©on dans la nuit du 12 au 13 avril 1814 ?',choices:['Il signe l\'abdication finale','Il tente de s\'empoisonner','Il prÃ©pare ses Adieux Ã  la Garde','Il reÃ§oit le tsar de Russie'],correct:1,feedback:'NapolÃ©on avale une dose de poison conservÃ©e depuis la campagne de Russie. Son mÃ©decin le sauve. Le lendemain, il prononce ses Adieux.'},
    ]
  },
  {
    id:'m4', icon:'ğŸ—ï¸', num:'Salle IV', accent:'#2a4a1a',
    title:'Les Couloirs de l\'Ombre',
    lyam_preview:'Lyam dÃ©couvre une porte cachÃ©e derriÃ¨re une tapisserie. De l\'autre cÃ´tÃ© : un passage Ã©troit, sombre, qui sent la poussiÃ¨re ancienne.',
    tag:'Secrets Â· Passages dÃ©robÃ©s Â· Ã€ toi de jouer',
    isLDVELH:true,
    ldvelhId:'passages',
  },
  {
    id:'m5', icon:'ğŸŒ¿', num:'Salle V', accent:'#1a3a5a',
    title:'La RiviÃ¨re Droite et la ForÃªt',
    lyam_preview:'Le Grand Canal lui coupe le souffle â€” pas par sa beautÃ©, mais par l\'idÃ©e derriÃ¨re. Des hommes ont rendu une riviÃ¨re droite. Pourquoi faire Ã§a ?',
    tag:'Jardins Â· ForÃªt Â· Nature royale',
    lyam:[
      `Lyam sort du chÃ¢teau et voit le Canal pour la premiÃ¨re fois. Il s'arrÃªte.`,
      `Ce n'est pas une riviÃ¨re. Les riviÃ¨res ne sont pas droites. Elles Ã©pousent le terrain, elles contournent les rochers, elles dÃ©cident elles-mÃªmes de leur chemin. Celle-lÃ  est droite comme une lame. 1,2 kilomÃ¨tre. Il compte le temps qu'il met Ã  marcher jusqu'au bout. Quelqu'un a creusÃ© Ã§a dans la terre, mÃ©thodiquement, au millimÃ¨tre.`,
      `Il comprend plus tard que c'Ã©tait Ã§a, le message. La nature obÃ©it au roi. Le paysage lui-mÃªme s'incline.`,
      `Mais Ã  deux cents pas du chÃ¢teau, la forÃªt commence. Et lÃ , plus rien n'obÃ©it Ã  personne. Les chÃªnes font ce qu'ils veulent depuis des siÃ¨cles. Les chemins se perdent. Et Lyam se sent, pour la premiÃ¨re fois depuis l'arrivÃ©e, dans quelque chose qui ressemble Ã  son monde.`,
    ],
    reality_title:'Les jardins et la forÃªt â€” nature domestiquÃ©e, nature sauvage',
    reality:[
      {type:'fact',title:'Le Grand Canal â€” prÃ©curseur de Versailles',content:`CommandÃ© par Henri IV entre 1606 et 1609, le Grand Canal mesure 1,2 kilomÃ¨tre de long. Il prÃ©cÃ¨de de soixante ans celui que Louis XIV fera construire Ã  Versailles. RÃ©cemment restaurÃ© (2020-2022), il illustre la volontÃ© des rois de "domestiquer" la nature â€” la plier aux formes gÃ©omÃ©triques du pouvoir.`},
      {type:'text',content:`Le domaine dispose de **130 hectares de parcs et jardins**. Trois jardins principaux coexistent, chacun avec une logique diffÃ©rente. Le **Jardin de Diane** â€” l'ancien jardin de la reine â€” est ornÃ© d'une fontaine surmontÃ©e d'une statue de la dÃ©esse chasseresse. Le **Jardin Anglais**, amÃ©nagÃ© sous NapolÃ©on, remplace l'ancien jardin des Pins et incarne le goÃ»t romantique du XIXe siÃ¨cle : allÃ©es sinueuses, riviÃ¨re artificielle, "dÃ©sordre" calculÃ©.`},
      {type:'text',content:`La forÃªt est la raison d'Ãªtre du chÃ¢teau. Les rois venaient d'abord chasser, et la forÃªt a Ã©tÃ© prÃ©servÃ©e â€” parfois replantÃ©e â€” pendant huit siÃ¨cles. Louis XIV et Louis XV font planter **5 000 hectares de feuillus** entre 1720 et 1795 pour maintenir la ressource en bois de chasse et de construction. Aujourd'hui, la forÃªt de Fontainebleau est l'une des plus cÃ©lÃ¨bres de France.`},
      {type:'fact',title:'1948 â€” La forÃªt devient symbole mondial',content:`Le 5 octobre 1948, Ã  Fontainebleau, est fondÃ©e l'Union Internationale pour la Protection de la Nature (UICN). La forÃªt royale devient le berceau symbolique des prÃ©occupations Ã©cologiques mondiales â€” une ironie que n'auraient pas manquÃ©e les rois chasseurs qui l'avaient prÃ©servÃ©e pour leurs plaisirs.`},
      {type:'text',content:`Le chÃ¢teau et sa forÃªt sont inscrits au **patrimoine mondial de l'UNESCO depuis 1981**. Ce classement reconnaÃ®t non seulement le monument architectural, mais aussi l'ensemble du domaine â€” chÃ¢teau, jardins, et forÃªt â€” comme un Ã©cosystÃ¨me culturel unique oÃ¹ "la main de l'homme et la force de la forÃªt ont fini par se confondre dans une harmonie royale et impÃ©riale".`},
    ],
    quiz:[
      {q:'Combien de temps le Grand Canal a-t-il prÃ©cÃ©dÃ© celui de Versailles ?',choices:['10 ans','30 ans','60 ans','100 ans'],correct:2,feedback:'Henri IV fait creuser le Grand Canal entre 1606 et 1609. Louis XIV crÃ©e celui de Versailles Ã  partir de 1668 â€” soit environ 60 ans plus tard.'},
      {q:'Quelle organisation mondiale est fondÃ©e Ã  Fontainebleau en 1948 ?',choices:['L\'UNESCO','L\'Union Internationale pour la Protection de la Nature','Les Nations Unies','L\'Organisation mondiale du commerce'],correct:1,feedback:'L\'UICN (Union Internationale pour la Protection de la Nature) est fondÃ©e le 5 octobre 1948 Ã  Fontainebleau â€” premier organisme mondial dÃ©diÃ© Ã  l\'environnement.'},
      {q:'Pourquoi Lyam trouve-t-il le Grand Canal troublant ?',choices:['Il est trop grand pour son monde','Une riviÃ¨re droite n\'existe pas dans la nature â€” c\'est une dÃ©monstration de pouvoir','Il ne sait pas nager','Il croit que c\'est un fossÃ© dÃ©fensif'],correct:1,feedback:'Exactement. Le Canal "droit" transgresse les lois naturelles â€” c\'est prÃ©cisÃ©ment l\'intention : montrer que le roi peut imposer sa volontÃ© mÃªme Ã  la gÃ©ographie.'},
    ]
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SÃ‰QUENCE LDVELH â€” Passages Secrets
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LDVELH_PASSAGES = {
  start:'p1',
  steps:6,
  passages:{
    p1:{
      num:'Â§ 1 Â· La porte cachÃ©e',mood:'ğŸ—ï¸',
      text:[
        `La tapisserie reprÃ©sente une chasse royale â€” des chevaux bondissants, des chiens Ã  la langue rose. Lyam la regarde depuis dix minutes quand il remarque qu'elle bouge lÃ©gÃ¨rement du bas.`,
        `Pas le vent. Il n'y a pas de fenÃªtre ouverte dans cette salle.`,
        `Il soulÃ¨ve un coin de la tapisserie. Une porte en bois sombre, sans poignÃ©e visible, juste une lÃ©gÃ¨re encoche dans le bois. Il appuie. La porte s'ouvre sur un couloir Ã©troit et sombre qui sent la pierre froide et quelque chose d'autre â€” de la cire ancienne, peut-Ãªtre.`,
        `RÃ©na le rejoint. <em>Â« Tu vas entrer ? Â»</em>`,
      ],
      choices:[
        {text:'Entrer seul â€” explorer rapidement avant que quelqu\'un remarque.',next:'p2a'},
        {text:'Entrer tous les deux â€” deux paires d\'yeux valent mieux qu\'une.',next:'p2b'},
        {text:'Refermer la tapisserie et signaler la porte Ã  un gardien.',next:'p2c'},
      ]
    },
    p2a:{
      num:'Â§ 2 Â· L\'escalier solitaire',mood:'ğŸ•¯ï¸',
      text:[
        `Le couloir descend. Lyam compte les marches : onze, puis un palier, puis un autre couloir horizontal. La pierre ici est diffÃ©rente â€” plus ancienne, plus rugueuse.`,
        `Il entend quelque chose. Pas des voix. Des pas, lÃ©gers, rÃ©guliers, au-dessus de lui. Quelqu'un marche dans la salle qu'il vient de quitter.`,
        `Il continue. Le couloir tourne Ã  droite et dÃ©bouche sur une petite piÃ¨ce circulaire avec une chaise en bois, une bougie dans un chandelier de fer, et sur le mur, des marques gravÃ©es : des noms, des dates, des phrases en vieilles lettres qu'il ne reconnaÃ®t pas.`,
        `<em>Des gens sont passÃ©s ici. Beaucoup de gens. Depuis trÃ¨s longtemps.</em>`,
      ],
      choices:[
        {text:'Chercher Ã  comprendre les inscriptions â€” les recopier pour les faire traduire.',next:'p3a'},
        {text:'Continuer dans la piÃ¨ce et chercher une autre sortie.',next:'p3b'},
      ]
    },
    p2b:{
      num:'Â§ 2 Â· Ensemble',mood:'ğŸ¤',
      text:[
        `Ils entrent tous les deux. La porte se referme derriÃ¨re eux â€” pas completement, juste assez pour que l'obscuritÃ© soit totale.`,
        `RÃ©na sort une petite pierre lumineuse de son sac (dans leur monde, c'est courant). Dans le couloir de ce chÃ¢teau, Ã§a fait un effet bizarre â€” une lueur bleutÃ©e sur de la pierre vieille de siÃ¨cles.`,
        `<em>Â« Ces passages, Â»</em> dit RÃ©na Ã  voix basse, <em>Â« ils ne sont pas lÃ  par accident. Quelqu'un les a construits pour se dÃ©placer sans Ãªtre vu. Â»</em>`,
        `<em>Â« Un roi ? Â»</em>`,
        `<em>Â« Ou quelqu'un qui voulait approcher le roi sans que personne le sache. Â»</em>`,
        `Deux directions s'offrent Ã  eux.`,
      ],
      choices:[
        {text:'Prendre le passage qui monte â€” vers les appartements royaux.',next:'p3a'},
        {text:'Prendre le passage qui descend â€” vers les caves et les fondations.',next:'p3b'},
      ]
    },
    p2c:{
      num:'Â§ 2 Â· La dÃ©cision sage',mood:'ğŸ“‹',
      text:[
        `Lyam referme la tapisserie et trouve un gardien â€” un homme en uniforme vert sombre avec un badge dorÃ©. Il lui montre la porte.`,
        `L'homme sourit. <em>Â« Ah oui, les passages. Ils sont rÃ©pertoriÃ©s. Certains sont accessibles en visite guidÃ©e. Â»</em>`,
        `En attendant la visite guidÃ©e, Lyam apprend quelque chose : ces passages sont connus, documentÃ©s, cartographiÃ©s. Dans son monde, un passage secret qui a Ã©tÃ© dÃ©couvert n'est plus secret â€” il est abandonnÃ© ou condamnÃ©. Ici, il est devenu une attraction. La transparence comme forme de conservation.`,
        `La visite guidÃ©e commence vingt minutes plus tard. Lyam pose des questions pendant tout le trajet. Le guide rÃ©pond Ã  toutes.`,
      ],
      choices:[
        {text:'Suivre le guide jusqu\'au bout â€” apprendre tout ce qu\'il a Ã  dire.',next:'p3c'},
      ]
    },
    p3a:{
      num:'Â§ 3 Â· Les inscriptions',mood:'ğŸ“œ',
      text:[
        `Les inscriptions sur le mur circulaire sont des noms et des dates. Le plus rÃ©cent qu'il peut dÃ©chiffrer : 1901. Le plus ancien, presque effacÃ© : quelque chose qui ressemble Ã  1647.`,
        `Des gens ont traversÃ© ce passage pendant deux cent cinquante ans et ont laissÃ© leur trace. Pas pour la gloire â€” juste pour dire <em>j'Ã©tais lÃ </em>. Un page anonyme. Un domestique. Un amant peut-Ãªtre, venu en secret. L'histoire officielle n'a gardÃ© aucun de ces noms.`,
        `Il pense Ã  Christine de SuÃ¨de, dont il ne connaÃ®t pas encore l'histoire, et Ã  tous ceux qui ont circulÃ© dans l'ombre pendant que les rois Ã©clairaient les grandes salles. Et il se demande : dans le monde officiel, qui voit-on ? Qui reste invisible ?`,
      ],
      choices:[
        {text:'Continuer vers le choix final.',next:'p_dilemme'},
      ]
    },
    p3b:{
      num:'Â§ 3 Â· L\'autre direction',mood:'â¬‡ï¸',
      text:[
        `Le passage descend jusqu'Ã  un niveau qui doit Ãªtre sous la cour principale. L'air est plus humide, plus froid. Des niches dans le mur semblent avoir contenu des torches, autrefois.`,
        `Et puis â€” une autre porte. Mince, en fer forgÃ©, fermÃ©e par un cadenas moderne (mÃ©tal brillant, mÃ©canisme inconnu de Lyam). DerriÃ¨re : dans l'obscuritÃ©, on devine des formes protÃ©gÃ©es sous des bÃ¢ches blanches.`,
        `Des Å“uvres. ProtÃ©gÃ©es lÃ , dans l'obscuritÃ©, comme des trÃ©sors enterrÃ©s. Il comprendra plus tard que c'est ici qu'on les a cachÃ©es pendant une guerre â€” celle qu'ils appellent Seconde Guerre mondiale â€” quand des envahisseurs occupaient le chÃ¢teau.`,
        `La beautÃ© mise en sÃ»retÃ© dans l'ombre. Lyam trouve Ã§a Ã©trangement Ã©mouvant.`,
      ],
      choices:[
        {text:'Continuer vers le choix final.',next:'p_dilemme'},
      ]
    },
    p3c:{
      num:'Â§ 3 Â· La visite guidÃ©e',mood:'ğŸ¤',
      text:[
        `Le guide connaÃ®t tout â€” les escaliers du Roi et de la Reine, les passages du Primatice, les couloirs derriÃ¨re la chapelle de la TrinitÃ©.`,
        `Il raconte comment les passages permettaient aux souverains de se dÃ©placer sans Ãªtre vus des courtisans â€” pour l'intimitÃ©, pour les intrigues politiques, pour les amours secrÃ¨tes. Et comment, en 1657, la reine Christine de SuÃ¨de s'en est servie diffÃ©remment.`,
        `Christine avait soupÃ§onnÃ© son grand Ã©cuyer Monaldeschi de l'avoir trahie. Elle l'a fait suivre dans la Galerie des Cerfs par ses hommes. LÃ , malgrÃ© ses supplications, elle a ordonnÃ© son exÃ©cution. Dans une rÃ©sidence royale franÃ§aise. Cela a choquÃ© la cour de Louis XIV pendant des dÃ©cennies.`,
        `Lyam Ã©coute sans dire un mot. Dans son monde, les rÃ¨gles d'hospitalitÃ© sont absolues. On ne tue pas un invitÃ© sous votre toit, jamais. Ce qu'a fait Christine est une transgression que son code d'honneur ne peut pas calculer.`,
      ],
      choices:[
        {text:'Continuer vers le choix final.',next:'p_dilemme'},
      ]
    },
    p_dilemme:{
      num:'Â§ Final Â· La question de l\'ombre',mood:'âš–ï¸',
      text:[
        `De retour dans les grandes salles, Lyam rÃ©flÃ©chit Ã  ce qu'il a vu.`,
        `Les passages secrets racontent une histoire diffÃ©rente de celle des grandes galeries. Dans les galeries, tout est visible, magnifiÃ©, public â€” c'est l'histoire officielle. Dans les passages, l'invisible : les domestiques, les espions, les amants, les artistes qui travaillent la nuit, les fugitifs pendant la guerre.`,
        `RÃ©na lui pose la question directement : <em>Â« Laquelle de ces deux histoires est la vraie ? Â»</em>`,
        `Lyam doit rÃ©pondre.`,
      ],
      choices:[
        {text:'"L\'histoire officielle. Les rois ont bÃ¢ti cet endroit â€” c\'est leur histoire qui compte."',next:'p_echec',result:'fail'},
        {text:'"Les deux. L\'une n\'existe pas sans l\'autre. Les passages existent parce que les grandes salles existent, et inversement."',next:'p_succes',result:'success'},
        {text:'"L\'histoire des gens invisibles. Elle est plus vraie parce qu\'elle est moins racontÃ©e."',next:'p_succes_2',result:'success'},
      ]
    },
    p_succes:{
      num:'Â§ RÃ©ponse â€” La profondeur du regard',mood:'ğŸŒŸ',
      isResult:true,resultType:'success',
      text:[
        `RÃ©na hoche la tÃªte lentement. <em>Â« C'est Ã§a. Â»</em>`,
        `L'histoire d'un lieu n'est pas la somme de ses grandes dates et de ses rois cÃ©lÃ¨bres. C'est la tension entre ce qui est montrÃ© et ce qui est cachÃ©, entre le visible et l'ombre. Fontainebleau vaut autant par ses passages secrets que par sa Galerie FranÃ§ois Ier â€” et les deux sont indissociables.`,
        `Les historiens appellent Ã§a l'histoire des "oubliÃ©s" ou des "sans-noms". Mais Lyam n'a pas besoin de ce mot. Il sait juste que la rÃ©alitÃ© est Ã©paisse, qu'elle a des couloirs cachÃ©s, et que les visiter change la faÃ§on dont on regarde les grandes salles.`,
      ],
      endNote:'L\'histoire complÃ¨te d\'un lieu intÃ¨gre Ã  la fois les grandes figures et ceux qui n\'ont pas de statues. Les deux forment l\'Ã©paisseur de la rÃ©alitÃ©.'
    },
    p_succes_2:{
      num:'Â§ RÃ©ponse â€” Le regard de l\'ombre',mood:'ğŸŒŸ',
      isResult:true,resultType:'success',
      text:[
        `RÃ©na sourit. <em>Â« Dangereux comme rÃ©ponse. Mais pas faux. Â»</em>`,
        `Il y a une vÃ©ritÃ© dans cette position : les histoires peu racontÃ©es mÃ©ritent d'Ãªtre entendues d'abord parce qu'elles sont minoritaires, pas parce qu'elles sont plus vraies. Mais Lyam a raison de les privilÃ©gier ici â€” parce que le chÃ¢teau les a effacÃ©es volontairement. L'histoire officielle avait les moyens de se raconter elle-mÃªme.`,
        `Donner une voix Ã  ce qui a Ã©tÃ© tu, c'est aussi une forme de justice historique.`,
      ],
      endNote:'Valoriser les histoires oubliÃ©es, c\'est corriger un dÃ©sÃ©quilibre â€” pas nier l\'existence de l\'histoire officielle.'
    },
    p_echec:{
      num:'Â§ Un angle manquÃ©',mood:'ğŸŒ«ï¸',
      isResult:true,resultType:'fail',
      text:[
        `RÃ©na secoue la tÃªte doucement. <em>Â« Tu viens de traverser des passages oÃ¹ des gens ont vÃ©cu, cachÃ© des Å“uvres pendant une guerre, et gravÃ© leurs noms pour qu'on n'oublie pas qu'ils existaient. Et tu dis que c'est l'histoire des rois qui compte ? Â»</em>`,
        `Ce n'est pas qu'il a tort â€” les rois ont bien bÃ¢ti Fontainebleau. Mais rÃ©duire l'histoire d'un lieu Ã  ses commanditaires officiels, c'est amputer la rÃ©alitÃ© de toute son Ã©paisseur. L'histoire complÃ¨te, c'est la tension entre la grande salle et le passage secret.`,
        `Retente. La bonne rÃ©ponse est plus complexe que le choix entre "les uns" et "les autres".`,
      ],
      endNote:'L\'histoire d\'un monument ne se rÃ©duit pas Ã  ses commanditaires. Elle intÃ¨gre tous ceux qui y ont vÃ©cu, travaillÃ©, et laissÃ© une trace â€” mÃªme invisible.'
    }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDU HUB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHub(p){
  const xp=xpTotal(p);
  document.getElementById('playerName').textContent=cur;
  document.getElementById('playerXP').textContent=xp;
  const d=getDone();
  document.getElementById('moduleDone').textContent=Object.keys(d).length;
  const grid=document.getElementById('modulesGrid');
  grid.innerHTML='';
  MODULES.forEach(m=>{
    const done=isDone(m.id);
    const card=document.createElement('div');
    card.className='module-card'+(done?' done':'');
    card.style.setProperty('--mc-accent',m.accent||'#c9a84c');
    if(m.isLDVELH){
      card.innerHTML=`
        <span class="mc-icon">${m.icon}</span>
        <div class="mc-num">${m.num}</div>
        <div class="mc-title">${m.title}</div>
        <div class="mc-lyam">${m.lyam_preview}</div>
        <div class="mc-footer"><span class="mc-tag">${m.tag}</span><span class="mc-ldvelh">âš”ï¸ Tu joues</span></div>`;
      card.onclick=()=>openLDVELH();
    } else {
      card.innerHTML=`
        <span class="mc-icon">${m.icon}</span>
        <div class="mc-num">${m.num}</div>
        <div class="mc-title">${m.title}</div>
        <div class="mc-lyam">${m.lyam_preview}</div>
        <div class="mc-footer"><span class="mc-tag">${m.tag}</span><span class="mc-cta">${done?'Relire â–¸':'DÃ©couvrir â–¸'}</span></div>`;
      card.onclick=()=>openModule(m);
    }
    grid.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODULE TEXTE + QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeModule=null;
function openModule(m){
  activeModule=m;
  document.getElementById('modalTitle').textContent=`${m.num} Â· ${m.title}`;
  document.getElementById('modalContent').innerHTML=buildModuleHTML(m);
  document.getElementById('moduleModal').classList.add('open');
  document.getElementById('moduleModal').scrollTop=0;
  markDone(m.id);
  updateCounter();
}
function closeModule(){
  document.getElementById('moduleModal').classList.remove('open');
  const p=getPlayer(cur);if(p)renderHub(p);
}
function updateCounter(){
  document.getElementById('moduleDone').textContent=Object.keys(getDone()).length;
}

function buildModuleHTML(m){
  let h='';
  // Regard de Lyam
  h+=`<div class="lyam-block"><div class="lb-tag">ğŸ‘ï¸ Ce que voit Lyam â€” Ã©cuyer de Valdurne, XIe siÃ¨cle</div><div class="lb-text">`;
  m.lyam.forEach(t=>h+=`<p>${t}</p>`);
  h+=`</div></div>`;
  // RÃ©alitÃ©
  h+=`<div class="reality-block"><div class="rb-tag">ğŸ“š ${m.reality_title}</div><div class="rb-text">`;
  m.reality.forEach(b=>{
    if(b.type==='text') h+=`<p>${b.content}</p>`;
    else if(b.type==='fact') h+=`<div class="fact-box"><strong>ğŸ“Œ ${b.title}</strong>${b.content}</div>`;
  });
  h+=`</div></div>`;
  // Quiz
  if(m.quiz&&m.quiz.length){
    h+=`<div class="quiz-block"><div class="quiz-tag">ğŸ§  Teste-toi â€” ${m.quiz.length} questions</div>`;
    m.quiz.forEach((q,qi)=>{
      h+=`<div class="quiz-q" id="qq_${m.id}_${qi}">
        <div class="qq-text">${qi+1}. ${q.q}</div>
        <div class="qq-choices">`;
      q.choices.forEach((c,ci)=>{
        h+=`<button class="qq-btn" onclick="answerQuiz('${m.id}',${qi},${ci},${q.correct},'${escQ(q.feedback)}')">${c}</button>`;
      });
      h+=`</div><div class="qq-feedback" id="qf_${m.id}_${qi}"></div></div>`;
    });
    h+=`<div class="quiz-result" id="qresult_${m.id}">
      <div class="qr-title" id="qt_${m.id}"></div>
      <div class="qr-xp" id="qxp_${m.id}"></div>
      <div class="qr-text" id="qtxt_${m.id}"></div>
      <button class="btn-retry-quiz" onclick="retryQuiz('${m.id}')">Recommencer le quiz</button>
    </div></div>`;
  }
  return h;
}
function escQ(s){return s.replace(/'/g,"\\'").replace(/"/g,'\\"')}

const quizState={};
function answerQuiz(mid,qi,ci,correct,feedback){
  if(!quizState[mid])quizState[mid]={answers:{},done:false};
  const st=quizState[mid];
  if(st.done||st.answers[qi]!==undefined)return;
  st.answers[qi]=ci;
  const btns=document.querySelectorAll(`#qq_${mid}_${qi} .qq-btn`);
  btns.forEach((b,i)=>{
    b.classList.add('answered');
    b.disabled=true;
    if(i===correct)b.classList.add('correct');
    else if(i===ci&&ci!==correct)b.classList.add('wrong');
  });
  document.getElementById(`qf_${mid}_${qi}`).textContent=feedback;
  // VÃ©rifier si tout rÃ©pondu
  const m=MODULES.find(x=>x.id===mid);
  if(m&&m.quiz&&Object.keys(st.answers).length===m.quiz.length){
    finalizeQuiz(mid,m);
  }
}
function finalizeQuiz(mid,m){
  const st=quizState[mid];
  st.done=true;
  const correct=m.quiz.filter((q,i)=>st.answers[i]===q.correct).length;
  const ok=correct>=Math.ceil(m.quiz.length*0.67);
  const xp=ok?XP_BON:XP_MAL;
  const res=document.getElementById(`qresult_${mid}`);
  res.className='quiz-result visible '+(ok?'ok':'nok');
  document.getElementById(`qt_${mid}`).textContent=ok?`${correct}/${m.quiz.length} â€” Bien jouÃ© !`:`${correct}/${m.quiz.length} â€” Encore un effort`;
  document.getElementById(`qxp_${mid}`).textContent=ok?`+${xp} XP`:`${xp} XP`;
  document.getElementById(`qtxt_${mid}`).textContent=ok
    ?`Tu as maÃ®trisÃ© l'essentiel de cette salle. Les XP sont crÃ©ditÃ©s dans ton Portail.`
    :`Il te faut au moins ${Math.ceil(m.quiz.length*0.67)} bonnes rÃ©ponses. Relis et retente !`;
  creditXP(cur,xp,`FONT_QUIZ_${mid.toUpperCase()}`);
  showXpNotif(xp);
}
function retryQuiz(mid){
  quizState[mid]={answers:{},done:false};
  openModule(MODULES.find(x=>x.id===mid));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LDVELH PASSAGES SECRETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ldvHistory=[];
function openLDVELH(){
  document.getElementById('modalTitle').textContent='Salle IV Â· Les Couloirs de l\'Ombre';
  ldvHistory=[];
  renderPassage(LDVELH_PASSAGES.start);
  document.getElementById('moduleModal').classList.add('open');
  document.getElementById('moduleModal').scrollTop=0;
}
function renderPassage(pid){
  const pass=LDVELH_PASSAGES.passages[pid];
  if(!pass)return;
  ldvHistory.push(pid);
  // Barre de progression
  let progHtml=`<div class="ldv-progress">`;
  for(let i=0;i<LDVELH_PASSAGES.steps;i++){
    const cls=i<ldvHistory.length-1?'ldv-step done':i===ldvHistory.length-1?'ldv-step current':'ldv-step';
    progHtml+=`<div class="${cls}"></div>`;
  }
  progHtml+=`</div>`;
  let h=`<div class="ldvelh-section">
    <div class="ldvelh-tag">âš”ï¸ Les Couloirs de l'Ombre â€” Tu incarnes Lyam</div>
    ${progHtml}
    <div class="passage active">
      <div class="p-num">${pass.num}</div>
      ${pass.mood?`<div class="p-mood">${pass.mood}</div>`:''}
      <div class="p-text">${(pass.text||[]).map(t=>`<p>${t}</p>`).join('')}</div>
      <hr style="border:none;border-top:1px solid rgba(201,168,76,0.15);margin:16px 0">`;
  if(pass.isResult){
    const ok=pass.resultType==='success';
    const xp=ok?XP_BON:XP_MAL;
    if(ok){markDone('m4');updateCounter()}
    h+=`<div class="ldv-result ${ok?'success':'fail'}">
      <span class="lr-icon">${ok?'â­':'ğŸ’­'}</span>
      <div class="lr-title">${ok?'Bonne rÃ©ponse !':'Ã€ retravaillerâ€¦'}</div>
      <div class="lr-xp">${ok?'+'+xp+' XP':''+xp+' XP'}</div>
      <div class="lr-text">${pass.endNote||''}</div>
      <button class="btn-close-mod" onclick="closeModule()">Fermer</button>
      ${!ok?`<button class="btn-retry-ldv" onclick="openLDVELH()">Recommencer</button>`:''}
    </div>`;
    creditXP(cur,xp,ok?'FONT_PASSAGES_SUCCESS':'FONT_PASSAGES_ECHEC');
    showXpNotif(xp);
  } else if(pass.choices){
    h+=`<div class="choices">`;
    pass.choices.forEach(c=>{
      h+=`<button class="choice-btn" onclick="renderPassage('${c.next}')">${c.text}</button>`;
    });
    h+=`</div>`;
  }
  h+=`</div></div>`;
  document.getElementById('modalContent').innerHTML=h;
  document.getElementById('moduleModal').scrollTop=0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIF XP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showXpNotif(amount){
  const d=document.createElement('div');
  d.className='xp-notif '+(amount>0?'ok':'fail');
  d.textContent=amount>0?`+${amount} XP â€” Bien jouÃ© !`:`${amount} XP â€” Retente !`;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),5000);
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModule()});
</script>
</body>
</html>
