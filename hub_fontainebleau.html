<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chateau de Fontainebleau - Expedition de Valdurne</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{--or:#c9a84c;--or2:#e8c97a;--enc:#e8dfc8;--enc2:#c8bfa8;--p0:#120e0a;--p1:#1e1710;--r:8px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--p0);color:var(--enc);font-family:'Crimson Text',Georgia,serif;font-size:1.05em;line-height:1.75;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--p0)}::-webkit-scrollbar-thumb{background:rgba(201,168,76,.3);border-radius:3px}
.hdr{max-width:1100px;margin:0 auto;padding:36px 24px 0}
.htag{font-family:'Cinzel',serif;font-size:.63em;letter-spacing:5px;color:var(--or);opacity:.7;text-transform:uppercase;margin-bottom:10px}
.htitle{font-family:'Cinzel',serif;font-size:clamp(1.8em,5vw,2.6em);font-weight:700;color:var(--or2);line-height:1.2;margin-bottom:6px}
.hsub{font-style:italic;color:var(--enc2);opacity:.7;margin-bottom:20px}
.pbar{display:flex;align-items:center;gap:14px;flex-wrap:wrap;padding:10px 14px;background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.15);border-radius:6px;margin-bottom:28px;font-size:.82em}
.pi{color:var(--enc2)}.pv{color:var(--or2);font-weight:600;margin-left:4px}.ps{color:rgba(201,168,76,.3)}
.bnav{padding:5px 14px;background:transparent;border:1px solid rgba(201,168,76,.25);border-radius:4px;color:var(--enc2);font-size:.82em;text-decoration:none;display:inline-block;transition:all .2s}
.bnav:hover{border-color:var(--or);color:var(--or)}
.lib{max-width:1100px;margin:0 auto;padding:0 24px 60px}
.plabel{font-family:'Cinzel',serif;font-size:.7em;letter-spacing:4px;color:var(--or);text-transform:uppercase;margin:0 0 16px;padding-bottom:8px;border-bottom:1px solid rgba(201,168,76,.2)}
.pgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:36px}
.card{background:var(--p1);border:1px solid rgba(201,168,76,.2);border-radius:var(--r);padding:20px;position:relative;overflow:hidden;transition:transform .2s,border-color .2s,box-shadow .2s}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--ca,var(--or)),transparent)}
.card.ok{cursor:pointer}
.card.ok:hover{transform:translateY(-3px);border-color:rgba(201,168,76,.5);box-shadow:0 8px 30px rgba(0,0,0,.4)}
.card.nok{opacity:.5}
.card.done::after{content:'‚úì';position:absolute;top:10px;right:12px;color:var(--or);opacity:.7;font-size:.75em;font-family:'Cinzel',serif}
.cnum{font-family:'Cinzel',serif;font-size:.62em;letter-spacing:3px;color:var(--or);opacity:.6;margin-bottom:6px}
.cicon{font-size:1.8em;margin-bottom:8px;display:block}
.ctitle{font-family:'Cinzel',serif;font-size:.9em;font-weight:600;color:var(--or2);line-height:1.3;margin-bottom:4px}
.cmeta{font-size:.72em;color:var(--enc2);opacity:.65;margin-bottom:8px}
.cexc{font-style:italic;font-size:.82em;color:var(--enc2);line-height:1.65;border-left:2px solid rgba(201,168,76,.2);padding-left:10px;margin-bottom:14px}
.cfooter{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
.cbadge{font-size:.7em;color:var(--or);opacity:.8}
.ccta{padding:5px 14px;background:rgba(201,168,76,.1);border:1px solid rgba(201,168,76,.4);border-radius:4px;color:var(--or2);font-size:.75em;letter-spacing:1px}
.csoon{font-size:.75em;color:#666;font-style:italic}
.etag{position:absolute;top:10px;right:12px;background:linear-gradient(135deg,#5a3a1a,#3a2a0a);border:1px solid var(--or);border-radius:3px;padding:2px 8px;font-size:.6em;color:var(--or2);letter-spacing:1px;font-family:'Cinzel',serif}
.intro-block{background:rgba(201,168,76,.04);border:1px solid rgba(201,168,76,.15);border-radius:8px;padding:20px 24px;margin-bottom:32px;font-style:italic;color:var(--enc2);line-height:1.8;font-size:.92em}
.intro-block strong{color:var(--or2);font-style:normal}
@media(max-width:600px){.hdr,.lib{padding-left:14px;padding-right:14px}}
</style>
</head>
<body>

<div class="hdr">
  <div class="htag">Expedition de Valdurne - Portail de la Bibliotheque</div>
  <h1 class="htitle">Chateau de Fontainebleau</h1>
  <p class="hsub">Lyam et Rena ont franchi le portail. De l'autre cote : huit siecles d'histoire royale.</p>
  <div class="pbar">
    <span class="pi">Ecuyer : <span class="pv" id="nomJ">-</span></span>
    <span class="ps">¬∑</span>
    <span class="pi">XP : <span class="pv" id="xpJ">-</span></span>
    <span class="ps">¬∑</span>
    <span class="pi">Salles visitees : <span class="pv" id="nbVisites">0</span> / 5</span>
    <a class="bnav" href="hub_narration.html">Bibliotheque de Valdurne</a>
    <a class="bnav" href="index.html">Portail Vie Scolaire</a>
  </div>
</div>

<div class="lib">
  <div class="intro-block">
    <strong>Comment ca marche :</strong> Lyam et Rena decouvrent le chateau avec les yeux d'ecuyers du Xeme siecle. Chaque salle presente d'abord leur regard etonne ‚Äî puis la realite historique. Un quiz valide ta comprehension et te rapporte des XP.
  </div>

  <div class="plabel">Les Salles du Chateau</div>
  <div class="pgrid" id="gridSalles"></div>

  <div class="plabel">Sequence - Les Couloirs de l'Ombre</div>
  <div class="pgrid" id="gridLDVELH"></div>
</div>

<script>
var KEY  = 'pvs_hof_v2';
var AKEY = 'pvs_current_player';
var XKEY = 'pvs_narration_xp';
var DKEY = 'pvs_narration_done';
var W    = {pixhare:60, psc1:60, sanctuaire:60, loge:60, autres:60};
var CIT  = {representant_ca:{xp:500}};
var cur  = '';

function getS(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(e){ return {}; } }
function saveS(S){ try{ localStorage.setItem(KEY,JSON.stringify(S)); }catch(e){} }
function getP(code){ var S=getS(); return (S.players&&S.players[code]) ? S.players[code] : null; }
function getDone(){ try{ return JSON.parse(localStorage.getItem(DKEY)||'{}'); }catch(e){ return {}; } }

function missionXp(code){
  try{ var S=getS(); var lists=S.citizen_lists||{}; var n=0;
    Object.keys(CIT).forEach(function(k){ if((lists[k]||[]).indexOf(code)>=0) n+=CIT[k].xp; });
    return n; }catch(e){ return 0; }
}
function socialRaw(p){ return Number(p&&p.socialG||0)+Number(p&&p.wBonusG||0); }
function socialValid(p){ return Number(p&&p.witnessGiven||0)>0 ? socialRaw(p) : 0; }
function citizenXp(p){ try{ return missionXp(p&&p.code)+socialValid(p); }catch(e){ return 0; } }
function academyXp(p){
  try{ var cp=(p&&p.cp)||{};
    return Object.keys(W).reduce(function(a,k){ return a+Number(cp[k]||0)*W[k]; }, 0);
  }catch(e){ return 0; } }
function videoXp(p){ return Number(p&&p.videoG||0); }
function acadCoeff(p){
  try{ var n=Math.min(Number(p&&p.acadDone||0),50); var c=Math.round((1+n*0.02)*100)/100; return isNaN(c)?1:c; }catch(e){ return 1; } }
function xg(p){
  if(!p) return 0;
  try{ var base=citizenXp(p)+academyXp(p)+videoXp(p)+Number(p.malusG||0);
    var r=Math.round(base*acadCoeff(p)); return isNaN(r)?0:r; }catch(e){ return 0; } }

function creditXP(code,amount,reason){
  if(!code) return; var S=getS(); if(!S.players||!S.players[code]) return;
  var p=S.players[code]; var now=new Date().toISOString();
  if(!Array.isArray(S.logs)) S.logs=[];
  S.logs.unshift({d:now,p:code,t:reason,target:'FONTAINEBLEAU',xp:Number(amount)});
  if(S.logs.length>700) S.logs.length=700;
  if(amount>0){ p.wBonusG=(Number(p.wBonusG||0)+(amount/10)); p.wBonusW=(Number(p.wBonusW||0)+(amount/10)); }
  else { p.malusG=(Number(p.malusG||0)+amount); p.malusW=(Number(p.malusW||0)+amount); }
  p.up=now; saveS(S);
  var pending=JSON.parse(localStorage.getItem(XKEY)||'[]');
  pending.push({code:code,amount:amount,reason:reason,d:now});
  localStorage.setItem(XKEY,JSON.stringify(pending));
}

/* CATALOGUE */
var SALLES = [
  {id:'font_m1', file:'font_m1.html', num:'Salle I',   icon:'üóº', title:'Le Donjon Familier',           meta:'Origines medievales - 1137 a 1527', acc:'#8a6a1f',
   exc:'Lyam reconnait la logique du donjon. Mais certains details l arretent : une plaque de metal avec des chiffres, un fil de velours rouge qui interdit l acces sans aucun garde.'},
  {id:'font_m2', file:'font_m2.html', num:'Salle II',  icon:'üé®', title:'La Galerie des Sortileges',     meta:'Renaissance et Ecole de Fontainebleau - 1527 a 1610', acc:'#6a4a8a',
   exc:'Des corps grandeur nature sortent des murs en relief peint. Sept ans de travail pour un seul couloir. Lyam touche le cadre. Il ne connait pas cette technique.'},
  {id:'font_m3', file:'font_m3.html', num:'Salle III', icon:'‚öúÔ∏è', title:'Le Trone et les Adieux',        meta:'Bourbons et Napoleon - 1610 a 1814', acc:'#8a3a3a',
   exc:'L escalier Fer-a-Cheval : deux rampes qui s ecartent et se retrouvent en bas sur la meme marche. Personne a Valdurne n aurait gaspille de la pierre comme ca. Lyam comprend progressivement que l inefficacite est un message.'},
  {id:'font_m4', file:'font_m4.html', num:'Salle IV',  icon:'üåø', title:'La Riviere Droite et la Foret', meta:'Jardins, Canal et Nature royale', acc:'#3a6a3a',
   exc:'Le Grand Canal : 1,2 km de longueur parfaitement droite. Lyam s arrete. Les rivieres ne sont jamais droites. Quelqu un a corrige la nature elle-meme.'},
  {id:'font_m5', file:'font_m5.html', num:'Salle V',   icon:'üåç', title:'Le Chateau dans le Monde',      meta:'Fontainebleau aujourd hui et son heritage', acc:'#3a4a7a',
   exc:'Des visiteurs de partout dans le monde levent leurs petits rectangles brillants vers les fresques. Lyam essaie de comprendre pourquoi. Rena a une theorie.'},
];

var LDVELH = [
  {id:'font_ldv', file:'font_ldv_passages.html', icon:'üóùÔ∏è', title:'Les Couloirs de l Ombre',
   meta:'Sequence LDVELH - 6 passages - Tes choix ont des consequences', acc:'#5a3a6a',
   exc:'Lyam decouvre une porte cachee derriere une tapisserie. Passages secrets, histoires oubliees, et une question : laquelle des deux histoires du chateau est vraie ?',
   badge:'Historien des Ombres'},
];

function makeCard(cfg){
  var d=document.createElement('div');
  var cls='card '+(cfg.canOpen?'ok':'nok')+(cfg.done?' done':'');
  d.className=cls;
  if(cfg.acc) d.style.setProperty('--ca', cfg.acc);
  if(cfg.canOpen && cfg.file){
    var f=cfg.file;
    d.onclick=function(){ window.location.href=f; };
  }
  var h='';
  if(cfg.num) h+='<div class="cnum">'+cfg.num+'</div>';
  h+='<span class="cicon">'+cfg.icon+'</span>';
  h+='<div class="ctitle">'+cfg.title+'</div>';
  h+='<div class="cmeta">'+(cfg.meta||'')+'</div>';
  if(cfg.exc) h+='<div class="cexc">'+cfg.exc+'</div>';
  h+='<div class="cfooter">';
  h+=cfg.badge ? '<span class="cbadge">'+cfg.badge+'</span>' : '<span></span>';
  if(cfg.canOpen && cfg.file) h+='<span class="ccta">'+(cfg.done?'Revisiter':'Entrer')+'</span>';
  h+='</div>';
  d.innerHTML=h;
  return d;
}

function renderHub(p){
  var xp=xg(p);
  document.getElementById('nomJ').textContent=cur;
  document.getElementById('xpJ').textContent=xp;
  var done=getDone();
  var visited=SALLES.filter(function(s){ return done[s.id]; }).length;
  document.getElementById('nbVisites').textContent=visited;

  var gS=document.getElementById('gridSalles');
  gS.innerHTML='';
  SALLES.forEach(function(s){
    gS.appendChild(makeCard({
      icon:s.icon, title:s.title, meta:s.meta, exc:s.exc, num:s.num,
      file:s.file, acc:s.acc, canOpen:true, done:!!done[s.id],
    }));
  });

  var gL=document.getElementById('gridLDVELH');
  gL.innerHTML='';
  LDVELH.forEach(function(l){
    gL.appendChild(makeCard({
      icon:l.icon, title:l.title, meta:l.meta, exc:l.exc,
      file:l.file, acc:l.acc, badge:l.badge, canOpen:true, done:!!done[l.id],
    }));
  });
}

(function(){
  var raw=localStorage.getItem(AKEY)||'';
  if(!raw){ window.location.href='index.html'; return; }
  cur=raw.trim().toUpperCase();
  var p=getP(cur);
  if(!p){ window.location.href='index.html'; return; }
  renderHub(p);
})();
</script>
</body>
</html>
